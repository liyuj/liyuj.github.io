<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>11.生产准备 | Apache Ignite中文站</title>
    <meta name="description" content="Ignite内存计算平台的中文文档及相关资料">
    <link rel="shortcut icon" type="image/x-icon" href="https://ignite.apache.org/favicon.ico">
  <script src="https://hm.baidu.com/hm.js?03f40be28ff9a31fd798fd6b9dac0946"></script>
    
    <link rel="preload" href="/assets/css/0.styles.f86987ee.css" as="style"><link rel="preload" href="/assets/js/app.5bbff1f1.js" as="script"><link rel="preload" href="/assets/js/28.6290ed01.js" as="script"><link rel="prefetch" href="/assets/js/10.3fbbbcb9.js"><link rel="prefetch" href="/assets/js/100.107164fa.js"><link rel="prefetch" href="/assets/js/11.bdd7042e.js"><link rel="prefetch" href="/assets/js/12.77fef187.js"><link rel="prefetch" href="/assets/js/13.68c3827e.js"><link rel="prefetch" href="/assets/js/14.3b9b248b.js"><link rel="prefetch" href="/assets/js/15.8fda9c2c.js"><link rel="prefetch" href="/assets/js/16.c3affa37.js"><link rel="prefetch" href="/assets/js/17.e913ff43.js"><link rel="prefetch" href="/assets/js/18.d5e6e08c.js"><link rel="prefetch" href="/assets/js/19.b1033532.js"><link rel="prefetch" href="/assets/js/2.67b11a96.js"><link rel="prefetch" href="/assets/js/20.e07ab2a3.js"><link rel="prefetch" href="/assets/js/21.53c989b0.js"><link rel="prefetch" href="/assets/js/22.c57b3ce4.js"><link rel="prefetch" href="/assets/js/23.736edea3.js"><link rel="prefetch" href="/assets/js/24.37b4d1a9.js"><link rel="prefetch" href="/assets/js/25.dafb1ad4.js"><link rel="prefetch" href="/assets/js/26.b6b6006d.js"><link rel="prefetch" href="/assets/js/27.84d85805.js"><link rel="prefetch" href="/assets/js/29.23fd8c94.js"><link rel="prefetch" href="/assets/js/3.ec2e51de.js"><link rel="prefetch" href="/assets/js/30.5bde3d3b.js"><link rel="prefetch" href="/assets/js/31.1bc0a9a7.js"><link rel="prefetch" href="/assets/js/32.c74d70bb.js"><link rel="prefetch" href="/assets/js/33.b06809c6.js"><link rel="prefetch" href="/assets/js/34.935d6ae1.js"><link rel="prefetch" href="/assets/js/35.bcc19c8c.js"><link rel="prefetch" href="/assets/js/36.c070b612.js"><link rel="prefetch" href="/assets/js/37.245b043a.js"><link rel="prefetch" href="/assets/js/38.11b3684d.js"><link rel="prefetch" href="/assets/js/39.4ade0594.js"><link rel="prefetch" href="/assets/js/4.1ee1b332.js"><link rel="prefetch" href="/assets/js/40.254455c7.js"><link rel="prefetch" href="/assets/js/41.c42dfec4.js"><link rel="prefetch" href="/assets/js/42.00c027cd.js"><link rel="prefetch" href="/assets/js/43.c6ece485.js"><link rel="prefetch" href="/assets/js/44.0d58c883.js"><link rel="prefetch" href="/assets/js/45.f551a9ad.js"><link rel="prefetch" href="/assets/js/46.77f38a6c.js"><link rel="prefetch" href="/assets/js/47.41fa9710.js"><link rel="prefetch" href="/assets/js/48.bcdad433.js"><link rel="prefetch" href="/assets/js/49.f27768df.js"><link rel="prefetch" href="/assets/js/5.fc9dec3f.js"><link rel="prefetch" href="/assets/js/50.0af7190c.js"><link rel="prefetch" href="/assets/js/51.13acdc31.js"><link rel="prefetch" href="/assets/js/52.916e6c6c.js"><link rel="prefetch" href="/assets/js/53.98a08703.js"><link rel="prefetch" href="/assets/js/54.ab27d101.js"><link rel="prefetch" href="/assets/js/55.0a9f676e.js"><link rel="prefetch" href="/assets/js/56.44e4dabb.js"><link rel="prefetch" href="/assets/js/57.7f47260b.js"><link rel="prefetch" href="/assets/js/58.8247f2ee.js"><link rel="prefetch" href="/assets/js/59.35047073.js"><link rel="prefetch" href="/assets/js/6.c6bb0d04.js"><link rel="prefetch" href="/assets/js/60.62bcc2be.js"><link rel="prefetch" href="/assets/js/61.c2ffa382.js"><link rel="prefetch" href="/assets/js/62.0fcb56cf.js"><link rel="prefetch" href="/assets/js/63.39bd0025.js"><link rel="prefetch" href="/assets/js/64.332b1830.js"><link rel="prefetch" href="/assets/js/65.48557fdd.js"><link rel="prefetch" href="/assets/js/66.5e44e96e.js"><link rel="prefetch" href="/assets/js/67.5f86d9b1.js"><link rel="prefetch" href="/assets/js/68.0df4bc4f.js"><link rel="prefetch" href="/assets/js/69.ad94d131.js"><link rel="prefetch" href="/assets/js/7.9400d1e2.js"><link rel="prefetch" href="/assets/js/70.4e734829.js"><link rel="prefetch" href="/assets/js/71.0b195d4f.js"><link rel="prefetch" href="/assets/js/72.feb7c9f1.js"><link rel="prefetch" href="/assets/js/73.c9e10448.js"><link rel="prefetch" href="/assets/js/74.a86516bf.js"><link rel="prefetch" href="/assets/js/75.39e11beb.js"><link rel="prefetch" href="/assets/js/76.d28db209.js"><link rel="prefetch" href="/assets/js/77.4011fd89.js"><link rel="prefetch" href="/assets/js/78.d7e05c37.js"><link rel="prefetch" href="/assets/js/79.a1dfcab0.js"><link rel="prefetch" href="/assets/js/8.408122a9.js"><link rel="prefetch" href="/assets/js/80.858f1ab2.js"><link rel="prefetch" href="/assets/js/81.bb4be5b4.js"><link rel="prefetch" href="/assets/js/82.0e544f43.js"><link rel="prefetch" href="/assets/js/83.b49a5a4f.js"><link rel="prefetch" href="/assets/js/84.4863c748.js"><link rel="prefetch" href="/assets/js/85.e26b0cc5.js"><link rel="prefetch" href="/assets/js/86.2b05316e.js"><link rel="prefetch" href="/assets/js/87.7371cd2e.js"><link rel="prefetch" href="/assets/js/88.7dea1508.js"><link rel="prefetch" href="/assets/js/89.3b50ba01.js"><link rel="prefetch" href="/assets/js/9.ed4431a0.js"><link rel="prefetch" href="/assets/js/90.dc36de11.js"><link rel="prefetch" href="/assets/js/91.b63d9fe9.js"><link rel="prefetch" href="/assets/js/92.8a483972.js"><link rel="prefetch" href="/assets/js/93.e718c781.js"><link rel="prefetch" href="/assets/js/94.3dd41423.js"><link rel="prefetch" href="/assets/js/95.fe2eb94a.js"><link rel="prefetch" href="/assets/js/96.60363eb0.js"><link rel="prefetch" href="/assets/js/97.c25ca0a7.js"><link rel="prefetch" href="/assets/js/98.9a1ef9da.js"><link rel="prefetch" href="/assets/js/99.734e8c17.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f86987ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc/2.6.0/" class="home-link router-link-active"><!----> <span class="site-name">Apache Ignite中文站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc/2.6.0/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/2.6.0/java/" class="nav-link router-link-active">Java</a></div><div class="nav-item"><a href="/doc/2.6.0/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/2.6.0/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/2.6.0/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/2.6.0/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">2.6.0</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/ProductionReadiness.html" class="nav-link router-link-exact-active router-link-active">2.6.0</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc/2.6.0/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/2.6.0/java/" class="nav-link router-link-active">Java</a></div><div class="nav-item"><a href="/doc/2.6.0/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/2.6.0/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/2.6.0/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/2.6.0/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">2.6.0</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/ProductionReadiness.html" class="nav-link router-link-exact-active router-link-active">2.6.0</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc/2.6.0/java/" class="sidebar-link">1.基本概念</a></li><li><a href="/doc/2.6.0/java/Clustering.html" class="sidebar-link">2.集群化</a></li><li><a href="/doc/2.6.0/java/Key-ValueDataGrid.html" class="sidebar-link">3.键-值数据网格</a></li><li><a href="/doc/2.6.0/java/Security.html" class="sidebar-link">4.安全</a></li><li><a href="/doc/2.6.0/java/DataLoadingStreaming.html" class="sidebar-link">5.数据注入和流处理</a></li><li><a href="/doc/2.6.0/java/DistributedDataStructures.html" class="sidebar-link">6.分布式数据结构</a></li><li><a href="/doc/2.6.0/java/ComputeGrid.html" class="sidebar-link">7.计算网格</a></li><li><a href="/doc/2.6.0/java/ServiceGrid.html" class="sidebar-link">8.服务网格</a></li><li><a href="/doc/2.6.0/java/MessagingEvents.html" class="sidebar-link">9.消息和事件</a></li><li><a href="/doc/2.6.0/java/DurableMemory.html" class="sidebar-link">10.固化内存</a></li><li><a href="/doc/2.6.0/java/ProductionReadiness.html" class="active sidebar-link">11.生产准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-1-生产准备" class="sidebar-link">11.1.生产准备</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-2-容量规划" class="sidebar-link">11.2.容量规划</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-2-1-摘要" class="sidebar-link">11.2.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-2-2-规划内存使用量" class="sidebar-link">11.2.2.规划内存使用量</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-2-3-规划计算使用量" class="sidebar-link">11.2.3.规划计算使用量</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-2-4-容量规划faq" class="sidebar-link">11.2.4.容量规划FAQ</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-性能提示" class="sidebar-link">11.3.性能提示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-1-摘要" class="sidebar-link">11.3.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-2-禁用内部事件通知" class="sidebar-link">11.3.2.禁用内部事件通知</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-3-关闭备份" class="sidebar-link">11.3.3.关闭备份</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-4-固化内存调优" class="sidebar-link">11.3.4.固化内存调优</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-5-调整缓存数据再平衡" class="sidebar-link">11.3.5.调整缓存数据再平衡</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-6-配置线程池" class="sidebar-link">11.3.6.配置线程池</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-7-使用并置的计算" class="sidebar-link">11.3.7.使用并置的计算</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-8-使用数据流处理器" class="sidebar-link">11.3.8.使用数据流处理器</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-9-批量处理消息" class="sidebar-link">11.3.9.批量处理消息</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-10-调整垃圾收集" class="sidebar-link">11.3.10.调整垃圾收集</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-3-11-不要在读时进行值复制" class="sidebar-link">11.3.11.不要在读时进行值复制</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-4-固化内存调优" class="sidebar-link">11.4.固化内存调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-4-1-一般调优" class="sidebar-link">11.4.1.一般调优</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-4-2-与原生持久化有关的调优" class="sidebar-link">11.4.2.与原生持久化有关的调优</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-5-垃圾回收调优" class="sidebar-link">11.5.垃圾回收调优</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-5-1-垃圾回收调优" class="sidebar-link">11.5.1.垃圾回收调优</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-5-2-linux对gc的侵袭" class="sidebar-link">11.5.2.Linux对GC的侵袭</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-5-3-调试内存使用问题和gc暂停" class="sidebar-link">11.5.3.调试内存使用问题和GC暂停</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-5-4-文件描述符" class="sidebar-link">11.5.4.文件描述符</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-6-严重错误处理" class="sidebar-link">11.6.严重错误处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-6-1-摘要" class="sidebar-link">11.6.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-6-2-严重故障" class="sidebar-link">11.6.2.严重故障</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-6-3-故障处理" class="sidebar-link">11.6.3.故障处理</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/ProductionReadiness.html#_11-7-一致性检查" class="sidebar-link">11.7.一致性检查</a></li></ul></li></ul></li><li><a href="/doc/2.6.0/java/PlatformsProtocols.html" class="sidebar-link">12.平台和协议</a></li><li><a href="/doc/2.6.0/java/Plugins.html" class="sidebar-link">13.插件</a></li><li><a href="/doc/2.6.0/java/Deployment.html" class="sidebar-link">14.部署</a></li><li><a href="/doc/2.6.0/java/MachineLearningGrid.html" class="sidebar-link">15.机器学习网格</a></li><li><a href="/doc/2.6.0/java/Persistence.html" class="sidebar-link">16.持久化</a></li><li><a href="/doc/2.6.0/java/TestsAndBenchmarking.html" class="sidebar-link">17.基准测试</a></li><li><a href="/doc/2.6.0/java/Metrics.html" class="sidebar-link">18.指标</a></li><li><a href="/doc/2.6.0/java/ThinClients.html" class="sidebar-link">19.瘦客户端</a></li><li><a href="/doc/2.6.0/java/KubernetesDeployment.html" class="sidebar-link">20.Kubernetes部署</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="_11-生产准备"><a href="#_11-生产准备" aria-hidden="true" class="header-anchor">#</a> 11.生产准备</h1> <h2 id="_11-1-生产准备"><a href="#_11-1-生产准备" aria-hidden="true" class="header-anchor">#</a> 11.1.生产准备</h2> <p>本章涵盖了在准备将系统迁移到生产环境时的主要考虑因素。</p> <h2 id="_11-2-容量规划"><a href="#_11-2-容量规划" aria-hidden="true" class="header-anchor">#</a> 11.2.容量规划</h2> <h3 id="_11-2-1-摘要"><a href="#_11-2-1-摘要" aria-hidden="true" class="header-anchor">#</a> 11.2.1.摘要</h3> <p>对系统容量进行编制和规划是设计的一个必要组成部分。理解需要的缓存大小有助于决定需要多少物理内存、多少JVM、多少CPU和服务器。本章节会讨论有助于规划和确定一个部署的最小硬件需求的各种技术。</p> <h3 id="_11-2-2-规划内存使用量"><a href="#_11-2-2-规划内存使用量" aria-hidden="true" class="header-anchor">#</a> 11.2.2.规划内存使用量</h3> <ul><li>计算主数据大小：每个条目的大小(字节)乘以条目的总数量</li> <li>如果需要备份，乘以备份的数量</li> <li>索引也需要内存，基本的用例是增加一个30%的量</li> <li>每个缓存大约增加20MB（如果显式地指定<code>IgniteSystemProperties.IGNITE_ATOMIC_CACHE_DELETE_HISTORY_SIZE</code>为比默认值小的值，这个值可以减小）。</li> <li>每个节点增加大约200-300MB，为内部存储以及为了JVM和GC高效运行预留的合理的量。</li></ul> <blockquote><p>GridGain通常会为每个条目增加200个字节。</p></blockquote> <p><strong>内存容量规划示例</strong>
以如下的场景举例：</p> <ul><li>2,000,000个对象</li> <li>每个对象1,024个字节（1KB）</li> <li>1个备份</li> <li>4个节点</li></ul> <p>总对象数量 x 对象大小 x 2（每个对象一主一备）
2,000,000 x 1,024 x 2 = 4,096,000,000 字节</p> <p>考虑到索引：
4,096,000,000 + (4,096,000,000 x 30%) = 5,078 MB</p> <p>平台大约需要的额外内存：
300 MB x 4 = 1,200 MB</p> <p>总大小：
5,078 + 1,200 = 6,278 MB</p> <p>因此，预期的总内存消耗将超过 ~6GB</p> <h3 id="_11-2-3-规划计算使用量"><a href="#_11-2-3-规划计算使用量" aria-hidden="true" class="header-anchor">#</a> 11.2.3.规划计算使用量</h3> <p>如果在没有代码的情况下规划计算通常来说很难进行估计，理解应用中要执行的每个操作要花费的成本是非常重要的，然后再乘以各种情况下预期要执行的操作的数量。为此一个非常好的起点就是Ignite的基准测试，它详细描述了标准操作的执行结果，以及提供这种性能所必要的粗略的容量需求。
在32核4.large的AWS实例上，性能测试结果如下：</p> <blockquote><p>PUT/GET: 26k/s
PUT (事务): 68k/s
PUT (事务 - 悲观): 20k/s
PUT (事务 - 乐观): 44k/s
SQL查询: 72k/s</p></blockquote> <p><a href="http://www.gridgain.com/resources/benchmarks/ignite-vs-hazelcast-benchmarks" target="_self" rel="noopener noreferrer">这里</a>提供更多的信息。</p> <h3 id="_11-2-4-容量规划faq"><a href="#_11-2-4-容量规划faq" aria-hidden="true" class="header-anchor">#</a> 11.2.4.容量规划FAQ</h3> <ul><li>DB中有300GB的数据，Ignite中会不会也是这样的？
不是，磁盘上的数据大小不能直接1：1地映射到内存中，粗略估计的话，如果不计算索引和其他的负载，和磁盘比大概是2.5/3的关系，如果要得到精确值，可以通过将记录导入Ignite来得出对象大小的平均值，然后乘以期望的对象数量。</li></ul> <h2 id="_11-3-性能提示"><a href="#_11-3-性能提示" aria-hidden="true" class="header-anchor">#</a> 11.3.性能提示</h2> <h3 id="_11-3-1-摘要"><a href="#_11-3-1-摘要" aria-hidden="true" class="header-anchor">#</a> 11.3.1.摘要</h3> <p>Ignite内存数据网格的性能和吞吐量很大程度上依赖于使用的功能以及配置，在几乎所有的场景中都可以通过简单地调整缓存的配置来优化缓存的性能。</p> <h3 id="_11-3-2-禁用内部事件通知"><a href="#_11-3-2-禁用内部事件通知" aria-hidden="true" class="header-anchor">#</a> 11.3.2.禁用内部事件通知</h3> <p>Ignite有丰富的事件系统来向用户通知各种各样的事件，包括缓存的修改，退出，压缩，拓扑的变化以及很多其他的。因为每秒钟可能产生上千的事件，他会对系统产生额外的负载，这会导致显著地性能下降。因此，强烈建议只有应用逻辑必要时才启用这些事件。默认的话，事件通知是禁用的：
XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ... 
    <span class="token comment">&lt;!-- Enable only some events and leave other ones disabled. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>includeEventTypes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>constant</span> <span class="token attr-name">static-field</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.events.EventType.EVT_TASK_STARTED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>constant</span> <span class="token attr-name">static-field</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.events.EventType.EVT_TASK_FINISHED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">util:</span>constant</span> <span class="token attr-name">static-field</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.events.EventType.EVT_TASK_FAILED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_11-3-3-关闭备份"><a href="#_11-3-3-关闭备份" aria-hidden="true" class="header-anchor">#</a> 11.3.3.关闭备份</h3> <p>如果使用了<code>分区</code>缓存，而且数据丢失并不是关键（比如，当有一个备份缓存存储时），可以考虑禁用<code>分区</code>缓存的备份。当备份启用时，缓存引擎会为每个条目维护一个远程拷贝，这需要网络交换和而且是耗时的。要禁用备份，可以使用如下的配置：
XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            ...
            <span class="token comment">&lt;!-- Set cache mode. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PARTITIONED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Set number of backups to 0--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>backups<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p><strong>可能的数据丢失</strong>
如果没有启用<code>分区</code>缓存的备份，会丢失缓存在故障节点的所有数据，这对于缓存临时数据或者数据可以通过某种方式重建可能是可以接受的。禁用备份之前一定要确保对于应用来说丢失数据不是关键的。</p></blockquote> <h3 id="_11-3-4-固化内存调优"><a href="#_11-3-4-固化内存调优" aria-hidden="true" class="header-anchor">#</a> 11.3.4.固化内存调优</h3> <p>固化内存调优以及原生持久化，请参考相关的<code>10.3.内存配置</code>以及下面的<code>11.4.固化内存调优</code>章节。</p> <h3 id="_11-3-5-调整缓存数据再平衡"><a href="#_11-3-5-调整缓存数据再平衡" aria-hidden="true" class="header-anchor">#</a> 11.3.5.调整缓存数据再平衡</h3> <p>当有一个新节点加入网络时，已有的节点会放弃一些键的或主或备的所有权给新的节点以使整个集群中的数据一直保持均衡，这可能需要额外的资源以及影响缓存的性能。要处理这个可能的问题，可以考虑调整如下的参数：</p> <ul><li>配置适应网络状况的再平衡批量大小。默认是512KB，这意味着默认的平衡消息是512KB。然而，您可能需要将此值设置为基于网络性能的更高或更低的值；</li> <li>配置再平衡暂停减低CPU负载。如果数据集非常大，这会导致很多的消息需要发送，CPU或者网络都会过度消耗，这会连续地降低应用的性能。这时应该启用数据再平衡暂停来帮助调整再平衡消息之间的等待时间量以确保再平衡过程没有任何的负面性能影响。注意再平衡的过程中应用会持续地正确工作；</li> <li>配置再平衡线程池大小。与之前的观点相反，有时希望利用更多的CPU核心来加快再平衡的速度，这个可以通过增加再平衡线程池内的线程数量来实现（默认池内只有两个线程）。</li></ul> <p>下面是一个在缓存配置中设置上述所有参数的例子：
XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>             
            <span class="token comment">&lt;!-- Set rebalance batch size to 1 MB. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceBatchSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#{1024 * 1024}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
 
            <span class="token comment">&lt;!-- Explicitly disable rebalance throttling. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceThrottle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
 
            <span class="token comment">&lt;!-- Set 4 threads for rebalancing. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceThreadPoolSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>4<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            ... 
        &lt;/bean
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_11-3-6-配置线程池"><a href="#_11-3-6-配置线程池" aria-hidden="true" class="header-anchor">#</a> 11.3.6.配置线程池</h3> <p>Ignite使用了一组线程池，它们的大小默认由<code>max(8, CPU总核数)</code>确定，这个默认值适用于大多数场景，从而减少了上下文切换以及更高效地利用CPU缓存。但是，如果因为I/O阻塞或者其他的原因，只要希望也可以增加特定线程池的大小，下面是一个如何配置线程池的例子:
XML:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
    ... 
    &lt;!-- Configure internal thread pool. --&gt;
    &lt;property name=&quot;publicThreadPoolSize&quot; value=&quot;64&quot;/&gt;
    
    &lt;!-- Configure system thread pool. --&gt;
    &lt;property name=&quot;systemThreadPoolSize&quot; value=&quot;32&quot;/&gt;
    ...
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_11-3-7-使用并置的计算"><a href="#_11-3-7-使用并置的计算" aria-hidden="true" class="header-anchor">#</a> 11.3.7.使用并置的计算</h3> <p>Ignite可以在内存内执行MapReduce计算。然而，通常很多计算都会使用缓存在远程节点上的一些数据，大多数情况下从远程节点加载那些数据是很昂贵的而将计算发送到数据所在的节点就要便宜得多。最简单的实现方式就是使用<code>IgniteCompute.affinityRun()</code>方法或者<code>@CacheAffinityMapped</code>注解，也有其他的方式， 包括<code>Affinity.mapKeysToNodes()</code>方法。关于并置计算主题在<code>3.11.关系并置</code>章节有详细的描述，还有相关的代码样例。</p> <h3 id="_11-3-8-使用数据流处理器"><a href="#_11-3-8-使用数据流处理器" aria-hidden="true" class="header-anchor">#</a> 11.3.8.使用数据流处理器</h3> <p>如果需要往缓存中加载大量的数据，可以使用<code>IgniteDataStreamer</code>来实现，数据流处理器在将数据发送到远程节点之前会将数据正确地形成批次然后会正确地控制发生在每个节点的并发操作的数量来避免颠簸。通常他会比一堆单线程的操作有十倍的性能提升。可以在<code>3.13.数据加载</code>章节看到更详细的描述和样例。</p> <h3 id="_11-3-9-批量处理消息"><a href="#_11-3-9-批量处理消息" aria-hidden="true" class="header-anchor">#</a> 11.3.9.批量处理消息</h3> <p>如果能发送10个比较大的作业代替100个小些的作业，那么应该选择发送大些的作业，这会降低网络上传输作业的数量以及显著地提升性能。类似的，对于缓存的条目应该想办法使用API方法，他会使用键和值的集合，而不是一个一个地传递。</p> <h3 id="_11-3-10-调整垃圾收集"><a href="#_11-3-10-调整垃圾收集" aria-hidden="true" class="header-anchor">#</a> 11.3.10.调整垃圾收集</h3> <p>请参考<code>11.5.调整垃圾收集</code>章节的内容。</p> <h3 id="_11-3-11-不要在读时进行值复制"><a href="#_11-3-11-不要在读时进行值复制" aria-hidden="true" class="header-anchor">#</a> 11.3.11.不要在读时进行值复制</h3> <p>JCache标准要求缓存供应商支持基于值存储的语义，这意味着当从缓存中读取一个值时，无法得到真实存储的对象的引用，而是这个对象的一个副本。Ignite默认遵守这个方式，但是可以通过<code>CacheConfiguration.copyOnRead</code>这个配置属性覆盖这个行为。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 
        Force cache to return the instance that is stored in cache
        instead of creating a copy. 
    --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>copyOnRead<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p><strong>如果使用jul-to-slf4j桥，确保日志的正确配置</strong>
Ignite使用java.util.logging.Logger (JUL)，如果使用了jul-to-slf4j桥，那么需要特别注意为Ignite配置的JUL日志级别，如果因为某种原因将org.apache配置为DDEBUG级别，最终的日志级别可能是INFO，这意味着Ignite会花费十倍的负载来生成日志消息，它们在之后跨桥时会被丢弃，JUL的默认日志级别为INFO。在<code>org.apache.ignite.logger.java.JavaLogger#isDebugEnabled</code>中打上断点，当JUL系统的日志级别配置为DEBUG时，就会暴露这一点。</p></blockquote> <h2 id="_11-4-固化内存调优"><a href="#_11-4-固化内存调优" aria-hidden="true" class="header-anchor">#</a> 11.4.固化内存调优</h2> <p>本章节中包括了固化内存和原生持久化的性能建议和调优参数，在<code>10.3.内存配置</code>中已经包括了一般的配置参数。</p> <h3 id="_11-4-1-一般调优"><a href="#_11-4-1-一般调优" aria-hidden="true" class="header-anchor">#</a> 11.4.1.一般调优</h3> <p>为了正确地进行固化内存的调优，本章节中包含了一般性的建议，而不管将Ignite用于纯内存模式还是开启了持久化。
<strong>调整交换参数</strong>
当内存的使用达到阈值时，操作系统就会开始进行从内存到磁盘的页面交换，交换会显著影响Ignite节点进程的性能，这个问题可以通过调整操作系统参数来避免。如果使用的是UNIX，最佳选项是或者降低<code>vm.swappiness</code>的值到<code>10</code>，或者如果开启了原生持久化，也可以将其配置为<code>0</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sysctl –w vm.swappiness=0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>共享内存</strong>
操作系统和其他的应用为了满足功能需要也需要一块内存，再加上Ignite节点本身也需要一部分Java堆空间用于应用的查询和任务的处理，因此，如果Ignite运行于纯内存模式（无持久化），那么就不能将超过90%的内存分配给固化内存。
如果开启了Ignite的原生持久化，那么操作系统为了页面缓存还需要额外的内存空间来优化到磁盘的数据同步。在这个场景中，Ignite节点的整个内存占用（固化内存+Java堆）就不能超过内存总量的70%。
比如，下面的配置显示了如何为满足固化内存的需求分配4GB的内存空间：
XML：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;

&lt;property name=&quot;memoryConfiguration&quot;&gt;
  &lt;bean class=&quot;org.apache.ignite.configuration.MemoryConfiguration&quot;&gt;
    &lt;!-- Set the size of default memory region to 4GB. --&gt;
    &lt;property name=&quot;defaultMemoryPolicySize&quot; value=&quot;#{4L * 1024 * 1024 * 1024}&quot;/&gt;
  &lt;/bean&gt;
&lt;/property&gt;
  
&lt;!-- The rest of the parameters --&gt;
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Java：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IgniteConfiguration cfg = new IgniteConfiguration();

// Changing total RAM size to be used by Ignite Node.
MemoryConfiguration memCfg = new MemoryConfiguration();

// Setting the size of the default memory region to 4GB to achieve this.
memCfg.setDefaultMemoryPolicySize(4L * 1024 * 1024 * 1024);

cfg.setMemoryConfiguration(memCfg);

// Starting the node.
Ignition.start(cfg);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_11-4-2-与原生持久化有关的调优"><a href="#_11-4-2-与原生持久化有关的调优" aria-hidden="true" class="header-anchor">#</a> 11.4.2.与原生持久化有关的调优</h3> <p>本章节包含了开启Ignite原生持久化之后的建议。
<strong>页面大小</strong>
Ignite的页面大小（<code>MemoryConfiguration.pageSize</code>）不要小于存储设备（SSD、闪存等）的页面大小以及操作系统缓存页面的大小。
操作系统的缓存页面大小很容易就可以通过<a href="https://unix.stackexchange.com/questions/128213/how-is-page-size-determined-in-virtual-address-space" target="_self" rel="noopener noreferrer">系统工具和参数</a>获取到。
存储设备比如SSD的页面大小可以在设备的说明上找到，如果厂商未提供这些信息，可以运行SSD的基准测试来算出这个数值，如果还是难以拿到这个数值，可以使用4KB作为Ignite的页面大小。很多厂商为了适应4KB的随机写工作负载不得不调整驱动，因为很多标准基准测试都是默认使用4KB，来自英特尔的<a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ssd-server-storage-applications-paper.pdf" target="_self" rel="noopener noreferrer">白皮书</a>也确认4KB足够了。
选定最优值之后，可以将其用于集群的配置：
XML：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
   ...		
   &lt;property name=&quot;memoryConfiguration&quot;&gt;
    		&lt;bean class=&quot;org.apache.ignite.configuration.MemoryConfiguration&quot;&gt;
        		&lt;!-- Setting the page size to 4 KB --&gt;
            &lt;property name=&quot;pageSize&quot; value=&quot;#{4 * 1024}&quot;/&gt;
        &lt;/bean&gt;
    &lt;/property&gt;
    ...
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Java：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IgniteConfiguration cfg = new IgniteConfiguration();

// Changing total RAM size to be used by Ignite Node.
MemoryConfiguration memCfg = new MemoryConfiguration();

// Setting the page size to 4 KB.
memCfg.setPageSize(4096);

cfg.setMemoryConfiguration(memCfg);

// Starting the node.
Ignition.start(cfg);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>为WAL使用单独的磁盘设备</strong>
考虑为Ignite原生持久化的分区和索引文件以及WAL使用单独的磁盘设备。Ignite会主动地写入分区/索引文件以及WAL，因此，如果为每个使用单独的物理磁盘，可以将写入吞吐量增加一倍，下面的示例会显示如何实践：
XML：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
   ...		
  &lt;!-- Enabling Ignite Native Persistence. --&gt;
  &lt;property name=&quot;dataStorageConfiguration&quot;&gt;
    &lt;bean class=&quot;org.apache.ignite.configuration.DataStorageConfiguration&quot;&gt;
      &lt;!--
          Sets a path to the root directory where data and indexes are
          to be persisted. It's assumed the directory is on a separated SSD.
      --&gt;
      &lt;property name=&quot;storagePath&quot; value=&quot;/var/lib/ignite/persistence&quot;/&gt;

      &lt;!--
          Sets a path to the directory where WAL is stored.
          It's assumed the directory is on a separated HDD.
      --&gt;
      &lt;property name=&quot;walPath&quot; value=&quot;/wal&quot;/&gt;

      &lt;!--
          Sets a path to the directory where WAL archive is stored.
          The directory is on the same HDD as the WAL.
      --&gt;
      &lt;property name=&quot;walArchivePath&quot; value=&quot;/wal/archive&quot;/&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
    ...
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>Java：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IgniteConfiguration cfg = new IgniteConfiguration();

// Configuring Ignite Native Persistence.
DataStorageConfiguration storeCfg = new DataStorageConfiguration();

// Sets a path to the root directory where data and indexes are to be persisted.
// It's assumed the directory is on a separated SSD.
storeCfg.setStoragePath(&quot;/var/lib/ignite/persistence&quot;);

// Sets a path to the directory where WAL is stored.
// It's assumed the directory is on a separated HDD.
storeCfg.setWalPath(&quot;/wal&quot;);

// Sets a path to the directory where WAL archive is stored.
// The directory is on the same HDD as the WAL.
storeCfg.setWalArchivePath(&quot;/wal/archive&quot;);

// Starting the node.
Ignition.start(cfg);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>页面写入优化</strong>
Ignite会定期地启动检查点进程，以在内存和磁盘间同步脏页面。这个进程在后台进行，对应用没有影响。
但是，如果由检查点进程调度的一个脏页面，在写入磁盘前被更新，它之前的状态会被复制进一个特定的区域，叫做检查点缓冲区。如果这个缓冲区溢出，那么在检查点处理过程中，Ignite会停止所有的更新。因此，写入性能可能降为0，如下图所示：
<img src="https://files.readme.io/802c00c-image.png" alt>
当检查点处理正在进行中时，如果脏页面数达到阈值，同样的情况也会发生，这会使Ignite强制安排一个新的检查点执行，并停止所有的更新操作直到第一个检查点执行完成。
当磁盘较慢或者更新过于频繁时，这两种情况都会发生，要减少或者防止这样的性能下降，可以考虑启用页面写入优化算法。这个算法会在检查点缓冲区填充过快或者脏页面占比过高时，将更新操作的性能降低到磁盘的速度。</p> <blockquote><p><strong>页面写入优化剖析</strong>
要了解更多的信息，可以看相关专家维护的<a href="https://cwiki.apache.org/confluence/display/IGNITE/Ignite+Persistent+Store+-+under+the+hood#IgnitePersistentStore-underthehood-PagesWriteThrottling" target="_self" rel="noopener noreferrer">Wiki页面</a>。</p></blockquote> <p>下面的示例显示了如何开启页面写入优化：
XML：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
   ...		
  &lt;!-- Enabling Ignite Native Persistence. --&gt;
  &lt;property name=&quot;dataStorageConfiguration&quot;&gt;
    &lt;bean class=&quot;org.apache.ignite.configuration.DataStorageConfiguration&quot;&gt;
      &lt;!-- Enable write throttling. --&gt;
      &lt;property name=&quot;writeThrottlingEnabled&quot; value=&quot;true&quot;/&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
    ...
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Java：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IgniteConfiguration cfg = new IgniteConfiguration();

// Configuring Ignite Native Persistence.
DataStorageConfiguration storeCfg = new DataStorageConfiguration();

// Enabling the writes throttling.
storeCfg.setWriteThrottlingEnabled(true);

// Starting the node.
Ignition.start(cfg);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>检查点缓冲区大小</strong>
前述章节中描述的检查点缓冲区大小，是检查点处理的触发器之一。
缓冲区大小预定义为256MB，它并没有为写密集型应用进行优化，因为在大小接近标称值时，页面写入优化算法会降低写入的性能，因此在正在进行检查点处理时，可以考虑增加<code>DataRegionConfiguration.checkpointPageBufferSize</code>，并且开启写入优化来阻止性能的下
降：
XML：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
   ...		
  &lt;!-- Enabling Ignite Native Persistence. --&gt;
  &lt;property name=&quot;dataStorageConfiguration&quot;&gt;
    &lt;bean class=&quot;org.apache.ignite.configuration.DataStorageConfiguration&quot;&gt;
      &lt;!-- Enable write throttling. --&gt;
      &lt;property name=&quot;writeThrottlingEnabled&quot; value=&quot;true&quot;/&gt;
      
      &lt;property name=&quot;defaultDataRegionConfiguration&quot;&gt;
        &lt;bean class=&quot;org.apache.ignite.configuration.DataRegionConfiguration&quot;&gt;
          &lt;!-- Enabling persistence. --&gt;
          &lt;property name=&quot;persistenceEnabled&quot; value=&quot;true&quot;/&gt;
                
          &lt;!-- Increasing the buffer size to 1 GB. --&gt;
          &lt;property name=&quot;checkpointPageBufferSize&quot; 
                    value=&quot;#{1024L * 1024 * 1024}&quot;/&gt;
        &lt;/bean&gt;
      &lt;/property&gt;
    &lt;/bean&gt;
  &lt;/property&gt;
    ...
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>Java：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IgniteConfiguration cfg = new IgniteConfiguration();

// Configuring Ignite Native Persistence.
DataStorageConfiguration storeCfg = new DataStorageConfiguration();

// Enabling the writes throttling.
storeCfg.setWriteThrottlingEnabled(true);

// Increasing the buffer size to 1 GB.
storeCfg.getDefaultDataRegionConfiguration().setCheckpointPageBufferSize(
  1024L * 1024 * 1024);

// Starting the node.
Ignition.start(cfg);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在上例中，默认内存区的检查点缓冲区大小配置为1GB。</p> <blockquote><p><strong>检查点处理何时触发？</strong>
当脏页面数超过<code>总页数*2/3</code>或者达到<code>DataRegionConfiguration.checkpointPageBufferSize</code>时，检查点处理就会被触发。但是如果使用了页面写入优化，<code>DataRegionConfiguration.checkpointPageBufferSize</code>就会失效，因为算法的原因，不会达到这个值。</p></blockquote> <p><strong>启用直接I/O</strong>
通常当应用访问磁盘上的数据时，操作系统拿到数据后会将其写入一个文件缓冲区缓存，写操作也是同样，操作系统首先将数据写入缓存，然后才会传输到磁盘，要消除这个过程，可以打开直接IO，这时数据会忽略文件缓冲区缓存，直接从磁盘进行读写。
Ignite中的直接I/O插件用于检查点进程，它的作用是将内存中的脏页面写入磁盘，建议将直接IO插件用于写密集型或者混合式负载环境中。
注意，无法为WAL文件直接开启直接I/O，但是开启直接I/O可以为WAL文件带来一点好处，就是WAL数据不会在操作系统的缓冲区缓存中存储过长时间，他会在下一次页面缓存扫描中被刷新（依赖于WAL模式），然后从页面缓存中删除。
要启用直接I/O插件，需要将<code>ignite-direct-io-2.4.0.jar</code>和<code>jna-4.5.0.jar</code>加入应用的类路径，这些jar文件位于Ignite发行版的<code>libs/optional/ignite-direct-io</code>文件夹。另外，如果运行于独立模式，可以在运行<code>ignite.{sh|bat}</code>脚本前，将<code>ignite-direct-io</code>文件夹复制到<code>libs</code>文件夹中。
要禁用直接I/O，可以将<code>IGNITE_DIRECT_IO_ENABLED</code>系统属性配置为<code>false</code>。
相关的<a href="https://cwiki.apache.org/confluence/display/IGNITE/Ignite+Persistent+Store+-+under+the+hood#IgnitePersistentStore-underthehood-DirectI/O" target="_self" rel="noopener noreferrer">Wiki页面</a>有更多的细节。</p> <p><strong>购买产品级的SSD</strong>
限于<a href="http://codecapsule.com/2014/02/12/coding-for-ssds-part-2-architecture-of-an-ssd-and-benchmarking/" target="_self" rel="noopener noreferrer">SSD的操作特性</a>，在经历几个小时的高强度写入负载之后，Ignite原生持久化的性能可能会下降，因此需要考虑购买快速的产品级SSD来保证长时间高水平的性能。
<strong>SSD预留空间</strong>
由于SSD<a href="http://www.seagate.com/ru/ru/tech-insights/ssd-over-provisioning-benefits-master-ti/" target="_self" rel="noopener noreferrer">预留空间</a>的原因，50%使用率的磁盘的随机写性能要好于90%使用率的磁盘，因此需要考虑购买高预留空间比率的SSD，然后还要确保厂商能提供工具来进行相关的调整。</p> <h2 id="_11-5-垃圾回收调优"><a href="#_11-5-垃圾回收调优" aria-hidden="true" class="header-anchor">#</a> 11.5.垃圾回收调优</h2> <h3 id="_11-5-1-垃圾回收调优"><a href="#_11-5-1-垃圾回收调优" aria-hidden="true" class="header-anchor">#</a> 11.5.1.垃圾回收调优</h3> <p>下面是对应用的一套JVM配置，它会产生大量的临时对象，因此会因为垃圾收集活动而触发长时间的暂停。
集群中的JVM需要不断地进行监控和调优，GC的调优非常依赖于应用以及Ignite的使用模式。
对于JDK1.8来说，建议使用G1垃圾收集器，在下面的示例中，一台开启了G1的64核CPU的机器，配置10G的堆空间：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-server 
-Xms10g 
-Xmx10g
-XX:+AlwaysPreTouch
-XX:+UseG1GC
-XX:+ScavengeBeforeFullGC
-XX:+DisableExplicitGC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>如果要使用G1垃圾收集器，因为经过了不断地改进，建议使用最新版本的Oracle JDK8或者OpenJDK8。</p></blockquote> <p>如果G1无法满足应用场景或者使用的是JDK7，那么可以参照下面的基于CMS的配置，对于开始JVM调优是比较合适的（64核CPU的机器的10GB堆举例）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-server
-Xms10g
-Xmx10g
-XX:+AlwaysPreTouch
-XX:+UseParNewGC
-XX:+UseConcMarkSweepGC
-XX:+CMSClassUnloadingEnabled
-XX:+CMSPermGenSweepingEnabled 
-XX:+ScavengeBeforeFullGC
-XX:+CMSScavengeBeforeRemark
-XX:+DisableExplicitGC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>请注意，这些设置可能不总是理想的，所以一定确保在生产部署之前严格测试。</p></blockquote> <h3 id="_11-5-2-linux对gc的侵袭"><a href="#_11-5-2-linux对gc的侵袭" aria-hidden="true" class="header-anchor">#</a> 11.5.2.Linux对GC的侵袭</h3> <p>在Linux环境下，因为I/O或者内存饥饿或者其他特定内核的设定的原因，可能发生一个应用面临长时间的GC暂停的情况。本章节会给出一些指导，关于如何修改内核设定来避免因为Linux内核导致的长时间GC暂停。</p> <blockquote><p>下面给出的所有的Shell脚本命令都在RedHat7上做了测试，这些可能和实际的Linux发行版不同。
在应用任何基于内核的设定之前，还要确保检查系统统计数据、日志，使其对于实际场景的一个问题确实有效。
最后，在生产环境中针对Linux内核级做出改变，与IT部门商议也是明智的。</p></blockquote> <p><strong>I/O问题</strong>
如果GC日志显示：“low user time, low system time, long GC pause”，那么一个原因就是GC线程因为内核等待I/O而卡住了，发生的原因基本是日志提交或者因为日志滚动的gzip导致改变的文件系统刷新。
作为一个解决方案，可以增加页面刷新到磁盘的频率，从默认的30秒到5秒。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sysctl –w vm.dirty_writeback_centisecs<span class="token operator">=</span>500
  sysctl –w vm.dirty_expire_centisecs<span class="token operator">=</span>500
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>内存问题</strong>
如果GC日志显示“low user time, high system time, long GC pause”，那么最可能的是内存的压力触发了空闲内存的交换和扫描。</p> <ul><li>检查并且降低‘swappiness’的设定来保护堆和匿名内存</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sysctl –w vm.swappiness<span class="token operator">=</span>10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>启动时给JVM增加–XX:+AlwaysPreTouch参数</li> <li>关闭NUMA zone-reclaim优化</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sysctl –w vm.zone_reclaim_mode<span class="token operator">=</span>0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果使用RedHat发行版，关闭transparent_hugepage</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">echo</span> never <span class="token operator">&gt;</span> /sys/kernel/mm/redhat_transparent_hugepage/enabled
<span class="token keyword">echo</span> never <span class="token operator">&gt;</span> /sys/kernel/mm/redhat_transparent_hugepage/defrag
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>页面缓存</strong>
当应用与底层文件系统有大量的交互时，会导致内存大量使用页面缓存的情况，如果<code>kswapd</code>进程无法跟上页面缓存使用的页面回收，在后台应用就会面临当需要新页面时的直接回收导致的高延迟，这种情况不仅影响应用的性能，也可能导致长时间的GC暂停。
要避免内存页面直接回收导致的长时间GC暂停，在Linux的最新内核版本中，可以通过<code>/proc/sys/vm/extra_free_kbytes</code>设置在<code>wmark_min</code>和<code>wmark_low</code>之间增加额外的字节来避免前述的延迟。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sysctl -w vm.extra_free_kbytes<span class="token operator">=</span>1240000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>要获得有关本章节讨论的话题的更多信息，可以参考这个<a href="http://events.linuxfoundation.org/sites/events/files/lcjp13_moriya.pdf" target="_self" rel="noopener noreferrer">幻灯片</a>。</p> <h3 id="_11-5-3-调试内存使用问题和gc暂停"><a href="#_11-5-3-调试内存使用问题和gc暂停" aria-hidden="true" class="header-anchor">#</a> 11.5.3.调试内存使用问题和GC暂停</h3> <p>当需要调试和解决与内存使用或者长时间GC暂停有关的问题时，本章节包括了一些可能有助于解决这些问题的信息。
<strong>内存溢出时获得堆现场</strong>
当JVM抛出<code>OutOfMemoryException</code>并且JVM进程应该重启时，需要给JVM配置增加如下的属性：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath<span class="token operator">=</span>/path/to/heapdump
-XX:OnOutOfMemoryError<span class="token operator">=</span>“kill -9 %p”
-XX:+ExitOnOutOfMemoryError
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>详细的垃圾收集统计</strong>
为了捕获有关垃圾收集的详细信息以及它的性能，可以给JVM配置增加如下的参数：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-XX:+PrintGCDateStamps
-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles<span class="token operator">=</span>10
-XX:GCLogFileSize<span class="token operator">=</span>100M
-Xloggc:/path/to/gc/logs/log.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对于G1，建议设置如下的属性，他提供了很多符合人体工程学的、明确地保持-XX:+PrintGCDetails的详细信息：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-XX:+PrintAdaptiveSizePolicy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>确保修改相应的路径和文件名，并且确保对于每个调用使用一个不同的文件名来避免从多个进程覆盖日志文件。
<strong>FlightRecorder设置</strong>
当需要调试性能或者内存问题，可以依靠Java的Flight Recorder工具，他可以持续地收集底层的详细的运行时信息，来启用事后的事故分析，要开启Flight Recorder，可以使用如下的设定：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>-XX:+UnlockCommercialFeatures
-XX:+FlightRecorder
-XX:+UnlockDiagnosticVMOptions
-XX:+DebugNonSafepoints
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>要开始记录衣蛾特定的Java进程，可以使用下面的命令作为一个示例：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>jcmd <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span> JFR.start name<span class="token operator">=</span><span class="token operator">&lt;</span>recordcing_name<span class="token operator">&gt;</span> duration<span class="token operator">=</span>60s filename<span class="token operator">=</span>/var/recording/recording.jfr settings<span class="token operator">=</span>profile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>关于Java的Flight Recorder的完整信息，可以查看Oracle的官方文档。</p> <h3 id="_11-5-4-文件描述符"><a href="#_11-5-4-文件描述符" aria-hidden="true" class="header-anchor">#</a> 11.5.4.文件描述符</h3> <p><strong>系统级文件描述符限制</strong>
对于大规模的服务端应用，当运行大量的线程访问网格时，可能最终在客户端和服务端节点上打开大量的文件，因此建议增加默认值到默认的最大值。
错误的文件描述符设置会影响应用的稳定性和性能，为此，需要设置<code>系统级文件描述符限制</code>和<code>进程级文件描述符限制</code>，以root用户分别按照如下步骤操作：</p> <ul><li>修改**/etc/sysctl.conf**文件的如下行：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>fs.file-max = 300000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>执行如下命令使改变生效：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> /proc/sys/fs/file-max
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>验证这个设置可以用：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>sysctl fs.file-max
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>进程级文件描述符限制</strong>
默认情况下，Linux操作系统有一个相对较少的文件描述符和最大用户进程（1024）设置。重要的是，使用一个用户账户，它有他自己的最大打开文件描述符（打开文件数）和最大的用户进程配置为一个合适的值。</p> <blockquote><p>对于打开文件描述符，一个合理的最大值是32768。</p></blockquote> <p>使用如下命令来设置打开文件描述符的最大值和用户进程的最大值。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ulimit</span> -n 32768 -u 32768
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者，也可以相应地修改如下文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/etc/security/limits.conf

- soft    nofile          32768
- hard    nofile          32768

/etc/security/limits.d/90-nproc.conf

- soft nproc 32768
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>可以参照<a href="https://easyengine.io/tutorials/linux/increase-open-files-limit/" target="_self" rel="noopener noreferrer">增加打开文件数限制</a>了解更多细节。</p></blockquote> <h2 id="_11-6-严重错误处理"><a href="#_11-6-严重错误处理" aria-hidden="true" class="header-anchor">#</a> 11.6.严重错误处理</h2> <h3 id="_11-6-1-摘要"><a href="#_11-6-1-摘要" aria-hidden="true" class="header-anchor">#</a> 11.6.1.摘要</h3> <p>Ignite是一个健壮且容错的系统，但在现实中，一些无法预知的问题，可能导致节点无法操作，以致影响整个集群的状态，这样的问题可以在运行时进行检测，然后根据预配置的错误处理程序进行处理。</p> <h3 id="_11-6-2-严重故障"><a href="#_11-6-2-严重故障" aria-hidden="true" class="header-anchor">#</a> 11.6.2.严重故障</h3> <p>下面的故障会被视为严重：</p> <ul><li>系统级严重错误（<code>OutOfMemoryError</code>）；</li> <li>意外的系统工作节点终止（未处理的异常）；</li> <li>集群脑裂；</li></ul> <p>系统级严重错误会导致系统无法操作，比如：</p> <ul><li>文件I/O错误：通常<code>IOException</code>由文件读/写抛出，通常在开启持久化时会发生（比如磁盘空间不足或者设备故障），或者在内存模式中，Ignite会使用磁盘来存储部分元数据（比如达到了文件描述符限制或者文件访问被禁止）；</li> <li>内存溢出错误：固化内存分配空间失败（<code>IgniteOutOfMemoryException</code>）；</li> <li>内存溢出错误：集群节点堆溢出（<code>OutOfMemoryError</code>）；</li></ul> <p>下面的系统级功能为核心功能，如果出现终止，节点将无法操作：</p> <ul><li>发现：负责发现事件处理；</li> <li>TCP通信：负责节点间点对点的通信；</li> <li>交换：负责分区映射交换；</li> <li>超时：负责超时处理；</li> <li>检查点线程：负责Ignite持久化的检查点；</li> <li>WAL：负责写入预写日志，内存段的归档和压缩；</li> <li>过期：负责基于TTL的过期；</li> <li>NIO：负责基本的网络功能；</li></ul> <h3 id="_11-6-3-故障处理"><a href="#_11-6-3-故障处理" aria-hidden="true" class="header-anchor">#</a> 11.6.3.故障处理</h3> <p>Ignite检测到严重的错误后，会通过预配置的故障处理程序进行处理，配置方法如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;bean class=&quot;org.apache.ignite.configuration.IgniteConfiguration&quot;&gt;
    &lt;property name=&quot;failureHandler&quot;&gt;
        &lt;bean class=&quot;org.apache.ignite.failure.StopNodeFailureHandler&quot;/&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Ignite支持如下的故障处理器：</p> <table><thead><tr><th>类</th> <th>描述</th> <th>参数</th></tr></thead> <tbody><tr><td><code>NoOpFailureHandler</code></td> <td>忽略任何故障，用于测试和调试环境。</td> <td></td></tr> <tr><td><code>RestartProcessFailureHandler</code></td> <td>只能用于<code>ignite.(sh|bat)</code>的特定实现，进程必须使用<code>Ignition.restart(true)</code>调用进行终止。</td> <td></td></tr> <tr><td><code>StopNodeFailureHandler</code></td> <td>出现严重错误时，使用<code>Ignition.stop(true)</code>或者<code>Ignition.stop(nodeName, true)</code>调用停止节点。</td> <td></td></tr> <tr><td><code>StopNodeOrHaltFailureHandler</code></td> <td>默认处理器，它会试图停止节点，如果无法停止，那么它会试图终止JVM进程。</td> <td><code>boolean tryStop</code>：如果为<code>true</code>，会试图优雅地停止节点，默认为<code>false</code>，<code>long timeout</code>：超时时间，默认为0</td></tr></tbody></table> <h3 id="_11-7-一致性检查"><a href="#_11-7-一致性检查" aria-hidden="true" class="header-anchor">#</a> 11.7.一致性检查</h3> <p>Ignite为快速地进行调试、解决以及监控和一致性有关的问题，提供了若干工具。
比如，如果怀疑一个SQL查询返回了不完整或者错误的结果集，该命令会验证是否真的发生了数据不一致。
另外，一致性检查的命令还可以用于集群健康检查的一部分。
具体可以看<code>4.控制脚本</code>中的相关章节。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间：: </span> <span class="time">12/11/2018, 10:35:46 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/doc/2.6.0/java/DurableMemory.html" class="prev">
          10.固化内存
        </a></span> <span class="next"><a href="/doc/2.6.0/java/PlatformsProtocols.html">
          12.平台和协议
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.5bbff1f1.js" defer></script><script src="/assets/js/28.6290ed01.js" defer></script>
  </body>
</html>
