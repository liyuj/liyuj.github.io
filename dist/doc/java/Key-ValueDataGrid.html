<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3.键-值数据网格 | Apache Ignite中文站</title>
    <meta name="description" content="Ignite内存计算平台的中文文档及相关资料">
    <link rel="shortcut icon" type="image/x-icon" href="https://ignite.apache.org/favicon.ico">
  <script src="https://hm.baidu.com/hm.js?03f40be28ff9a31fd798fd6b9dac0946"></script>
    
    <link rel="preload" href="/assets/css/0.styles.f86987ee.css" as="style"><link rel="preload" href="/assets/js/app.7a7a4d7d.js" as="script"><link rel="preload" href="/assets/js/72.47b0ade0.js" as="script"><link rel="prefetch" href="/assets/js/10.b05dcd55.js"><link rel="prefetch" href="/assets/js/100.05da8ff9.js"><link rel="prefetch" href="/assets/js/101.0d7c2c6e.js"><link rel="prefetch" href="/assets/js/102.148886c5.js"><link rel="prefetch" href="/assets/js/103.58e25424.js"><link rel="prefetch" href="/assets/js/104.7c713e89.js"><link rel="prefetch" href="/assets/js/105.80aec85a.js"><link rel="prefetch" href="/assets/js/11.65b62558.js"><link rel="prefetch" href="/assets/js/12.97a6a0fb.js"><link rel="prefetch" href="/assets/js/13.9bbd062e.js"><link rel="prefetch" href="/assets/js/14.766eb24c.js"><link rel="prefetch" href="/assets/js/15.5673c542.js"><link rel="prefetch" href="/assets/js/16.53623345.js"><link rel="prefetch" href="/assets/js/17.88981c5f.js"><link rel="prefetch" href="/assets/js/18.f93aa156.js"><link rel="prefetch" href="/assets/js/19.5d0e4ca5.js"><link rel="prefetch" href="/assets/js/2.6a0a454c.js"><link rel="prefetch" href="/assets/js/20.afa35a6f.js"><link rel="prefetch" href="/assets/js/21.39bd4a89.js"><link rel="prefetch" href="/assets/js/22.1080b33e.js"><link rel="prefetch" href="/assets/js/23.f9327cd4.js"><link rel="prefetch" href="/assets/js/24.1d559b66.js"><link rel="prefetch" href="/assets/js/25.73843079.js"><link rel="prefetch" href="/assets/js/26.e79c0cb4.js"><link rel="prefetch" href="/assets/js/27.45e0d979.js"><link rel="prefetch" href="/assets/js/28.c48ac073.js"><link rel="prefetch" href="/assets/js/29.d690a3be.js"><link rel="prefetch" href="/assets/js/3.d3c59160.js"><link rel="prefetch" href="/assets/js/30.1999c048.js"><link rel="prefetch" href="/assets/js/31.dcd26861.js"><link rel="prefetch" href="/assets/js/32.abe44cb6.js"><link rel="prefetch" href="/assets/js/33.b8ca7d31.js"><link rel="prefetch" href="/assets/js/34.765bd404.js"><link rel="prefetch" href="/assets/js/35.72b1013f.js"><link rel="prefetch" href="/assets/js/36.8a32296f.js"><link rel="prefetch" href="/assets/js/37.722bf8a8.js"><link rel="prefetch" href="/assets/js/38.0a0cd8b2.js"><link rel="prefetch" href="/assets/js/39.8e2f1385.js"><link rel="prefetch" href="/assets/js/4.a8e7d184.js"><link rel="prefetch" href="/assets/js/40.fb1b4d7e.js"><link rel="prefetch" href="/assets/js/41.ed023c48.js"><link rel="prefetch" href="/assets/js/42.8cd3af9a.js"><link rel="prefetch" href="/assets/js/43.361a87ca.js"><link rel="prefetch" href="/assets/js/44.74993f14.js"><link rel="prefetch" href="/assets/js/45.359861e7.js"><link rel="prefetch" href="/assets/js/46.31709510.js"><link rel="prefetch" href="/assets/js/47.c5918e91.js"><link rel="prefetch" href="/assets/js/48.724602e9.js"><link rel="prefetch" href="/assets/js/49.5c32e4d6.js"><link rel="prefetch" href="/assets/js/5.90fa6a51.js"><link rel="prefetch" href="/assets/js/50.c66a5372.js"><link rel="prefetch" href="/assets/js/51.38400c5a.js"><link rel="prefetch" href="/assets/js/52.1046aa10.js"><link rel="prefetch" href="/assets/js/53.2692b377.js"><link rel="prefetch" href="/assets/js/54.e1bf8ed5.js"><link rel="prefetch" href="/assets/js/55.bcdcf7b7.js"><link rel="prefetch" href="/assets/js/56.597c5a31.js"><link rel="prefetch" href="/assets/js/57.a23bc04a.js"><link rel="prefetch" href="/assets/js/58.06e72825.js"><link rel="prefetch" href="/assets/js/59.c4d76482.js"><link rel="prefetch" href="/assets/js/6.9a2be00d.js"><link rel="prefetch" href="/assets/js/60.7f068634.js"><link rel="prefetch" href="/assets/js/61.df56ca2a.js"><link rel="prefetch" href="/assets/js/62.3a2d47c8.js"><link rel="prefetch" href="/assets/js/63.a1845a55.js"><link rel="prefetch" href="/assets/js/64.6874a387.js"><link rel="prefetch" href="/assets/js/65.8b9bf2bc.js"><link rel="prefetch" href="/assets/js/66.a61e331f.js"><link rel="prefetch" href="/assets/js/67.eee9e498.js"><link rel="prefetch" href="/assets/js/68.d95ef38e.js"><link rel="prefetch" href="/assets/js/69.45ef2d6b.js"><link rel="prefetch" href="/assets/js/7.2fce0861.js"><link rel="prefetch" href="/assets/js/70.8a8a085f.js"><link rel="prefetch" href="/assets/js/71.4de0ace7.js"><link rel="prefetch" href="/assets/js/73.87c3d407.js"><link rel="prefetch" href="/assets/js/74.bd9ec74f.js"><link rel="prefetch" href="/assets/js/75.63259745.js"><link rel="prefetch" href="/assets/js/76.8183dadc.js"><link rel="prefetch" href="/assets/js/77.9402c561.js"><link rel="prefetch" href="/assets/js/78.4fb39ad6.js"><link rel="prefetch" href="/assets/js/79.96275caf.js"><link rel="prefetch" href="/assets/js/8.666e0228.js"><link rel="prefetch" href="/assets/js/80.373e4b34.js"><link rel="prefetch" href="/assets/js/81.30d72c48.js"><link rel="prefetch" href="/assets/js/82.269a2ca4.js"><link rel="prefetch" href="/assets/js/83.0bc05294.js"><link rel="prefetch" href="/assets/js/84.3c0be6d6.js"><link rel="prefetch" href="/assets/js/85.190b76f8.js"><link rel="prefetch" href="/assets/js/86.b632eea1.js"><link rel="prefetch" href="/assets/js/87.adbf292e.js"><link rel="prefetch" href="/assets/js/88.ef8417e7.js"><link rel="prefetch" href="/assets/js/89.a379c311.js"><link rel="prefetch" href="/assets/js/9.eea38aa2.js"><link rel="prefetch" href="/assets/js/90.db166d53.js"><link rel="prefetch" href="/assets/js/91.2b2319d7.js"><link rel="prefetch" href="/assets/js/92.020a68b6.js"><link rel="prefetch" href="/assets/js/93.03edacce.js"><link rel="prefetch" href="/assets/js/94.b6022e1b.js"><link rel="prefetch" href="/assets/js/95.a0108f30.js"><link rel="prefetch" href="/assets/js/96.fef03b06.js"><link rel="prefetch" href="/assets/js/97.659a2075.js"><link rel="prefetch" href="/assets/js/98.b07d3d36.js"><link rel="prefetch" href="/assets/js/99.ee24bc45.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f86987ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Apache Ignite中文站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/java/" class="nav-link router-link-active">Java</a></div><div class="nav-item"><a href="/doc/cpp/" class="nav-link">C++</a></div><div class="nav-item"><a href="/doc/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="/doc/gridgain/" class="nav-link">商业版</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">最新版本</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/java/Key-ValueDataGrid.html" class="nav-link router-link-exact-active router-link-active">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/" class="nav-link">2.6.0</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/java/" class="nav-link router-link-active">Java</a></div><div class="nav-item"><a href="/doc/cpp/" class="nav-link">C++</a></div><div class="nav-item"><a href="/doc/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="/doc/gridgain/" class="nav-link">商业版</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">最新版本</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/java/Key-ValueDataGrid.html" class="nav-link router-link-exact-active router-link-active">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/" class="nav-link">2.6.0</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc/java/" class="sidebar-link">1.基本概念</a></li><li><a href="/doc/java/Clustering.html" class="sidebar-link">2.集群化</a></li><li><a href="/doc/java/Key-ValueDataGrid.html" class="active sidebar-link">3.键-值数据网格</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-1-数据网格" class="sidebar-link">3.1.数据网格</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-超越jcache" class="sidebar-link">3.2.超越JCache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-1-摘要" class="sidebar-link">3.2.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-2-ignitecache" class="sidebar-link">3.2.2.IgniteCache</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-3-基本操作" class="sidebar-link">3.2.3.基本操作</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-4-entryprocessor" class="sidebar-link">3.2.4.EntryProcessor</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-5-异步支持" class="sidebar-link">3.2.5.异步支持</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-2-6-将ignite作为jcache提供者" class="sidebar-link">3.2.6.将Ignite作为JCache提供者</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-缓存配置" class="sidebar-link">3.3.缓存配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-1-分区和复制" class="sidebar-link">3.3.1.分区和复制</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-2-分区丢失策略" class="sidebar-link">3.3.2.分区丢失策略</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-3-主节点和备份副本" class="sidebar-link">3.3.3.主节点和备份副本</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-4-缓存组" class="sidebar-link">3.3.4.缓存组</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-3-5-缓存模板" class="sidebar-link">3.3.5.缓存模板</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-缓存查询" class="sidebar-link">3.4.缓存查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-1-摘要" class="sidebar-link">3.4.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-2-主要的抽象" class="sidebar-link">3.4.2.主要的抽象</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-3-扫描查询" class="sidebar-link">3.4.3.扫描查询</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-4-sql查询" class="sidebar-link">3.4.4.SQL查询</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-5-文本查询" class="sidebar-link">3.4.5.文本查询</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-6-通过注解进行查询的配置" class="sidebar-link">3.4.6.通过注解进行查询的配置</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-4-7-使用queryentity进行查询配置" class="sidebar-link">3.4.7.使用QueryEntity进行查询配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-5-近缓存" class="sidebar-link">3.5.近缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-5-1-配置" class="sidebar-link">3.5.1.配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-6-连续查询" class="sidebar-link">3.6.连续查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-6-1-连续查询" class="sidebar-link">3.6.1.连续查询</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-6-2-事件传递保证" class="sidebar-link">3.6.2.事件传递保证</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-6-3-示例" class="sidebar-link">3.6.3.示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-关系并置" class="sidebar-link">3.7.关系并置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-1-数据与数据的并置" class="sidebar-link">3.7.1.数据与数据的并置</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-2-数据和计算的并置" class="sidebar-link">3.7.2.数据和计算的并置</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-3-ignitecompute和entryprocessor" class="sidebar-link">3.7.3.IgniteCompute和EntryProcessor</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-4-关系函数" class="sidebar-link">3.7.4.关系函数</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-7-5-关系键映射器" class="sidebar-link">3.7.5.关系键映射器</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-8-事务" class="sidebar-link">3.8.事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-8-1-事务" class="sidebar-link">3.8.1.事务</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-8-2-并发模型和隔离级别" class="sidebar-link">3.8.2.并发模型和隔离级别</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-8-3-多版本并发控制" class="sidebar-link">3.8.3.多版本并发控制</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-9-锁" class="sidebar-link">3.9.锁</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-数据再平衡" class="sidebar-link">3.10.数据再平衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-1-摘要" class="sidebar-link">3.10.1.摘要</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-2-再平衡模式" class="sidebar-link">3.10.2.再平衡模式</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-3-再平衡线程池调节" class="sidebar-link">3.10.3.再平衡线程池调节</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-4-再平衡消息限流" class="sidebar-link">3.10.4.再平衡消息限流</a></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-10-5-配置" class="sidebar-link">3.10.5.配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/java/Key-ValueDataGrid.html#_3-11-拓扑验证" class="sidebar-link">3.11.拓扑验证</a></li></ul></li><li><a href="/doc/java/Security.html" class="sidebar-link">4.安全</a></li><li><a href="/doc/java/DataLoadingStreaming.html" class="sidebar-link">5.数据注入和流处理</a></li><li><a href="/doc/java/DistributedDataStructures.html" class="sidebar-link">6.分布式数据结构</a></li><li><a href="/doc/java/ComputeGrid.html" class="sidebar-link">7.计算网格</a></li><li><a href="/doc/java/ServiceGrid.html" class="sidebar-link">8.服务网格</a></li><li><a href="/doc/java/MessagingEvents.html" class="sidebar-link">9.消息和事件</a></li><li><a href="/doc/java/DurableMemory.html" class="sidebar-link">10.固化内存</a></li><li><a href="/doc/java/ProductionReadiness.html" class="sidebar-link">11.生产准备</a></li><li><a href="/doc/java/PlatformsProtocols.html" class="sidebar-link">12.平台和协议</a></li><li><a href="/doc/java/Plugins.html" class="sidebar-link">13.插件</a></li><li><a href="/doc/java/Deployment.html" class="sidebar-link">14.部署</a></li><li><a href="/doc/java/MachineLearning.html" class="sidebar-link">15.机器学习网格</a></li><li><a href="/doc/java/Persistence.html" class="sidebar-link">16.持久化</a></li><li><a href="/doc/java/TestsAndBenchmarking.html" class="sidebar-link">17.基准测试</a></li><li><a href="/doc/java/Metrics.html" class="sidebar-link">18.指标</a></li><li><a href="/doc/java/ThinClients.html" class="sidebar-link">19.瘦客户端</a></li><li><a href="/doc/java/KubernetesDeployment.html" class="sidebar-link">20.Kubernetes部署</a></li><li><a href="/doc/java/DeepLearning.html" class="sidebar-link">21.深度学习</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="_3-键-值数据网格"><a href="#_3-键-值数据网格" aria-hidden="true" class="header-anchor">#</a> 3.键-值数据网格</h1> <h2 id="_3-1-数据网格"><a href="#_3-1-数据网格" aria-hidden="true" class="header-anchor">#</a> 3.1.数据网格</h2> <p>Ignite针对越来越火的水平扩展概念而构建，具有实时按需增加节点的能力。它可以线性扩展至几百个节点，通过数据位置的强语义以及数据关系路由来降低冗余数据噪声。</p> <p>Ignite数据网格是一个<code>基于内存的分布式键值存储</code>，他可以视为一个分布式的分区化哈希，每个集群节点都持有所有数据的一部分，这意味着随着集群节点的增加，就可以缓存更多的数据。</p> <p><img src="https://files.readme.io/58ec82e-data_grid.png" alt></p> <p>与其他键值存储系统不同，Ignite通过可插拔的哈希算法来决定数据的位置，每个客户端都可以通过一个加入一个哈希函数决定一个键属于哪个节点，而不需要任何特定的映射服务器或者name节点。</p> <p>Ignite数据网格支持本地、复制的、分区化的数据集，允许使用标准SQL语法方便地进行跨数据集查询，同时还支持在数据中进行分布式SQL关联。</p> <p>Ignite数据网格轻量快速，是目前在集群中支持数据的事务性和原子性的最快的实现之一。</p> <p><code>数据一致性</code>
只要集群仍然处于活动状态，即使节点崩溃或者网络拓扑发生变化，Ignite都会保证不同集群节点中的数据的一致性。</p> <p><code>JCache (JSR107)</code>
Ignite实现了<code>JCache</code>(JSR107)规范。</p> <h2 id="_3-2-超越jcache"><a href="#_3-2-超越jcache" aria-hidden="true" class="header-anchor">#</a> 3.2.超越JCache</h2> <h3 id="_3-2-1-摘要"><a href="#_3-2-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.2.1.摘要</h3> <p>Ignite是**JCache(JSR107)**规范的一个实现，JCache为数据访问提供了简单易用且功能强大的API。然而规范忽略了任何有关数据分布以及一致性的细节来允许开发商在自己的实现中有足够的自由度。</p> <p>可以通过JCache实现：</p> <ul><li>基本缓存操作</li> <li>ConcurrentMap API</li> <li>并行处理(EntryProcessor)</li> <li>事件和度量</li> <li>可插拔的持久化</li></ul> <p>在JCache之外，Ignite还提供了ACID事务，数据查询的能力(包括SQL)，各种内存模型等。</p> <h3 id="_3-2-2-ignitecache"><a href="#_3-2-2-ignitecache" aria-hidden="true" class="header-anchor">#</a> 3.2.2.IgniteCache</h3> <p><code>IgniteCache</code>接口是Ignite缓存实现的一个入口，提供了保存和获取数据，执行查询，包括SQL，迭代和扫描等等的方法。<code>IgniteCache</code>是基于**JCache(JSR107)**的，所以在非常基本的API上可以减少到<code>javax.cache.Cache</code>接口，然而<code>IgniteCache</code>还提供了JCache规范之外的、有用的功能，比如数据加载，查询，异步模型等。</p> <p>可以从<code>Ignite</code>中直接获得<code>IgniteCache</code>的实例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain instance of cache named &quot;myCache&quot;.</span>
<span class="token comment">// Note that different caches may have different generics.</span>
IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>动态缓存</strong></p> <p>也可以动态地创建缓存的一个实例，这时，Ignite会在所有的符合条件的集群成员中创建和部署该缓存。一个动态缓存启动后，它也会自动的部署到新加入的符合条件的节点上。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CacheConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setAtomicityMode</span><span class="token punctuation">(</span>TRANSACTIONAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create cache with given name, if it does not exist.</span>
IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">getOrCreateCache</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p><strong>XML配置</strong>
在任意的缓存节点上定义的基于Spring的XML配置的所有缓存同时会自动地在所有的集群节点上创建和部署（不需要在每个集群节点上指定同样的配置）。</p></blockquote> <h3 id="_3-2-3-基本操作"><a href="#_3-2-3-基本操作" aria-hidden="true" class="header-anchor">#</a> 3.2.3.基本操作</h3> <p>下面是一些JCache基本原子操作的例子：</p> <p>Put和Get：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">(</span>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;examples/config/example-cache.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// Store keys in cache (values will end up on different cache nodes).</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Got [key=&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>原子操作：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Put-if-absent which returns previous value.</span>
Integer oldVal <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getAndPutIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// Put-if-absent which returns boolean success flag.</span>
<span class="token keyword">boolean</span> success <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// Replace-if-exists operation (opposite of getAndPutIfAbsent), returns previous value.</span>
oldVal <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getAndReplace</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Replace-if-exists operation (opposite of putIfAbsent), returns boolean success flag.</span>
success <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// Replace-if-matches operation.</span>
success <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// Remove-if-matches operation.</span>
success <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p><strong>死锁</strong>
如果批量（比如<code>IgniteCache#putAll</code>, <code>IgniteCache#invokeAll</code>等）操作以并行方式执行，那么键应该是有序的，以避免死锁，建议使用<code>TreeMap</code>而不是<code>HashMap</code>以保证一致性、有序性，注意这个对于<code>原子化</code>和<code>事务化</code>缓存都是一样的。</p></blockquote> <h3 id="_3-2-4-entryprocessor"><a href="#_3-2-4-entryprocessor" aria-hidden="true" class="header-anchor">#</a> 3.2.4.EntryProcessor</h3> <p>当在缓存中执行<code>puts</code>和<code>updates</code>操作时，通常需要在网络中发送完整的状态数据，而<code>EntryProcessor</code>可以直接在主节点上处理数据，只需要传输增量数据而不是全量数据。</p> <p>此外，可以在<code>EntryProcessor</code>中嵌入自定义逻辑，比如，获取之前缓存的数据然后加1。</p> <p>Java8：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Increment cache value 10 times.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  cache<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;mykey&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>entry<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Integer val <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>val <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Java7：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">jcache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Increment cache value 10 times.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  cache<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;mykey&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EntryProcessor</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Void<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> Object <span class="token function">process</span><span class="token punctuation">(</span>MutableEntry<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Integer val <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>val <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> val <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">原子性</p> <p><code>EntryProcessor</code>通过给键加锁以原子性方式执行。</p></div> <h3 id="_3-2-5-异步支持"><a href="#_3-2-5-异步支持" aria-hidden="true" class="header-anchor">#</a> 3.2.5.异步支持</h3> <p>和Ignite中的所有API一样，<code>IgniteCache</code>实现了<code>IgniteAsynchronousSupport</code>接口，因此可以以异步的方式使用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Enable asynchronous mode.</span>
IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> asyncCache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Asynhronously store value in cache.</span>
asyncCache<span class="token punctuation">.</span><span class="token function">getAndPut</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get future for the above invocation.</span>
IgniteFuture<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span> fut <span class="token operator">=</span> asyncCache<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Asynchronously listen for the operation to complete.</span>
fut<span class="token punctuation">.</span><span class="token function">listenAsync</span><span class="token punctuation">(</span>f <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Previous cache value: &quot;</span> <span class="token operator">+</span> f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-6-将ignite作为jcache提供者"><a href="#_3-2-6-将ignite作为jcache提供者" aria-hidden="true" class="header-anchor">#</a> 3.2.6.将Ignite作为JCache提供者</h3> <p>如果创建缓存实例时使用JCache管理器，JCache可以接受一个特定的提供者配置。如果从另一个JCache实现上移植，在不修改已有代码的前提下，就可以利用Ignite提供的分布式缓存的优势。</p> <p>下面是使用JCache管理器时，如何进行Ignite缓存配置的示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Get or create a cache manager.</span>
CacheManager cacheMgr <span class="token operator">=</span> Caching<span class="token punctuation">.</span><span class="token function">getCachingProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is an Ignite configuration object (org.apache.ignite.configuration.CacheConfiguration).</span>
CacheConfiguration<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Specify cache mode and/or any other Ignite-specific configuration properties.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCacheMode</span><span class="token punctuation">(</span>CacheMode<span class="token punctuation">.</span>PARTITIONED<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a cache based on the configuration created above.</span>
Cache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> cacheMgr<span class="token punctuation">.</span><span class="token function">createCache</span><span class="token punctuation">(</span><span class="token string">&quot;aCache&quot;</span><span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Cache operations</span>
Integer key <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
String value <span class="token operator">=</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">;</span>
cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value&quot;<span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>另外，<code>CachingProvider.getCacheManager(..)</code>方法可以接受一个特定的URI，它指向一个Ignite的xml格式配置文件，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Get or create a cache manager.</span>
CacheManager cacheMgr <span class="token operator">=</span> Caching<span class="token punctuation">.</span><span class="token function">getCachingProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheManager</span><span class="token punctuation">(</span>
  Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;path/to/ignite/xml/configuration/file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get a cache defined in the configuration file provided above.</span>
Cache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> cacheMgr<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Cache operations</span>
Integer key <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
String value <span class="token operator">=</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">;</span>
cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value&quot;<span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注意，上述的<code>Cache&lt;K, V&gt;</code>实例只支持<code>javax.cache.Cache</code>类型。</p> <p>要使用Ignite提供的扩展功能，比如SQL、扫描或者连续查询，需要将<code>javax.cache.Cache</code>实例转换成<code>IgniteCache</code>实例，这样的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Get or create a cache manager.</span>
CacheManager cacheMgr <span class="token operator">=</span> Caching<span class="token punctuation">.</span><span class="token function">getCachingProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheManager</span><span class="token punctuation">(</span>
  Paths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;path/to/ignite/xml/configuration/file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get a cache defined in the configuration file provided above.</span>
Cache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> cacheMgr<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Obtain org.apache.ignite.IgniteCache instance.</span>
IgniteCache igniteCache <span class="token operator">=</span> <span class="token punctuation">(</span>IgniteCache<span class="token punctuation">)</span> cache<span class="token punctuation">;</span>

<span class="token comment">// Ignite specific cache operations</span>
<span class="token comment">//......</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_3-3-缓存配置"><a href="#_3-3-缓存配置" aria-hidden="true" class="header-anchor">#</a> 3.3.缓存配置</h2> <p>为了满足应用的需求，Ignite可以对缓存的行为进行各种各样的配置，缓存的属性由<code>CacheConfiguration</code>类定义，该类通过<code>IgniteConfiguration.getCacheConfiguration()</code>方法传递。它定义了在集群中启动一个缓存所有必要的配置参数，在一个集群中，通过不同的名字，可以有多个缓存，Ignite缓存可以配置如下的特性：</p> <p><code>分区和复制</code>：Ignite提供了3种不同的缓存操作模式：<code>分区</code>、<code>复制</code>、<code>本地</code>，每个缓存只能配置一个模式，缓存模式由<code>CacheMode</code>枚举定义。</p> <p><code>分区丢失策略</code>：当某些分区由于与之对应的主或备节点故障而丢失时，可以配置缓存的工作方式。</p> <p><code>主节点和备份副本</code>：在<code>分区</code>模式中，数据的主键归属的节点被称为主节点，对于缓存的数据，可以可选地配置任意数量的备份节点。</p> <p><code>缓存组</code>：可以在单个缓存组中对缓存进行配置，这样可以共享各种内部结构，从而提高拓扑事件的处理能力以及减少总体内存的使用。</p> <p><code>缓存模板</code>：如果希望用和集群中已有缓存相同的配置创建新的缓存时，缓存模板会非常有用，这样不用定义一长串的配置参数就可以创建一个缓存。</p> <h3 id="_3-3-1-分区和复制"><a href="#_3-3-1-分区和复制" aria-hidden="true" class="header-anchor">#</a> 3.3.1.分区和复制</h3> <h4 id="_3-3-1-1-摘要"><a href="#_3-3-1-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.3.1.1.摘要</h4> <p>Ignite提供了三种不同的缓存操作模式，<code>分区</code>、<code>复制</code>和<code>本地</code>。缓存模型可以为每个缓存单独配置，缓存模型是通过<code>CacheMode</code>枚举定义的。</p> <div class="tip custom-block"><p class="custom-block-title">数据分区内部实现</p> <p>如果想了解Ignite分区的内部实现，以及再平衡的工作机制，可以看这个<a href="https://cwiki.apache.org/confluence/display/IGNITE/%28Partition+Map%29+Exchange+-+under+the+hood" target="_self" rel="noopener noreferrer">Wiki页面</a>。</p></div> <h4 id="_3-3-1-2-分区模式"><a href="#_3-3-1-2-分区模式" aria-hidden="true" class="header-anchor">#</a> 3.3.1.2.分区模式</h4> <p><code>分区</code>模式是扩展性最好的分布式缓存模式，这种模式下，所有数据被均等地分布在分区中，所有的分区也被均等地拆分在相关的节点中，实际上就是为缓存的数据创建了一个巨大的内存内分布式存储。这个方式可以在所有节点上只要匹配总可用存储(内存和磁盘)就可以存储尽可能多的数据，因此，可以在集群的所有节点的内存中可以存储TB级的数据。也就是说，只要有足够多的节点，就可以存储足够多的数据。</p> <p>与<code>复制</code>模式不同，它更新是很昂贵的，因为集群内的每个节点都需要更新，而<code>分区</code>模式更新就很廉价，因为对于每个键只需要更新一个主节点（可选择一个或者多个备份节点），然而，读取变得较为昂贵，因为只有特定节点才持有缓存的数据。</p> <p>为了避免额外的数据移动，总是访问恰好缓存有要访问的数据的节点是很重要的，这个方法叫做<em>关系并置</em>，当工作在分区化缓存时强烈建议使用。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>分区化缓存适合于数据量很大而更新频繁的场合。</p></div> <p>下图简单描述了一下一个分区缓存，实际上，键A赋予了运行在JVM1上的节点，B赋予了运行在JVM3上的节点，等等。</p> <p><img src="https://files.readme.io/egtolRvXRdqIWEQWP940_partitioned_cache.png" alt></p> <p>下面的配置章节显示了如何配置缓存模式的例子。</p> <h4 id="_3-3-1-3-复制模式"><a href="#_3-3-1-3-复制模式" aria-hidden="true" class="header-anchor">#</a> 3.3.1.3.复制模式</h4> <p><code>复制</code>模式中，所有数据都被复制到集群内的每个节点，因为每个节点都有效所以这个缓存模式提供了最大的数据可用性。然而，这个模式每个数据更新都要传播到其他所有节点，因而会对性能和可扩展性产生影响。</p> <p>Ignite中，<em>复制缓存</em>的实现类似于<em>分区缓存</em>，每个键都有一个主拷贝而且在集群内的其他节点也会有备份。比如下图中，对于键A，运行于JVM1的节点为主节点，但是同时他还存储了其它数据的拷贝（B、C、D）。</p> <p><img src="https://files.readme.io/0yOEFydERAyggehGP75B_replicated_catche_8_sm.png" alt></p> <p>因为相同的数据被存储在所有的集群节点中，复制缓存的大小受到节点的有效存储（内存和磁盘）的限制。这个模式适用于读缓存比写缓存频繁的多而且数据集较小的场景，如果应用超过80%的时间用于查找缓存，那么就要考虑使用<code>复制</code>缓存模式了。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>复制缓存适用于数据集不大而且更新不频繁的场合。</p></div> <h4 id="_3-3-1-4-本地模式"><a href="#_3-3-1-4-本地模式" aria-hidden="true" class="header-anchor">#</a> 3.3.1.4.本地模式</h4> <p><code>本地</code>模式是最轻量的模式，因为没有数据被分布化到其他节点。他适用于或者数据是只读的，或者需要定期刷新的场景中。当缓存数据失效需要从持久化存储中加载数据时，他也可以工作与<code>通读</code>模式。除了分布化以外，本地缓存包括了分布式缓存的所有功能，比如自动数据回收，过期，磁盘交换，数据查询以及事务。</p> <h4 id="_3-3-1-5-配置"><a href="#_3-3-1-5-配置" aria-hidden="true" class="header-anchor">#</a> 3.3.1.5.配置</h4> <p>缓存可以每个缓存分别配置，通过设置<code>CacheConfiguration</code>的<code>cacheMode</code>属性实现：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  	...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Set a cache name. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Set cache mode. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PARTITIONED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Other cache configurations. --&gt;</span>
            ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setCacheMode</span><span class="token punctuation">(</span>CacheMode<span class="token punctuation">.</span>PARTITIONED<span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_3-3-2-分区丢失策略"><a href="#_3-3-2-分区丢失策略" aria-hidden="true" class="header-anchor">#</a> 3.3.2.分区丢失策略</h3> <p>在整个集群的生命周期中，所有的主节点以及持有这些分区数据的备份节点全部故障，导致分区数据丢失，是有可能的，这会导致部分数据丢失，这个需要根据实际需要进行处理。比如，有些应用认为这是严重的问题，会阻止所有到这个分区的写操作，而其他的应用可能忽略掉这个问题，因为数据可以重新加载。</p> <p><strong>策略</strong></p> <p>Ignite支持如下的<a href="https://ignite.apache.org/releases/latest/javadoc/org/apache/ignite/cache/PartitionLossPolicy.html" target="_self" rel="noopener noreferrer">分区丢失策略</a>：</p> <ul><li><code>READ_ONLY_SAFE</code>：所有缓存/表的写操作都会抛出异常，在线分区的读操作是可以的，丢失分区的读操作会抛出异常；</li> <li><code>READ_ONLY_ALL</code>：包括丢失的分区，所有分区都是可以读的，任意分区的写操作都会抛出异常，从丢失的分区读取数据的结果是未定义的，而且不同的节点返回结果可能不同；</li> <li><code>READ_WRITE_SAFE</code>：在线分区的读写都是可以的，丢失分区的读写操作都会抛出异常；</li> <li><code>READ_WRITE_ALL</code>：所有的读写都会继续进行，就像所有分区都处于一致状态那样（就像没有分区丢失），从丢失分区的读操作是未定义的，并且不同节点返回结果可能不同；</li> <li><code>IGNORE</code>：该模式不会标记丢失的分区为丢失状态，假定没有发生分区丢失，并且立即清除分区丢失状态。从技术上来说，分区不会被加入<code>lostPartitions</code>列表，这是与<code>READ_WRITE_ALL</code>模式的主要区别，<code>IGNORE</code>模式为默认模式。</li></ul> <p>分区丢失策略是在缓存层级进行配置的：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  	...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Set a cache name. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Set partition loss policy. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>partitionLossPolicy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>READ_ONLY_SAFE<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Other cache configurations. --&gt;</span>
            ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>acheConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;cacheName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set partition loss policy to READ_ONLY_SAFE</span>
cfg<span class="token punctuation">.</span><span class="token function">setPartitionLossPolicy</span><span class="token punctuation">(</span>PartitionLossPolicy<span class="token punctuation">.</span>READ_ONLY_SAFE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>分区丢失事件处理</strong></p> <p>Ignite提供了一些功能来处理分区丢失事件。</p> <p>首先，确保订阅了<code>EVT_CACHE_REBALANCE_PART_DATA_LOST</code>事件，这样在分区丢失时会收到通知。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Local listener that listenes to local events.</span>
IgnitePredicate<span class="token generics function"><span class="token punctuation">&lt;</span>CacheEvent<span class="token punctuation">&gt;</span></span> locLsnr <span class="token operator">=</span> evt <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Received event [evt=&quot;</span> <span class="token operator">+</span> evt<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Continue listening.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe to specified cache events occuring on local node.</span>
ignite<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localListen</span><span class="token punctuation">(</span>locLsnr<span class="token punctuation">,</span>
  EventType<span class="token punctuation">.</span>EVT_CACHE_REBALANCE_PART_DATA_LOST<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>下一步，如果业务逻辑希望某时获取所有的丢失分区，那么要使用<code>IgniteCache.lostPartitions()</code>方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Cache reference</span>
IgniteCache cache<span class="token punctuation">;</span>

<span class="token comment">// Getting a list of the lost partitions.</span>
Collection<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">&gt;</span></span> lostPartitions <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">lostPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Performing some actions upon the partitions.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后，如果确认所有的丢失分区都已经恢复（比如，之前所有的主备节点故障之后，存储在Ignite持久化中的该分区数据，重新导入），那么需要使用<code>Ignite.resetLostPartitions(...)</code>方法清除<code>lost</code>标志，以使所有分区恢复正常：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Clear partition's lost state and moves caches to a normal mode.</span>
ignite<span class="token punctuation">.</span><span class="token function">resetLostPartitions</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;cache1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cache2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// check that there are no more lost partitions</span>
<span class="token keyword">boolean</span> lostPartiion <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">lostPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-3-3-主节点和备份副本"><a href="#_3-3-3-主节点和备份副本" aria-hidden="true" class="header-anchor">#</a> 3.3.3.主节点和备份副本</h3> <h4 id="_3-3-3-1-摘要"><a href="#_3-3-3-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.3.3.1.摘要</h4> <p>在<code>分区</code>模式下，数据的主键归属的节点叫做这些主键的主节点，对于缓存的数据，也可以可选地配置任意多个备份节点。如果副本数量大于0，那么Ignite会自动地为每个独立的键赋予备份节点，比如，如果副本数量为1，那么数据网格内缓存的每个键都会有2个备份，一主一备。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>因为性能原因备份默认是被关闭的。</p></div> <h4 id="_3-3-3-2-配置备份"><a href="#_3-3-3-2-配置备份" aria-hidden="true" class="header-anchor">#</a> 3.3.3.2.配置备份</h4> <p>备份可以通过<code>CacheConfiguration</code>的<code>backups</code>属性进行配置，如下：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  	...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Set a cache name. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Set cache mode. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PARTITIONED<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token comment">&lt;!-- Number of backup nodes. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>backups<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;cacheName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setCacheMode</span><span class="token punctuation">(</span>CacheMode<span class="token punctuation">.</span>PARTITIONED<span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setBackups</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_3-3-3-3-同步和异步备份"><a href="#_3-3-3-3-同步和异步备份" aria-hidden="true" class="header-anchor">#</a> 3.3.3.3.同步和异步备份</h4> <p><code>CacheWriteSynchronizationMode</code>枚举可以用来配置主节点和备份部分的同步和异步更新。同步写模式告诉Ignite在完成写或者提交之前客户端节点是否要等待来自远程节点的响应。</p> <p>同步写模式可以设置为下面的三种之一：</p> <table><thead><tr><th>同步写模式</th> <th>描述</th></tr></thead> <tbody><tr><td><code>FULL_SYNC</code></td> <td>客户端节点要等待所有相关远程节点的写入或者提交完成（主和备）。</td></tr> <tr><td><code>FULL_ASYNC</code></td> <td>这种情况下，客户端不需要等待来自相关节点的响应。这时远程节点会在获得他们的状态在任意的缓存写操作完成或者<code>Transaction.commit()</code>方法调用完成之后进行小幅更新。</td></tr> <tr><td><code>PRIMARY_SYNC</code></td> <td>这是<strong>默认</strong>模式，客户端节点会等待主节点的写或者提交完成，但不会等待备份节点的更新完成。</td></tr></tbody></table> <div class="tip custom-block"><p class="custom-block-title">缓存数据一致性</p> <p>注意不管那种写同步模式，在使用事务时缓存数据都会保持在所有相关节点上的完整一致性。</p></div> <p>写同步模式可以通过<code>CacheConfiguration</code>的<code>writeSynchronizationMode</code>属性进行配置，像下面这样：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   ...
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- Set a cache name. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheName<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token comment">&lt;!-- Set write synchronization mode. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>writeSynchronizationMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>FULL_SYNC<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 
          ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;cacheName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setWriteSynchronizationMode</span><span class="token punctuation">(</span>CacheWriteSynchronizationMode<span class="token punctuation">.</span>FULL_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-3-4-缓存组"><a href="#_3-3-4-缓存组" aria-hidden="true" class="header-anchor">#</a> 3.3.4.缓存组</h3> <p>对于部署在集群中的一个缓存来说，总有一个开销——即缓存被拆分为分区，其状态必须在每个集群节点上进行跟踪以满足系统需要。</p> <p>比如，假定一个集群节点维护了一个叫做分区映射的数据结构，它驻留在Java堆中，并且消耗了部分空间，当拓扑变更（新节点加入集群或者某个节点离开）事件触发时，分区映射会在集群节点间进行交换，并且如果Ignite的持久化开启，那么对于每个分区来说，都会在磁盘上打开一个文件进行读写，因此，如果有更多的缓存和分区：</p> <ul><li>分区映射就会占用更多的Java堆，每个缓存都有自己的分区映射；</li> <li>新节点加入集群就会花费更多的时间；</li> <li>节点离开集群也会因为再平衡花费更多的时间；</li> <li>打开中的分区文件就会更多从而影响检查点的性能；</li></ul> <p>通常，如果只有几十甚至几百个缓存时，不用担心这些问题，但是如果增长到上千时，这类问题就会凸显。</p> <p>要避免这个情况，可以考虑使用<strong>缓存组</strong>，一个组内的缓存会共享各种内部数据结构比如上面提到的分区映射，这样，会提高拓扑事件处理的效率以及降低整体的内存使用量。注意，从API上来看，缓存是不是组的一部分并没有什么区别。</p> <p>通过配置<code>CacheConfiguration</code>的<code>groupName</code>属性可以创建一个缓存组，示例如下：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- Partitioned cache for Persons data. --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Person<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>backups<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                    
        <span class="token comment">&lt;!-- Group the cache belongs to. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>groupName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>group1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

      <span class="token comment">&lt;!-- Partitioned cache for Organizations data. --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Organization<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>backups<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                    
        <span class="token comment">&lt;!-- Group the cache belongs to. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>groupName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>group1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Defining cluster configuration.</span>
IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Defining Person cache configuration.</span>
CacheConfiguration personCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;Person&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
personCfg<span class="token punctuation">.</span><span class="token function">setBackups</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Group the cache belongs to.</span>
personCfg<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span><span class="token string">&quot;group1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Defining Organization cache configuration.</span>
CacheConfiguration orgCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;Organization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

orgCfg<span class="token punctuation">.</span><span class="token function">setBackups</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Group the cache belongs to.</span>
orgCfg<span class="token punctuation">.</span><span class="token function">setGroupName</span><span class="token punctuation">(</span><span class="token string">&quot;group1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>personCfg<span class="token punctuation">,</span> orgCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">//Starting the node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>从上例来看，<code>Person</code>和<code>Organization</code>都属于<code>group1</code>。</p> <div class="tip custom-block"><p class="custom-block-title">键值对如何区分？</p> <p>将缓存分配给一个缓存组之后，它的数据就会被存储于共享分区的内部数据结构中，插入缓存中的每个键都会附加该键所属的缓存的唯一ID，这个ID是从缓存名派生的。这些都是透明的，从而使得Ignite可以混合存储于共享分区、B+树以及分区文件中的缓存数据。</p></div> <p>将缓存分组的原因很简单，如果决定对1000个缓存进行分组，那么存储分区数据、分区映射以及打开的Ignite持久化分区文件数量都会变为原来的千分之一。</p> <div class="warning custom-block"><p class="custom-block-title">分组适用于所有场景么？</p> <p>虽然有这么多的好处，但是它可能影响读操作和索引的性能，这是由于所有的数据和索引都混合在一个共享的数据结构（分区映射、B+树）中，查询的时间变长导致的。<br>
因此，如果集群中有几十个节点上百个缓存，可以考虑使用缓存组，这样可以降低内部结构的Java堆使用量，但同时会降低检查点的性能，节点接入集群的速度也会下降。</p></div> <h3 id="_3-3-5-缓存模板"><a href="#_3-3-5-缓存模板" aria-hidden="true" class="header-anchor">#</a> 3.3.5.缓存模板</h3> <h4 id="_3-3-5-1-摘要"><a href="#_3-3-5-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.3.5.1.摘要</h4> <p>模板是<code>CacheConfiguration</code>类的实例，可以通过<code>Ignite.addCacheConfiguration(...)</code>方法在集群中注册。基本上来说，可以使用某个名称创建一个<code>CacheConfiguration</code>并将其注册。这样做之后就可以将此配置用作模板，其中模板的名称与注册的配置的名称相对应。</p> <p>如果希望用和集群中已有缓存相同的配置创建新的缓存时，缓存模板会非常有用，这样不用定义一长串的配置参数就可以创建一个缓存。目前，Ignite中的模板支持<a href="/doc/sql/SQLReference.html#_2-2-3-create-table">CREATE TABLE</a>和<a href="/doc/java/PlatformsProtocols.html#_12-2-rest-api">REST</a>命令。如果使用了模板名，Ignite就会用模板中的所有配置来实例化新缓存。</p> <h4 id="_3-3-5-2-示例"><a href="#_3-3-5-2-示例" aria-hidden="true" class="header-anchor">#</a> 3.3.5.2.示例</h4> <p>下面会创建一个缓存模板并且在集群中注册:</p> <p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CacheConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;myCacheTemplate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Set required cache configuration properties.</span>
cfg<span class="token punctuation">.</span><span class="token function">setBackups</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setCacheMode</span><span class="token punctuation">(</span>CacheMode<span class="token punctuation">.</span>PARTITIONED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">// Register the cache template in Ignite.</span>
ignite<span class="token punctuation">.</span><span class="token function">addCacheConfiguration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>XML:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span> 
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cache-template-bean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">abstract</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myCacheTemplate<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span> 
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>PARTITIONED<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>backups<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span> 
          <span class="token comment">&lt;!-- Other cache configurations --&gt;</span>
          ...
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span> 
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>就像上面的代码片段，缓存模板在集群中注册之后，就可以使用这个模板名创建其它配置相同的缓存。</p> <p><strong>使用REST命令</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://host:port/ignite?cmd=getorcreate&amp;cacheName=mynewCache&amp;templateName=myCacheTemplate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个命令中，要把<code>host</code>和<code>port</code>换成实际值。</p> <p><strong>使用CREATE TABLE命令</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> Person <span class="token punctuation">(</span>
  id <span class="token keyword">int</span><span class="token punctuation">,</span>
  city_id <span class="token keyword">int</span><span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">,</span>
  age <span class="token keyword">int</span><span class="token punctuation">,</span> 
  company <span class="token keyword">varchar</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> city_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token string">&quot;template=myCacheTemplate, key_type=PersonKey, value_type=MyPerson&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_3-4-缓存查询"><a href="#_3-4-缓存查询" aria-hidden="true" class="header-anchor">#</a> 3.4.缓存查询</h2> <h3 id="_3-4-1-摘要"><a href="#_3-4-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.4.1.摘要</h3> <p>Ignite提供了非常优雅的查询API，支持基于谓词的扫描查询、SQL查询（ANSI-99兼容）、文本查询。对于SQL查询，Ignite提供了内存索引，因此所有的数据检索都是非常快的。</p> <p>Ignite也通过<code>IndexingSpi</code>和<code>SpiQuery</code>类提供对自定义索引的支持。</p> <h3 id="_3-4-2-主要的抽象"><a href="#_3-4-2-主要的抽象" aria-hidden="true" class="header-anchor">#</a> 3.4.2.主要的抽象</h3> <p><code>IgniteCache</code>有若干个查询方法，这些方法可以获得一些<code>Query</code>的子类以及返回<code>QueryCursor</code>。</p> <p><strong>查询</strong></p> <p><code>Query</code>抽象类表示一个在分布式缓存上执行的抽象分页查询。可以通过<code>Query.setPageSize(...)</code>方法设置返回游标的每页大小（默认值是<code>1024</code>）。</p> <p><strong>查询游标</strong></p> <p><code>QueryCursor</code>表示查询的结果集，可以透明地进行一页一页地迭代。每当迭代到每页的最后时，会自动地在后台请求下一页的数据，当不需要分页时，可以使用<code>QueryCursor.getAll()</code>方法，他会获得整个查询结果集然后存储在集合里。</p> <div class="tip custom-block"><p class="custom-block-title">关闭游标</p> <p>如果调用了<code>QueryCursor.getAll()</code>方法，游标会自动关闭。如果通过for循环迭代一个游标或者显式地获得<code>Iterator</code>，必须显式地关闭或者使用<code>AutoCloseable</code>语法。</p></div> <h3 id="_3-4-3-扫描查询"><a href="#_3-4-3-扫描查询" aria-hidden="true" class="header-anchor">#</a> 3.4.3.扫描查询</h3> <p>扫描查询可以通过用户定义的谓词以分布式的形式进行缓存的查询。</p> <p>Java8：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Find only persons earning more than 1,000.</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span>QueryCursor cursor <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span><span class="token function">getSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Person p <span class="token operator">:</span> cursor<span class="token punctuation">)</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Java7:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Find only persons earning more than 1,000.</span>
IgniteBiPredicate<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteBiPredicate</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>Long key<span class="token punctuation">,</span> Perons p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">getSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">(</span>QueryCursor cursor <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Person p <span class="token operator">:</span> cursor<span class="token punctuation">)</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>扫描查询还支持可选的转换器闭包，它可以在服务端节点在将数据发送到客户端之前对其进行转换。这个很有用，比如，当只是希望从一个大的对象获取少量字段时，这样可以最小化网络的数据传输量，下面的示例显示了如何只获取对象的键，而不发送对象的值。</p> <p>Java8:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get only keys for persons earning more than 1,000.</span>
List<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>k<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span><span class="token function">getSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Remote filter.</span>
    Cache<span class="token punctuation">.</span>Entry<span class="token operator">:</span><span class="token operator">:</span>getKey              <span class="token comment">// Transformer.</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Java7：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get only keys for persons earning more than 1,000.</span>
List<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    <span class="token comment">// Remote filter.</span>
    <span class="token keyword">new</span> <span class="token class-name">IgniteBiPredicate</span><span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>Long k<span class="token punctuation">,</span> Person p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">getSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// Transformer.</span>
    <span class="token keyword">new</span> <span class="token class-name">IgniteClosure</span><span class="token operator">&lt;</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> Long<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Long <span class="token function">apply</span><span class="token punctuation">(</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_3-4-4-sql查询"><a href="#_3-4-4-sql查询" aria-hidden="true" class="header-anchor">#</a> 3.4.4.SQL查询</h3> <p>Ignite的SQL查询请参照SQL网格的相关章节。</p> <h3 id="_3-4-5-文本查询"><a href="#_3-4-5-文本查询" aria-hidden="true" class="header-anchor">#</a> 3.4.5.文本查询</h3> <p>Ignite也支持通过Lucene索引实现的基于文本的查询。</p> <p>文本查询：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Query for all people with &quot;Master Degree&quot; in their resumes.</span>
TextQuery txt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextQuery</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;Master Degree&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">(</span>QueryCursor<span class="token operator">&lt;</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> masters <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> cursor<span class="token punctuation">)</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-4-6-通过注解进行查询的配置"><a href="#_3-4-6-通过注解进行查询的配置" aria-hidden="true" class="header-anchor">#</a> 3.4.6.通过注解进行查询的配置</h3> <p>索引可以在代码中通过<code>@QuerySqlField</code>注解进行配置，来告诉Ignite那个类型要被索引，键值对可以传入<code>CacheConfiguration.setIndexedTypes(MyKey.class, MyValue.class)</code>方法。注意这个方法只会接受成对的类型，一个是键类型，一个是值类型。</p> <p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
  <span class="token comment">/** Person ID (indexed). */</span>
  <span class="token annotation punctuation">@QuerySqlField</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>

  <span class="token comment">/** Organization ID (indexed). */</span>
  <span class="token annotation punctuation">@QuerySqlField</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> orgId<span class="token punctuation">;</span>

  <span class="token comment">/** First name (not-indexed). */</span>
  <span class="token annotation punctuation">@QuerySqlField</span>
  <span class="token keyword">private</span> String firstName<span class="token punctuation">;</span>

  <span class="token comment">/** Last name (not indexed). */</span>
  <span class="token annotation punctuation">@QuerySqlField</span>
  <span class="token keyword">private</span> String lastName<span class="token punctuation">;</span>

  <span class="token comment">/** Resume text (create LUCENE-based TEXT index for this field). */</span>
  <span class="token annotation punctuation">@QueryTextField</span>
  <span class="token keyword">private</span> String resume<span class="token punctuation">;</span>

  <span class="token comment">/** Salary (indexed). */</span>
  <span class="token annotation punctuation">@QuerySqlField</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">double</span> salary<span class="token punctuation">;</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_3-4-7-使用queryentity进行查询配置"><a href="#_3-4-7-使用queryentity进行查询配置" aria-hidden="true" class="header-anchor">#</a> 3.4.7.使用QueryEntity进行查询配置</h3> <p>索引和字段也可以通过<code>org.apache.ignite.cache.QueryEntity</code>进行配置，他便于通过Spring使用XML进行配置，详细信息可以参照JavaDoc。他与<code>@QuerySqlField</code>注解是等价的，因为在内部类注解会被转换成查询实体。</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mycache<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- Configure query entities --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>queryEntities<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.QueryEntity<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>keyType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>valueType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.examples.Person<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>fields<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>orgId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.Long<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>firstName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.String<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>lastName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.String<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>resume<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.String<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>salary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>java.lang.Double<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>indexes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.QueryIndex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.QueryIndex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>orgId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.QueryIndex<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>salary<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration<span class="token generics function"><span class="token punctuation">&lt;</span>Long<span class="token punctuation">,</span> Person<span class="token punctuation">&gt;</span></span> cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
cacheCfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting up query entity.</span>
QueryEntity queryEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queryEntity<span class="token punctuation">.</span><span class="token function">setKeyType</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queryEntity<span class="token punctuation">.</span><span class="token function">setValueType</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listing query fields.</span>
LinkedHashMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> fields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;orgId&quot;</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;lastName&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;resume&quot;</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fields<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">,</span> Double<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queryEntity<span class="token punctuation">.</span><span class="token function">setFields</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listing indexes.</span>
Collection<span class="token generics function"><span class="token punctuation">&lt;</span>QueryIndex<span class="token punctuation">&gt;</span></span> indexes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

indexes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryIndex</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
indexes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryIndex</span><span class="token punctuation">(</span><span class="token string">&quot;orgId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
indexes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryIndex</span><span class="token punctuation">(</span><span class="token string">&quot;salary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queryEntity<span class="token punctuation">.</span><span class="token function">setIndexes</span><span class="token punctuation">(</span>indexes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
cacheCfg<span class="token punctuation">.</span><span class="token function">setQueryEntities</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>queryEntity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="_3-5-近缓存"><a href="#_3-5-近缓存" aria-hidden="true" class="header-anchor">#</a> 3.5.近缓存</h2> <p>分区化的缓存也可以通过<code>近</code>缓存前移，他是一个较小的本地缓存，可以用来存储最近或者最频繁访问的数据。和分区缓存一样，可以控制近缓存的大小以及回收策略。</p> <p>近缓存可以通过在<code>Ignite.createNearCache(NearConfiguration)</code>中传入<code>NearConfiguration</code>或者通过调用<code>Ignite.getOrCreateNearCache(NearConfiguration)</code>方法在<em>客户端节点</em>直接创建。使用<code>Ignite.getOrCreateCache(CacheConfiguration, NearCacheConfiguration)</code>，可以在动态启动一个分布式缓存的同时为其创建一个近缓存。</p> <p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Create near-cache configuration for &quot;myCache&quot;.</span>
NearCacheConfiguration<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> nearCfg <span class="token operator">=</span> 
    <span class="token keyword">new</span> <span class="token class-name">NearCacheConfiguration</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use LRU eviction policy to automatically evict entries</span>
<span class="token comment">// from near-cache, whenever it reaches 100_000 in size.</span>
nearCfg<span class="token punctuation">.</span><span class="token function">setNearEvictionPolicy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LruEvictionPolicy</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">100</span>_000<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a distributed cache on server nodes and </span>
<span class="token comment">// a near cache on the local node, named &quot;myCache&quot;.</span>
IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">getOrCreateCache</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nearCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>XML:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myCache<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>nearConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.NearCacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>nearEvictionPolicy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.eviction.lru.LruEvictionPolicy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>100000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在大多数情况下，只要用了Ignite的关系并置，近缓存就不应该用了。如果计算与相应的分区化缓存节点是并置的，那么近缓存也不需要了，因为所有数据只在分区缓存的本地才有效。但是，有时没有必要将计算任务发送给远端节点，比如近缓存可以显著提升可扩展性或者提升应用的整体性能的场景。</p> <div class="tip custom-block"><p class="custom-block-title">事务</p> <p>近缓存是完全事务性的，当服务端的数据发生改变时会自动地获得更新或者失效。</p></div> <div class="tip custom-block"><p class="custom-block-title">服务端节点的近缓存</p> <p>每当以一个非托管的方式从服务器端的<code>分区</code>缓存中访问数据时，都需要通过<code>CacheConfiguration.setNearConfiguration(...)</code>方法在服务端节点上配置近缓存。</p></div> <h3 id="_3-5-1-配置"><a href="#_3-5-1-配置" aria-hidden="true" class="header-anchor">#</a> 3.5.1.配置</h3> <p><code>CacheConfiguration</code>中与近缓存有关的大部分参数都会继承于服务端的配置，比如，如果服务端缓存有一个<code>ExpiryPolicy</code>，近缓存中的条目也会基于同样的策略。</p> <p>下表中列出的参数是不会从服务端配置中继承的，是通过<code>NearCacheConfiguration</code>对象单独提供的：</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setNearEvictionPolicy(CacheEvictionPolicy)</code></td> <td>近缓存回收策略</td> <td>无</td></tr> <tr><td><code>setNearStartSize(int)</code></td> <td>缓存初始大小</td> <td>375,000</td></tr></tbody></table> <h2 id="_3-6-连续查询"><a href="#_3-6-连续查询" aria-hidden="true" class="header-anchor">#</a> 3.6.连续查询</h2> <h3 id="_3-6-1-连续查询"><a href="#_3-6-1-连续查询" aria-hidden="true" class="header-anchor">#</a> 3.6.1.连续查询</h3> <p>连续查询可以监听缓存中数据的变更。连续查询一旦启动，如果有，就会收到符合查询条件的数据变化的通知。</p> <p>连续查询的功能是通过<code>ContinuousQuery</code>类体现的，下面会详细描述。</p> <div class="danger custom-block"><p class="custom-block-title">连续查询和MVCC</p> <p>对于开启了MVCC的缓存，连续查询有一些<a href="/doc/java/Key-ValueDataGrid.html#_3-8-2-5-限制">功能限制</a>。</p></div> <h4 id="_3-6-1-1-初始化查询"><a href="#_3-6-1-1-初始化查询" aria-hidden="true" class="header-anchor">#</a> 3.6.1.1.初始化查询</h4> <p>当要执行连续查询时，在将连续查询注册在集群中以及开始接收更新之前，可以有选择地指定一个初始化查询。</p> <p>初始化查询可以通过<code>ContinuousQuery.setInitialQuery(Query)</code>方法进行设置，并且可以是任意查询类型，包括扫描查询，SQL查询和文本查询。</p> <h4 id="_3-6-1-2-远程过滤器"><a href="#_3-6-1-2-远程过滤器" aria-hidden="true" class="header-anchor">#</a> 3.6.1.2.远程过滤器</h4> <p>这个过滤器在给定键对应的主和备节点上执行，然后评估更新是否需要作为一个事件传播给该查询的本地监听器。</p> <p>如果过滤器返回<code>true</code>，那么本地监听器就会收到通知，否则事件会被忽略。产生更新的特定主和备节点，会在主/备节点以及应用端执行的本地监听器之间，减少不必要的网络流量。</p> <p>远程过滤器可以通过<code>ContinuousQuery.setRemoteFilter(CacheEntryEventFilter&lt;K, V&gt;)</code>方法进行设置。</p> <h4 id="_3-6-1-3-本地监听器"><a href="#_3-6-1-3-本地监听器" aria-hidden="true" class="header-anchor">#</a> 3.6.1.3.本地监听器</h4> <p>当缓存被修改时（一个条目被插入、更新或者删除），更新对应的事件就会发送给连续查询的本地监听器，之后应用就可以做出对应的反应。</p> <p>当事件通过了远程过滤器，他们就会被发送给客户端，通知哪里的本地监听器。</p> <p>本地监听器是通过<code>ContinuousQuery.setLocalListener(CacheEntryUpdatedListener&lt;K, V&gt;)</code>方法设置的。</p> <p>Java8:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;mycache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Creating a continuous query.</span>
ContinuousQuery<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> qry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContinuousQuery</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting an optional initial query. </span>
<span class="token comment">// The query will return entries for the keys greater than 10.</span>
qry<span class="token punctuation">.</span><span class="token function">setInitialQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> k <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Local listener that is called locally when an update notification is received.</span>
qry<span class="token punctuation">.</span><span class="token function">setLocalListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>evts<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> 
	evts<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This filter will be evaluated remotely on all nodes.</span>
<span class="token comment">// Entry that pass this filter will be sent to the local listener.</span>
qry<span class="token punctuation">.</span><span class="token function">setRemoteFilter</span><span class="token punctuation">(</span>e <span class="token operator">-</span><span class="token operator">&gt;</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Executing the query.</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span>QueryCursor<span class="token operator">&lt;</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> cur <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>qry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Iterating over existing data stored in cache.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> cur<span class="token punctuation">)</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Adding a few more cache entries.</span>
  <span class="token comment">// As a result, the local listener above will be called.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>Java7:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// // Creating a continuous query.</span>
ContinuousQuery<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> qry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContinuousQuery</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting an optional initial query. </span>
<span class="token comment">// The query will return entries for the keys greater than 10.</span>
qry<span class="token punctuation">.</span><span class="token function">setInitialQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ScanQuery</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">IgniteBiPredicate</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>Integer key<span class="token punctuation">,</span> String val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Local listener that is called locally when an update notification is received.</span>
qry<span class="token punctuation">.</span><span class="token function">setLocalListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheEntryUpdatedListener</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onUpdated</span><span class="token punctuation">(</span>Iterable<span class="token operator">&lt;</span>CacheEntryEvent<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token operator">&gt;&gt;</span> evts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>CacheEntryEvent<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> evts<span class="token punctuation">)</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This filter will be evaluated remotely on all nodes.</span>
<span class="token comment">// Entry that pass this filter will be sent to the local listener.</span>
qry<span class="token punctuation">.</span><span class="token function">setRemoteFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheEntryEventFilter</span><span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>CacheEntryEvent<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute query.</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span>QueryCursor<span class="token operator">&lt;</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> cur <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>qry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Iterating over existing data stored in cache.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span>Entry<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> cur<span class="token punctuation">)</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;key=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Adding a few more cache entries.</span>
  <span class="token comment">// As a result, the local listener above will be called.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> keyCnt<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyCnt <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="_3-6-1-4-远程转换器"><a href="#_3-6-1-4-远程转换器" aria-hidden="true" class="header-anchor">#</a> 3.6.1.4.远程转换器</h4> <p>连续查询默认会将整个更新后的对象发送给应用端的监听器，这会导致网络的过度使用，如果传输的对象很大，更是如此。另外，应用通常更希望得到所有字段的子集，而不是整个对象。</p> <p>为了解决这个问题，可以使用<code>ContinuousQueryWithTransformer</code>，它可以为每个更新的对象配置一个自定义的转换器工厂，它会在远程节点执行，然后只将转换后的结果发给监听器。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Create a new continuous query with the transformer.</span>
ContinuousQueryWithTransformer qry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContinuousQueryWithTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Factory to create transformers.</span>
Factory factory <span class="token operator">=</span> FactoryBuilder<span class="token punctuation">.</span><span class="token function">factoryOf</span><span class="token punctuation">(</span>
    <span class="token comment">// Return one field of a complex object.</span>
    <span class="token comment">// Only this field will be sent over to a local listener over the network.</span>
    <span class="token punctuation">(</span>IgniteClosure<span class="token generics function"><span class="token punctuation">&lt;</span>CacheEntryEvent<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
        event <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Organization<span class="token punctuation">)</span>event<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

qry<span class="token punctuation">.</span><span class="token function">setRemoteTransformerFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listener that will receive transformed data.</span>
qry<span class="token punctuation">.</span><span class="token function">setLocalListener</span><span class="token punctuation">(</span>names <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Object name <span class="token operator">:</span> names<span class="token punctuation">)</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;New organization name: &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>ContinuousQueryWithTransformer</code>的使用示例，<a href="https://github.com/apache/ignite/blob/master/examples/src/main/java/org/apache/ignite/examples/datagrid/CacheContinuousQueryWithTransformerExample.java" target="_self" rel="noopener noreferrer">GitHub</a>上有。</p> <h3 id="_3-6-2-事件传递保证"><a href="#_3-6-2-事件传递保证" aria-hidden="true" class="header-anchor">#</a> 3.6.2.事件传递保证</h3> <p>连续查询的实现会明确地保证，一个事件只会传递给客户端的本地监听器一次。</p> <p>因为除了主节点，在每个备份节点维护一个更新队列是可行的。如果主节点故障或者由于某些其它原因拓扑发生了改变，之后每个备份节点会刷新它的内部队列的内容给客户端，确保事件都会被传递给客户端的本地监听器。</p> <p>为了避免重复通知，当所有的备份节点都刷新它们的队列给客户端时，Ignite会为每个分区维护一个更新计数器。当某个分区的一个条目已经更新，这个分区的计数器在主节点和备份节点都会增加。这个计数器的值会和事件通知一起发给客户端，该客户端还维护该映射的副本。如果客户端收到了一个更新，对应的计数小于它的本地映射，这个更新会被视为重复的然后被忽略。</p> <p>一旦客户端确认一个事件已经收到，主节点和备份节点会从它们的备份队列中删除该事件的记录。</p> <h3 id="_3-6-3-示例"><a href="#_3-6-3-示例" aria-hidden="true" class="header-anchor">#</a> 3.6.3.示例</h3> <p>关于描述连续查询如何使用的完整示例，已经随着Ignite的发行版一起发布，名为<code>CacheContinuousQueryExample</code>，相关的代码在<a href="https://github.com/apache/ignite/blob/master/examples/src/main/java/org/apache/ignite/examples/datagrid/CacheContinuousQueryExample.java" target="_self" rel="noopener noreferrer">GitHub</a>上也有。</p> <h2 id="_3-7-关系并置"><a href="#_3-7-关系并置" aria-hidden="true" class="header-anchor">#</a> 3.7.关系并置</h2> <p>数据和计算以及数据和数据的并置可以显著地提升应用的性能和可扩展性。</p> <h3 id="_3-7-1-数据与数据的并置"><a href="#_3-7-1-数据与数据的并置" aria-hidden="true" class="header-anchor">#</a> 3.7.1.数据与数据的并置</h3> <p>在许多情况下，如果不同的缓存键被同时访问的话那么将他们并置在一起是很有利的。通常来说业务逻辑需要访问不止一个的缓存键，通过将他们并置在一起可以确保具有同一个<code>affinityKey</code>的所有键都会缓存在同一个处理节点上,从而避免从远程节点获取数据的昂贵网络开销。</p> <p>例如，有一个<code>Person</code>和<code>Company</code>对象，然后希望将<code>Person</code>对象和其工作的<code>Company</code>对象并置在一起。</p> <p>要做到这一点，用于缓存<code>Person</code>对象的缓存键应该有一个属性加注了<code>@AffinityKeyMapped</code>注解，他会提供用于并置的<code>Company</code>键的值，方便起见，也可以选用<code>AffinityKey</code>类。</p> <p>如果缓存是通过SQL创建的，那么关系键是通过<code>CREATE TABLE</code>的<code>AFFINITY_KEY</code>参数传递的。</p> <div class="tip custom-block"><p class="custom-block-title">Scala中的注解</p> <p>注意，如果Scala的case class用于键类并且它的构造函数参数之一加注了<code>@AffinityKeyMapped</code>注解，默认这个注解并不会正确地用于生成的字段，因此也就不会被Ignite识别。要覆盖这个行为，可以使用<code>@field</code><a href="http://www.scala-lang.org/api/current/#scala.annotation.meta.package" target="_self" rel="noopener noreferrer">元注解</a>而不是<code>@AffinityKeyMapped</code>（看下面的示例）。</p></div> <p>使用PersonKey:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PersonKey</span> <span class="token punctuation">{</span>
    <span class="token comment">// Person ID used to identify a person.</span>
    <span class="token keyword">private</span> String personId<span class="token punctuation">;</span>
 
    <span class="token comment">// Company ID which will be used for affinity.</span>
    <span class="token annotation punctuation">@AffinityKeyMapped</span>
    <span class="token keyword">private</span> String companyId<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Instantiate person keys with the same company ID which is used as affinity key.</span>
Object personKey1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Object personKey2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PersonKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Person p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Both, the company and the person objects will be cached on the same node.</span>
comCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Company</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>使用PersonKey（Scala）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">case</span> <span class="token keyword">class</span> <span class="token class-name">PersonKey</span> <span class="token punctuation">(</span>
    <span class="token comment">// Person ID used to identify a person.</span>
    personId<span class="token operator">:</span> String<span class="token punctuation">,</span>
 
    <span class="token comment">// Company ID which will be used for affinity.</span>
    @<span class="token punctuation">(</span>AffinityKeyMapped <span class="token annotation punctuation">@field</span><span class="token punctuation">)</span>
    companyId<span class="token operator">:</span> String
<span class="token punctuation">)</span>

<span class="token comment">// Instantiate person keys with the same company ID which is used as affinity key.</span>
val personKey1 <span class="token operator">=</span> <span class="token function">PersonKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
val personKey2 <span class="token operator">=</span> <span class="token function">PersonKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
val p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
val p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Both, the company and the person objects will be cached on the same node.</span>
compCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">,</span> <span class="token function">Company</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>使用AffinityKey：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Object personKey1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AffinityKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Object personKey2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AffinityKey</span><span class="token punctuation">(</span><span class="token string">&quot;myPersonId2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
Person p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Person p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Both, the company and the person objects will be cached on the same node.</span>
comCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Company</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
perCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p><strong>SQL关联</strong>
当在分区缓存上的数据执行SQL分布式关联时，一定要确保关联的键是并置的。</p></blockquote> <h3 id="_3-7-2-数据和计算的并置"><a href="#_3-7-2-数据和计算的并置" aria-hidden="true" class="header-anchor">#</a> 3.7.2.数据和计算的并置</h3> <p>也有可能向缓存数据的节点发送计算，这是一个被称为数据和计算的并置的概念，他可以向特定的节点发送整个的工作单元。</p> <p>要将数据和计算并置在一起，需要使用<code>IgniteCompute.affinityRun(...)</code>和<code>IgniteCompute.affinityCall(...)</code>方法。
下面的例子显示了如何和上面提到的缓存<code>Person</code>和<code>Company</code>对象的同一个集群节点进行并置计算：</p> <p>Java8:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>String companyId <span class="token operator">=</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">;</span>
 
<span class="token comment">// Execute Runnable on the node where the key is cached.</span>
ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">affinityRun</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">,</span> companyId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  Company company <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Since we collocated persons with the company in the above example,</span>
  <span class="token comment">// access to the persons objects is local.</span>
  Person person1 <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Person person2 <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Java7:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> String companyId <span class="token operator">=</span> <span class="token string">&quot;myCompanyId&quot;</span><span class="token punctuation">;</span>
 
<span class="token comment">// Execute Runnable on the node where the key is cached.</span>
ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">affinityRun</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">,</span> companyId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Company company <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    Person person1 <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>personKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Person person2 <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>personKey2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-7-3-ignitecompute和entryprocessor"><a href="#_3-7-3-ignitecompute和entryprocessor" aria-hidden="true" class="header-anchor">#</a> 3.7.3.IgniteCompute和EntryProcessor</h3> <p><code>IgniteCompute.affinityRun(...)</code>和<code>IgniteCache.invoke(...)</code>方法都提供了数据和计算的并置。主要的不同在于<code>invoke(...)</code>方法是原子的并且执行时在键上加了锁，无法从<code>EntryProcessor</code>逻辑内部访问其他的键，因为它会触发一个死锁。
另一方面，<code>affinityRun(...)</code>和<code>affinityCall(...)</code>不持有任何锁。比如，在这些方法内开启多个事务或者执行缓存查询是绝对合法的，不用担心死锁。这时Ignite会自动检测处理是并置的然后对事务采用优化过的一阶段提交而不是二阶段提交。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>关于<code>IgniteCache.invoke(...)</code>方法的更多信息，请参照<a href="/doc/java/Key-ValueDataGrid.html#_3-2-4-entryprocessor">EntryProcessor</a>文档。</p></div> <h3 id="_3-7-4-关系函数"><a href="#_3-7-4-关系函数" aria-hidden="true" class="header-anchor">#</a> 3.7.4.关系函数</h3> <p>分区的关系控制一个分区缓存在哪个网格节点或者哪些节点上。<code>AffinityFunction</code>是一个可插拔的API用于确定网格中分区到节点的一个理想映射。当集群网络发生变化时，分区到节点的映射可能不同于关系函数提供的理想分布，直到再平衡结束。</p> <p>Ignite提供了<code>RendezvousAffinityFunction</code>，这个函数允许分区到节点的映射有点区别（即一些节点可能比其他节点负责稍微多一点的分区数量）。然而，它保证当网络发生变化时，分区只会迁移到一个新加入的节点或者只来自一个离开的节点，集群内已有的节点间不会发生数据的交换。</p> <p>注意，缓存关系函数不会直接映射键和节点，它映射的是键和分区。分区只是来自一个有限集合的简单的数字（默认0-1024）。在键映射到他们的分区之后（即获得了他们的分区号），已有的分区到节点的映射会用于当前的网络版本，键到分区的映射在时间上并不会改变。
下面的代码显示了如何自定义和配置一个关系函数：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Creating a cache configuration. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myCache<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

                <span class="token comment">&lt;!-- Creating the affinity function with custom setting. --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>affinity<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.affinity.rendezvous.RendezvousAffinityFunction<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>excludeNeighbors<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>partitions<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>2048<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Preparing Apache Ignite node configuration.</span>
IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Creating a cache configuration.</span>
CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Creating the affinity function with custom setting.</span>
RendezvousAffinityFunction affFunc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RendezvousAffinityFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
affFunc<span class="token punctuation">.</span><span class="token function">setExcludeNeighbors</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
affFunc<span class="token punctuation">.</span><span class="token function">setPartitions</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Applying the affinity function configuration.</span>
cacheCfg<span class="token punctuation">.</span><span class="token function">setAffinity</span><span class="token punctuation">(</span>affFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Setting the cache configuration.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">关系的故障安全</p> <p>主备副本不位于同一台物理机上，以这样的方式调整集群内的分区是很有用的，要确保这个属性，可以在<code>RendezvousAffinityFunction</code>上设置<code>excludeNeighbors</code>标志。</p> <p>有时将一个分区的主备副本放在不同的机架上也是很有用的。这时，可以为每个节点赋予一个特别的属性然后在<code>RendezvousAffinityFunction</code>上使用<code>AffinityBackupFilter</code>属性来排除同一个机架中分配用于备份副本的若干节点。</p> <p>此外，可以用<code>ClusterNodeAttributeAffinityBackupFilter</code>创建<code>AffinityBackupFilter</code>，该<code>AffinityBackupFilter</code>根据节点对某些环境变量（例如<code>AVAILABILITY_ZONE</code>）的值来分离主节点和备份副本。有关如何配置此属性的更多信息，请参考<code>ClusterNodeAttributeAffinityBackupFilter.java</code>类的<a href="https://ignite.apache.org/releases/latest/javadoc/index.html" target="_self" rel="noopener noreferrer">javadoc</a>。</p></div> <p><code>AffinityFunction</code>是一个可插拔的API，也可以提供这个函数的自定义实现，<code>AffinityFunction</code>API的三个主要方法是：</p> <ul><li><code>partitions()</code>：获取一个缓存的分区总数量，集群启动之后无法改变。</li> <li><code>partition(...)</code>：给定一个键，这个方法确定一个键属于哪个分区，这个映射在时间上不会改变。</li> <li><code>assignPartitions(...)</code>：这个方法在集群网络发生变化时每次都会被调用，这个方法对于给定的集群网络返回一个分区到节点的映射。</li></ul> <h3 id="_3-7-5-关系键映射器"><a href="#_3-7-5-关系键映射器" aria-hidden="true" class="header-anchor">#</a> 3.7.5.关系键映射器</h3> <p><code>CacheAffinityKeyMapper</code>是一个可插拔的API，负责为一个缓存键获取关系键。通常缓存键本身就用于关系键，然而为了与其他的缓存键并置，有时改变一个缓存键的关系是很重要的。</p> <p><code>CacheAffinityKeyMapper</code>的主要方法是<code>affinityKey(key)</code>，他会为一个缓存键返回一个<code>affinityKey</code>。Ignite默认会查找加注<code>@CacheAffinityKeyMapped</code>注解的所有属性和方法。如果没有找到这样的属性或者方法，那么缓存键本身就会用做关系键。如果找到了这样的属性或者方法，那么这个属性或者方法的值就会从<code>CacheAffinityKeyMapper.affinityKey(key)</code>方法返回，这样只要需要，就可以指定一个替代的关系键，而不是缓存键本身。</p> <h2 id="_3-8-事务"><a href="#_3-8-事务" aria-hidden="true" class="header-anchor">#</a> 3.8.事务</h2> <h3 id="_3-8-1-事务"><a href="#_3-8-1-事务" aria-hidden="true" class="header-anchor">#</a> 3.8.1.事务</h3> <h4 id="_3-8-1-1-原子化模式"><a href="#_3-8-1-1-原子化模式" aria-hidden="true" class="header-anchor">#</a> 3.8.1.1.原子化模式</h4> <p>Ignite支持几种类型的缓存操作，<code>事务</code>模式和<code>原子</code>模式，<code>原子模式</code>支持多个原子性操作，一次一个。<code>事务模式</code>中，可以将一个或多个键上的多个缓存操作组成单个逻辑操作（称为事务）。在这些键上的所有操作都不会有其他的操作干扰，并且要么全部成功，要么全部失败。操作没有部分执行。</p> <p>原子化模式由<code>CacheAtomicityMode</code>枚举定义（<code>TRANSACTIONAL</code>、<code>TRANSACTIONAL_SNAPSHOT</code>、<code>ATOMIC</code>），可以通过<code>CacheConfiguration</code>的<code>atomicityMode</code>属性进行配置。</p> <p><code>TRANSACTIONAL</code>和<code>TRANSACTIONAL_SNAPSHOT</code>模式支持完全兼容ACID的事务，<code>TRANSACTIONAL</code>模式只支持基于Java API的键-值事务，这个模式的事务有不同的并发模型和隔离级别。</p> <p><code>TRANSACTIONAL_SNAPSHOT</code>模式同时支持键-值事务和SQL事务，它是通过多版本并发控制（MVCC）来支持两种类型的事务的。后面会详细介绍多版本并发控制以及这个模式的限制。</p> <p>只有在需要支持ACID操作时，才需要开启<code>TRANSACTIONAL</code>和<code>TRANSACTIONAL_SNAPSHOT</code>模式。</p> <p><code>ATOMIC</code>模式因为避免了事务锁，所以性能更好，但是仍然提供了<strong>单个数据</strong>的原子性和一致性。<code>ATOMIC</code>模式的另一个不同是批量写，比如<code>putAll(...)</code>和<code>removeAll(...)</code>方法不再可以在一个事务中执行并且可能部分失败，在部分失败时，会抛出<code>CachePartialUpdateException</code>，它里面包含了更新失败的键列表。</p> <p>原子化模式是在<code>CacheAtomicityMode</code>枚举中定义的，</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Set a cache name. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myCache<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

            <span class="token comment">&lt;!-- Set atomicity mode, can be ATOMIC, TRANSACTIONAL or TRANSACTIONAL_SNAPSHOT. 
                ATOMIC is default. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>atomicityMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TRANSACTIONAL<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
     
    <span class="token comment">&lt;!-- Optional transaction configuration. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>transactionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.TransactionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Configure TM lookup here. --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;cacheName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setAtomicityMode</span><span class="token punctuation">(</span>CacheAtomicityMode<span class="token punctuation">.</span>ATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Optional transaction configuration. Configure TM lookup here.</span>
TransactionConfiguration txCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setTransactionConfiguration</span><span class="token punctuation">(</span>txCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">性能</p> <p>注意当使用<code>ATOMIC</code>模式时，事务是被禁用的，因为不需要事务，因此可以获得更高的性能和吞吐量。</p></div> <h4 id="_3-8-1-2-ignitetransactions"><a href="#_3-8-1-2-ignitetransactions" aria-hidden="true" class="header-anchor">#</a> 3.8.1.2.IgniteTransactions</h4> <p><code>IgniteTransactions</code>接口包括了启动和结束事务的功能，以及订阅监听器或者获得指标数据。</p> <div class="tip custom-block"><p class="custom-block-title">跨缓存事务</p> <p>可以在一个事务中组合来自不同缓存的多个操作。注意它可以在一个事务中更新不同类型的缓存，比如<code>复制</code>和<code>分区</code>缓存。</p></div> <div class="warning custom-block"><p class="custom-block-title">近缓存事务</p> <p>近缓存是完全事务化的（<code>TRANSACTIONAL</code>模式），当数据在服务端改变时，会自动地获得更新或者失效。<code>TRANSACTIONAL_SNAPSHOT</code>模式不支持近缓存。</p></div> <div class="danger custom-block"><p class="custom-block-title">警告</p> <p>不能在具有不同原子化模式的多个缓存上执行事务。单个事务中包含的所有缓存都必须具有相同的原子化模式（<code>TRANSACTIONAL</code>或<code>TRANSACTIONAL_SNAPSHOT</code>）。</p></div> <p>可以像下面这样获得<code>IgniteTransactions</code>的一个实例：</p> <p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteTransactions transactions <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>下面是一个事务如何在Ignite中执行的例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">(</span>Transaction tx <span class="token operator">=</span> transactions<span class="token punctuation">.</span><span class="token function">txStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Integer hello <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hello <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">事务对象生命周期</p> <p>一个<code>Transaction</code>对象用完之后需要关闭，要保证不出差错，可以这么做：</p> <ul><li>在<code>try-with-resources</code>语句中启动<code>Transaction</code>，它最终会调用close()方法；</li> <li>使用<code>finally</code>代码块，手工调用<code>tx.close()</code>方法。</li></ul></div> <div class="warning custom-block"><p class="custom-block-title">事务化方法</p> <p>当缓存开启事务时，并不是<code>IgniteCache</code>API中的所有方法都支持事务，需要看它的方法签名，如果其抛出<code>TransactionException</code>异常，那么它就满足ACID原则，可以安全地用于分布式事务。</p></div> <h4 id="_3-8-1-3-2阶段提交（2pc）"><a href="#_3-8-1-3-2阶段提交（2pc）" aria-hidden="true" class="header-anchor">#</a> 3.8.1.3.2阶段提交（2PC）</h4> <p>Ignite在事务中使用了2阶段提交（2PC）的协议，但是只要适用也带有很多一阶段提交的优化。在一个事务中当数据更新时，在调用<code>commit()</code>方法之前，Ignite会在本地事务映射中保持事务状态，在这一点，只要需要，数据都会被传输到远程节点。</p> <p>顾名思义，有两个阶段：准备和提交，具体可以参照如下文章：</p> <ul><li><a href="https://my.oschina.net/liyuj/blog/1626309" target="_self" rel="noopener noreferrer">Apache Ignite事务架构：2阶段提交协议</a></li> <li><a href="https://my.oschina.net/liyuj/blog/1627248" target="_self" rel="noopener noreferrer">Apache Ignite事务架构：并发模型和隔离级别</a></li> <li><a href="https://my.oschina.net/liyuj/blog/1791800" target="_self" rel="noopener noreferrer">Apache Ignite事务架构：故障和恢复</a></li> <li><a href="https://my.oschina.net/liyuj/blog/1793912" target="_self" rel="noopener noreferrer">Apache Ignite事务架构：Ignite持久化的事务处理</a></li> <li><a href="https://my.oschina.net/liyuj/blog/1796152" target="_self" rel="noopener noreferrer">Apache Ignite事务架构：第三方持久化的事务处理</a></li></ul> <p>或者，也可以看下面的<a href="https://cwiki.apache.org/confluence/display/IGNITE/Ignite+Key-Value+Transactions+Architecture" target="_self" rel="noopener noreferrer">资料</a>，了解事务子系统的内部实现。</p> <div class="tip custom-block"><p class="custom-block-title">ACID完整性</p> <p>Ignite提供了完整的ACID（原子性，一致性，隔离性和持久性）兼容事务来确保一致性。</p></div> <h4 id="_3-8-1-4-死锁检测"><a href="#_3-8-1-4-死锁检测" aria-hidden="true" class="header-anchor">#</a> 3.8.1.4.死锁检测</h4> <p>当处理分布式事务时必须要遵守的主要规则是参与一个事务的键的锁，必须按照同样的顺序获得，违反这个规则就可能导致分布式死锁。
Ignite无法避免分布式死锁，而是有一个内建的功能来使调试和解决这个问题更容易。</p> <p>就像下面的代码片段所示，一个带有超时时间的事务启动。如果过了超时时间，死锁检测过程就会试图查找一个触发这个超时的可能的死锁。当超过超时时间时，会抛出<code>TransactionTimeoutException</code>并且像触发<code>CacheException</code>那样传播到应用层而不会管死锁。然而，如果检测到了一个死锁，返回的<code>TransactionTimeoutException</code>的cause会是<code>TransactionDeadlockException</code>（至少涉及死锁的一个事务）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">(</span>Transaction tx <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txStart</span><span class="token punctuation">(</span>TransactionConcurrency<span class="token punctuation">.</span>PESSIMISTIC<span class="token punctuation">,</span>
    TransactionIsolation<span class="token punctuation">.</span>READ_COMMITTED<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CacheException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">TransactionTimeoutException</span> <span class="token operator">&amp;&amp;</span>
        e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">TransactionDeadlockException</span><span class="token punctuation">)</span>    
        
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>TransactionDeadlockException</code>里面包含了有用的信息，有助于找到导致死锁的原因。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Deadlock detected:

K1: TX1 holds lock, TX2 waits lock.
K2: TX2 holds lock, TX1 waits lock.

Transactions:

TX1 [txId=GridCacheVersion [topVer=74949328, time=1463469328421, order=1463469326211, nodeOrder=1], nodeId=ad68354d-07b8-4be5-85bb-f5f2362fbb88, threadId=73]
TX2 [txId=GridCacheVersion [topVer=74949328, time=1463469328421, order=1463469326210, nodeOrder=1], nodeId=ad68354d-07b8-4be5-85bb-f5f2362fbb88, threadId=74]

Keys:

K1 [key=1, cache=default]
K2 [key=2, cache=default]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>死锁检测是一个多步过程，依赖于集群中节点的数量、键以及可能导致死锁涉及的事务数，可能需要做很多次迭代。一个死锁检测的发起者是发起事务并且出现<code>TransactionTimeoutException</code>错误的那个节点，这个节点会检查是否发生了死锁，通过与其他远程节点交换请求/响应，并且准备一个与死锁有关的、由<code>TransactionDeadlockException</code>提供的报告，每个这样的消息（请求/响应）都会被称为一个迭代器。</p> <p>因为死锁检测过程不结束，事务就不会回滚，有时，如果希望对于事务回滚有一个可预测的时间，调整一下参数还是有意义的（下面会描述）。</p> <ul><li><code>IgniteSystemProperties.IGNITE_TX_DEADLOCK_DETECTION_MAX_ITERS</code>：指定死锁检测过程迭代器的最大数，如果这个属性的值小于等于0，死锁检测会被禁用（默认为1000）；</li> <li><code>IgniteSystemProperties.IGNITE_TX_DEADLOCK_DETECTION_TIMEOUT</code>：指定死锁检测机制的超时时间（默认为1分钟）。</li></ul> <p>注意如果迭代器太少的话，可能获得一个不完整的死锁检测报告。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>如果想彻底避免死锁，可以看下面的无死锁事务章节。</p></div> <h4 id="_3-8-1-5-无死锁事务"><a href="#_3-8-1-5-无死锁事务" aria-hidden="true" class="header-anchor">#</a> 3.8.1.5.无死锁事务</h4> <p>对于<code>乐观</code>的<code>可序列化</code>事务，锁不是按顺序获得的。该模式中键可以按照任何顺序访问，因为事务锁是通过一个额外的检查以并行的方式获得的，这使得Ignite可以避免死锁。</p> <p>这里需要引入几个概念来描述<code>可序列化</code>的事务锁是如何工作的。Ignite中的每个事务都会被赋予一个叫做<code>XidVersion</code>的可比较的版本号，事务提交时该事务中修改的每个条目都会被赋予一个叫做<code>EntryVersion</code>的新的版本号，一个版本号为<code>XidVersionA</code>的<code>乐观可序列化</code>事务在如下情况下会抛出<code>TransactionOptimisticException</code>异常而失败：</p> <ul><li>有一个进行中的<code>悲观</code>的或者非可序列化<code>乐观</code>事务在<code>可序列化</code>事务中的一个条目上持有了一个锁；</li> <li>有另外一个进行中的版本号为<code>XidVersionB</code>的<code>乐观可序列化</code>事务，在<code>XidVersionB &gt; XidVersionA</code>时以及这个事务在<code>可序列化</code>事务中的一个条目上持有了一个锁；</li> <li>在该<code>乐观可序列化</code>事务获得所有必要的锁时，存在在提交之前的版本与当前版本不同的条目；</li></ul> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>在一个高并发环境中，乐观锁可能导致一个很高的事务失败率。但是悲观锁如果锁被事务以一个不同的顺序获得可能导致死锁。<br>
然而，在一个同质化的环境中，乐观可序列化锁对于大的事务可能提供更好的性能，因为网络交互的数量只取决于事务相关的节点的数量，而不取决于事务中的键的数量。</p></div> <h4 id="_3-8-1-6-失败事务处理"><a href="#_3-8-1-6-失败事务处理" aria-hidden="true" class="header-anchor">#</a> 3.8.1.6.失败事务处理</h4> <p>如下的异常可能导致事务失败：</p> <table><thead><tr><th>异常名称</th> <th>描述</th></tr></thead> <tbody><tr><td>事务死锁会触发这个异常，<code>解决办法</code>：使用死锁检测机制调试和修正死锁，或者切换到乐观序列化事务（无死锁事务）。由<code>TransactionTimeoutException</code>触发的<code>CacheException</code></td> <td>事务超时会触发<code>TransactionTimeoutException</code>，<code>解决办法</code>：可以增加超时时间或者缩短事务执行时间</td></tr> <tr><td><code>TransactionDeadlockException</code>触发<code>TransactionTimeoutException</code>，再触发<code>CacheException</code></td> <td>事务死锁会触发这个异常，<code>解决办法</code>：使用死锁检测机制调试和修正死锁，或者切换到乐观序列化事务（无死锁事务）。</td></tr> <tr><td><code>TransactionOptimisticException</code></td> <td>乐观事务失败会抛出这个异常，大多数情况下，该异常发生在事务试图并发更新数据的场景中。<code>解决办法</code>：重新执行事务。</td></tr> <tr><td><code>TransactionRollbackException</code></td> <td>事务自动或者手动回滚时，可能抛出这个异常，这时，数据状态是一致的。<code>解决方法</code>：因为数据状态是一致的，所以可以对事务进行重试。</td></tr> <tr><td><code>TransactionHeuristicException</code></td> <td>这是一个不太可能发生的异常，由Ignite中意想不到的内部错误或者通信错误导致，该异常存在于事务子系统无法预知的不确定场景中，目前没有被合理地处理。<code>解决办法</code>：如果出现该异常，数据可能不一致，这时需要对数据进行重新加载，或者报告给Ignite开发社区。</td></tr></tbody></table> <div class="tip custom-block"><p class="custom-block-title">事务重试</p> <p>对于乐观和悲观事务的重试，都是合理的，即使因为网络或者节点故障导致事务失败，Ignite仍然会利用备份或者磁盘上的可用数据，来保证数据一致性，所有这些，都支持事务重试。<br>
但是，不要在应用层无限地进行事务重试，包括在有限的时间内这样做也不好。</p></div> <h4 id="_3-8-1-7-长时间运行事务终止"><a href="#_3-8-1-7-长时间运行事务终止" aria-hidden="true" class="header-anchor">#</a> 3.8.1.7.长时间运行事务终止</h4> <p>在Ignite集群中，部分事件会触发分区映射的交换过程以及数据的再平衡，来保证整个集群的数据分布，这个事件的一个例子就是集群拓扑变更事件，它会在新节点加入或者已有节点离开时触发，还有，新的缓存或者SQL表创建时，也会触发分区映射的交换。</p> <p>当分区映射交换开始时，Ignite会在特定的阶段拿到一个全局锁，只有在未完成的事务并行执行时才需要获得锁，这些事务会阻止分区映射交换进程往前走，从而阻断一些新节点加入进程这样的一些操作。</p> <p>使用<code>TransactionConfiguration.setTxTimeoutOnPartitionMapExchange(...)</code>方法，可以配置长期运行事务阻断分区映射交换的最大时间，时间一到，所有的未完成事务都会回滚，让分区映射交换进程先完成。</p> <p>下面的示例显示如何配置超时时间：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  	...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>transactionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.TransactionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Set the timeout to 20 seconds--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TxTimeoutOnPartitionMapExchange<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>20000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--Other trasaction configurations--&gt;</span>
        ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Create Ignite configuration</span>
IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Create Ignite Transactions configuration</span>
TransactionConfiguration txCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the timeout to 20 seconds</span>
txCfg<span class="token punctuation">.</span><span class="token function">setTxTimeoutOnPartitionMapExchange</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setTransactionConfiguration</span><span class="token punctuation">(</span>txCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start the cluster node</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>如果事务因为超时而回滚，可以捕获并且处理<code>TransactionTimeoutException</code>。</p> <h4 id="_3-8-1-8-集成jta"><a href="#_3-8-1-8-集成jta" aria-hidden="true" class="header-anchor">#</a> 3.8.1.8.集成JTA</h4> <p>Ignite可以通过<code>TransactionConfiguration#setTxManagerFactory</code>方法配置一个JTA事务管理器搜索类，事务管理器工厂是一个工厂，他给Ignite提供了一个JTA事务管理器的实例。</p> <p>Ignite提供了一个<code>CacheJndiTmFactory</code>工厂，他是一个通过JNDI名字查找事务管理器的事务管理器工厂实现。</p> <p>设置了之后，在事务中的每一次缓存操作，Ignite都会检查是否存在一个进行中的JTA事务。如果JTA事务开启了，Ignite也会开启一个事务然后通过他自己的一个<code>XAResource</code>的内部实现来将其加入JTA事务，Ignite事务会准备，提交或者干脆回滚相应的JTA事务。
下面是一个在Ignite中使用JTA事务管理器的示例：</p> <p>Java:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Get an instance of JTA transaction manager.</span>
TMService tms <span class="token operator">=</span> appCtx<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span>TMService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get an instance of Ignite cache.</span>
IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UserTransaction jtaTx <span class="token operator">=</span> tms<span class="token punctuation">.</span><span class="token function">getUserTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start JTA transaction.</span>
jtaTx<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do some cache operations.</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Commit the transaction.</span>
    jtaTx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// Rollback in a case of exception.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jtaTx<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>STATUS_ACTIVE<span class="token punctuation">)</span>
        jtaTx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="_3-8-2-并发模型和隔离级别"><a href="#_3-8-2-并发模型和隔离级别" aria-hidden="true" class="header-anchor">#</a> 3.8.2.并发模型和隔离级别</h3> <p>当原子化模式配置为<code>TRANSACTIONAL</code>时，Ignite对事务支持<code>乐观</code>和<code>悲观</code>的<strong>并发模型</strong>。并发模型决定了何时获得一个条目级的事务锁-在访问数据时或者在<code>prepare</code>阶段。锁定可以防止对一个对象的并发访问。比如，当试图用悲观锁更新一个ToDo列表项时，服务端会在该对象上置一个锁，在提交或者回滚该事务之前，其它的事务或者操作都无法更新该条目。不管在一个事务中使用那种并发模型，在提交之前都存在事务中的所有条目被锁定的时刻。</p> <p><strong>隔离级别</strong>定义了并发事务如何&quot;看&quot;以及处理针对同一个键的操作。Ignite支持<code>读提交</code>、<code>可重复读</code>、<code>可序列化</code>隔离级别。</p> <p>并发模型和隔离级别的所有组合都是可以同时使用的。下面是针对Ignite提供的每一个并发-隔离组合的行为和保证的描述。</p> <h4 id="_3-8-2-1-悲观事务"><a href="#_3-8-2-1-悲观事务" aria-hidden="true" class="header-anchor">#</a> 3.8.2.1.悲观事务</h4> <p>在<code>悲观</code>事务中，锁是在第一次读或者写访问期间获得（取决于隔离级别）然后被事务持有直到其被提交或者回滚。该模式中，锁首先在主节点获得然后在准备阶段提升至备份节点。下面的隔离级别可以配置为<code>悲观</code>并发模型。</p> <ul><li><code>读提交</code>：数据被无锁地读取并且不会被事务本身缓存。如果缓存配置允许的话数据是可能从一个备份节点中读取的。在这个隔离级别中，可以有所谓的非可重复读，因为当在自己的事务中读取数据两次时，一个并发事务可以改变该数据。锁只有在第一次写访问时才会获得（包括<code>EntryProcessor</code>调用）。这意味着事务中已经读取的一个条目在该事务提交时可能有一个不同的值，这种情况是不会抛出异常的。</li> <li><code>可重复读</code>：获得条目锁以及第一次读或者写访问时从主节点获得数据，然后就存储在本地事务映射中。之后对同一数据的所有连续访问都是本地化的，并且返回最后一次读或者被更新的事务值。这意味着没有其他的并发事务可以改变锁定的数据，这样就获得了事务的可重复读。</li> <li><code>可序列化</code>：在<code>悲观</code>模式中，这个隔离级别与<code>可重复读</code>是一样的工作方式。</li></ul> <p>注意，在<code>悲观</code>模式中，锁的顺序是很重要的。此外，Ignite可以按照用户提供的顺序依次并且准确地获得锁。</p> <div class="tip custom-block"><p class="custom-block-title">性能考量</p> <p>设想网络中有三个节点（A、B、C），并且在事务中针对键[1, 2, 3, 4, 5, 6]执行一个<code>putAll</code>。假定这些键以如下形式映射到节点：{A: 1, 4}, {B: 2, 5}, {C: 3, 6}，因为Ignite在<code>悲观</code>模式中无法改变获得锁的顺序，他会产生6次连续地网络往返：[A, B, C, A, B, C]。在键的锁定顺序对于一个事务的语义不重要的情况下，将键按照分区进行分组然后将在一个分区的键一起锁定是明智的。这在一个大的事务中可以显著地降低网络消息的数量。在这个示例中，如果对于一个<code>putAll</code>键按照如下的方式排序：[1, 4, 2, 5, 3, 6]，之后只需要3次的连续网络访问。</p></div> <div class="danger custom-block"><p class="custom-block-title">拓扑变化约束</p> <p>注意，如果至少获得一个悲观事务锁，都不可能改变缓存的拓扑，直到事务被提交或者回滚，因此，不建议长时间地持有事务锁。</p></div> <h4 id="_3-8-2-2-乐观事务"><a href="#_3-8-2-2-乐观事务" aria-hidden="true" class="header-anchor">#</a> 3.8.2.2.乐观事务</h4> <p>在乐观事务中，条目锁是在二阶段提交的<code>准备</code>阶段从主节点获得的，然后提升至备份节点，该锁在事务提交时被释放。如果用户回滚事务没有试图做提交，是不会获得锁的。下面的隔离级别可以与<code>乐观</code>并发模型配置在一起。</p> <ul><li><code>读提交</code>：应该作用于缓存的改变是在源节点上收集的，然后事务提交后生效。事务数据无锁地读取并且不会在事务中缓存。如果缓存配置允许的话该数据是可能从备份节点中读取的。在这个隔离级别中，可以有一个所谓的非可重复读，因为在自己的事务中读取数据两次时另一个事务可以修改数据。这个模式组合在第一次读或者写操作后如果条目值被修改是不会做校验的，并且不会抛出异常。</li> <li><code>可重复读</code>：这个隔离级别的事务的工作方式类似于<code>乐观</code> <code>读提交</code>的事务，只有一个不同-读取值缓存于源节点并且所有的后续读保证都是本地化的。这个模式组合在第一次读或者写操作后如果条目值被修改是不会做校验的，并且不会抛出异常。</li> <li><code>可序列化</code>：在第一次读访问之后会存储一个条目的版本，如果Ignite引擎检测到发起事务中的条目只要有一个被修改，Ignite就会在提交阶段放弃该事务，这是在提交阶段对网格内的事务中记载的条目的版本进行内部检查实现的。简而言之，这意味着Ignite如果在一个事务的提交阶段检测到一个冲突，就会放弃这个事务并且抛出<code>TransactionOptimisticException</code>异常以及回滚已经做出的任何改变，开发者应该处理这个异常并且重试该事务。</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Re-try transaction finite amount of time.</span>
<span class="token keyword">int</span> retryCount <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> retries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// Start transaction in optimistic mode with serializable isolation level.</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>retries <span class="token operator">&lt;</span> retryCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    retries<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>Transaction tx <span class="token operator">=</span>  
        ignite<span class="token punctuation">.</span><span class="token function">transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txStart</span><span class="token punctuation">(</span>TransactionConcurrency<span class="token punctuation">.</span>OPTIMISTIC<span class="token punctuation">,</span>
                                      TransactionIsolation<span class="token punctuation">.</span>SERIALIZABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Modify cache entries as part of this transaction.</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
        <span class="token comment">// commit transaction.  </span>
        tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Transaction succeeded. Leave the while loop.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionOptimisticException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Transaction has failed. Retry.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>这里另外一个需要注意的重要的点是，即使一个条目只是简单地读取（没有改变，<code>cache.put(...)</code>），一个事务仍然可能失败，因为该条目的值对于发起事务中的逻辑很重要。</p> <p>注意，对于<code>读提交</code>和<code>可重复读</code>事务，键的顺序是很重要的，因为这些模式中锁也是按顺序获得的。</p> <div class="tip custom-block"><p class="custom-block-title">乐观可序列化事务的重试</p> <p>对于乐观可序列化事务的失败，重试是个好办法，因为事务试图更新的数据，	可能被并发地修改，因此，需要通过重试逻辑来处理<code>TransactionOptimisticException</code>异常，只不过需要合理地限制重试的次数。</p></div> <h4 id="_3-8-2-3-读一致性"><a href="#_3-8-2-3-读一致性" aria-hidden="true" class="header-anchor">#</a> 3.8.2.3.读一致性</h4> <p>为了在悲观模式下实现完全的读一致性，需要获取读锁。这意味着只有在悲观的可重复读（或可序列化）事务中，悲观模式下的读之间的完全一致性才能够实现。</p> <p>当使用乐观事务时，通过禁止读之间的潜在冲突，可以实现完全的读一致性。此行为由乐观的可序列化模式提供。但是，请注意，在提交发生之前，用户仍然可以读取部分事务状态，因此事务逻辑必须对其进行保护。只有在提交阶段，在任何冲突的情况下，才会抛出<code>TransactionOptimisticException</code>，这将允许开发者重试事务。</p> <div class="warning custom-block"><p class="custom-block-title">警告</p> <p>如果没有使用悲观的可重复读或者可序列化事务，或者也没有使用乐观的序列化事务，那么就可以看到部分的事务状态，这意味着如果一个事务更新对象A和B，那么另一个事务可能看到A的新值和B的旧值。</p></div> <h3 id="_3-8-3-多版本并发控制"><a href="#_3-8-3-多版本并发控制" aria-hidden="true" class="header-anchor">#</a> 3.8.3.多版本并发控制</h3> <h4 id="_3-8-3-1-摘要"><a href="#_3-8-3-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.8.3.1.摘要</h4> <p>配置为<code>TRANSACTIONAL_SNAPSHOT</code>原子化模式的缓存，支持SQL事务以及键-值事务，并且为两种类型的事务开启了多版本并发控制（MVCC）。</p> <h4 id="_3-8-3-2-多版本并发控制"><a href="#_3-8-3-2-多版本并发控制" aria-hidden="true" class="header-anchor">#</a> 3.8.3.2.多版本并发控制</h4> <p>多版本并发控制，是一种在多用户并发访问时，控制数据一致性的方法，MVCC实现了<a href="https://en.wikipedia.org/wiki/Snapshot_isolation" target="_self" rel="noopener noreferrer">快照隔离</a>保证，确保每个事务总是看到一致的数据快照。</p> <p>每个事务在开始时会获得一个数据的一致性快照，并且只能查看和修改该快照中的数据。当事务更新一个条目时，Ignite验证其他事务没有更新该条目，并创建该条目的一个新的版本。新版本只有在事务成功提交时才对其他事务可见。</p> <p>快照不是物理快照，而是由MVCC协调器生成的逻辑快照，MVCC协调器是协调集群中的事务活动的集群节点。协调器跟踪所有活动的事务，并在每个事务完成时得到通知。启用MVCC的缓存的所有操作都需要从协调器请求一个数据的快照。</p> <h4 id="_3-8-3-3-开启mvcc"><a href="#_3-8-3-3-开启mvcc" aria-hidden="true" class="header-anchor">#</a> 3.8.3.3.开启MVCC</h4> <p>要为缓存开启MVCC，需要在缓存配置中使用<code>TRANSACTIONAL_SNAPSHOT</code>原子化模式，如果使用<code>CREATE TABLE</code>命令创建表，则需要在该命令的<code>WITH</code>子句中将原子化模式作为参数传进去。</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myCache<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>atomicityMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TRANSACTIONAL_SNAPSHOT<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>SQL：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> Person <span class="token keyword">WITH</span> <span class="token string">&quot;ATOMICITY=TRANSACTIONAL_SNAPSHOT&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">警告</p> <p><code>TRANSACTIONAL_SNAPSHOT</code>模式只支持默认的并发模型（<code>悲观</code>）和默认的隔离级别（<code>可重复读</code>），具体可以看上面的<a href="#_3-8-2-%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E5%92%8C%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB">并发模型和隔离级别</a>章节。</p></div> <h4 id="_3-8-3-4-并发更新"><a href="#_3-8-3-4-并发更新" aria-hidden="true" class="header-anchor">#</a> 3.8.3.4.并发更新</h4> <p>在一个事务中，如果一个条目先被读取然后被更新，那么就有一种可能性，即另一个事务可能在两个操作之间切入然后首先更新该条目，这时，当第一个事务试图更新该条目时就会抛出异常，然后该事务会被标记为<code>只能回滚</code>，这时开发者就需要进行事务重试。</p> <p>那么怎么知道发生了冲突呢？</p> <ul><li>如果使用了Java的事务API，抛出了<code>CacheException</code>异常（异常信息为<code>Cannot serialize transaction due to write conflict (transaction is marked for rollback)</code>），并且<code>Transaction.rollbackOnly</code>标志为<code>true</code>；</li> <li>如果通过JDBC/ODBC驱动执行了SQL事务，那么开发者会得到<code>SQLSTATE:40001</code>错误代码。</li></ul> <p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span><span class="token number">5</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span>Transaction tx <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">txStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;attempt #&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;, value: &quot;</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;new value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;attempt #&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot; succeeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CacheException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tx<span class="token punctuation">.</span><span class="token function">isRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Transaction was not marked as &quot;rollback only&quot;, </span>
              <span class="token comment">// so it's not a concurrent update issue.</span>
              <span class="token comment">// Process the exception here.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>JDBC：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.ignite.IgniteJdbcThinDriver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Open JDBC connection.</span>
Connection conn <span class="token operator">=</span> DriverManager<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:ignite:thin://127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

PreparedStatement updateStmt <span class="token operator">=</span> null<span class="token punctuation">;</span>
PreparedStatement selectStmt <span class="token operator">=</span> null<span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// starting a transaction</span>
    conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    selectStmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;select name from Person where id = 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    selectStmt<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ResultSet rs <span class="token operator">=</span> selectStmt<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;name = &quot;</span> <span class="token operator">+</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    updateStmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;update Person set name = ? where id = ? &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    updateStmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;New Name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    updateStmt<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    updateStmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// committing the transaction</span>
    conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;40001&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getSQLState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// retry the transaction</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// process the exception</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateStmt <span class="token operator">!=</span> null<span class="token punctuation">)</span> updateStmt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectStmt <span class="token operator">!=</span> null<span class="token punctuation">)</span> selectStmt<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h4 id="_3-8-3-5-限制"><a href="#_3-8-3-5-限制" aria-hidden="true" class="header-anchor">#</a> 3.8.3.5.限制</h4> <p><strong>跨缓存事务</strong></p> <p><code>TRANSACTIONAL_SNAPSHOT</code>模式是缓存级的，并且事务中涉及的缓存不允许有不同的原子化模式，因此，如果希望在一个SQL事务中覆盖多个表，则必须使用<code>TRANSACTIONAL_SNAPSHOT</code>模式创建所有表。</p> <p><strong>嵌套事务</strong></p> <p>通过JDBC/ODBC连接参数，Ignite支持三种模式来处理SQL的嵌套事务：</p> <p>JDBC连接串：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>jdbc:ignite:thin://127.0.0.1/?nestedTransactionsMode=COMMIT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当在一个事务中出现了嵌套事务，系统的行为依赖于<code>nestedTransactionsMode</code>参数：</p> <ul><li><code>ERROR</code>：如果发生了嵌套事务，会抛出错误，包含事务会回滚，这是默认的行为；</li> <li><code>COMMIT</code>：包含事务会被提交，嵌套事务开始并且在遇到<code>COMMIT</code>语句时会提交，包含事务中的其余部分会作为隐式事务执行；</li> <li><code>IGNORE</code>：<strong>不要使用这个模式</strong>，嵌套事务的开始会被忽略，嵌套事务中的语句会作为包含事务的一部分来执行，然后所有的变更会随着嵌套事务的提交而提交，包含事务中的其余部分会作为隐式事务执行。</li></ul> <p><strong>连续查询</strong></p> <p>如果在开启了MVCC的缓存上使用连续查询，那么有些限制需要知道：</p> <ul><li>当接收到更新事件时，后续对更新过的键的读取有时可能返回旧的值。这是因为只要更新了键，更新事件是从更新键的节点立即发送的。这时，MVCC协调器可能不会立即感知到该更新，因此，随后的读取可能暂时返回过时的信息。</li> <li>当使用连续查询时，每个节点单个事务可以更新的键数量是有限制的。更新后的值保存在内存中，如果更新太多，节点可能没有足够的内存来保存所有对象。为了避免内存溢出错误，每个事务在一个节点上只能最多更新20000个键（默认值）。如果超过此值，事务将抛出异常并回滚。可以通过指定<code>IGNITE_MVCC_TX_SIZE_CACHING_THRESHOLD</code>系统属性来修改该值。</li></ul> <p><strong>其它的限制</strong></p> <p>开启MVCC的缓存，下面的特性是不支持的：</p> <ul><li><a href="/doc/java/Key-ValueDataGrid.html#_3-5-近缓存">近缓存</a>；</li> <li><a href="/doc/java/DurableMemory.html#_10-5-过期策略">过期策略</a>；</li> <li><a href="/doc/java/MessagingEvents.html#_9-2-本地和远程事件">事件</a>；</li> <li><a href="https://ignite.apache.org/releases/latest/javadoc/org/apache/ignite/cache/CacheInterceptor.html" target="_self" rel="noopener noreferrer">缓存拦截器</a>；</li> <li><a href="/doc/java/Persistence.html#_16-4-第三方持久化">第三方持久化</a>；</li> <li><a href="/doc/java/DurableMemory.html#_10-3-3-堆内缓存">堆内缓存</a>；</li> <li><a href="https://ignite.apache.org/releases/latest/javadoc/org/apache/ignite/IgniteCache.html#lock-K-" target="_self" rel="noopener noreferrer">显式锁</a>；</li> <li><a href="https://ignite.apache.org/releases/latest/javadoc/org/apache/ignite/IgniteCache.html#localEvict-java.util.Collection-" target="_self" rel="noopener noreferrer">localEvict()</a>和<a href="https://ignite.apache.org/releases/latest/javadoc/org/apache/ignite/IgniteCache.html#localPeek-K-org.apache.ignite.cache.CachePeekMode...-" target="_self" rel="noopener noreferrer">localPeek()</a>方法。</li></ul> <h2 id="_3-9-锁"><a href="#_3-9-锁" aria-hidden="true" class="header-anchor">#</a> 3.9.锁</h2> <p>缓存事务会隐式地获得锁，然而，有些情况下显式锁是很有用的。<code>IgniteCache</code>API的<code>lock()</code>方法会返回一个<code>java.util.concurrent.locks.Lock</code>的实例，他可以在任意给定的键上定义显式的分布式锁，也可以通过<code>IgniteCache.lockAll()</code>方法给集合对象加锁。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a lock for the given key</span>
Lock lock <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token string">&quot;keyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Acquire the lock</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>  
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// Release the lock</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p><strong>原子化模式</strong>
Ignite中，只有在<code>TRANSACTIONAL</code>原子化模式中才支持锁，他可以通过<code>CacheConfiguration</code>的<code>atomicityMode</code>属性进行配置。</p></blockquote> <p><strong>锁和事务</strong></p> <p>显式锁是非事务性的，不能在事务中使用（会抛出异常）。如果确实需要在事务中使用显式锁，那么需要使用事务的<code>TransactionConcurrency.PESSIMISTIC</code>并发控制，他会为相关的缓存操作获得显式锁。</p> <h2 id="_3-10-数据再平衡"><a href="#_3-10-数据再平衡" aria-hidden="true" class="header-anchor">#</a> 3.10.数据再平衡</h2> <h3 id="_3-10-1-摘要"><a href="#_3-10-1-摘要" aria-hidden="true" class="header-anchor">#</a> 3.10.1.摘要</h3> <p>当一个新节点加入集群时，已有节点会放弃一部分缓存条目的所有权转交给新的节点，以使整个网格在任何时候都保持键的均等平衡。</p> <p>如果新的节点成为一些分区的主节点或者备份节点，他会从该分区之前的主节点获取数据，或者从该分区的备份节点之一获取数据。一旦分区全部载入新的节点，旧节点就会被标记为过时然后该节点在所有当前的事务完成之后最终会被退出。因此，在一些很短的时间段，在网络发生变化之后，有一种情况是在缓存中对于一个键备份的数量可能比事先配置的多。然而，一旦再平衡完成，额外的备份会被删除。</p> <h3 id="_3-10-2-再平衡模式"><a href="#_3-10-2-再平衡模式" aria-hidden="true" class="header-anchor">#</a> 3.10.2.再平衡模式</h3> <p>下面的再平衡模式是在<code>CacheRebalanceMode</code>枚举中定义的：</p> <table><thead><tr><th>缓存再平衡模式</th> <th>描述</th></tr></thead> <tbody><tr><td><code>SYNC</code></td> <td>同步再平衡模式，直到所有必要的数据全部从其他有效节点加载完毕分布式缓存才会启动，这意味着所有对缓存的开放API的调用都会阻塞直到再平衡结束</td></tr> <tr><td><code>ASYNC</code></td> <td>异步平衡模式，分布式缓存会马上启动，然后在后台会从其他节点加载所有必要的数据</td></tr> <tr><td><code>NONE</code></td> <td>该模式下不会发生再平衡，这意味着要么在访问数据时从持久化存储载入，要么数据被显式地填充。</td></tr></tbody></table> <p>默认启用<code>ASYNC</code>再平衡模式，要使用其他的再平衡模式，可以像下面这样设置<code>CacheConfiguration</code>的<code>rebalanceMode</code>属性：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- Set synchronous rebalancing. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>SYNC<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          ... 
        &lt;/bean
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setRebalanceMode</span><span class="token punctuation">(</span>CacheRebalanceMode<span class="token punctuation">.</span>SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_3-10-3-再平衡线程池调节"><a href="#_3-10-3-再平衡线程池调节" aria-hidden="true" class="header-anchor">#</a> 3.10.3.再平衡线程池调节</h3> <p><code>IgniteConfiguration</code>提供了一个<code>setRebalanceThreadPoolSize</code>方法，他可以为了再平衡的需要，从Ignite的系统线程池中获取一定数量的线程，每当一个节点需要向远程节点发送一批数据时，或者需要处理来自相反方向的一批数据时，都会从池中获取一个系统线程，这个远程节点既可能是一个分区的主节点，也可能是备份节点。这个线程在批处理发送或者接收完以及处理完之后，就会被释放。</p> <p>默认只会有一个线程用于再平衡。这基本上意味着在一个特定的时间点只有一个线程用于从一个节点到另一节点传输批量数据，或者处理来自远端的批量数据。举例来说，如果集群有两个节点和一个缓存，那么所有缓存的分区都会一个一个地按照顺序进行再平衡。如果集群有两个节点和两个不同的缓存，那么这些缓存会以并行的方式进行再平衡，但是在一个特定的时间点，就像上面解释的那样，只会处理属于某一个特定缓存的批量数据。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>每个缓存的分区数量不会影响再平衡的性能，有影响的是数据的总量，再平衡线程池大小以及下面章节列出的其他参数。</p></div> <p>根据系统中缓存的数量以及缓存中存储的数据量，如果再平衡线程池的大小为1，要将所有的数据再平衡至一个节点上，会花费很长的时间。要加快预加载的进程，可以根据需要增加<code>IgniteConfiguration.setRebalanceThreadPoolSize</code>的值。</p> <p>假定将<code>IgniteConfiguration.setRebalanceThreadPoolSize</code>的值设为4然后考虑上述的示例，再平衡的过程会如下所示：</p> <ul><li>如果集群有两个节点和一个缓存，那么缓存的分区逻辑上会分为4个不同的组，他们会以并行的方式进行处理，每个线程处理一个组，属于一个特定组的分区会按照顺序一个一个地进行再平衡。</li> <li>如果集群有两个节点和两个不同的缓存，那么每个缓存的分区逻辑上都会分为四个不同的组（每个缓存都会有四个组，总共8个组），然后会有四个不同的线程并行地处理这些组，然而在一个特定的时间点，就像上面解释的那样，只有属于一个特定组（总共8个）的数据会被处理。</li></ul> <div class="warning custom-block"><p class="custom-block-title">警告</p> <p>在内部，系统线程池广泛用于和缓存有关的所有操作（put，get等），SQL引擎和其他模块，因此将<code>IgniteConfiguration.setRebalanceThreadPoolSize</code>设置为一个很大的值会显著提高再平衡的性能，但是会影响应用的性能。</p></div> <h3 id="_3-10-4-再平衡消息限流"><a href="#_3-10-4-再平衡消息限流" aria-hidden="true" class="header-anchor">#</a> 3.10.4.再平衡消息限流</h3> <p>当再平衡器将数据从一个节点传输到另一个节点时，他会将整个数据集拆分为多个批次然后将每一个批次作为一个单独的消息进行发送。如果数据集很大那么就会有很多的消息要发送，CPU和网络就会过度的消耗，这时在再平衡消息之间进行等待是合理的，以使由于再平衡过程导致的性能下降冲击最小化。这个时间间隔可以通过<code>CacheConfiguration</code>的<code>rebalanceThrottle</code>属性进行控制，他的默认值是0，意味着在消息之间没有暂停，注意单个消息的大小也可以通过<code>rebalanceBatchSize</code>属性进行设置(默认值是512K)。</p> <p>比如，如果希望再平衡器间隔100ms每个消息发送2MB数据，需要提供如下的配置：</p> <p>XML：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- Set batch size. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceBatchSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#{2 * 1024 * 1024}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token comment">&lt;!-- Set throttle interval. --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>rebalanceThrottle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token comment">&lt;!-- ... --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Java：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>CacheConfiguration cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setRebalanceBatchSize</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
cacheCfg<span class="token punctuation">.</span><span class="token function">setRebalanceThrottle</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-10-5-配置"><a href="#_3-10-5-配置" aria-hidden="true" class="header-anchor">#</a> 3.10.5.配置</h3> <p>缓存的再平衡行为可以有选择地通过下面的配置属性进行定制：</p> <p><strong>CacheConfiguration</strong></p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setRebalanceMode</code></td> <td>分布式缓存的再平衡模式，细节可以参照再平衡模式章节</td> <td>ASYNC</td></tr> <tr><td><code>setRebalanceDelay</code></td> <td>当节点加入或者离开（故障）集群时，再平衡应该自动启动的延迟时间（毫秒），如果打算在节点离开集群后重启节点，再平衡也应该推迟，如果打算在同时启动多个节点，或者一个个启动节点的过程中，不进行再平衡，也可以推迟，只到所有节点都启动完成再进行。</td> <td>0，无延迟</td></tr> <tr><td><code>setRebalanceBatchSize</code></td> <td>单个再平衡消息的大小（byte），再平衡算法会在发送数据之前将每个节点的整个数据集拆分成多个批次。</td> <td>512K</td></tr> <tr><td><code>setRebalanceThrottle</code></td> <td>可以看上面的<a href="#_3-10-4-%E5%86%8D%E5%B9%B3%E8%A1%A1%E6%B6%88%E6%81%AF%E9%99%90%E6%B5%81">再平衡消息限流</a>章节。</td> <td>0，无间隔</td></tr> <tr><td><code>setRebalanceOrder</code></td> <td>要完成的再平衡的顺序，只有同步和异步再平衡模式的缓存才可以将再平衡顺序设置为非0值，具有更小值的缓存再平衡会被首先完成，再平衡默认是无序的</td> <td>0</td></tr> <tr><td><code>setRebalanceBatchesPrefetchCount</code></td> <td>为了达到更好的性能，数据提供者节点会在再平衡开始时提供不止一个批次然后在下一个请求时提供一个新的批次。这个方法会设置再平衡开始时数据提供者节点产生的批次的数量</td> <td>2</td></tr> <tr><td><code>setRebalanceTimeout</code></td> <td>节点间正在交换的等待再平衡消息的超时时间</td> <td>10秒</td></tr></tbody></table> <p><strong>IgniteConfiguration</strong>：</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setRebalanceThreadPoolSize</code></td> <td>用于再平衡的线程的最大值</td> <td>1，对整个集群的操作影响最小</td></tr></tbody></table> <h2 id="_3-11-拓扑验证"><a href="#_3-11-拓扑验证" aria-hidden="true" class="header-anchor">#</a> 3.11.拓扑验证</h2> <p>拓扑验证器用于验证集群网络拓扑对于未来的缓存操作是否有效。</p> <p>拓扑验证器在每次集群拓扑发生变化时都会被调用（或者新节点加入或者已有节点故障或者其他的）。如果没有配置拓扑验证器，那么集群拓扑会被认为一直有效。</p> <p>当<code>TopologyValidator.validate(Collection)</code>方法返回true时，那么对于特定的缓存以及在这个缓存上的所有有效操作拓扑都会被认为是有效的，否则，该缓存上的所有更新操作都会抛出如下异常：</p> <ul><li><code>CacheException</code>:所有试图更新的操作都会抛出（put，remove等）</li> <li><code>IgniteException</code>:试图进行事务提交的操作会抛出</li></ul> <p>返回false以及声明拓扑无效后，当下一次拓扑发生变化时拓扑验证器可以返回正常状态。</p> <p>示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>CacheConfiguration cCfg <span class="token operator">:</span> iCfg<span class="token punctuation">.</span><span class="token function">getCacheConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cCfg<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cCfg<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CACHE_NAME_1<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cCfg<span class="token punctuation">.</span><span class="token function">setTopologyValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopologyValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span>Collection<span class="token generics function"><span class="token punctuation">&lt;</span>ClusterNode<span class="token punctuation">&gt;</span></span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cCfg<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>CACHE_NAME_2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cCfg<span class="token punctuation">.</span><span class="token function">setTopologyValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopologyValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span>Collection<span class="token generics function"><span class="token punctuation">&lt;</span>ClusterNode<span class="token punctuation">&gt;</span></span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> nodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在这个例子中，对缓存允许更新操作情况如下：</p> <ul><li><code>CACHE_NAME_1</code>:集群具有两个节点时</li> <li><code>CACHE_NAME_2</code>:集群至少有两个节点时</li></ul> <p><strong>配置</strong></p> <p>拓扑验证器通过<code>CacheConfiguration.setTopologyValidator(TopologyValidator)</code>方法既可以用代码也可以用XML进行配置。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间：: </span> <span class="time">2/1/2019, 3:28:53 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/doc/java/Clustering.html" class="prev">
          2.集群化
        </a></span> <span class="next"><a href="/doc/java/Security.html">
          4.安全
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.7a7a4d7d.js" defer></script><script src="/assets/js/72.47b0ade0.js" defer></script>
  </body>
</html>
