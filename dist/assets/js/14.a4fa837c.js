(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{68:function(s,a,n){"use strict";n.r(a);var t=n(0),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"kafka连接器深度解读之错误处理和死信队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kafka连接器深度解读之错误处理和死信队列","aria-hidden":"true"}},[s._v("#")]),s._v(" Kafka连接器深度解读之错误处理和死信队列")]),s._v(" "),n("p",[s._v("Kafka连接器是Kafka的一部分，是在Kafka和其它技术之间构建流式管道的一个强有力的框架。它可用于将数据从多个地方（包括数据库、消息队列和文本文件）流式注入到Kafka，以及从Kafka将数据流式传输到目标端（如文档存储、NoSQL、数据库、对象存储等）中。")]),s._v(" "),n("p",[s._v("现实世界并不完美，出错是难免的，因此在出错时Kafka的管道能尽可能优雅地处理是最好的。一个常见的场景是获取与特定序列化格式不匹配的主题的消息（比如预期为Avro时实际为JSON，反之亦然）。自从Kafka 2.0版本发布以来，Kafka连接器包含了错误处理选项，即将消息路由到"),n("em",[s._v("死信队列")]),s._v("的功能，这是构建数据管道的常用技术。")]),s._v(" "),n("p",[s._v("在本文中将介绍几种处理问题的常见模式，并说明如何实现。")]),s._v(" "),n("h2",{attrs:{id:"失败后立即停止"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#失败后立即停止","aria-hidden":"true"}},[s._v("#")]),s._v(" 失败后立即停止")]),s._v(" "),n("p",[s._v("有时可能希望在发生错误时立即停止处理，可能遇到质量差的数据是由于上游的原因导致的，必须由上游来解决，继续尝试处理其它的消息已经没有意义。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Source_Topic_Messages_Kafka_Connect_Sink_Messages-e1552329568691.png",alt:""}})]),s._v(" "),n("p",[s._v("这是Kafka连接器的默认行为，也可以使用下面的配置项显式地指定：")]),s._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.tolerance")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("none")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("在本示例中，该连接器配置为从主题中读取JSON格式数据，然后将其写入纯文本文件。注意这里为了演示使用的是"),n("code",[s._v("FileStreamSinkConnector")]),s._v("连接器，不建议在生产中使用。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d \'{\n        "name": "file_sink_01",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_json",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "file":"/data/file_sink_01.txt"\n                }\n        }\'\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("主题中的某些JSON格式消息是无效的，连接器会立即终止，进入以下的"),n("code",[s._v("FAILED")]),s._v("状态：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://localhost:8083/connectors/file_sink_01/status"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    jq -c -M "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[.name,.tasks[].state]'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file_sink_01"')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FAILED"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("查看Kafka连接器工作节点的日志，可以看到错误已经记录并且任务已经终止：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('org.apache.kafka.connect.errors.ConnectException: Tolerance exceeded in error handler\n at org.apache.kafka.connect.runtime.errors.RetryWithToleranceOperator.execAndHandleError(RetryWithToleranceOperator.java:178)\n…\nCaused by: org.apache.kafka.connect.errors.DataException: Converting byte[] to Kafka Connect data failed due to serialization error:\n at org.apache.kafka.connect.json.JsonConverter.toConnectData(JsonConverter.java:334)\n…\nCaused by: org.apache.kafka.common.errors.SerializationException: com.fasterxml.jackson.core.JsonParseException: Unexpected character (\'b\' (code 98)): was expecting double-quote to start field name\n at [Source: (byte[])"{brokenjson-:"bar 1"}"; line: 1, column: 3]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("要修复管道，需要解决源主题上的消息问题。除非事先指定，Kafka连接器是不会简单地“跳过”无效消息的。如果是配置错误（例如指定了错误的序列化转换器），那最好了，改正之后重新启动连接器即可。不过如果确实是该主题的无效消息，那么需要找到一种方式，即不要阻止所有其它有效消息的处理。")]),s._v(" "),n("h2",{attrs:{id:"静默忽略无效的消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#静默忽略无效的消息","aria-hidden":"true"}},[s._v("#")]),s._v(" 静默忽略无效的消息")]),s._v(" "),n("p",[s._v("如果只是希望处理一直持续下去：")]),s._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.tolerance")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("all")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Source_Topic_Messages_Kafka_Connect_Sink_Messages_v2-e1552330256955.png",alt:""}})]),s._v(" "),n("p",[s._v("在实际中大概如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d \'{\n        "name": "file_sink_05",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_json",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "file":"/data/file_sink_05.txt",\n                "errors.tolerance": "all"\n                }\n        }\'\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("启动连接器之后（还是原来的源主题，其中既有有效的，也有无效的消息），就可以持续地运行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('$ curl -s "http://localhost:8083/connectors/file_sink_05/status"| \\\n    jq -c -M \'[.name,.tasks[].state]\'\n["file_sink_05","RUNNING"]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("这时即使连接器读取的源主题上有无效的消息，也不会有错误写入Kafka连接器工作节点的输出，而有效的消息会按照预期写入输出文件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ head data/file_sink_05.txt\n{foo=bar 1}\n{foo=bar 2}\n{foo=bar 3}\n…\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h2",{attrs:{id:"是否可以感知数据的丢失？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#是否可以感知数据的丢失？","aria-hidden":"true"}},[s._v("#")]),s._v(" 是否可以感知数据的丢失？")]),s._v(" "),n("p",[s._v("配置了"),n("code",[s._v("errors.tolerance = all")]),s._v("之后，Kafka连接器就会忽略掉无效的消息，并且默认也不会记录被丢弃的消息。如果确认配置"),n("code",[s._v("errors.tolerance = all")]),s._v("，那么就需要仔细考虑是否以及如何知道实际上发生的消息丢失。在实践中这意味着基于可用指标的监控/报警，和/或失败消息的记录。")]),s._v(" "),n("p",[s._v("确定是否有消息被丢弃的最简单方法，是将源主题上的消息数与写入目标端的数量进行对比：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ kafkacat -b localhost:9092 -t test_topic_json -o beginning -C -e -q -X enable.partition.eof=true | wc -l\n     150\n\n$ wc -l data/file_sink_05.txt\n     100 data/file_sink_05.txt\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这个做法虽然不是很优雅，但是确实能看出发生了消息的丢失，并且因为日志中没有记录，所以用户仍然对此一无所知。")]),s._v(" "),n("p",[s._v("一个更加可靠的办法是，使用"),n("a",{attrs:{href:"https://kafka.apache.org/documentation/#connect_monitoring",target:"_self",rel:"noopener noreferrer"}},[s._v("JMX指标")]),s._v("来主动监控和报警错误消息率：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Kafka_Connect_Totals-e1552339993226.png",alt:""}})]),s._v(" "),n("p",[s._v("这时可以看到发生了错误，但是并不知道那些消息发生了错误，不过这是用户想要的。其实即使之后这些被丢弃的消息被写入了"),n("code",[s._v("/dev/null")]),s._v("，实际上也是可以知道的，这也正是死信队列概念出现的点。")]),s._v(" "),n("h2",{attrs:{id:"将消息路由到死信队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#将消息路由到死信队列","aria-hidden":"true"}},[s._v("#")]),s._v(" 将消息路由到死信队列")]),s._v(" "),n("p",[s._v("Kafka连接器可以配置为将无法处理的消息（例如上面提到的反序列化错误）发送到一个单独的Kafka主题，即死信队列。有效消息会正常处理，管道也会继续运行。然后可以从死信队列中检查无效消息，并根据需要忽略或修复并重新处理。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/DLQ_Source_Topic_Messages_Kafka_Connect_Sink_Messages-e1552339900964.png",alt:""}})]),s._v(" "),n("p",[s._v("进行如下的配置可以启用死信队列：")]),s._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.tolerance")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("all")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.deadletterqueue.topic.name")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v(" ")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("如果运行于单节点Kafka集群，还需要配置"),n("code",[s._v("errors.deadletterqueue.topic.replication.factor = 1")]),s._v("，其默认值为3。")]),s._v(" "),n("p",[s._v("具有此配置的连接器配置示例大致如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d \'{\n        "name": "file_sink_02",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_json",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "file": "/data/file_sink_02.txt",\n                "errors.tolerance": "all",\n                "errors.deadletterqueue.topic.name":"dlq_file_sink_02",\n                "errors.deadletterqueue.topic.replication.factor": 1\n                }\n        }\'\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("使用和之前相同的源主题，然后处理混合有有效和无效的JSON数据，会看到新的连接器可以稳定运行：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://localhost:8083/connectors/file_sink_02/status"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    jq -c -M "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[.name,.tasks[].state]'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file_sink_02"')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RUNNING"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("源主题中的有效记录将写入目标文件：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" data/file_sink_02.txt\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("…"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("这样管道可以继续正常运行，并且还有了死信队列主题中的数据，这可以从指标数据中看出：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Kafka_Connect_Graph-e1552408650942.png",alt:""}})]),s._v(" "),n("p",[s._v("检查主题本身也可以看出来：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('ksql> LIST TOPICS;\n\n Kafka Topic            | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups\n---------------------------------------------------------------------------------------------------\n dlq_file_sink_02       | false      | 1          | 1                  | 0         | 0\n test_topic_json        | false      | 1          | 1                  | 1         | 1\n---------------------------------------------------------------------------------------------------\n\nksql> PRINT \'dlq_file_sink_02\' FROM BEGINNING;\nFormat:STRING\n1/24/19 5:16:03 PM UTC , NULL , {foo:"bar 1"}\n1/24/19 5:16:03 PM UTC , NULL , {foo:"bar 2"}\n1/24/19 5:16:03 PM UTC , NULL , {foo:"bar 3"}\n…\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("从输出中可以看出，消息的时间戳为（"),n("code",[s._v("1/24/19 5:16:03 PM UTC")]),s._v("），键为（"),n("code",[s._v("NULL")]),s._v("），然后为值。这时可以看到值是无效的JSON格式"),n("code",[s._v('{foo:"bar 1"}')]),s._v("（"),n("code",[s._v("foo")]),s._v("也应加上引号），因此JsonConverter在处理时会抛出异常，因此最终会输出到死信主题。")]),s._v(" "),n("p",[s._v("但是只有看到消息才能知道它是无效的JSON，即便如此，也只能假设消息被拒绝的原因，要确定Kafka连接器将消息视为无效的实际原因，有两个方法：")]),s._v(" "),n("ul",[n("li",[s._v("死信队列的消息头；")]),s._v(" "),n("li",[s._v("Kafka连接器的工作节点日志。")])]),s._v(" "),n("p",[s._v("下面会分别介绍。")]),s._v(" "),n("h2",{attrs:{id:"记录消息的失败原因：消息头"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#记录消息的失败原因：消息头","aria-hidden":"true"}},[s._v("#")]),s._v(" 记录消息的失败原因：消息头")]),s._v(" "),n("p",[s._v("消息头是使用Kafka消息的键、值和时间戳存储的附加元数据，是在Kafka 0.11版本中引入的。Kafka连接器可以将有关消息拒绝原因的信息写入消息本身的消息头中。这个做法比写入日志文件更好，因为它将原因直接与消息联系起来。")]),s._v(" "),n("p",[s._v("配置如下的参数，可以在死信队列的消息头中包含拒绝原因：")]),s._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.deadletterqueue.context.headers.enable")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("true")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("配置示例大致如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST http://localhost:8083/connectors -H "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n        "name": "file_sink_03",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_json",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "file": "/data/file_sink_03.txt",\n                "errors.tolerance": "all",\n                "errors.deadletterqueue.topic.name":"dlq_file_sink_03",\n                "errors.deadletterqueue.topic.replication.factor": 1,\n                "errors.deadletterqueue.context.headers.enable":true\n                }\n        }\'')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("和之前一致，连接器可以正常运行（因为配置了"),n("code",[s._v("errors.tolerance=all")]),s._v("）。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://localhost:8083/connectors/file_sink_03/status"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    jq -c -M "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[.name,.tasks[].state]'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file_sink_03"')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RUNNING"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("源主题中的有效消息会正常写入目标文件：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" data/file_sink_03.txt\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("…"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("可以使用任何消费者工具来检查死信队列上的消息（之前使用了KSQL），不过这里会使用kafkacat，然后马上就会看到原因，最简单的操作大致如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("kafkacat -b localhost:9092 -t dlq_file_sink_03\n% Auto-selecting Consumer mode "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("use -P or -C to override"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo:"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bar 1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo:"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bar 2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n…\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("不过kafkacat有更强大的功能，可以看到比消息本身更多的信息：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("kafkacat -b localhost:9092 -t dlq_file_sink_03 -C -o-1 -c1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -f "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("Key (%K bytes): %k\n  Value (%S bytes): %s\n  Timestamp: %T\n  Partition: %p\n  Offset: %o\n  Headers: %h"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("这个命令将获取最后一条消息（"),n("code",[s._v("-o-1")]),s._v("，针对偏移量，使用最后一条消息），只读取一条消息（"),n("code",[s._v("-c1")]),s._v("），并且通过"),n("code",[s._v("-f")]),s._v("参数对其进行格式化，以更易于理解：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('Key (-1 bytes):\n  Value (13 bytes): {foo:"bar 5"}\n  Timestamp: 1548350164096\n  Partition: 0\n  Offset: 34\n  Headers: __connect.errors.topic=test_topic_json,__connect.errors.partition=0,__connect.errors.offset=94,__connect.errors.connector.name=file_sink_03,__connect.errors.task.id=0,__connect.errors.stage=VALU\nE_CONVERTER,__connect.errors.class.name=org.apache.kafka.connect.json.JsonConverter,__connect.errors.exception.class.name=org.apache.kafka.connect.errors.DataException,__connect.errors.exception.message=Co\nnverting byte[] to Kafka Connect data failed due to serialization error: ,__connect.errors.exception.stacktrace=org.apache.kafka.connect.errors.DataException: Converting byte[] to Kafka Connect data failed\n due to serialization error:\n[…]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("也可以只显示消息头，并使用一些简单的技巧将其拆分，这样可以更清楚地看到该问题的更多信息：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ kafkacat -b localhost:9092 -t dlq_file_sink_03 -C -o-1 -c1 -f '%h'|tr ',' '\\n'\n__connect.errors.topic=test_topic_json\n__connect.errors.partition=0\n__connect.errors.offset=94\n__connect.errors.connector.name=file_sink_03\n__connect.errors.task.id=0\n__connect.errors.stage=VALUE_CONVERTER\n__connect.errors.class.name=org.apache.kafka.connect.json.JsonConverter\n__connect.errors.exception.class.name=org.apache.kafka.connect.errors.DataException\n__connect.errors.exception.message=Converting byte[] to Kafka Connect data failed due to serialization error:\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("Kafka连接器处理的每条消息都来自源主题和该主题中的特定点（偏移量），消息头已经准确地说明了这一点。因此可以使用它来回到原始主题并在需要时检查原始消息，由于死信队列已经有一个消息的副本，这个检查更像是一个保险的做法。")]),s._v(" "),n("p",[s._v("根据从上面的消息头中获取的详细信息，可以再检查一下源消息：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("__connect.errors.topic=test_topic_json\n__connect.errors.offset=94\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("将这些值分别插入到kafkacat的代表主题和偏移的"),n("code",[s._v("-t")]),s._v("和"),n("code",[s._v("-o")]),s._v("参数中，可以得到：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ kafkacat -b localhost:9092 -C "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -t test_topic_json -o94 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -f "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("Key (%K bytes): %k\n  Value (%S bytes): %s\n  Timestamp: %T\n  Partition: %p\n  Offset: %o\n  Topic: %t"),n("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("'")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('Key (-1 bytes):\n  Value (13 bytes): {foo:"bar 5"}\n  Timestamp: 1548350164096\n  Partition: 0\n  Offset: 94\n  Topic: test_topic_json\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("与死信队列中的上述消息相比，可以看到完全相同，甚至包括时间戳，唯一的区别是主题、偏移量和消息头。")]),s._v(" "),n("h2",{attrs:{id:"记录消息的失败原因：日志"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#记录消息的失败原因：日志","aria-hidden":"true"}},[s._v("#")]),s._v(" 记录消息的失败原因：日志")]),s._v(" "),n("p",[s._v("记录消息的拒绝原因的第二个选项是将其写入日志。根据安装方式不同，Kafka连接器会将其写入标准输出或日志文件。无论哪种方式都会为每个失败的消息生成一堆详细输出。进行如下配置可启用此功能：")]),s._v(" "),n("div",{staticClass:"language-properties line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-properties"}},[n("code",[n("span",{pre:!0,attrs:{class:"token attr-name"}},[s._v("errors.log.enable")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token attr-value"}},[s._v("true")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("通过配置"),n("code",[s._v("errors.log.include.messages = true")]),s._v("，还可以在输出中包含有关消息本身的元数据。此元数据中包括一些和上面提到的消息头中一样的项目，包括源消息的主题和偏移量。注意它不包括消息键或值本身。")]),s._v(" "),n("p",[s._v("这时的连接器配置如下：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST http://localhost:8083/connectors -H "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n        "name": "file_sink_04",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_json",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "file": "/data/file_sink_04.txt",\n                "errors.tolerance": "all",\n                "errors.log.enable":true,\n                "errors.log.include.messages":true\n                }\n        }\'')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("连接器是可以成功运行的：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://localhost:8083/connectors/file_sink_04/status"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    jq -c -M "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[.name,.tasks[].state]'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"file_sink_04"')]),s._v(","),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RUNNING"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nValid records from the "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" topic get written to the target file:\n$ "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" data/file_sink_04.txt\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("foo"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bar "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("…"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("这时去看Kafka连接器的工作节点日志，会发现每个失败的消息都有错误记录：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ERROR Error encountered in task file_sink_04-0. Executing stage 'VALUE_CONVERTER' with class 'org.apache.kafka.connect.json.JsonConverter', where consumed record is {topic='test_topic_json', partition=0, offset=94, timestamp=1548350164096, timestampType=CreateTime}. (org.apache.kafka.connect.runtime.errors.LogReporter)\norg.apache.kafka.connect.errors.DataException: Converting byte[] to Kafka Connect data failed due to serialization error:\n at org.apache.kafka.connect.json.JsonConverter.toConnectData(JsonConverter.java:334)\n[…]\nCaused by: org.apache.kafka.common.errors.SerializationException: com.fasterxml.jackson.core.JsonParseException: Unexpected character ('f' (code 102)): was expecting double-quote to start field name\n at [Source: (byte[])\"{foo:\"bar 5\"}\"; line: 1, column: 3]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("可以看到错误本身，还有就是和错误有关的信息：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("{topic='test_topic_json', partition=0, offset=94, timestamp=1548350164096, timestampType=CreateTime}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("如上所示，可以在kafkacat等工具中使用该主题和偏移量来检查源主题上的消息。根据抛出的异常也可能会看到记录的源消息：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('Caused by: org.apache.kafka.common.errors.SerializationException:\n…\nat [Source: (byte[])"{foo:"bar 5"}"; line: 1, column: 3]\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h2",{attrs:{id:"处理死信队列的消息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#处理死信队列的消息","aria-hidden":"true"}},[s._v("#")]),s._v(" 处理死信队列的消息")]),s._v(" "),n("p",[s._v("虽然设置了一个死信队列，但是如何处理那些“死信”呢？因为它只是一个Kafka主题，所以可以像使用任何其它主题一样使用标准的Kafka工具。上面已经看到了，比如可以使用kafkacat来检查消息头，并且对于消息的内容及其元数据的一般检查kafkacat也可以做。当然根据被拒绝的原因，也可以选择对消息进行重播。")]),s._v(" "),n("p",[s._v("一个场景是连接器正在使用Avro转换器，但是主题上的却是JSON格式消息（因此被写入死信队列）。可能由于遗留原因JSON和Avro格式的生产者都在写入源主题，这个问题得解决，但是目前只需要将管道流中的数据写入接收器即可。")]),s._v(" "),n("p",[s._v("首先，从初始的接收器读取源主题开始，使用Avro反序列化并路由到死信队列：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST http://localhost:8083/connectors -H "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n        "name": "file_sink_06__01-avro",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"test_topic_avro",\n                "file":"/data/file_sink_06.txt",\n                "key.converter": "io.confluent.connect.avro.AvroConverter",\n                "key.converter.schema.registry.url": "http://schema-registry:8081",\n                "value.converter": "io.confluent.connect.avro.AvroConverter",\n                "value.converter.schema.registry.url": "http://schema-registry:8081",\n                "errors.tolerance":"all",\n                "errors.deadletterqueue.topic.name":"dlq_file_sink_06__01",\n                "errors.deadletterqueue.topic.replication.factor":1,\n                "errors.deadletterqueue.context.headers.enable":true,\n                "errors.retry.delay.max.ms": 60000,\n                "errors.retry.timeout": 300000\n                }\n        }\'')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("另外再创建第二个接收器，将第一个接收器的死信队列作为源主题，并尝试将记录反序列化为JSON，在这里要更改的是"),n("code",[s._v("value.converter")]),s._v("、"),n("code",[s._v("key.converter")]),s._v("、源主题名和死信队列名（如果此连接器需要将任何消息路由到死信队列，要避免递归）。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Create_Second_Sink-e1552340041115.png",alt:""}})]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST http://localhost:8083/connectors -H "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: application/json"')]),s._v(" -d "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n        "name": "file_sink_06__02-json",\n        "config": {\n                "connector.class": "org.apache.kafka.connect.file.FileStreamSinkConnector",\n                "topics":"dlq_file_sink_06__01",\n                "file":"/data/file_sink_06.txt",\n                "value.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "value.converter.schemas.enable": false,\n                "key.converter":"org.apache.kafka.connect.json.JsonConverter",\n                "key.converter.schemas.enable": false,\n                "errors.tolerance":"all",\n                "errors.deadletterqueue.topic.name":"dlq_file_sink_06__02",\n                "errors.deadletterqueue.topic.replication.factor":1,\n                "errors.deadletterqueue.context.headers.enable":true,\n                "errors.retry.delay.max.ms": 60000,\n                "errors.retry.timeout": 300000\n                }\n        }\'')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("现在可以验证一下。")]),s._v(" "),n("p",[s._v("首先，源主题收到20条Avro消息，之后可以看到20条消息被读取并被原始Avro接收器接收：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Source_Records_Read_Avro_Sink_Records_Written-e1552335642875.png",alt:""}})]),s._v(" "),n("p",[s._v("然后发送8条JSON消息，这时8条消息被发送到死信队列，然后被JSON接收器接收：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/JSON_Records_Messages_DLQ_JSON_Sink-e1552335802462.png",alt:""}})]),s._v(" "),n("p",[s._v("现在再发送5条格式错误的JSON消息，之后可以看到两者都有失败的消息，有2点可以确认：")]),s._v(" "),n("ol",[n("li",[s._v("从Avro接收器发送到死信队列的消息数与成功发送的JSON消息数之间有差异；")]),s._v(" "),n("li",[s._v("消息被发送到JSON接收器的死信队列。")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Records_Requests-e1552335946185.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"通过ksql监控死信队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#通过ksql监控死信队列","aria-hidden":"true"}},[s._v("#")]),s._v(" 通过KSQL监控死信队列")]),s._v(" "),n("p",[s._v("除了使用JMX监控死信队列之外，还可以利用KSQL的聚合能力编写一个简单的流应用来监控消息写入队列的速率：")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 为每个死信队列主题注册流。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" STREAM dlq_file_sink_06__01（MSG "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),s._v("）"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v("（KAFKA_TOPIC "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dlq_file_sink_06__01'")]),s._v("，VALUE_FORMAT "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DELIMITED'")]),s._v("）"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" STREAM dlq_file_sink_06__02（MSG "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),s._v("）"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v("（KAFKA_TOPIC "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dlq_file_sink_06__02'")]),s._v("，VALUE_FORMAT "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DELIMITED'")]),s._v("）"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 从主题的开头消费数据")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'auto.offset.reset'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'earliest'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 使用其它列创建监控流，可用于后续聚合查询")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" STREAM DLQ_MONITOR "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("VALUE_FORMAT"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AVRO'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" \\\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dlq_file_sink_06__01'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" SINK_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Records: '")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" GROUP_COL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         MSG \\\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" dlq_file_sink_06__01"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 使用来自第二个死信队列的消息注入相同的监控流")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" DLQ_MONITOR \\\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'dlq_file_sink_06__02'")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" SINK_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Records: '")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" GROUP_COL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         MSG \\\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" dlq_file_sink_06__02"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 在每个死信队列每分钟的时间窗口内，创建消息的聚合视图")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" DLQ_MESSAGE_COUNT_PER_MIN "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" \\\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" TIMESTAMPTOSTRING"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("WINDOWSTART"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yyyy-MM-dd HH:mm:ss'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" START_TS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         SINK_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         GROUP_COL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n         "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("COUNT")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" DLQ_MESSAGE_COUNT \\\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" DLQ_MONITOR \\\n          WINDOW TUMBLING "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SIZE "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MINUTE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \\\n "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GROUP")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" SINK_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \\\n          GROUP_COL"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("p",[s._v("这个聚合表可以以交互式的方式进行查询，下面显示了一分钟内每个死信队列中的消息数量：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ksql> SELECT START_TS, SINK_NAME, DLQ_MESSAGE_COUNT FROM DLQ_MESSAGE_COUNT_PER_MIN;\n2019-02-01 02:56:00 | dlq_file_sink_06__01 | 9\n2019-02-01 03:10:00 | dlq_file_sink_06__01 | 8\n2019-02-01 03:12:00 | dlq_file_sink_06__01 | 5\n2019-02-01 02:56:00 | dlq_file_sink_06__02 | 5\n2019-02-01 03:12:00 | dlq_file_sink_06__02 | 5\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("因为这个表的下面是Kafka主题，所以可以将其路由到期望的任何监控仪表盘，还可以用于驱动告警。假定有几条错误消息是可以接受的，但是一分钟内超过5条消息就是个大问题需要关注：")]),s._v(" "),n("div",{staticClass:"language-sql line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-sql"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" DLQ_BREACH "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" \\\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" START_TS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" SINK_NAME"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" DLQ_MESSAGE_COUNT \\\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" DLQ_MESSAGE_COUNT_PER_MIN \\\n     "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" DLQ_MESSAGE_COUNT"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("现在又有了一个报警服务可以订阅的"),n("code",[s._v("DLQ_BREACH")]),s._v("主题，当收到任何消息时，可以触发适当的操作（例如通知）。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ksql> SELECT START_TS, SINK_NAME, DLQ_MESSAGE_COUNT FROM DLQ_BREACH;\n2019-02-01 02:56:00 | dlq_file_sink_06__01 | 9\n2019-02-01 03:10:00 | dlq_file_sink_06__01 | 8\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h2",{attrs:{id:"kafka连接器哪里没有提供错误处理？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kafka连接器哪里没有提供错误处理？","aria-hidden":"true"}},[s._v("#")]),s._v(" Kafka连接器哪里没有提供错误处理？")]),s._v(" "),n("p",[s._v("Kafka连接器的错误处理方式，如下表所示：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("连接器生命周期阶段")]),s._v(" "),n("th",[s._v("描述")]),s._v(" "),n("th",[s._v("是否处理错误？")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("开始")]),s._v(" "),n("td",[s._v("首次启动连接器时，其将执行必要的初始化，例如连接到数据存储")]),s._v(" "),n("td",[s._v("无")])]),s._v(" "),n("tr",[n("td",[s._v("拉取（针对源连接器）")]),s._v(" "),n("td",[s._v("从源数据存储读取消息")]),s._v(" "),n("td",[s._v("无")])]),s._v(" "),n("tr",[n("td",[s._v("格式转换")]),s._v(" "),n("td",[s._v("从Kafka主题读写数据并对JSON/Avro格式进行序列化/反序列化")]),s._v(" "),n("td",[s._v("有")])]),s._v(" "),n("tr",[n("td",[s._v("单消息转换")]),s._v(" "),n("td",[s._v("应用任何已配置的单消息转换")]),s._v(" "),n("td",[s._v("有")])]),s._v(" "),n("tr",[n("td",[s._v("接收（针对接收连接器）")]),s._v(" "),n("td",[s._v("将消息写入目标数据存储")]),s._v(" "),n("td",[s._v("无")])])])]),s._v(" "),n("p",[s._v("注意源连接器没有死信队列。")]),s._v(" "),n("h2",{attrs:{id:"错误处理配置流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#错误处理配置流程","aria-hidden":"true"}},[s._v("#")]),s._v(" 错误处理配置流程")]),s._v(" "),n("p",[s._v("关于连接器错误处理的配置，可以按照如下的流程一步步进阶：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://www.confluent.io/wp-content/uploads/Permutations_Error_Handling_Kafka_Connect_Configuration.png",alt:""}})]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("处理错误是任何稳定可靠的数据管道的重要组成部分，根据数据的使用方式，可以有两个选项。如果管道任何错误的消息都不能接受，表明上游存在严重的问题，那么就应该立即停止处理（这是Kafka连接器的默认行为）。")]),s._v(" "),n("p",[s._v("另一方面，如果只是想将数据流式传输到存储以进行分析或非关键性处理，那么只要不传播错误，保持管道稳定运行则更为重要。这时就可以定义错误的处理方式，推荐的方式是使用死信队列并密切监视来自Kafka连接器的可用JMX指标。")])])}),[],!1,null,null,null);a.default=e.exports}}]);