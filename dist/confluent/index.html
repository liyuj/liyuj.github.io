<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka连接器深度解读之JDBC源连接器 | Apache Ignite中文站</title>
    <meta name="description" content="Ignite内存计算平台的中文文档及相关资料">
    <link rel="shortcut icon" type="image/x-icon" href="https://ignite.apache.org/favicon.ico">
  <script src="https://hm.baidu.com/hm.js?03f40be28ff9a31fd798fd6b9dac0946"></script>
    
    <link rel="preload" href="/assets/css/0.styles.f86987ee.css" as="style"><link rel="preload" href="/assets/js/app.412b616b.js" as="script"><link rel="preload" href="/assets/js/10.8e8203a7.js" as="script"><link rel="prefetch" href="/assets/js/100.64422fc2.js"><link rel="prefetch" href="/assets/js/101.1179ca52.js"><link rel="prefetch" href="/assets/js/102.f0fbcad1.js"><link rel="prefetch" href="/assets/js/103.6233b7f6.js"><link rel="prefetch" href="/assets/js/104.f2ec6a89.js"><link rel="prefetch" href="/assets/js/105.65dc1f20.js"><link rel="prefetch" href="/assets/js/106.dabac401.js"><link rel="prefetch" href="/assets/js/107.8d478bfe.js"><link rel="prefetch" href="/assets/js/108.333839a6.js"><link rel="prefetch" href="/assets/js/109.c97593f3.js"><link rel="prefetch" href="/assets/js/11.202ada0f.js"><link rel="prefetch" href="/assets/js/110.c55987bd.js"><link rel="prefetch" href="/assets/js/111.680a7f8f.js"><link rel="prefetch" href="/assets/js/112.00dd9134.js"><link rel="prefetch" href="/assets/js/113.f456a29b.js"><link rel="prefetch" href="/assets/js/114.1111f87c.js"><link rel="prefetch" href="/assets/js/115.99d1fca5.js"><link rel="prefetch" href="/assets/js/116.5827665c.js"><link rel="prefetch" href="/assets/js/117.e4b1f5d2.js"><link rel="prefetch" href="/assets/js/12.da43ae1b.js"><link rel="prefetch" href="/assets/js/13.2a6fbeb4.js"><link rel="prefetch" href="/assets/js/14.65a7c9c4.js"><link rel="prefetch" href="/assets/js/15.722169a0.js"><link rel="prefetch" href="/assets/js/16.571393f5.js"><link rel="prefetch" href="/assets/js/17.899c831e.js"><link rel="prefetch" href="/assets/js/18.ea6a5616.js"><link rel="prefetch" href="/assets/js/19.040f7789.js"><link rel="prefetch" href="/assets/js/2.0b8aaecb.js"><link rel="prefetch" href="/assets/js/20.f628ebbf.js"><link rel="prefetch" href="/assets/js/21.73e1175c.js"><link rel="prefetch" href="/assets/js/22.9266b3a6.js"><link rel="prefetch" href="/assets/js/23.481de5ba.js"><link rel="prefetch" href="/assets/js/24.b45f18e6.js"><link rel="prefetch" href="/assets/js/25.645e0510.js"><link rel="prefetch" href="/assets/js/26.e630c248.js"><link rel="prefetch" href="/assets/js/27.40257737.js"><link rel="prefetch" href="/assets/js/28.f83517b5.js"><link rel="prefetch" href="/assets/js/29.5c7de173.js"><link rel="prefetch" href="/assets/js/3.d3c59160.js"><link rel="prefetch" href="/assets/js/30.b4412f36.js"><link rel="prefetch" href="/assets/js/31.437c8758.js"><link rel="prefetch" href="/assets/js/32.550158fd.js"><link rel="prefetch" href="/assets/js/33.4e198842.js"><link rel="prefetch" href="/assets/js/34.b5bbd597.js"><link rel="prefetch" href="/assets/js/35.cbeee8fd.js"><link rel="prefetch" href="/assets/js/36.6957cca2.js"><link rel="prefetch" href="/assets/js/37.d7bf8dbe.js"><link rel="prefetch" href="/assets/js/38.762b85ee.js"><link rel="prefetch" href="/assets/js/39.2d61f2a1.js"><link rel="prefetch" href="/assets/js/4.10c7f2ba.js"><link rel="prefetch" href="/assets/js/40.39c83aec.js"><link rel="prefetch" href="/assets/js/41.113a0d66.js"><link rel="prefetch" href="/assets/js/42.22ef9479.js"><link rel="prefetch" href="/assets/js/43.cbb0a84c.js"><link rel="prefetch" href="/assets/js/44.025632f3.js"><link rel="prefetch" href="/assets/js/45.25565275.js"><link rel="prefetch" href="/assets/js/46.f78db23a.js"><link rel="prefetch" href="/assets/js/47.5eb807f5.js"><link rel="prefetch" href="/assets/js/48.aab65a89.js"><link rel="prefetch" href="/assets/js/49.04294765.js"><link rel="prefetch" href="/assets/js/5.8a81e9fc.js"><link rel="prefetch" href="/assets/js/50.5304fc2e.js"><link rel="prefetch" href="/assets/js/51.8100c7b5.js"><link rel="prefetch" href="/assets/js/52.96c34a93.js"><link rel="prefetch" href="/assets/js/53.743ead38.js"><link rel="prefetch" href="/assets/js/54.7fc8cc30.js"><link rel="prefetch" href="/assets/js/55.c60d725a.js"><link rel="prefetch" href="/assets/js/56.84092c9a.js"><link rel="prefetch" href="/assets/js/57.af7ab3f6.js"><link rel="prefetch" href="/assets/js/58.ad40a388.js"><link rel="prefetch" href="/assets/js/59.e09ef91e.js"><link rel="prefetch" href="/assets/js/6.91205a0f.js"><link rel="prefetch" href="/assets/js/60.75589dfc.js"><link rel="prefetch" href="/assets/js/61.338a2e5a.js"><link rel="prefetch" href="/assets/js/62.0dc2b7a4.js"><link rel="prefetch" href="/assets/js/63.15bcd9a3.js"><link rel="prefetch" href="/assets/js/64.ee5dfcb3.js"><link rel="prefetch" href="/assets/js/65.690cb0d4.js"><link rel="prefetch" href="/assets/js/66.ef7fc66a.js"><link rel="prefetch" href="/assets/js/67.6a722259.js"><link rel="prefetch" href="/assets/js/68.dc286622.js"><link rel="prefetch" href="/assets/js/69.99de0332.js"><link rel="prefetch" href="/assets/js/7.3c31d9d0.js"><link rel="prefetch" href="/assets/js/70.64c87179.js"><link rel="prefetch" href="/assets/js/71.4fa1dabc.js"><link rel="prefetch" href="/assets/js/72.1320f18d.js"><link rel="prefetch" href="/assets/js/73.75b06019.js"><link rel="prefetch" href="/assets/js/74.5e39a5b8.js"><link rel="prefetch" href="/assets/js/75.8474449d.js"><link rel="prefetch" href="/assets/js/76.d9b1514f.js"><link rel="prefetch" href="/assets/js/77.9e4db3de.js"><link rel="prefetch" href="/assets/js/78.69a28186.js"><link rel="prefetch" href="/assets/js/79.2fb70321.js"><link rel="prefetch" href="/assets/js/8.447d2fe0.js"><link rel="prefetch" href="/assets/js/80.501e0615.js"><link rel="prefetch" href="/assets/js/81.f47904ce.js"><link rel="prefetch" href="/assets/js/82.40ece1cf.js"><link rel="prefetch" href="/assets/js/83.3e991c38.js"><link rel="prefetch" href="/assets/js/84.f4ab1f22.js"><link rel="prefetch" href="/assets/js/85.ba522441.js"><link rel="prefetch" href="/assets/js/86.1e708ae1.js"><link rel="prefetch" href="/assets/js/87.f2cf4473.js"><link rel="prefetch" href="/assets/js/88.c6603ddf.js"><link rel="prefetch" href="/assets/js/89.25c281a4.js"><link rel="prefetch" href="/assets/js/9.994821de.js"><link rel="prefetch" href="/assets/js/90.26cc2e16.js"><link rel="prefetch" href="/assets/js/91.63ff2709.js"><link rel="prefetch" href="/assets/js/92.e11925b5.js"><link rel="prefetch" href="/assets/js/93.0c6a5335.js"><link rel="prefetch" href="/assets/js/94.027eac0c.js"><link rel="prefetch" href="/assets/js/95.6ba5bc4f.js"><link rel="prefetch" href="/assets/js/96.7a7ec032.js"><link rel="prefetch" href="/assets/js/97.78833ca8.js"><link rel="prefetch" href="/assets/js/98.74cd85eb.js"><link rel="prefetch" href="/assets/js/99.e1b978bf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f86987ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Apache Ignite中文站</span></a> <div class="links" style="max-width:nullpx;"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/doc/cpp/" class="nav-link">C++</a></div><div class="nav-item"><a href="/doc/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="/doc/gridgain/" class="nav-link">商业版</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/confluent/" class="nav-link router-link-exact-active router-link-active">Confluent平台</a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">最新版本</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/confluent/" class="nav-link router-link-exact-active router-link-active">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/" class="nav-link">2.6.0</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/doc/java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/doc/cpp/" class="nav-link">C++</a></div><div class="nav-item"><a href="/doc/sql/" class="nav-link">SQL</a></div><div class="nav-item"><a href="/doc/integration/" class="nav-link">集成</a></div><div class="nav-item"><a href="/doc/spark/" class="nav-link">Ignite&amp;Spark</a></div><div class="nav-item"><a href="/doc/tools/" class="nav-link">工具</a></div><div class="nav-item"><a href="/doc/gridgain/" class="nav-link">商业版</a></div><div class="nav-item"><a href="https://my.oschina.net/liyuj" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/confluent/" class="nav-link router-link-exact-active router-link-active">Confluent平台</a></div><div class="nav-item"><a href="https://www.zybuluo.com/liyuj/note/230739" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">最新版本</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/confluent/" class="nav-link router-link-exact-active router-link-active">2.7.0</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/" class="nav-link">2.6.0</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/confluent/" class="active sidebar-link">Kafka连接器深度解读之JDBC源连接器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/confluent/#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/confluent/#jdbc驱动" class="sidebar-link">JDBC驱动</a></li><li class="sidebar-sub-header"><a href="/confluent/#指定要提取的表" class="sidebar-link">指定要提取的表</a></li><li class="sidebar-sub-header"><a href="/confluent/#增量提取" class="sidebar-link">增量提取</a></li><li class="sidebar-sub-header"><a href="/confluent/#基于查询的提取" class="sidebar-link">基于查询的提取</a></li><li class="sidebar-sub-header"><a href="/confluent/#一个还是多个连接器？" class="sidebar-link">一个还是多个连接器？</a></li><li class="sidebar-sub-header"><a href="/confluent/#为什么没有数据？" class="sidebar-link">为什么没有数据？</a></li><li class="sidebar-sub-header"><a href="/confluent/#重置jdbc源连接器读取数据的点" class="sidebar-link">重置JDBC源连接器读取数据的点</a></li><li class="sidebar-sub-header"><a href="/confluent/#配置kafka消息键" class="sidebar-link">配置Kafka消息键</a></li><li class="sidebar-sub-header"><a href="/confluent/#更改主题名称" class="sidebar-link">更改主题名称</a></li><li class="sidebar-sub-header"><a href="/confluent/#bytes-decimals-numerics和自定义类型" class="sidebar-link">Bytes, Decimals, Numerics和自定义类型</a></li><li class="sidebar-sub-header"><a href="/confluent/#处理多个表" class="sidebar-link">处理多个表</a></li></ul></li><li><a href="/confluent/Kafka-ConvertersSerialization.html" class="sidebar-link">Kafka连接器深度解读之转换器和序列化</a></li><li><a href="/confluent/Kafka-ErrorHandlingDeadLetterQueues.html" class="sidebar-link">Kafka连接器深度解读之错误处理和死信队列</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="kafka连接器深度解读之jdbc源连接器"><a href="#kafka连接器深度解读之jdbc源连接器" aria-hidden="true" class="header-anchor">#</a> Kafka连接器深度解读之JDBC源连接器</h1> <p>在现实业务中，Kafka经常会遇到的一个集成场景就是，从数据库获取数据，因为关系数据库是一个非常丰富的事件源。数据库中的现有数据以及对该数据的任何更改都可以流式传输到Kafka主题中，在这里这些事件可用于驱动应用，也可以流式传输到其它数据存储（比如搜索引擎或者缓存）用于分析等。</p> <p>实现这个需求有很多种做法，但是在本文中，会聚焦其中的一个解决方案，即Kafka连接器中的JDBC连接器，讲述如何进行配置，以及一些问题排查的技巧，至于更多的细节，请参见Kafka的文档。</p> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>Kafka连接器中的JDBC连接器包含在Confluent Platform中，也可以与Confluent Hub分开安装。它可以作为源端从数据库提取数据到Kafka，也可以作为接收端从一个Kafka主题中将数据推送到数据库。几乎所有关系数据库都提供JDBC驱动，包括Oracle、Microsoft SQL Server、DB2、MySQL和Postgres。</p> <p><img src="https://www.confluent.io/wp-content/uploads/JDBC-connector.png" alt></p> <p>下面将从最简单的Kafka连接器配置开始，然后进行构建。本文中的示例是从MySQL数据库中提取数据，该数据库有两个模式，每个模式都有几张表：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; SELECT table_schema, table_name FROM INFORMATION_SCHEMA.tables WHERE TABLE_SCHEMA != 'information_schema';
+--------------+--------------+
| TABLE_SCHEMA | TABLE_NAME   |
+--------------+--------------+
| demo         | accounts     |
| demo         | customers    |
| demo         | transactions |
| security     | firewall     |
| security     | log_events   |
+--------------+--------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="jdbc驱动"><a href="#jdbc驱动" aria-hidden="true" class="header-anchor">#</a> JDBC驱动</h2> <p>在进行配置之前，要确保Kafka连接器可以实际连接到数据库，即确保JDBC驱动可用。如果使用的是SQLite或Postgres，那么驱动已经包含在内，就可以跳过此步骤。对于所有其它数据库，需要将相关的JDBC驱动JAR文件放在和<code>kafka-connect-jdbc</code>JAR相同的文件夹中。此文件夹的标准位置为：</p> <ol><li>Confluent CLI：下载的Confluent Platform文件夹中的<code>share/java/kafka-connect-jdbc/</code>；</li> <li>Docker，DEB / RPM安装：<code>/usr/share/java/kafka-connect-jdbc/</code>，关于如何将JDBC驱动添加到Kafka连接器的Docker容器，请参阅<a href="https://rmoff.net/2018/12/15/docker-tips-and-tricks-with-ksql-and-kafka/" target="_self" rel="noopener noreferrer">此处</a>；</li> <li>如果<code>kafka-connect-jdbc</code>JAR位于其它位置，则可以使用<code>plugin.path</code>指向包含它的文件夹，并确保JDBC驱动位于同一文件夹中。</li></ol> <p>还可以在启动Kafka连接器时指定<code>CLASSPATH</code>，设置为可以找到JDBC驱动的位置。一定要将其设置为JAR本身，而不仅仅是包含它的文件夹，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CLASSPATH=/u01/jdbc-drivers/mysql-connector-java-8.0.13.JAR ./bin/connect-distributed ./etc/kafka/connect-distributed.properties
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>两个事情要注意一下：</p> <ol><li>如果<code>kafka-connect-jdbc</code>JAR位于其它位置，则Kafka连接器的<code>plugin.path</code>选项将无法直接指向JDBC驱动JAR文件 。根据文档，每个JDBC驱动JAR必须与<code>kafka-connect-jdbc</code>JAR位于同一目录；</li> <li>如果正在运行多节点Kafka连接器集群，则需要在集群中的每个连接器工作节点上都正确安装JDBC驱动JAR。</li></ol> <p><strong>找不到合适的驱动</strong></p> <p>与JDBC连接器有关的常见错误是<code>No suitable driver found</code>，比如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{&quot;error_code&quot;:400,&quot;message&quot;:&quot;Connector configuration is invalid and contains the following 2 error(s):\nInvalid value java.sql.SQLException: No suitable driver found for jdbc:mysql://X.X.X.X:3306/test_db?user=root&amp;password=pwd for configuration Couldn't open connection to jdbc:mysql://X.X.X.X:3306/test_db?user=root&amp;password=pwd\nInvalid value java.sql.SQLException: No suitable driver found for jdbc:mysql://X.X.X.X:3306/test_db?user=root&amp;password=admin for configuration Couldn't open connection to jdbc:mysql://X.X.X.X:3306/test_db?user=root&amp;password=pwd\nYou can also find the above list of errors at the endpoint `/{connectorType}/config/validate`&quot;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这可能有2个原因：</p> <ol><li>未加载正确的JDBC驱动；</li> <li>JDBC URL不正确。</li></ol> <p><strong>确认是否已加载JDBC驱动</strong></p> <p>Kafka连接器会加载与<code>kafka-connect-jdbc</code>JAR文件在同一文件夹中的所有JDBC驱动，还有在<code>CLASSPATH</code>上找到的任何JDBC驱动。如果要验证一下，可以将连接器工作节点的<a href="https://rmoff.github.io/post/kafka-connect-change-log-level-and-write-log-to-file/" target="_self" rel="noopener noreferrer">日志级别调整</a>为<code>DEBUG</code>，然后会看到如下信息：</p> <p>1.<code>DEBUG Loading plugin urls</code>：包含<code>kafka-connect-jdbc-5.1.0.jar</code>（或者对应当前正在运行的版本号）的一组JAR文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DEBUG Loading plugin urls: [file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/audience-annotations-0.5.0.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/common-utils-5.1.0.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/jline-0.9.94.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/jtds-1.3.1.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/kafka-connect-jdbc-5.1.0.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/mysql-connector-java-8.0.13.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/netty-3.10.6.Final.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/postgresql-9.4-1206-jdbc41.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/slf4j-api-1.7.25.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/sqlite-jdbc-3.25.2.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/zkclient-0.10.jar, file:/Users/Robin/cp/confluent-5.1.0/share/java/kafka-connect-jdbc/zookeeper-3.4.13.jar] (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在这个JAR列表中，应该有JDBC驱动JAR。在上面的输出中，可以看到MySQL、Postgres和SQLite的JAR。如果期望的JDBC驱动JAR不在，可以将驱动放入<code>kafka-connect-jdbc</code>JAR所在的文件夹中。</p> <p>2.<code>INFO Added plugin 'io.confluent.connect.jdbc.JdbcSourceConnector'</code>：在此之后，在记录任何其它插件之前，可以看到JDBC驱动已注册：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INFO Added plugin 'io.confluent.connect.jdbc.JdbcSourceConnector' (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
DEBUG Registered java.sql.Driver: jTDS 1.3.1 to java.sql.DriverManager (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
DEBUG Registered java.sql.Driver: com.mysql.cj.jdbc.Driver@7bbbb6a8 to java.sql.DriverManager (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
DEBUG Registered java.sql.Driver: org.postgresql.Driver@ea9e141 to java.sql.DriverManager (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
DEBUG Registered java.sql.Driver: org.sqlite.JDBC@236134a1 to java.sql.DriverManager (org.apache.kafka.connect.runtime.isolation.DelegatingClassLoader)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>确认JDBC驱动包含在已注册的列表中。如果没有，那么就是安装不正确。</p> <p>注意，虽然可能会在日志的其它地方看到驱动的<code>Registered java.sql.Driver</code>信息，但如果要确认其对于JDBC连接器可用，那么它必须<code>直接</code>出现在<code>INFO Added plugin 'io.confluent.connect.jdbc</code>消息的后面。</p> <p><strong>JDBC URL</strong></p> <p>对于源数据库来说JDBC URL必须是正确的，如果搞错了，那么Kafka连接器即使驱动正确，也是不行。以下是一些常见的JDBC URL格式：</p> <table><thead><tr><th>数据库</th> <th>下载地址</th> <th>JDBC URL</th></tr></thead> <tbody><tr><td>IBM DB2</td> <td><a href="https://www-01.ibm.com/support/docview.wss?uid=swg21363866" target="_self" rel="noopener noreferrer">下载</a></td> <td><code>jdbc:db2://&lt;host&gt;:&lt;port50000&gt;/&lt;database&gt;</code></td></tr> <tr><td>IBM Informix</td> <td></td> <td><code>jdbc:informix-sqli://:/:informixserver=&lt;debservername&gt;</code></td></tr> <tr><td>MS SQL</td> <td><a href="https://docs.microsoft.com/en-us/sql/connect/jdbc/microsoft-jdbc-driver-for-sql-server?view=sql-server-2017" target="_self" rel="noopener noreferrer">下载</a></td> <td><code>jdbc:sqlserver://&lt;host&gt;[:&lt;port1433&gt;];databaseName=&lt;database&gt;</code></td></tr> <tr><td>MySQL</td> <td><a href="https://dev.mysql.com/downloads/connector/j/" target="_self" rel="noopener noreferrer">下载</a></td> <td><code>jdbc:mysql://&lt;host&gt;:&lt;port3306&gt;/&lt;database&gt;</code></td></tr> <tr><td>Oracle</td> <td><a href="https://www.oracle.com/technetwork/database/application-development/jdbc/downloads/index.html" target="_self" rel="noopener noreferrer">下载</a></td> <td><code>jdbc:oracle:thin://&lt;host&gt;:&lt;port&gt;/&lt;service&gt; or jdbc:oracle:thin:&lt;host&gt;:&lt;port&gt;:&lt;SID&gt;</code></td></tr> <tr><td>Postgres</td> <td>Kafka连接器自带</td> <td><code>jdbc:postgresql://&lt;host&gt;:&lt;port5432&gt;/&lt;database&gt;</code></td></tr> <tr><td>Amazon Redshift</td> <td><a href="https://docs.aws.amazon.com/redshift/latest/mgmt/configure-jdbc-connection.html#download-jdbc-driver" target="_self" rel="noopener noreferrer">下载</a></td> <td><code>jdbc:redshift://&lt;server&gt;:&lt;port5439&gt;/&lt;database&gt;</code></td></tr> <tr><td>Snowflake</td> <td></td> <td><code>jdbc:snowflake://&lt;account_name&gt;.snowflakecomputing.com/?&lt;connection_params&gt;</code></td></tr></tbody></table> <p>注意，虽然JDBC URL通常允许嵌入身份验证信息，但这些内容将以<strong>明文形式</strong>记录在Kafka连接器日志中。因此应该使用单独的<code>connection.user</code>和<code>connection.password</code>配置项，这样在记录时会被合理地处理。</p> <h2 id="指定要提取的表"><a href="#指定要提取的表" aria-hidden="true" class="header-anchor">#</a> 指定要提取的表</h2> <p>JDBC驱动安装完成之后，就可以配置Kafka连接器从数据库中提取数据了。下面是最小的配置，不过它不一定是最有用的，因为它是数据的批量导入，在本文后面会讨论如何进行增量加载。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_01&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-01-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>使用此配置，每个表（用户有权访问）将完全复制到Kafka，通过使用KSQL列出Kafka集群上的主题，我们可以看到：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; LIST TOPICS;

 Kafka Topic            | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups
----------------------------------------------------------------------------------------------------
 mysql-01-accounts      | false      | 1          | 1                  | 0         | 0
 mysql-01-customers     | false      | 1          | 1                  | 0         | 0
 mysql-01-firewall      | false      | 1          | 1                  | 0         | 0
 mysql-01-log_events    | false      | 1          | 1                  | 0         | 0
 mysql-01-transactions  | false      | 1          | 1                  | 0         | 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>注意<code>mysql-01</code>前缀，表格内容的完整副本将每五秒刷新一次，可以通过修改<code>poll.interval.ms</code>进行调整，例如每小时刷新一次：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_02&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-02-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;poll.interval.ms&quot; : 3600000
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>找个主题确认一下，显示完整的数据，看看是不是自己想要的：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; PRINT 'mysql-02-accounts' FROM BEGINNING;
Format:AVRO
12/20/18 3:18:44 PM UTC, null, {&quot;id&quot;: 1, &quot;first_name&quot;: &quot;Hamel&quot;, &quot;last_name&quot;: &quot;Bly&quot;, &quot;username&quot;: &quot;Hamel Bly&quot;, &quot;company&quot;: &quot;Erdman-Halvorson&quot;, &quot;created_date&quot;: 17759}
12/20/18 3:18:44 PM UTC, null, {&quot;id&quot;: 2, &quot;first_name&quot;: &quot;Scottie&quot;, &quot;last_name&quot;: &quot;Geerdts&quot;, &quot;username&quot;: &quot;Scottie Geerdts&quot;, &quot;company&quot;: &quot;Mante Group&quot;, &quot;created_date&quot;: 17692}
12/20/18 3:18:44 PM UTC, null, {&quot;id&quot;: 3, &quot;first_name&quot;: &quot;Giana&quot;, &quot;last_name&quot;: &quot;Bryce&quot;, &quot;username&quot;: &quot;Giana Bryce&quot;, &quot;company&quot;: &quot;Wiza Inc&quot;, &quot;created_date&quot;: 17627}
12/20/18 3:18:44 PM UTC, null, {&quot;id&quot;: 4, &quot;first_name&quot;: &quot;Allen&quot;, &quot;last_name&quot;: &quot;Rengger&quot;, &quot;username&quot;: &quot;Allen Rengger&quot;, &quot;company&quot;: &quot;Terry, Jacobson and Daugherty&quot;, &quot;created_date&quot;: 17746}
12/20/18 3:18:44 PM UTC, null, {&quot;id&quot;: 5, &quot;first_name&quot;: &quot;Reagen&quot;, &quot;last_name&quot;: &quot;Volkes&quot;, &quot;username&quot;: &quot;Reagen Volkes&quot;, &quot;company&quot;: &quot;Feeney and Sons&quot;, &quot;created_date&quot;: 17798}
…
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>目前会展示所有可用的表，这可能不是实际的需求，可能只希望包含特定模式的表，这个可以使用<code>catalog.pattern/schema.pattern</code>（具体哪一个取决于数据库）配置项进行控制：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_03&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-03-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;poll.interval.ms&quot; : 3600000,
                &quot;catalog.pattern&quot; : &quot;demo&quot;
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样就只会从<code>demo</code>模式中取得3张表：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ksql<span class="token operator">&gt;</span> LIST TOPICS<span class="token punctuation">;</span>

 Kafka Topic            <span class="token operator">|</span> Registered <span class="token operator">|</span> Partitions <span class="token operator">|</span> Partition Replicas <span class="token operator">|</span> Consumers <span class="token operator">|</span> ConsumerGroups
----------------------------------------------------------------------------------------------------
<span class="token punctuation">[</span>…<span class="token punctuation">]</span>
 mysql-03-accounts      <span class="token operator">|</span> <span class="token boolean">false</span>      <span class="token operator">|</span> 1          <span class="token operator">|</span> 1                  <span class="token operator">|</span> 0         <span class="token operator">|</span> 0
 mysql-03-customers     <span class="token operator">|</span> <span class="token boolean">false</span>      <span class="token operator">|</span> 1          <span class="token operator">|</span> 1                  <span class="token operator">|</span> 0         <span class="token operator">|</span> 0
 mysql-03-transactions  <span class="token operator">|</span> <span class="token boolean">false</span>      <span class="token operator">|</span> 1          <span class="token operator">|</span> 1                  <span class="token operator">|</span> 0         <span class="token operator">|</span> 0
<span class="token punctuation">[</span>…<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>也可以使用<code>table.whitelist</code>（白名单）或<code>table.blacklist</code>（黑名单）来控制连接器提取的表，下面的示例显式地列出了希望拉取到Kafka中的表清单：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_04&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-04-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;poll.interval.ms&quot; : 3600000,
                &quot;catalog.pattern&quot; : &quot;demo&quot;,
                &quot;table.whitelist&quot; : &quot;accounts&quot;
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这时就只有一个表从数据库流式传输到Kafka：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ksql<span class="token operator">&gt;</span> LIST TOPICS<span class="token punctuation">;</span>

 Kafka Topic            <span class="token operator">|</span> Registered <span class="token operator">|</span> Partitions <span class="token operator">|</span> Partition Replicas <span class="token operator">|</span> Consumers <span class="token operator">|</span> ConsumerGroups
----------------------------------------------------------------------------------------------------
 mysql-04-accounts      <span class="token operator">|</span> <span class="token boolean">false</span>      <span class="token operator">|</span> 1          <span class="token operator">|</span> 1                  <span class="token operator">|</span> 0         <span class="token operator">|</span> 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为只有一个表，下面的配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;catalog.pattern&quot; : &quot;demo&quot;,
&quot;table.whitelist&quot; : &quot;accounts&quot;,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>等同于：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;table.whitelist&quot; : &quot;demo.accounts&quot;,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以在一个模式中指定多个表，比如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;catalog.pattern&quot; : &quot;demo&quot;,
&quot;table.whitelist&quot; : &quot;accounts, customers&quot;,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>或者也可以跨越多个模式：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;table.whitelist&quot; : &quot;demo.accounts, security.firewall&quot;,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>还可以使用其它的表过滤选项，比如<code>table.types</code>可以选择表之外的对象，例如视图。</p> <p>过滤表时要注意，因为如果最终没有对象匹配该模式（或者连接到数据库的已认证用户没有权限访问），那么连接器将报错：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INFO After filtering the tables are:  (io.confluent.connect.jdbc.source.TableMonitorThread)
…
ERROR Failed to reconfigure connector's tasks, retrying after backoff: (org.apache.kafka.connect.runtime.distributed.DistributedHerder)
java.lang.IllegalArgumentException: Number of groups must be positive
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在通过<code>table.whitelist/table.blacklist</code>进行过滤之前，可以将日志级别调整为<code>DEBUG</code>，查看用户可以访问的表清单：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DEBUG Got the following tables: [&quot;demo&quot;.&quot;accounts&quot;, &quot;demo&quot;.&quot;customers&quot;] (io.confluent.connect.jdbc.source.TableMonitorThread)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后，连接器会根据提供的白名单/黑名单过滤此列表，因此要确认指定的列表位于连接器可用的列表中，还要注意连接用户要有权限访问这些表，因此还要检查数据库端的<code>GRANT</code>语句。</p> <h2 id="增量提取"><a href="#增量提取" aria-hidden="true" class="header-anchor">#</a> 增量提取</h2> <p>到目前为止，已经按计划将整张表都拉取到Kafka，这虽然对于转存数据非常有用，不过都是批量并且并不总是适合将源数据库集成到Kafka流系统中。</p> <p>JDBC连接器还有一个<a href="https://docs.confluent.io/5.1.0/connect/kafka-connect-jdbc/source-connector/source_config_options.html#mode" target="_self" rel="noopener noreferrer">流式传输到Kafka</a>的选项，它只会传输上次拉取后的数据变更，具体可以基于自增列（例如自增主键）和/或时间戳（例如最后更新时间戳）来执行此操作。在模式设计中的常见做法是使用这些中的一个或两个，例如，事务表<code>ORDERS</code>可能有：</p> <ul><li><code>ORDER_ID</code>：一个唯一键（可能是主键），每个新订单递增；</li> <li><code>UPDATE_TS</code>：每次数据变更时更新的时间戳列。</li></ul> <p>可以使用<code>mode</code>参数配置该选项，比如使用<code>timestamp</code>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_08&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-08-&quot;,
                &quot;mode&quot;:&quot;timestamp&quot;,
                &quot;table.whitelist&quot; : &quot;demo.accounts&quot;,
                &quot;timestamp.column.name&quot;: &quot;UPDATE_TS&quot;,
                &quot;validate.non.null&quot;: false
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>下面会获取表的全部数据，外加源数据后续的更新和插入：</p> <p><img src="https://www.confluent.io/wp-content/uploads/incremental_ingest.gif" alt></p> <p>注意：</p> <ul><li>可以结合使用这些方法中的（时间戳/自增）或两者（时间戳+自增）；</li> <li>要使用的时间戳和/或自增列必须在连接器处理的所有表上。如果不同的表具有不同名称的时间戳/自增列，则需要创建单独的连接器配置；</li> <li>如果只使用自增列，则不会捕获对数据的更新，除非每次更新时自增列也会增加（在主键的情况下几乎不可能）；</li> <li>某些表可能没有唯一的标识，或者有多个组合的列表示行的唯一标识（联合主键），不过JDBC连接器只支持单个标识列；</li> <li><code>时间戳+自增列</code>选项为识别新行和更新行提供了最大的覆盖范围；</li> <li>许多RDBMS支持声明更新时间戳列的DDL，该列会自动更新。例如：
<ul><li>MySQL：</li></ul></li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo <span class="token punctuation">(</span>
        …
        UPDATE_TS <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>Postgres：</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo <span class="token punctuation">(</span>
        …
        UPDATE_TS <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- Courtesy of https://techblog.covermymeds.com/databases/on-update-timestamps-mysql-vs-postgres/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> update_updated_at_column<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">trigger</span>
    <span class="token keyword">LANGUAGE</span> plpgsql
    <span class="token keyword">AS</span> $$
  <span class="token keyword">BEGIN</span>
    NEW<span class="token punctuation">.</span>update_ts <span class="token operator">=</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span>
  <span class="token keyword">END</span><span class="token punctuation">;</span>
$$<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> t1_updated_at_modtime BEFORE <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> foo <span class="token keyword">FOR EACH ROW</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span> update_updated_at_column<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>Oracle：</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> foo <span class="token punctuation">(</span>
        …
        CREATE_TS <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">TRIGGER</span> TRG_foo_UPD
BEFORE <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> foo
REFERENCING NEW <span class="token keyword">AS</span> NEW_ROW
  <span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">SELECT</span> SYSDATE
        <span class="token keyword">INTO</span> :NEW_ROW<span class="token punctuation">.</span>UPDATE_TS
        <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="基于查询的提取"><a href="#基于查询的提取" aria-hidden="true" class="header-anchor">#</a> 基于查询的提取</h2> <p>有时可能想从RDBMS中提取数据，但希望有比整个表更灵活的方式，原因可能包括：</p> <ul><li>一个有许多列的宽表，但是只希望有部分列被传输到Kafka主题上；</li> <li>表中包含敏感信息，不希望这些信息传输到Kafka主题上（尽管也可以提取时在Kafka连接器中使用单消息转换进行处理）；</li> <li>多个表之间存在依赖关系，因此在传输到Kafka之前，可能希望将其解析为一个单一的一致性视图。</li></ul> <p>这可以使用JDBC连接器的<code>query</code>模式。在了解如何实现之前，需要注意以下几点：</p> <ul><li>谨防管道的“过早优化”，仅仅因为不需要源表中的某些列或行，而不是说在流式传输到Kafka时不应包含它们；</li> <li>正如将在下面看到的，当涉及增量摄取时，<code>query</code>模式可能不那么灵活，因此从源中简单地删除列的另一种方法（无论是简单地减少数量，还是因为敏感信息）都是在连接器本身中使用<code>ReplaceField</code>单消息转换；</li> <li>随着查询越来越复杂（例如解析关联），潜在的压力和对源数据库的影响会增加；</li> <li>在RDBMS（作为源头）中关联数据是解决关联的一种方法，另一种方法是将源表流式传输到单独的Kafka主题，然后使用KSQL或Kafka Streams根据需求进行关联（过滤和标记数据也是如此），KSQL是在Kafka中对数据进行<code>后处理</code>的绝佳方式，使管道尽可能简单。</li></ul> <p>下面将展示如何将<code>transactions</code>表，再加上<code>customers</code>表中的数据流式传输到Kafka：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_09&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-09&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;query&quot;:&quot;SELECT t.txn_id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id;&quot;,
                &quot;poll.interval.ms&quot; : 3600000
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可能注意到已切换回<code>bulk</code>模式，可以使用主键或者时间戳其中一个增量选项，但要确保在SELECT子句中包含相应的主键/时间戳列（例如<code>txn_id</code>）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_10&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-10&quot;,
                &quot;mode&quot;:&quot;incrementing&quot;,
                &quot;query&quot;:&quot;SELECT txn_id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id&quot;,
                &quot;incrementing.column.name&quot;: &quot;txn_id&quot;,
                &quot;validate.non.null&quot;: false
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>如果不包括该列（即使它存在于源表中），那么连接器会报错并显示<code>org.apache.kafka.connect.errors.DataException</code>异常（<a href="https://github.com/confluentinc/kafka-connect-jdbc/issues/561" target="_self" rel="noopener noreferrer">＃561</a>）或<code>java.lang.NullPointerException</code>异常（<a href="https://github.com/confluentinc/kafka-connect-jdbc/issues/560" target="_self" rel="noopener noreferrer">＃560</a>），这是因为连接器需要在返回的数据中获取值，以便可以存储相应偏移量的最新值。</p> <p>如果使用<code>query</code>选项，除非使用<code>mode: bulk</code>（<a href="https://github.com/confluentinc/kafka-connect-jdbc/issues/566" target="_self" rel="noopener noreferrer">＃566</a>），否则无法指定自己的WHERE子句，也就是说，在查询中使用自己的谓词和使用Kafka进行增量提取之间是互斥的。</p> <h2 id="一个还是多个连接器？"><a href="#一个还是多个连接器？" aria-hidden="true" class="header-anchor">#</a> 一个还是多个连接器？</h2> <p>如果需要不同的参数设定，可以创建新的连接器，例如，可能希望有不同的参数：</p> <ul><li>包含自增主键和/或时间戳的列的名称；</li> <li>轮询表的频率；</li> <li>连接数据库的用户不同。</li></ul> <p>简单来说，如果所有表参数都一样，则可以使用单个连接器。</p> <h2 id="为什么没有数据？"><a href="#为什么没有数据？" aria-hidden="true" class="header-anchor">#</a> 为什么没有数据？</h2> <p>创建连接器之后，可能在目标Kafka主题中看不到任何数据。下面会一步步进行诊断：</p> <p>1.查询<code>/connectors</code>端点，可确认连接器是否创建成功：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s“http：// localhost：8083 / connectors”
<span class="token punctuation">[</span> “jdbc_source_mysql_10”<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>应该看到连接器列表，如果没有，则需要按照之前的步骤进行创建，然后关注Kafka连接器返回的任何错误。</p> <p>2.检查连接器及其任务的状态：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s <span class="token string">&quot;http://localhost:8083/connectors/jdbc_source_mysql_10/status&quot;</span><span class="token operator">|</span>jq <span class="token string">'.'</span>
<span class="token punctuation">{</span>
<span class="token string">&quot;name&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;jdbc_source_mysql_10&quot;</span>,
<span class="token string">&quot;connector&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
<span class="token string">&quot;state&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;RUNNING&quot;</span>,
<span class="token string">&quot;worker_id&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;kafka-connect:8083&quot;</span>
<span class="token punctuation">}</span>,
<span class="token string">&quot;tasks&quot;</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>
<span class="token string">&quot;state&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;RUNNING&quot;</span>,
<span class="token string">&quot;id&quot;</span><span class="token keyword">:</span> 0,
<span class="token string">&quot;worker_id&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;kafka-connect:8083&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">]</span>,
<span class="token string">&quot;type&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;source&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>正常应该看到所有的连接器和任务的<code>state</code>都是<code>RUNNING</code>，不过<code>RUNNING</code>不总是意味着正常。</p> <p>3.如果连接器或任务的状态是<code>FAILED</code>，或者即使状态是<code>RUNNING</code>但是没有按照预期行为运行，那么可以转到Kafka连接器工作节点的输出（<a href="https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained#finding-connect-worker-log" target="_self" rel="noopener noreferrer">这里</a>有相关的说明），这里会显示是否存在任何实际的问题。以上面的连接器为例，其状态为<code>RUNNING</code>，但是连接器工作节点日志中实际上全是重复的错误：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ERROR Failed to run query for table TimestampIncrementingTableQuerier{table=null, query='SELECT t.id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id;', topicPrefix='mysql-10', incrementingColumn='t.id', timestampColumns=[]}: {} (io.confluent.connect.jdbc.source.JdbcSourceTask)
java.sql.SQLSyntaxErrorException: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'WHERE `t.id` &gt; -1 ORDER BY `t.id` ASC' at line 1
 at com.mysql.cj.jdbc.exceptions.SQLError.createSQLException(SQLError.java:120)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>4.在这里，问题是什么并不明确，需要调出连接器的配置来检查指定的查询是否正确：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s <span class="token string">&quot;http://localhost:8083/connectors/jdbc_source_mysql_10/config&quot;</span><span class="token operator">|</span>jq <span class="token string">'.'</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;connector.class&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;</span>,
  <span class="token string">&quot;mode&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;incrementing&quot;</span>,
  <span class="token string">&quot;incrementing.column.name&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;t.id&quot;</span>,
  <span class="token string">&quot;topic.prefix&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;mysql-10&quot;</span>,
  <span class="token string">&quot;connection.password&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;asgard&quot;</span>,
  <span class="token string">&quot;validate.non.null&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;false&quot;</span>,
  <span class="token string">&quot;connection.user&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;connect_user&quot;</span>,
  <span class="token string">&quot;query&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;SELECT t.id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id;&quot;</span>,
  <span class="token string">&quot;name&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;jdbc_source_mysql_10&quot;</span>,
  <span class="token string">&quot;connection.url&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;jdbc:mysql://mysql:3306/demo&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>5.在MySQL中运行此查询发现能正常执行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; SELECT t.id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id;
+------+-------------+--------+----------+----------------------+------------+-----------+----------------------------+--------+------------------------------------------------------+
| id   | customer_id | amount | currency | txn_timestamp        | first_name | last_name | email                      | gender | comments                                             |
+------+-------------+--------+----------+----------------------+------------+-----------+----------------------------+--------+------------------------------------------------------+
|    1 |           5 | -72.97 | RUB      | 2018-12-12T13:58:37Z | Modestia   | Coltart   | mcoltart4@scribd.com       | Female | Reverse-engineered non-volatile success
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>6.所以肯定是Kafka连接器在执行时做了什么。鉴于错误消息引用<code>t.id</code>，这是在<code>incrementing.column.name</code>参数中指定的，可能问题与此有关。通过将Kafka连接器的日志级别调整为<code>DEBUG</code>，可以看到执行的完整SQL语句：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DEBUG TimestampIncrementingTableQuerier{table=null, query='SELECT t.id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id;', topicPrefix='mysql-10', incrementingColumn='t.id', timestampColumns=[]} prepared SQL query: SELECT t.id, t.customer_id, t.amount, t.currency, t.txn_timestamp, c.first_name, c.last_name, c.email, c.gender, c.comments FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id; WHERE `t.id` &gt; ? ORDER BY `t.id` ASC (io.confluent.connect.jdbc.source.TimestampIncrementingTableQuerier)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>7.看一下该<code>prepared SQL query</code>部分，可能会发现：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[…] FROM demo.transactions t LEFT OUTER JOIN demo.customers c on t.customer_id = c.id; WHERE `t.id` &gt; ? ORDER BY `t.id` ASC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>8.注意在<code>JOIN</code>子句的<code>c.id</code>后面有语句终止符（;），后面有WHERE子句。该<code>WHERE</code>子句由Kafka连接器附加，用于实现所要求的<code>incrementing</code>模式，但创建了一个无效的SQL语句；
9.然后在GitHub中查找与看到的错误相关的问题，因为有时它实际上是一个已知的问题，例如这个问题；
10.如果连接器存在并且是<code>RUNNING</code>，并且Kafka连接器工作节点日志中也没有错误，还应该检查：</p> <pre><code>- 连接器的提取间隔是多少？也许它完全按照配置运行，并且源表中的数据已经更改，但就是没有拉取到新数据。要检查这一点，可以在Kafka连接器工作节点的输出中查找`JdbcSourceTaskConfig`的值和`poll.interval.ms`的值；
- 如果正在使用的是增量摄取，Kafka连接器关于偏移量是如何存储的？如果删除并重建相同名称的连接器，则将保留前一个实例的偏移量。考虑这样的场景，创建完连接器之后，成功地将所有数据提取到源表中的给定主键或时间戳值，然后删除并重新创建了它，新版本的连接器将获得之前版本的偏移量，因此仅提取比先前处理的数据更新的数据，具体可以通过查看保存在其中的`offset.storage.topic`值和相关表来验证这一点。
</code></pre> <h2 id="重置jdbc源连接器读取数据的点"><a href="#重置jdbc源连接器读取数据的点" aria-hidden="true" class="header-anchor">#</a> 重置JDBC源连接器读取数据的点</h2> <p>当Kafka连接器以分布式模式运行时，它会在Kafka主题（通过<code>offset.storage.topic</code>配置）中存储有关它在源系统中读取的位置（称为偏移量）的信息，当连接器任务重启时，它可以从之前的位置继续进行处理，具体可以在连接器工作节点日志中看到：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INFO Found offset {{protocol=1, table=demo.accounts}={timestamp_nanos=0, timestamp=1547030056000}, {table=accounts}=null} for partition {protocol=1, table=demo.accounts} (io.confluent.connect.jdbc.source.JdbcSourceTask)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>每次连接器轮询时，都会使用这个偏移量，它会使用预编译的SQL语句，并且使用Kafka连接器任务传递的值替换<code>?</code>占位符：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DEBUG TimestampIncrementingTableQuerier{table=&quot;demo&quot;.&quot;accounts&quot;, query='null', topicPrefix='mysql-08-', incrementingColumn='', timestampColumns=[UPDATE_TS]} prepared SQL query: SELECT * FROM `demo`.`accounts` WHERE `demo`.`accounts`.`UPDATE_TS` &gt; ? AND `demo`.`accounts`.`UPDATE_TS` &lt; ? ORDER BY `demo`.`accounts`.`UPDATE_TS` ASC (io.confluent.connect.jdbc.source.TimestampIncrementingTableQuerier)
DEBUG Executing prepared statement with timestamp value = 2019-01-09 10:34:16.000 end time = 2019-01-09 13:23:40.000 (io.confluent.connect.jdbc.source.TimestampIncrementingCriteria)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里，第一个时间戳值就是存储的偏移量，第二个时间戳值是当前时间戳。</p> <p>虽然没有文档记载，但可以手动更改连接器使用的偏移量，因为是在JDBC源连接器的上下文中，所以可以跨多个源连接器类型，这意味着更改时间戳或主键，连接器会将后续记录视为未处理的状态。</p> <p>首先要做的是确保Kafka连接器已经刷新了周期性的偏移量，可以在工作节点日志中看到何时执行此操作：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INFO WorkerSourceTask{id=jdbc_source_mysql_08-0} Committing offsets (org.apache.kafka.connect.runtime.WorkerSourceTask)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>看下Kafka的主题，可以看到Kafka连接器创建的内部主题，并且负责偏移量的主题也是其中之一，名字可能有所不同：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; LIST TOPICS;

 Kafka Topic            | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups
----------------------------------------------------------------------------------------------------
 docker-connect-configs | false      | 1          | 1                  | 0         | 0
 docker-connect-offsets | false      | 1          | 1                  | 0         | 0
 docker-connect-status  | false      | 5          | 1                  | 0         | 0

ksql&gt; PRINT 'docker-connect-offsets' FROM BEGINNING;
Format:JSON
{&quot;ROWTIME&quot;:1547038346644,&quot;ROWKEY&quot;:&quot;[\&quot;jdbc_source_mysql_08\&quot;,{\&quot;protocol\&quot;:\&quot;1\&quot;,\&quot;table\&quot;:\&quot;demo.customers\&quot;}]&quot;,&quot;timestamp_nanos&quot;:0,&quot;timestamp&quot;:1547030057000}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当Kafka连接器任务启动时，它会读取此主题并使用适当主键的最新值。要更改偏移量，只需插入一个新值即可。最简单的方法是转存当前主题内容，修改内容并重新执行，因为一致性和简单，可以考虑使用<a href="https://github.com/edenhill/kafkacat/" target="_self" rel="noopener noreferrer">kafkacat</a>：</p> <ul><li>转存当前的内容：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ kafkacat -b kafka:29092 -t docker-connect-offsets -C -K<span class="token comment"># -o-1</span>
% Reached end of topic docker-connect-offsets <span class="token punctuation">[</span>0<span class="token punctuation">]</span> at offset 0
<span class="token punctuation">[</span><span class="token string">&quot;jdbc_source_mysql_08&quot;</span>,<span class="token punctuation">{</span><span class="token string">&quot;protocol&quot;</span><span class="token keyword">:</span><span class="token string">&quot;1&quot;</span>,<span class="token string">&quot;table&quot;</span><span class="token keyword">:</span><span class="token string">&quot;demo.accounts&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token comment">#{&quot;timestamp_nanos&quot;:0,&quot;timestamp&quot;:1547030056000}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果是多个连接器，可能复杂些，但是这里只有一个，所以使用了<code>-o-1</code>标志，它定义了返回的偏移量。</p> <ul><li>根据需要修改偏移量。在这里使用了<code>mode=timestamp</code>来监测表中的变化。时间戳值是<code>1547030056000</code>，使用相关的<a href="https://www.epochconverter.com/" target="_self" rel="noopener noreferrer">时间戳转换</a>之类的工具，可以很容易地转换和操作，比如将其提前一小时（<code>1547026456000</code>）。接下来，使用更新后的<code>timestamp</code>值准备新消息：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>[&quot;jdbc_source_mysql_08&quot;,{&quot;protocol&quot;:&quot;1&quot;,&quot;table&quot;:&quot;demo.accounts&quot;}]#{&quot;timestamp_nanos&quot;:0,&quot;timestamp&quot;:1547026456000}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>将新消息发给主题：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">echo</span> <span class="token string">'[&quot;jdbc_source_mysql_08&quot;,{&quot;protocol&quot;:&quot;1&quot;,&quot;table&quot;:&quot;demo.accounts&quot;}]#{&quot;timestamp_nanos&quot;:0,&quot;timestamp&quot;:1547026456000}'</span> <span class="token operator">|</span> \
kafkacat -b kafka:29092 -t docker-connect-offsets -P -Z -K<span class="token comment">#</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>如果要从头开始重启连接器，可以发送<code>NULL</code>消息值：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">echo</span><span class="token string">'[“jdbc_source_mysql_08”，{“protocol”：“1”，“table”：“demo.accounts”}]＃'</span><span class="token operator">|</span> \
kafkacat -b kafka：29092 -t docker-connect-offsets -P -Z -K＃
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>重启连接器任务：</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -i -X POST -H <span class="token string">&quot;Accept:application/json&quot;</span> \
        -H <span class="token string">&quot;Content-Type:application/json&quot;</span> http://localhost:8083/connectors/jdbc_source_mysql_08/tasks/0/restart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>也可以只重启Kafka连接器工作节点，重启之后，数据源中所有比新设置的偏移量更新的记录，都会被重新提取到Kafka主题中。</li></ul> <p><strong>从指定的时间戳或者主键处开启表的捕获</strong></p> <p>当使用时间戳或自增主键模式创建JDBC源连接器时，它会从主键为<code>-1</code>和/或时间戳为<code>1970-01-01 00:00:00.00</code>开始，这意味着会获得表的全部内容，然后在后续的轮询中获取任何插入/更新的数据。</p> <p>但是如果不想要表的完整副本，只是希望连接器从现在开始，该怎么办呢？这在目前的Kafka连接器中还不支持，但可以使用前述的方法。不需要获取现有的偏移量消息并对其进行定制，而是自己创建。消息的格式依赖于正在使用的连接器和表的名称，一种做法是先创建连接器，确定格式，然后删除连接器，另一种做法是使用具有相同源表名和结构的环境，除非在该环境中没有可供连接器提取的数据，否则同样也能得到所需的消息格式。</p> <p>在创建连接器之前，使用适当的值配置偏移量主题。在这里，希望从<code>demo.transactions</code>表中提取自增主键大于42的所有行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token keyword">echo</span> <span class="token string">'[&quot;jdbc_source_mysql_20&quot;,{&quot;protocol&quot;:&quot;1&quot;,&quot;table&quot;:&quot;demo.transactions&quot;}]#{&quot;incrementing&quot;:42}'</span> <span class="token operator">|</span> \
kafkacat -b kafka:29092 -t docker-connect-offsets -P -Z -K<span class="token comment">#</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下面创建连接器：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_20&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-20-&quot;,
                &quot;mode&quot;:&quot;incrementing&quot;,
                &quot;table.whitelist&quot; : &quot;demo.transactions&quot;,
                &quot;incrementing.column.name&quot;: &quot;txn_id&quot;,
                &quot;validate.non.null&quot;: false
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在生成的Kafka连接器工作日志中，可以看到：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>INFO Found offset {{protocol=1, table=demo.transactions}={incrementing=42}, {table=transactions}=null} for partition {protocol=1, table=demo.transactions} (io.confluent.connect.jdbc.source.JdbcSourceTask)
…
DEBUG Executing prepared statement with incrementing value = 42 (io.confluent.connect.jdbc.source.TimestampIncrementingCriteria)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>和预期一样，Kafka主题中只注入了<code>txn_id</code>大于42的行：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; PRINT 'mysql-20x-transactions' FROM BEGINNING;
Format:AVRO
1/9/19 1:44:07 PM UTC, null, {&quot;txn_id&quot;: 43, &quot;customer_id&quot;: 3, &quot;amount&quot;: {&quot;bytes&quot;: &quot;ús&quot;}, &quot;currency&quot;: &quot;CNY&quot;, &quot;txn_timestamp&quot;: &quot;2018-12-15T08:23:24Z&quot;}
1/9/19 1:44:07 PM UTC, null, {&quot;txn_id&quot;: 44, &quot;customer_id&quot;: 5, &quot;amount&quot;: {&quot;bytes&quot;: &quot;\f!&quot;}, &quot;currency&quot;: &quot;CZK&quot;, &quot;txn_timestamp&quot;: &quot;2018-10-04T13:10:17Z&quot;}
1/9/19 1:44:07 PM UTC, null, {&quot;txn_id&quot;: 45, &quot;customer_id&quot;: 3, &quot;amount&quot;: {&quot;bytes&quot;: &quot;çò&quot;}, &quot;currency&quot;: &quot;USD&quot;, &quot;txn_timestamp&quot;: &quot;2018-04-03T03:40:49Z&quot;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="配置kafka消息键"><a href="#配置kafka消息键" aria-hidden="true" class="header-anchor">#</a> 配置Kafka消息键</h2> <p>Kafka消息是键/值对，其中值是<code>有效内容</code>。在JDBC连接器的上下文中，值是要被提取的表行的内容。Kafka消息中的键对于分区和下游处理非常重要，其中任何关联（比如KSQL）都将在数据中完成。</p> <p>JDBC连接器默认不设置消息键，但是使用Kafka连接器的<a href="https://docs.confluent.io/current/connect/transforms/index.html?_ga=2.23365946.1426807846.1551933483-1401297420.1550931180" target="_self" rel="noopener noreferrer">单消息转换</a>（SMT）机制可以轻松实现。假设想要提取<code>accounts</code>表并将其<code>ID</code>列用作消息键。只需简单地将其添加到下面的配置中即可：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_06&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-06-&quot;,
                &quot;poll.interval.ms&quot; : 3600000,
                &quot;table.whitelist&quot; : &quot;demo.accounts&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;transforms&quot;:&quot;createKey,extractInt&quot;,
                &quot;transforms.createKey.type&quot;:&quot;org.apache.kafka.connect.transforms.ValueToKey&quot;,
                &quot;transforms.createKey.fields&quot;:&quot;id&quot;,
                &quot;transforms.extractInt.type&quot;:&quot;org.apache.kafka.connect.transforms.ExtractField<span class="token variable">$Key</span>&quot;,
                &quot;transforms.extractInt.field&quot;:&quot;id&quot;
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这时如果使用诸如<code>kafka-avro-console-consumer</code>之类的工具检查数据，就会看到键（JSON内容之前的最左列）与<code>id</code>值匹配：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>kafka-avro-console-consumer \
      --bootstrap-server kafka:29092 \
      --property schema.registry.url=http://schema-registry:8081 \
      --topic mysql-06-accounts --from-beginning --property print.key=true

1       {&quot;id&quot;:{&quot;int&quot;:1},&quot;first_name&quot;:{&quot;string&quot;:&quot;Hamel&quot;},&quot;last_name&quot;:{&quot;string&quot;:&quot;Bly&quot;},&quot;username&quot;:{&quot;string&quot;:&quot;Hamel Bly&quot;},&quot;company&quot;:{&quot;string&quot;:&quot;Erdman-Halvorson&quot;},&quot;created_date&quot;:{&quot;int&quot;:17759}}
2       {&quot;id&quot;:{&quot;int&quot;:2},&quot;first_name&quot;:{&quot;string&quot;:&quot;Scottie&quot;},&quot;last_name&quot;:{&quot;string&quot;:&quot;Geerdts&quot;},&quot;username&quot;:{&quot;string&quot;:&quot;Scottie Geerdts&quot;},&quot;company&quot;:{&quot;string&quot;:&quot;Mante Group&quot;},&quot;created_date&quot;:{&quot;int&quot;:17692}}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果要在数据中设置键以便与KSQL一起使用，则需要将其创建为字符串类型，因为KSQL目前不支持其它键类型，具体可以在连接器配置中添加如下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;key.converter&quot;: &quot;org.apache.kafka.connect.storage.StringConverter&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后就可以在KSQL中使用了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; CREATE STREAM ACCOUNTS WITH (KAFKA_TOPIC='mysql-06X-accounts', VALUE_FORMAT='AVRO');
ksql&gt; SELECT ROWKEY, ID, FIRST_NAME + ' ' + LAST_NAME FROM ACCOUNTS;
1 | 1 | Hamel Bly
2 | 2 | Scottie Geerdts
3 | 3 | Giana Bryce
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="更改主题名称"><a href="#更改主题名称" aria-hidden="true" class="header-anchor">#</a> 更改主题名称</h2> <p>JDBC连接器要求指定<code>topic.prefix</code>，但如果不想要，或者想将主题名更改为其它模式，SMT可以实现。</p> <p>假设要删除<code>mysql-07-</code>前缀，那么需要一点<a href="https://docs.confluent.io/current/connect/transforms/regexrouter.html?&_ga=2.232540063.1426807846.1551933483-1401297420.1550931180#regexrouter" target="_self" rel="noopener noreferrer">正则表达式</a>的技巧：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_07&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-07-&quot;,
                &quot;poll.interval.ms&quot; : 3600000,
                &quot;catalog.pattern&quot; : &quot;demo&quot;,
                &quot;table.whitelist&quot; : &quot;accounts&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;transforms&quot;:&quot;dropTopicPrefix&quot;,
                &quot;transforms.dropTopicPrefix.type&quot;:&quot;org.apache.kafka.connect.transforms.RegexRouter&quot;,
                &quot;transforms.dropTopicPrefix.regex&quot;:&quot;mysql-07-(.*)&quot;,
                &quot;transforms.dropTopicPrefix.replacement&quot;:&quot;<span class="token variable">$1</span>&quot;
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样主题名就和表名一致了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; LIST TOPICS;

 Kafka Topic            | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups
----------------------------------------------------------------------------------------------------
 accounts               | false      | 1          | 1                  | 0         | 0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="bytes-decimals-numerics和自定义类型"><a href="#bytes-decimals-numerics和自定义类型" aria-hidden="true" class="header-anchor">#</a> Bytes, Decimals, Numerics和自定义类型</h2> <p>这是话题比较深入。</p> <ul><li><code>numeric.mapping</code>: <code>best_fit</code>如果源中包含<code>NUMERIC/NUMBER</code>类型的数据，则可能需要这个配置项；</li> <li>如果需要，可以在JDBC连接器中使用<code>query</code>选项，用于对源表中的数据进行转换；</li> <li>如果字段以JDBC<code>DECIMAL</code>类型暴露，则<code>numeric.mapping</code>无法处理：
<ul><li>MySQL将所有数值存储为<code>DECIMAL</code>；</li> <li>SQL Server将<code>DECIMAL</code>和<code>NUMERIC</code>原生存储，因此必须将<code>DECIMAL</code>字段转换为<code>NUMERIC</code>；</li></ul></li> <li>在Oracle中，要在<code>NUMBER</code>字段中指定长度和标度，例如<code>NUMBER(5,0)</code>，不能是<code>NUMBER</code>；</li> <li><code>NUMERIC</code>和<code>DECIMAL</code>都被视为NUMBER，<code>INT</code>也是；</li></ul> <p>完成之后，下面会做一个解释：</p> <p>Kafka连接器是一个可以将数据注入Kafka、与特定源技术无关的框架。无论是来自SQL Server、DB2、MQTT、文本文件、REST还是Kafka连接器支持的任何其它数十种来源，它发送给Kafka的数据格式都为<code>Avro</code>或<code>JSON</code>，这通常是一个透明的过程，只是在处理数值数据类型时有些特别，比如<code>DECIMAL</code>，<code>NUMBER</code>等等，以下面的MySQL查询为例：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; SELECT * FROM transactions LIMIT 1;
+--------+-------------+--------+----------+----------------------+
| txn_id | customer_id | amount | currency | txn_timestamp        |
+--------+-------------+--------+----------+----------------------+
|      1 |           5 | -72.97 | RUB      | 2018-12-12T13:58:37Z |
+--------+-------------+--------+----------+----------------------+
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>挺正常是吧？其实，<code>amount</code>列是<code>DECIMAL(5,2)</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mysql&gt; describe transactions;
+---------------+--------------+------+-----+---------+-------+
| Field         | Type         | Null | Key | Default | Extra |
+---------------+--------------+------+-----+---------+-------+
| txn_id        | int(11)      | YES  |     | NULL    |       |
| customer_id   | int(11)      | YES  |     | NULL    |       |
| amount        | decimal(5,2) | YES  |     | NULL    |       |
| currency      | varchar(50)  | YES  |     | NULL    |       |
| txn_timestamp | varchar(50)  | YES  |     | NULL    |       |
+---------------+--------------+------+-----+---------+-------+
5 rows in set (0.00 sec)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>但是当使用JDBC连接器的默认设置提取到Kafka中时，最终会是这样：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; PRINT 'mysql-02-transactions' FROM BEGINNING;
Format:AVRO
1/4/19 5:38:45 PM UTC, null, {&quot;txn_id&quot;: 1, &quot;customer_id&quot;: 5, &quot;amount&quot;: {&quot;bytes&quot;: &quot;ã\u007F&quot;}, &quot;currency&quot;: &quot;RUB&quot;, &quot;txn_timestamp&quot;: &quot;2018-12-12T13:58:37Z&quot;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>DECIMAL</code>变成了一个看似乱码的<code>bytes</code>值，连接器默认会使用自己的<code>DECIMAL</code>逻辑类型，该类型在Avro中被序列化为字节，可以通过查看Confluent模式注册表中的相关条目来看到这一点：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s <span class="token string">&quot;http://localhost:8081/subjects/mysql-02-transactions-value/versions/1&quot;</span><span class="token operator">|</span>jq <span class="token string">'.schema|fromjson.fields[] | select (.name == &quot;amount&quot;)'</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;amount&quot;</span>,
  <span class="token string">&quot;type&quot;</span><span class="token keyword">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;null&quot;</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;bytes&quot;</span>,
      <span class="token string">&quot;scale&quot;</span><span class="token keyword">:</span> 2,
      <span class="token string">&quot;precision&quot;</span><span class="token keyword">:</span> 64,
      <span class="token string">&quot;connect.version&quot;</span><span class="token keyword">:</span> 1,
      <span class="token string">&quot;connect.parameters&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;scale&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;2&quot;</span>
      <span class="token punctuation">}</span>,
      <span class="token string">&quot;connect.name&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;org.apache.kafka.connect.data.Decimal&quot;</span>,
      <span class="token string">&quot;logicalType&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;decimal&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;default&quot;</span><span class="token keyword">:</span> null
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>当连接器使用<code>AvroConverter</code>消费时，这会正常处理并保存为<code>DECIMAL</code>（并且在Java中也可以反序列化为<code>BigDecimal</code>），但对于反序列化Avro的其它消费者，它们只会得到字节。在使用启用了模式的JSON时，也会看到这一点，<code>amount</code>值会是Base64编码的字节字符串：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;schema&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;struct&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bytes&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;optional&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;org.apache.kafka.connect.data.Decimal&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">&quot;parameters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;scale&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;amount&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;txn_id&quot;</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token property">&quot;customer_id&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Cv8=&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>因此，不管使用的是JSON还是Avro，这都是<a href="https://docs.confluent.io/5.1.0/connect/kafka-connect-jdbc/source-connector/source_config_options.html?_ga=2.224776090.1426807846.1551933483-1401297420.1550931180#database" target="_self" rel="noopener noreferrer">numeric.mapping</a>配置项的来源。它默认设置为<code>none</code>（即使用连接器的<code>DECIMAL</code>类型），但通常希望连接器将类型实际转换为更兼容的类型，以适合数字的精度，更具体的说明，可以参见相关的<a href="https://docs.confluent.io/current/connect/kafka-connect-jdbc/source-connector/index.html?_ga=2.27699900.1426807846.1551933483-1401297420.1550931180#mapping-column-types" target="_self" rel="noopener noreferrer">文档</a>。</p> <p><a href="https://github.com/confluentinc/kafka-connect-jdbc/issues/563" target="_self" rel="noopener noreferrer">此选项目前不支持<code>DECIMAL</code>类型</a>，因此这里是在Postgres中具有<code>NUMERIC</code>类型的相同原理的示例：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
              &quot;name&quot;: &quot;jdbc_source_postgres_12&quot;,
              &quot;config&quot;: {
                      &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                      &quot;connection.url&quot;: &quot;jdbc:postgresql://postgres:5432/postgres&quot;,
                      &quot;connection.user&quot;: &quot;connect_user&quot;,
                      &quot;connection.password&quot;: &quot;asgard&quot;,
                      &quot;topic.prefix&quot;: &quot;postgres-12-&quot;,
                      &quot;numeric.mapping&quot;: &quot;best_fit&quot;,
                      &quot;table.whitelist&quot; : &quot;demo.transactions&quot;,
                      &quot;mode&quot;:&quot;bulk&quot;,
                      &quot;poll.interval.ms&quot; : 3600000
                      }
              }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>结果如下所示：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ksql&gt; PRINT 'postgres-12-transactions' FROM BEGINNING;
Format:AVRO
1/7/19 6:27:16 PM UTC, null, {&quot;txn_id&quot;: 1, &quot;customer_id&quot;: 5, &quot;amount&quot;: -72.97, &quot;currency&quot;: &quot;RUB&quot;, &quot;txn_timestamp&quot;: &quot;2018-12-12T13:58:37Z&quot;}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以在<a href="https://gist.github.com/confluentgist/f58107f44741943a21c7a821c89bbf21" target="_self" rel="noopener noreferrer">这里</a>看到有关此内容的更多详细信息，以及Postgres、Oracle和MS SQL Server中的示例。</p> <h2 id="处理多个表"><a href="#处理多个表" aria-hidden="true" class="header-anchor">#</a> 处理多个表</h2> <p>如果需要从多个表中提取数据，则可以通过并行处理来减少总提取时间，这在Kafka的JDBC连接器有两种方法：</p> <ol><li>定义多个连接器，每个连接器都处理单独的表；</li> <li>定义单个连接器，但增加任务数。每个Kafka连接器的工作由一个或多个<a href="https://docs.confluent.io/current/connect/concepts.html?_ga=2.70626960.1426807846.1551933483-1401297420.1550931180#connect-tasks" target="_self" rel="noopener noreferrer">任务</a>来执行，每个连接器默认只有一个任务，这意味着从数据库中提取数据是单进程处理的。</li></ol> <p>前者具有更高的管理开销，但确实提供了每个表自定义设置的灵活性。如果可以使用相同的连接器配置提取所有表，则增加单个连接器中的任务数是一种好方法。</p> <p>当增加从数据库中提取数据的并发性时，要从整体上考虑。因为运行一百个并发任务虽然可能会更快，但数百个与数据库的连接可能会对数据库产生负面影响。</p> <p>以下是同一连接器的两个示例。两者都将从数据库中提取所有表，总共6个。在第一个连接器中，未指定最大任务数，因此为默认值1。在第二个中，指定了最多运行三个任务（<code>&quot;tasks.max&quot;:3</code>）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_01&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-01-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;
                }
        }'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> -X POST http://localhost:8083/connectors -H <span class="token string">&quot;Content-Type: application/json&quot;</span> -d <span class="token string">'{
        &quot;name&quot;: &quot;jdbc_source_mysql_11&quot;,
        &quot;config&quot;: {
                &quot;connector.class&quot;: &quot;io.confluent.connect.jdbc.JdbcSourceConnector&quot;,
                &quot;connection.url&quot;: &quot;jdbc:mysql://mysql:3306/demo&quot;,
                &quot;connection.user&quot;: &quot;connect_user&quot;,
                &quot;connection.password&quot;: &quot;asgard&quot;,
                &quot;topic.prefix&quot;: &quot;mysql-11-&quot;,
                &quot;mode&quot;:&quot;bulk&quot;,
                &quot;tasks.max&quot;:3
                }
        }'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当查询连接器的<a href="https://docs.confluent.io/current/connect/references/restapi.html?_ga=2.262439820.1426807846.1551933483-1401297420.1550931180" target="_self" rel="noopener noreferrer">Kafka连接器REST</a>API时，可以看到每个连接器正在运行的任务数以及它们已分配的表。第一个连接器有一个任务负责所有6张表：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s <span class="token string">&quot;http://localhost:8083/connectors/jdbc_source_mysql_01/tasks&quot;</span><span class="token operator">|</span>jq <span class="token string">'.'</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;id&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;connector&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;jdbc_source_mysql_01&quot;</span>,
      <span class="token string">&quot;task&quot;</span><span class="token keyword">:</span> 0
    <span class="token punctuation">}</span>,
    <span class="token string">&quot;config&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;tables&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>NUM_TEST<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>accounts<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>customers<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>transactions<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>security<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>firewall<span class="token variable">`</span></span>,<span class="token variable"><span class="token variable">`</span>security<span class="token variable">`</span></span>.<span class="token variable"><span class="token variable">`</span>log_events<span class="token variable">`</span></span>&quot;</span>,
      …
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>第二个连接器有3个任务，每个任务分配2张表：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s“http：// localhost：8083 / connectors / jdbc_source_mysql_11 / tasks”<span class="token operator">|</span> jq<span class="token string">'。'</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    “ID”： <span class="token punctuation">{</span>
      “connector”：“jdbc_source_mysql_11”，“任务”：0
    <span class="token punctuation">}</span>，
    “config”：<span class="token punctuation">{</span>
      “tables”：“<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span> .NUM_TEST<span class="token variable"><span class="token variable">`</span>，<span class="token variable">`</span></span>demo<span class="token variable"><span class="token variable">`</span> .accounts<span class="token variable">`</span></span>”，
      <span class="token punctuation">..</span>.
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>，
  <span class="token punctuation">{</span>
    “ID”： <span class="token punctuation">{</span>
      “connector”：“jdbc_source_mysql_11”，“任务”：1
    <span class="token punctuation">}</span>，
    “config”：<span class="token punctuation">{</span>
      “tables”：“<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span><span class="token variable"><span class="token variable">`</span>customers<span class="token variable">`</span></span>，<span class="token variable"><span class="token variable">`</span>demo<span class="token variable">`</span></span> .transactions<span class="token variable"><span class="token variable">`</span>”，
      <span class="token punctuation">..</span>.
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>，
  <span class="token punctuation">{</span>
    “ID”： <span class="token punctuation">{</span>
      “connector”：“jdbc_source_mysql_11”，“任务”：2
    <span class="token punctuation">}</span>，
    “config”：<span class="token punctuation">{</span>
      “tables”：“<span class="token variable">`</span></span>security`<span class="token variable"><span class="token variable">`</span>firewall<span class="token variable">`</span></span>，<span class="token variable"><span class="token variable">`</span>security<span class="token variable">`</span></span><span class="token variable"><span class="token variable">`</span>log_events<span class="token variable">`</span></span>”，
      <span class="token punctuation">..</span>.
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间：: </span> <span class="time">3/25/2019, 12:13:27 AM</span></div></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/confluent/Kafka-ConvertersSerialization.html">
          Kafka连接器深度解读之转换器和序列化
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.412b616b.js" defer></script><script src="/assets/js/10.8e8203a7.js" defer></script>
  </body>
</html>
