<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>8.服务网格</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.b473d3ab.css" as="style"><link rel="preload" href="/assets/js/app.53dd0248.js" as="script"><link rel="preload" href="/assets/js/78.c45b8b13.js" as="script"><link rel="prefetch" href="/assets/js/10.629160f8.js"><link rel="prefetch" href="/assets/js/100.8dd41c82.js"><link rel="prefetch" href="/assets/js/11.3ae3899e.js"><link rel="prefetch" href="/assets/js/12.5eea5fa7.js"><link rel="prefetch" href="/assets/js/13.814cf144.js"><link rel="prefetch" href="/assets/js/14.27bf9273.js"><link rel="prefetch" href="/assets/js/15.eb64c1d5.js"><link rel="prefetch" href="/assets/js/16.b8fd3ac5.js"><link rel="prefetch" href="/assets/js/17.6d72ceaa.js"><link rel="prefetch" href="/assets/js/18.ded6af2d.js"><link rel="prefetch" href="/assets/js/19.7dc3ecdc.js"><link rel="prefetch" href="/assets/js/2.82c623fb.js"><link rel="prefetch" href="/assets/js/20.13a8ea33.js"><link rel="prefetch" href="/assets/js/21.2d8f264c.js"><link rel="prefetch" href="/assets/js/22.a3e293d9.js"><link rel="prefetch" href="/assets/js/23.bf9aba6e.js"><link rel="prefetch" href="/assets/js/24.26ebce5a.js"><link rel="prefetch" href="/assets/js/25.b41b81b0.js"><link rel="prefetch" href="/assets/js/26.45147931.js"><link rel="prefetch" href="/assets/js/27.e25bc550.js"><link rel="prefetch" href="/assets/js/28.29be7cc5.js"><link rel="prefetch" href="/assets/js/29.7db78037.js"><link rel="prefetch" href="/assets/js/3.16a62f01.js"><link rel="prefetch" href="/assets/js/30.3223c2eb.js"><link rel="prefetch" href="/assets/js/31.1d38e4bb.js"><link rel="prefetch" href="/assets/js/32.95bcb255.js"><link rel="prefetch" href="/assets/js/33.fe204e0d.js"><link rel="prefetch" href="/assets/js/34.6a081c8a.js"><link rel="prefetch" href="/assets/js/35.e3f2095e.js"><link rel="prefetch" href="/assets/js/36.b15e9b49.js"><link rel="prefetch" href="/assets/js/37.238f3eb8.js"><link rel="prefetch" href="/assets/js/38.0a5e78b8.js"><link rel="prefetch" href="/assets/js/39.0fcea5ab.js"><link rel="prefetch" href="/assets/js/4.09795317.js"><link rel="prefetch" href="/assets/js/40.9d3805de.js"><link rel="prefetch" href="/assets/js/41.241989d7.js"><link rel="prefetch" href="/assets/js/42.f81cd3e4.js"><link rel="prefetch" href="/assets/js/43.44b41407.js"><link rel="prefetch" href="/assets/js/44.d2b58ee5.js"><link rel="prefetch" href="/assets/js/45.84e6dc48.js"><link rel="prefetch" href="/assets/js/46.121b15a3.js"><link rel="prefetch" href="/assets/js/47.d26a7115.js"><link rel="prefetch" href="/assets/js/48.8e1168fc.js"><link rel="prefetch" href="/assets/js/49.99b7227e.js"><link rel="prefetch" href="/assets/js/5.83f9a4bc.js"><link rel="prefetch" href="/assets/js/50.3e4ea217.js"><link rel="prefetch" href="/assets/js/51.5b29294d.js"><link rel="prefetch" href="/assets/js/52.b88a3b5d.js"><link rel="prefetch" href="/assets/js/53.1b185c21.js"><link rel="prefetch" href="/assets/js/54.58426c6e.js"><link rel="prefetch" href="/assets/js/55.7ab1c65d.js"><link rel="prefetch" href="/assets/js/56.12afb1ea.js"><link rel="prefetch" href="/assets/js/57.c73d6313.js"><link rel="prefetch" href="/assets/js/58.60ff3bef.js"><link rel="prefetch" href="/assets/js/59.c0f33441.js"><link rel="prefetch" href="/assets/js/6.9557d6ac.js"><link rel="prefetch" href="/assets/js/60.c20ede71.js"><link rel="prefetch" href="/assets/js/61.87c33cdc.js"><link rel="prefetch" href="/assets/js/62.5bfe9f57.js"><link rel="prefetch" href="/assets/js/63.43ce1725.js"><link rel="prefetch" href="/assets/js/64.40e55d8a.js"><link rel="prefetch" href="/assets/js/65.0ef2261c.js"><link rel="prefetch" href="/assets/js/66.2d2385c6.js"><link rel="prefetch" href="/assets/js/67.ab14fb75.js"><link rel="prefetch" href="/assets/js/68.bfe208fb.js"><link rel="prefetch" href="/assets/js/69.84ea4b5c.js"><link rel="prefetch" href="/assets/js/7.f4c076d8.js"><link rel="prefetch" href="/assets/js/70.ce385281.js"><link rel="prefetch" href="/assets/js/71.15058880.js"><link rel="prefetch" href="/assets/js/72.362628d3.js"><link rel="prefetch" href="/assets/js/73.5049f712.js"><link rel="prefetch" href="/assets/js/74.0b17fabc.js"><link rel="prefetch" href="/assets/js/75.e80e5cd9.js"><link rel="prefetch" href="/assets/js/76.e55635e8.js"><link rel="prefetch" href="/assets/js/77.74e0006a.js"><link rel="prefetch" href="/assets/js/79.3bac2928.js"><link rel="prefetch" href="/assets/js/8.ce6bd56a.js"><link rel="prefetch" href="/assets/js/80.54dc2d57.js"><link rel="prefetch" href="/assets/js/81.ae36540a.js"><link rel="prefetch" href="/assets/js/82.82b6f620.js"><link rel="prefetch" href="/assets/js/83.a48b249e.js"><link rel="prefetch" href="/assets/js/84.0db96720.js"><link rel="prefetch" href="/assets/js/85.d6c6f40e.js"><link rel="prefetch" href="/assets/js/86.ed566c04.js"><link rel="prefetch" href="/assets/js/87.ea8bb864.js"><link rel="prefetch" href="/assets/js/88.0002226c.js"><link rel="prefetch" href="/assets/js/89.ed9dd008.js"><link rel="prefetch" href="/assets/js/9.cf32c538.js"><link rel="prefetch" href="/assets/js/90.da0276d6.js"><link rel="prefetch" href="/assets/js/91.18376f61.js"><link rel="prefetch" href="/assets/js/92.bf23c8b6.js"><link rel="prefetch" href="/assets/js/93.a4737653.js"><link rel="prefetch" href="/assets/js/94.7127c03e.js"><link rel="prefetch" href="/assets/js/95.7eef57a8.js"><link rel="prefetch" href="/assets/js/96.3fa99fdb.js"><link rel="prefetch" href="/assets/js/97.968f6f05.js"><link rel="prefetch" href="/assets/js/98.52358adc.js"><link rel="prefetch" href="/assets/js/99.4ad86e2e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b473d3ab.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <!----> </div> <div class="page"> <div class="content"><h1 id="_8-服务网格"><a href="#_8-服务网格" aria-hidden="true" class="header-anchor">#</a> 8.服务网格</h1> <h2 id="_8-1-服务网格"><a href="#_8-1-服务网格" aria-hidden="true" class="header-anchor">#</a> 8.1.服务网格</h2> <h3 id="_8-1-1-摘要"><a href="#_8-1-1-摘要" aria-hidden="true" class="header-anchor">#</a> 8.1.1.摘要</h3> <p>服务网格可以在集群上部署任意用户定义的服务，比如自定义计数器，ID生成器，分层映射等。</p> <p>比如，服务网格可以作为基于微服务架构的解决方案或者应用的技术基础，了解更多的信息可以参考下面的文章：</p> <ul><li><a href="https://www.zybuluo.com/liyuj/note/580738" target="_blank" rel="noopener noreferrer">在Ignite之上运行微服务：第一部分<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zybuluo.com/liyuj/note/639612" target="_blank" rel="noopener noreferrer">在Ignite之上运行微服务：第二部分<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zybuluo.com/liyuj/note/742474" target="_blank" rel="noopener noreferrer">在Ignite之上运行微服务：第三部分<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>Ignite可以控制每个集群节点应该部署多少个服务的实例，可以自动地确保所有的服务正确地部署和容错。</p> <p><img src="https://files.readme.io/qOINezbjTiOJFl3ueIUs_ignite_service.png" alt></p> <p><strong>特性一览</strong></p> <ul><li>无论拓扑发生变化或者节点故障都会使部署的服务<strong>持续有效</strong></li> <li>在集群中自动地部署任意数量的分布式服务实例</li> <li>自动地部署单例，包括集群单例、节点单例或者关系键单例</li> <li>通过在配置中指定在节点启动时自动部署分布式服务</li> <li>取消任何已部署的服务</li> <li>在集群中获得有关服务部署拓扑结构的信息</li> <li>对于访问远程部署的分布式服务创建服务代理</li></ul> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>可以访问<code>8.2.服务示例</code>章节来获得有关服务部署和访问服务的API信息。</p></div> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>注意，默认情况下，所有的集群节点的类路径中都包含服务类是必须的，服务网格是不支持对等类加载的，下面的服务部署章节会描述如何克服这个约束。</p></div> <h3 id="_8-1-2-igniteservices"><a href="#_8-1-2-igniteservices" aria-hidden="true" class="header-anchor">#</a> 8.1.2.IgniteServices</h3> <p>所有的服务网格功能都是通过<code>IgniteServices</code>接口实现的。</p> <div class="language-java extra-class"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get services instance spanning all nodes in the cluster.</span>
IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以将服务部署的范围限制在一个集群组内，这时，服务只会局限在集群组所属的节点内部。</p> <div class="language-java extra-class"><pre class="language-java"><code>Ignite ignite <span class="token operator">=</span> Ignitition<span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ClusterGroup remoteGroup <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit service deployment only to remote nodes (exclude the local node).</span>
IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span>remoteGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-1-3-负载平衡"><a href="#_8-1-3-负载平衡" aria-hidden="true" class="header-anchor">#</a> 8.1.3.负载平衡</h3> <p>在所有的情况下，除非单例服务部署，Ignite会自动地确保集群内的每个节点部署相同数量的服务。当网络发生变化时，为了更好地进行负载平衡，Ignite会对服务的部署进行重新评估然后可能将已经部署的服务重新部署到其他的节点。</p> <h3 id="_8-1-4-容错"><a href="#_8-1-4-容错" aria-hidden="true" class="header-anchor">#</a> 8.1.4.容错</h3> <p>Ignite会一直保证服务的持续有效，以及不管拓扑发生变化或者节点故障都会按照指定的配置进行部署。</p> <h3 id="_8-1-5-部署管理"><a href="#_8-1-5-部署管理" aria-hidden="true" class="header-anchor">#</a> 8.1.5.部署管理</h3> <p>默认情况下，就像上面负载平衡部分描述的那样，会根据集群的负载情况，Ignite服务会被部署到一个随机的节点（多个节点）。</p> <p>除了这个默认的方式，Ignite还提供了一个API以将服务部署到特定的节点集合上，下面会详细描述各个方式。</p> <p><strong>基于节点过滤器的部署</strong></p> <p>这个方式是基于过滤谓词的，Ignite服务引擎在决定将服务部署到哪些候选节点上时每个节点都会调用，如果谓词返回<code>true</code>，那么节点就会包含进集合，否则就会被排除。</p> <p>节点过滤器需要实现<code>IgnitePredicate&lt;ClusterNode&gt;</code>接口，比如下面这个典型示例，它会通知服务引擎将一个Ignite服务部署到本地属性中包含<code>west.coast.attribute</code>的非客户端节点上：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// The filter implementation.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceFilter</span> <span class="token keyword">implements</span> <span class="token class-name">IgnitePredicate</span><span class="token generics function"><span class="token punctuation">&lt;</span>ClusterNode<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>ClusterNode node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// The service will be deployed on non client nodes</span>
    <span class="token comment">// that have the attribute 'west.coast.node'.</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>node<span class="token punctuation">.</span><span class="token function">isClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    node<span class="token punctuation">.</span><span class="token function">attributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;west.coast.node&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后可以将其传给<code>ServiceConfiguration.setNodeFilter(...)</code>方法，然后使用这个配置启动服务。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">/</span> Initiating cache configuration<span class="token punctuation">.</span> 
ServiceConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Setting service instance to deploy.</span>
cfg<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Setting service name.</span>
cfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Providing the nodes filter.</span>
cfg<span class="token punctuation">.</span><span class="token function">setNodeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Getting instance of Ignite Service Grid.</span>
IgniteServices services <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// Deploying the service.</span>
services<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">注意</p> <p>确保节点过滤器的类位于每个节点的类路径中，不管服务是否要部署到那个节点上，否则会得到一个<code>ClassNotFoundException</code>。
另一方面，原则上在集群的整个生命周期中，是可以只将服务的实现类添加到可能待部署的节点的类路径中的。</p></div> <p><strong>基于集群组的部署</strong></p> <p>另一个方式是基于定义的特定<code>ClusterGroup</code>，一旦通过特定的集群组获得了Ignite服务网格的引用，新的服务的部署只会发生在这个组的一个或者几个节点上。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">/</span> A service will be deployed on the server nodes only<span class="token punctuation">.</span>
IgniteServices services <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span>ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Deploying the service.</span>
services<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>serviceCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>基于关系键的部署</strong></p> <p>最后一个可以影响服务部署的方式是基于关系键的定义，服务的配置需要包含关系键的值及其所属的缓存名，服务启动时，服务网格会将服务部署在该关系键所在的主节点上。在整个周期中，如果主节点发生变化，那么服务也会自动进行再部署。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Initiating cache configuration.</span>
ServiceConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting service instance to deploy.</span>
cfg<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting service name.</span>
cfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting the cache name and key's value for the affinity based deployment.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCacheName</span><span class="token punctuation">(</span><span class="token string">&quot;orgCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setAffinityKey</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Getting instance of Ignite Service Grid.</span>
IgniteServices services <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Deploying the service.</span>
services<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用上述示例的配置部署服务后，Ignite会确保将服务部署到名为<code>orgCache</code>的缓存中犍为<code>123</code>所在的主节点上。</p> <h3 id="_8-1-6-服务卸载"><a href="#_8-1-6-服务卸载" aria-hidden="true" class="header-anchor">#</a> 8.1.6.服务卸载</h3> <p>Ignite在所有的节点上存储已部署服务的描述符，如前述，如果一个服务部署在节点的子集上，停止所有这些节点也不会卸载服务，只要满足节点过滤器的节点有一个有备份，服务都会以同样的配置重启。</p> <p>如果要对服务的配置进行修改，就需要显式地卸载它然后重新部署新的配置，使用<code>IgniteServices#cancel</code>或者<code>IgniteServices#cancelAll</code>方法可以进行卸载。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Getting instance of Ignite Service Grid.</span>
IgniteServices services <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">&quot;serviceName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-2-服务示例"><a href="#_8-2-服务示例" aria-hidden="true" class="header-anchor">#</a> 8.2.服务示例</h2> <h3 id="_8-2-1-定义服务接口"><a href="#_8-2-1-定义服务接口" aria-hidden="true" class="header-anchor">#</a> 8.2.1.定义服务接口</h3> <p>作为一个示例，可以定义一个简单的计数器服务：<code>MyCounterService</code>接口，注意这是一个简单的Java接口，没有任何特别的注解或者方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyCounterService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Increment counter value and return the new value.
     */</span>
    <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CacheException<span class="token punctuation">;</span>
     
    <span class="token comment">/**
     * Get current counter value.
     */</span>
    <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CacheException<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-2-2-服务实现"><a href="#_8-2-2-服务实现" aria-hidden="true" class="header-anchor">#</a> 8.2.2.服务实现</h3> <p>一个分布式服务的实现必须实现<code>Service</code>和<code>MyCounterService</code>两个接口。</p> <p>这个计数器服务的实现将计数值存储在缓存中。这个计数值的键是服务的名字，这样可以使多个计数器服务实例复用同一个缓存。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCounterServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Service</span><span class="token punctuation">,</span> MyCounterService <span class="token punctuation">{</span>
  <span class="token comment">/** Auto-injected instance of Ignite. */</span>
  <span class="token annotation punctuation">@IgniteInstanceResource</span>
  <span class="token keyword">private</span> Ignite ignite<span class="token punctuation">;</span>

  <span class="token comment">/** Distributed cache used to store counters. */</span>
  <span class="token keyword">private</span> IgniteCache<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> cache<span class="token punctuation">;</span>

  <span class="token comment">/** Service name. */</span>
  <span class="token keyword">private</span> String svcName<span class="token punctuation">;</span>

  <span class="token comment">/**
   * Service initialization.
   */</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>ServiceContext ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Pre-configured cache to store counters.</span>
    cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token string">&quot;myCounterCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    svcName <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Service was initialized: &quot;</span> <span class="token operator">+</span> svcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Cancel this service.
   */</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span>ServiceContext ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Remove counter from cache.</span>
    cache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>svcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Service was cancelled: &quot;</span> <span class="token operator">+</span> svcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Start service execution.
   */</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>ServiceContext ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Since our service is simply represented by a counter</span>
    <span class="token comment">// value stored in cache, there is nothing we need</span>
    <span class="token comment">// to do in order to start it up.</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Executing distributed service: &quot;</span> <span class="token operator">+</span> svcName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CacheException <span class="token punctuation">{</span>
    Integer i <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>svcName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> i <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> i<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CacheException <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>svcName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CounterEntryProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Entry processor which atomically increments value currently stored in cache.
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CounterEntryProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">EntryProcessor</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Integer <span class="token function">process</span><span class="token punctuation">(</span>MutableEntry<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token punctuation">&gt;</span></span> e<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">int</span> newVal <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
      
      <span class="token comment">// Update cache.</span>
      e<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> newVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>      
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-2-3-服务部署"><a href="#_8-2-3-服务部署" aria-hidden="true" class="header-anchor">#</a> 8.2.3.服务部署</h3> <p>可以将上述的计数器服务作为节点级单例部署在建立了<code>myCounterCache</code>缓存的集群组中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Cluster group which includes all caching nodes.</span>
ClusterGroup cacheGrp <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forCacheNodes</span><span class="token punctuation">(</span><span class="token string">&quot;myCounterService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get an instance of IgniteServices for the cluster group.</span>
IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span>cacheGrp<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Deploy per-node singleton. An instance of the service</span>
<span class="token comment">// will be deployed on every node within the cluster group.</span>
svcs<span class="token punctuation">.</span><span class="token function">deployNodeSingleton</span><span class="token punctuation">(</span><span class="token string">&quot;myCounterService&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyCounterServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-2-4-服务代理"><a href="#_8-2-4-服务代理" aria-hidden="true" class="header-anchor">#</a> 8.2.4.服务代理</h3> <p>可以从集群内的任意节点访问已部署的服务实例。如果一个服务部署在某个节点，那么本地部署的实例会被返回，否则，如果服务不是本地的，那么会创建服务的一个远程代理。</p> <p><strong>粘性和非粘性代理</strong></p> <p>代理既可以是<em>粘性</em>的也可以是<em>非粘性</em>的。如果代理是粘性的，Ignite会总是访问同一个集群节点的服务，如果代理是非粘性的，那么Ignite会在服务部署的所有集群节点内对远程服务代理的调用进行负载平衡。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Get service proxy for the deployed service.</span>
MyCounterService cntrSvc <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
  <span class="token function">serviceProxy</span><span class="token punctuation">(</span><span class="token string">&quot;myCounterService&quot;</span><span class="token punctuation">,</span> MyCounterService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment">/*not-sticky*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ivoke a method on 'MyCounterService' interface.</span>
cntrSvc<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Print latest counter value from our counter service.</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Incremented value : &quot;</span> <span class="token operator">+</span> cntrSvc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-2-5-从计算访问服务"><a href="#_8-2-5-从计算访问服务" aria-hidden="true" class="header-anchor">#</a> 8.2.5.从计算访问服务</h3> <p>为了方便，可以通过<code>@ServiceResource</code>注解在计算中注入一个服务代理的实例。</p> <div class="language-java extra-class"><pre class="language-java"><code>IgniteCompute compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compute<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@ServiceResource</span><span class="token punctuation">(</span>serviceName <span class="token operator">=</span> <span class="token string">&quot;myCounterService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> MyCounterService counterSvc<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ivoke a method on 'MyCounterService' interface.</span>
    <span class="token keyword">int</span> newValue <span class="token operator">=</span> cntrSvc<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Print latest counter value from our counter service.</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Incremented value : &quot;</span> <span class="token operator">+</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-3-集群单例"><a href="#_8-3-集群单例" aria-hidden="true" class="header-anchor">#</a> 8.3.集群单例</h2> <h3 id="_8-3-1-摘要"><a href="#_8-3-1-摘要" aria-hidden="true" class="header-anchor">#</a> 8.3.1.摘要</h3> <p><code>IgniteServices</code>可以在任意的集群节点上部署任意数量的的服务，然而，最常用的特性是在集群中部署一个服务的单例，Ignite会管理这个单例除非拓扑发生变化或者节点发生故障。</p> <div class="tip custom-block"><p class="custom-block-title">注意</p> <p>注意如果拓扑发生了变化，因为网络的延迟，可能存在一个临时的情况，就是几个单例服务的实例在不止一个节点上都处于活跃状态（比如故障检测延迟）。</p></div> <h3 id="_8-3-2-集群单例"><a href="#_8-3-2-集群单例" aria-hidden="true" class="header-anchor">#</a> 8.3.2.集群单例</h3> <p>可以部署一个集群范围的单例服务，Ignite会保证集群内会一直有一个该服务的实例。当部署该服务的节点故障或者停止时，Ignite会自动在另一个节点上重新部署该服务。然而，如果部署该服务的节点仍然在网络中，那么服务会一直部署在该节点上，除非拓扑发生了变化。</p> <div class="language-java extra-class"><pre class="language-java"><code>IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

svcs<span class="token punctuation">.</span><span class="token function">deployClusterSingleton</span><span class="token punctuation">(</span><span class="token string">&quot;myClusterSingleton&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码类似于下面的调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>svcs<span class="token punctuation">.</span><span class="token function">deployMultiple</span><span class="token punctuation">(</span><span class="token string">&quot;myClusterSingleton&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_8-3-3-节点单例"><a href="#_8-3-3-节点单例" aria-hidden="true" class="header-anchor">#</a> 8.3.3.节点单例</h3> <p>也可以部署一个节点范围的单例服务，Ignite会保证每个节点都会有一个服务的实例在运行。当在集群组中启动了新的节点时，Ignite会自动地在每个新节点上部署一个新的服务实例。</p> <div class="language-java extra-class"><pre class="language-java"><code>IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

svcs<span class="token punctuation">.</span><span class="token function">deployNodeSingleton</span><span class="token punctuation">(</span><span class="token string">&quot;myNodeSingleton&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码类似于下面的调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>svcs<span class="token punctuation">.</span><span class="token function">deployMultiple</span><span class="token punctuation">(</span><span class="token string">&quot;myNodeSingleton&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-3-4-缓存键关系单例"><a href="#_8-3-4-缓存键关系单例" aria-hidden="true" class="header-anchor">#</a> 8.3.4.缓存键关系单例</h3> <p>可以将一个服务的单例通过一个给定的关系键部署在一个主节点上。当拓扑或者主键节点发生变化时，Ignite会一直确保服务在之前的主节点上卸载然后部署在一个新的主节点上。</p> <div class="language-java extra-class"><pre class="language-java"><code>IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

svcs<span class="token punctuation">.</span><span class="token function">deployKeyAffinitySingleton</span><span class="token punctuation">(</span><span class="token string">&quot;myKeySingleton&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;myCache&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyCacheKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码类似于下面的调用：</p> <div class="language-java extra-class"><pre class="language-java"><code>IgniteServices svcs <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ServiceConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
cfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;myKeySingleton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setCacheName</span><span class="token punctuation">(</span><span class="token string">&quot;myCache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setAffinityKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCacheKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setMaxPerNodeCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
svcs<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-4-服务配置"><a href="#_8-4-服务配置" aria-hidden="true" class="header-anchor">#</a> 8.4.服务配置</h2> <h3 id="_8-4-1-配置"><a href="#_8-4-1-配置" aria-hidden="true" class="header-anchor">#</a> 8.4.1.配置</h3> <p>除了通过调用Ignite提供的<code>IgniteServices.deploy(...)</code>方法部署服务之外，还可以通过IgniteConfiguration的<code>serviceConfiguration</code>属性在<strong>启动时自动地部署服务</strong>。</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...  
    <span class="token comment">&lt;!-- Distributed Service configuration. --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>serviceConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.services.ServiceConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>MyClusterSingletonSvc<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxPerNodeCount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>totalCount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>service<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>myServiceImpl<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>foo.bar.MyServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code>ServiceConfiguration svcCfg1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Cluster-wide singleton configuration.</span>
svcCfg1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;MyClusterSingletonSvc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
svcCfg1<span class="token punctuation">.</span><span class="token function">setMaxPerNodeCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
svcCfg1<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
svcCfg1<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyClusterSingletonImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
ServiceConfiguration svcCfg2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// Per-node singleton configuration.</span>
svcCfg2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;MyNodeSingletonSvc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
svcCfg2<span class="token punctuation">.</span><span class="token function">setMaxPerNodeCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
svcCfg2<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyNodeSingletonImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IgniteConfiguration igniteCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
igniteCfg<span class="token punctuation">.</span><span class="token function">setServiceConfiguration</span><span class="token punctuation">(</span>svcCfg1<span class="token punctuation">,</span> svcCfg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment">// Start Ignite node.</span>
Ignition<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>gridCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-4-2-启动后部署"><a href="#_8-4-2-启动后部署" aria-hidden="true" class="header-anchor">#</a> 8.4.2.启动后部署</h3> <p>可以通过配置然后在节点启动之后部署服务，除了可以部署各种集群单例的一些方便的方法外，还可以通过定制的配置来创建和部署服务。</p> <div class="language-java extra-class"><pre class="language-java"><code>ServiceConfiguration cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;myService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfg<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Maximum of 4 service instances within cluster.</span>
cfg<span class="token punctuation">.</span><span class="token function">setTotalCount</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Maximum of 2 service instances per each Ignite node.</span>
cfg<span class="token punctuation">.</span><span class="token function">setMaxPerNodeCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
ignite<span class="token punctuation">.</span><span class="token function">services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.53dd0248.js" defer></script><script src="/assets/js/78.c45b8b13.js" defer></script>
  </body>
</html>
