<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算网格 | Apache Ignite技术服务</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="stylesheet" href="/css/plugin.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://hm.baidu.com/hm.js?8e93516f96b603fac3e2738ca002c88a"></script>
    <meta name="description" content="apache ignite,ignite中文,ignite官网,内存数据库,分布式数据库">
    <meta name="keywords" content="apache ignite,ignite中文,ignite官网,内存数据库,分布式数据库">
    <meta http-equiv="cache-control" content="no-store,no-cache,must-revalidate">
    <meta http-equiv="expires" content="0">
    
    <link rel="preload" href="/assets/css/0.styles.97ec401e.css" as="style"><link rel="preload" href="/assets/js/app.e19e712a.js" as="script"><link rel="preload" href="/assets/js/3.d41ef727.js" as="script"><link rel="preload" href="/assets/js/1.c1604912.js" as="script"><link rel="preload" href="/assets/js/100.7e3232a9.js" as="script"><link rel="prefetch" href="/assets/js/10.cd30f947.js"><link rel="prefetch" href="/assets/js/101.3fb7151f.js"><link rel="prefetch" href="/assets/js/102.3026f662.js"><link rel="prefetch" href="/assets/js/103.711189c2.js"><link rel="prefetch" href="/assets/js/104.4b2ee848.js"><link rel="prefetch" href="/assets/js/105.6eb36a3e.js"><link rel="prefetch" href="/assets/js/106.c0129421.js"><link rel="prefetch" href="/assets/js/107.287497ee.js"><link rel="prefetch" href="/assets/js/108.9ac67a9f.js"><link rel="prefetch" href="/assets/js/109.bafb9de2.js"><link rel="prefetch" href="/assets/js/11.43551a62.js"><link rel="prefetch" href="/assets/js/110.3fefe09b.js"><link rel="prefetch" href="/assets/js/111.db1312c4.js"><link rel="prefetch" href="/assets/js/112.46dd09fd.js"><link rel="prefetch" href="/assets/js/113.d8a8cef8.js"><link rel="prefetch" href="/assets/js/114.4a6018ca.js"><link rel="prefetch" href="/assets/js/115.edd50462.js"><link rel="prefetch" href="/assets/js/116.1ebcccf4.js"><link rel="prefetch" href="/assets/js/117.3d0377a6.js"><link rel="prefetch" href="/assets/js/118.218cf736.js"><link rel="prefetch" href="/assets/js/119.130567ca.js"><link rel="prefetch" href="/assets/js/12.7891e08b.js"><link rel="prefetch" href="/assets/js/120.5d17c163.js"><link rel="prefetch" href="/assets/js/121.db5e0a95.js"><link rel="prefetch" href="/assets/js/122.d41d5f10.js"><link rel="prefetch" href="/assets/js/123.dc097107.js"><link rel="prefetch" href="/assets/js/124.5fb95d58.js"><link rel="prefetch" href="/assets/js/125.ad49caec.js"><link rel="prefetch" href="/assets/js/126.c789b90b.js"><link rel="prefetch" href="/assets/js/127.ccd19bab.js"><link rel="prefetch" href="/assets/js/128.ba9d7b99.js"><link rel="prefetch" href="/assets/js/129.e2b9b80c.js"><link rel="prefetch" href="/assets/js/13.550a0e6d.js"><link rel="prefetch" href="/assets/js/130.766ce9da.js"><link rel="prefetch" href="/assets/js/131.bf9635b3.js"><link rel="prefetch" href="/assets/js/132.7c5e9a6b.js"><link rel="prefetch" href="/assets/js/133.3a706529.js"><link rel="prefetch" href="/assets/js/134.a52965fa.js"><link rel="prefetch" href="/assets/js/135.1652d314.js"><link rel="prefetch" href="/assets/js/136.4bc6a61a.js"><link rel="prefetch" href="/assets/js/137.61e1e61c.js"><link rel="prefetch" href="/assets/js/138.3e707785.js"><link rel="prefetch" href="/assets/js/139.a6b1250b.js"><link rel="prefetch" href="/assets/js/14.de7151b7.js"><link rel="prefetch" href="/assets/js/140.c00db03c.js"><link rel="prefetch" href="/assets/js/141.7051c585.js"><link rel="prefetch" href="/assets/js/142.071de2b6.js"><link rel="prefetch" href="/assets/js/143.7626803b.js"><link rel="prefetch" href="/assets/js/144.078455b1.js"><link rel="prefetch" href="/assets/js/145.7cfead36.js"><link rel="prefetch" href="/assets/js/146.6481436d.js"><link rel="prefetch" href="/assets/js/147.df3252a4.js"><link rel="prefetch" href="/assets/js/148.337db904.js"><link rel="prefetch" href="/assets/js/149.848964fb.js"><link rel="prefetch" href="/assets/js/15.7875df61.js"><link rel="prefetch" href="/assets/js/150.c99cf7d2.js"><link rel="prefetch" href="/assets/js/151.8b054147.js"><link rel="prefetch" href="/assets/js/152.4e50e1d5.js"><link rel="prefetch" href="/assets/js/153.1a5c9601.js"><link rel="prefetch" href="/assets/js/154.64543ae6.js"><link rel="prefetch" href="/assets/js/155.9b519c0b.js"><link rel="prefetch" href="/assets/js/156.e5171ed9.js"><link rel="prefetch" href="/assets/js/157.15a566b4.js"><link rel="prefetch" href="/assets/js/158.136f5c28.js"><link rel="prefetch" href="/assets/js/159.44943b28.js"><link rel="prefetch" href="/assets/js/16.774f17c1.js"><link rel="prefetch" href="/assets/js/160.f1402393.js"><link rel="prefetch" href="/assets/js/161.bc7ba5e4.js"><link rel="prefetch" href="/assets/js/162.7a7a07cb.js"><link rel="prefetch" href="/assets/js/163.eed6ddd4.js"><link rel="prefetch" href="/assets/js/164.5d326d15.js"><link rel="prefetch" href="/assets/js/165.0bc4ff9b.js"><link rel="prefetch" href="/assets/js/166.16682d7d.js"><link rel="prefetch" href="/assets/js/167.a29ebb1a.js"><link rel="prefetch" href="/assets/js/168.678047a7.js"><link rel="prefetch" href="/assets/js/169.dc6ab55c.js"><link rel="prefetch" href="/assets/js/17.3ec33795.js"><link rel="prefetch" href="/assets/js/170.00049626.js"><link rel="prefetch" href="/assets/js/171.5f553b26.js"><link rel="prefetch" href="/assets/js/172.d0e53c3d.js"><link rel="prefetch" href="/assets/js/173.abf9167c.js"><link rel="prefetch" href="/assets/js/174.cb747306.js"><link rel="prefetch" href="/assets/js/175.e0f71f8c.js"><link rel="prefetch" href="/assets/js/176.1195b6f7.js"><link rel="prefetch" href="/assets/js/177.9bdedac7.js"><link rel="prefetch" href="/assets/js/178.f61d7f54.js"><link rel="prefetch" href="/assets/js/179.f9b56f97.js"><link rel="prefetch" href="/assets/js/18.ff5516a9.js"><link rel="prefetch" href="/assets/js/180.fbabdc76.js"><link rel="prefetch" href="/assets/js/181.4d6bdd28.js"><link rel="prefetch" href="/assets/js/182.0ac46cf9.js"><link rel="prefetch" href="/assets/js/183.513aea07.js"><link rel="prefetch" href="/assets/js/184.6864be6e.js"><link rel="prefetch" href="/assets/js/185.f0df1752.js"><link rel="prefetch" href="/assets/js/186.ffcd2148.js"><link rel="prefetch" href="/assets/js/187.9a2554ad.js"><link rel="prefetch" href="/assets/js/188.747cdf92.js"><link rel="prefetch" href="/assets/js/189.7e4e6de4.js"><link rel="prefetch" href="/assets/js/19.0cae43ad.js"><link rel="prefetch" href="/assets/js/190.605307a5.js"><link rel="prefetch" href="/assets/js/191.96ec974e.js"><link rel="prefetch" href="/assets/js/192.ac982c75.js"><link rel="prefetch" href="/assets/js/193.adea6234.js"><link rel="prefetch" href="/assets/js/194.6cebdb9d.js"><link rel="prefetch" href="/assets/js/195.fbc25c7e.js"><link rel="prefetch" href="/assets/js/196.13b7c516.js"><link rel="prefetch" href="/assets/js/197.af35dae8.js"><link rel="prefetch" href="/assets/js/198.5aa0b9a5.js"><link rel="prefetch" href="/assets/js/199.a8d1f982.js"><link rel="prefetch" href="/assets/js/20.e5e79f5b.js"><link rel="prefetch" href="/assets/js/200.a2356e21.js"><link rel="prefetch" href="/assets/js/201.1b512a6a.js"><link rel="prefetch" href="/assets/js/202.9562d280.js"><link rel="prefetch" href="/assets/js/203.bd91d108.js"><link rel="prefetch" href="/assets/js/204.0eedb40b.js"><link rel="prefetch" href="/assets/js/205.d9690844.js"><link rel="prefetch" href="/assets/js/206.31346f6e.js"><link rel="prefetch" href="/assets/js/207.23803fcf.js"><link rel="prefetch" href="/assets/js/208.53bff87f.js"><link rel="prefetch" href="/assets/js/209.3bef74ab.js"><link rel="prefetch" href="/assets/js/21.cd3962b3.js"><link rel="prefetch" href="/assets/js/210.529c6596.js"><link rel="prefetch" href="/assets/js/211.0149c636.js"><link rel="prefetch" href="/assets/js/212.495d5d66.js"><link rel="prefetch" href="/assets/js/213.7385ee92.js"><link rel="prefetch" href="/assets/js/214.6b2a24dd.js"><link rel="prefetch" href="/assets/js/215.902accbe.js"><link rel="prefetch" href="/assets/js/216.f1b488f2.js"><link rel="prefetch" href="/assets/js/217.a2f9536c.js"><link rel="prefetch" href="/assets/js/218.5c91b75c.js"><link rel="prefetch" href="/assets/js/219.e764adb0.js"><link rel="prefetch" href="/assets/js/22.4ef74b42.js"><link rel="prefetch" href="/assets/js/220.feb2cbeb.js"><link rel="prefetch" href="/assets/js/221.a8530e53.js"><link rel="prefetch" href="/assets/js/222.07615a73.js"><link rel="prefetch" href="/assets/js/223.ec446ba4.js"><link rel="prefetch" href="/assets/js/224.d058ca14.js"><link rel="prefetch" href="/assets/js/225.9d713b96.js"><link rel="prefetch" href="/assets/js/226.66135fdb.js"><link rel="prefetch" href="/assets/js/227.34d0b8af.js"><link rel="prefetch" href="/assets/js/228.ec9899ca.js"><link rel="prefetch" href="/assets/js/229.b89d57c3.js"><link rel="prefetch" href="/assets/js/23.46a7d273.js"><link rel="prefetch" href="/assets/js/230.09d90c8a.js"><link rel="prefetch" href="/assets/js/231.f115b830.js"><link rel="prefetch" href="/assets/js/232.6c2594cc.js"><link rel="prefetch" href="/assets/js/233.079b9aa9.js"><link rel="prefetch" href="/assets/js/234.043fc77c.js"><link rel="prefetch" href="/assets/js/235.8af86500.js"><link rel="prefetch" href="/assets/js/236.de7c4b53.js"><link rel="prefetch" href="/assets/js/237.77290873.js"><link rel="prefetch" href="/assets/js/238.6fc15632.js"><link rel="prefetch" href="/assets/js/239.1b3455f4.js"><link rel="prefetch" href="/assets/js/24.2d7b82f1.js"><link rel="prefetch" href="/assets/js/240.367d5841.js"><link rel="prefetch" href="/assets/js/241.51fcc762.js"><link rel="prefetch" href="/assets/js/242.b49f75a5.js"><link rel="prefetch" href="/assets/js/243.4aab3281.js"><link rel="prefetch" href="/assets/js/244.630ea25e.js"><link rel="prefetch" href="/assets/js/245.1809455f.js"><link rel="prefetch" href="/assets/js/246.186107ce.js"><link rel="prefetch" href="/assets/js/247.2d6e7001.js"><link rel="prefetch" href="/assets/js/248.cb4275dd.js"><link rel="prefetch" href="/assets/js/249.167a262b.js"><link rel="prefetch" href="/assets/js/25.630e2357.js"><link rel="prefetch" href="/assets/js/250.bbf34a8b.js"><link rel="prefetch" href="/assets/js/251.2ea87fb3.js"><link rel="prefetch" href="/assets/js/252.3390e0a2.js"><link rel="prefetch" href="/assets/js/253.7d324f48.js"><link rel="prefetch" href="/assets/js/254.888f3dcf.js"><link rel="prefetch" href="/assets/js/255.f5559bb4.js"><link rel="prefetch" href="/assets/js/256.c5a5867e.js"><link rel="prefetch" href="/assets/js/257.0f294953.js"><link rel="prefetch" href="/assets/js/26.d9a1ec00.js"><link rel="prefetch" href="/assets/js/27.e135a679.js"><link rel="prefetch" href="/assets/js/28.9a057a0a.js"><link rel="prefetch" href="/assets/js/29.2c3a87e0.js"><link rel="prefetch" href="/assets/js/30.2cc51d92.js"><link rel="prefetch" href="/assets/js/31.aa462b87.js"><link rel="prefetch" href="/assets/js/32.c22012c3.js"><link rel="prefetch" href="/assets/js/33.6b198417.js"><link rel="prefetch" href="/assets/js/34.7a34b7d7.js"><link rel="prefetch" href="/assets/js/35.2b1b8468.js"><link rel="prefetch" href="/assets/js/36.96decd2e.js"><link rel="prefetch" href="/assets/js/37.f3b74f8f.js"><link rel="prefetch" href="/assets/js/38.34ee2cf8.js"><link rel="prefetch" href="/assets/js/39.547ea2bc.js"><link rel="prefetch" href="/assets/js/4.51a792b3.js"><link rel="prefetch" href="/assets/js/40.07e513da.js"><link rel="prefetch" href="/assets/js/41.f7237ddc.js"><link rel="prefetch" href="/assets/js/42.3b4e70ba.js"><link rel="prefetch" href="/assets/js/43.82c2363a.js"><link rel="prefetch" href="/assets/js/44.af5d542b.js"><link rel="prefetch" href="/assets/js/45.581f794f.js"><link rel="prefetch" href="/assets/js/46.5cadc469.js"><link rel="prefetch" href="/assets/js/47.e6613404.js"><link rel="prefetch" href="/assets/js/48.e3a9b976.js"><link rel="prefetch" href="/assets/js/49.1c9e5731.js"><link rel="prefetch" href="/assets/js/5.9a6e789f.js"><link rel="prefetch" href="/assets/js/50.426b73a2.js"><link rel="prefetch" href="/assets/js/51.89ef07ae.js"><link rel="prefetch" href="/assets/js/52.43da4e0a.js"><link rel="prefetch" href="/assets/js/53.1ca339d7.js"><link rel="prefetch" href="/assets/js/54.0b490226.js"><link rel="prefetch" href="/assets/js/55.49db8070.js"><link rel="prefetch" href="/assets/js/56.ddc31e25.js"><link rel="prefetch" href="/assets/js/57.d0a969e8.js"><link rel="prefetch" href="/assets/js/58.7eeaa0f4.js"><link rel="prefetch" href="/assets/js/59.8808a61c.js"><link rel="prefetch" href="/assets/js/6.9fc1f886.js"><link rel="prefetch" href="/assets/js/60.5f8210aa.js"><link rel="prefetch" href="/assets/js/61.7a05ef08.js"><link rel="prefetch" href="/assets/js/62.3d69e92c.js"><link rel="prefetch" href="/assets/js/63.8aece5ab.js"><link rel="prefetch" href="/assets/js/64.d01335e4.js"><link rel="prefetch" href="/assets/js/65.313ac867.js"><link rel="prefetch" href="/assets/js/66.5742e448.js"><link rel="prefetch" href="/assets/js/67.e2cc3056.js"><link rel="prefetch" href="/assets/js/68.51074e1b.js"><link rel="prefetch" href="/assets/js/69.187f55d2.js"><link rel="prefetch" href="/assets/js/7.db4f6f85.js"><link rel="prefetch" href="/assets/js/70.6d783586.js"><link rel="prefetch" href="/assets/js/71.401b661c.js"><link rel="prefetch" href="/assets/js/72.da518b37.js"><link rel="prefetch" href="/assets/js/73.1f7b3c0d.js"><link rel="prefetch" href="/assets/js/74.e2a22f95.js"><link rel="prefetch" href="/assets/js/75.e009a648.js"><link rel="prefetch" href="/assets/js/76.f7de624f.js"><link rel="prefetch" href="/assets/js/77.ef4a01e0.js"><link rel="prefetch" href="/assets/js/78.3e735921.js"><link rel="prefetch" href="/assets/js/79.bb789130.js"><link rel="prefetch" href="/assets/js/8.7ff96eb1.js"><link rel="prefetch" href="/assets/js/80.d9ca901d.js"><link rel="prefetch" href="/assets/js/81.96a961b5.js"><link rel="prefetch" href="/assets/js/82.05783848.js"><link rel="prefetch" href="/assets/js/83.e2994430.js"><link rel="prefetch" href="/assets/js/84.75fd70df.js"><link rel="prefetch" href="/assets/js/85.63b6dd59.js"><link rel="prefetch" href="/assets/js/86.f9163b90.js"><link rel="prefetch" href="/assets/js/87.938bfabb.js"><link rel="prefetch" href="/assets/js/88.ab52b170.js"><link rel="prefetch" href="/assets/js/89.77d1009d.js"><link rel="prefetch" href="/assets/js/9.0e08b3f1.js"><link rel="prefetch" href="/assets/js/90.53b5180a.js"><link rel="prefetch" href="/assets/js/91.c3b3bf09.js"><link rel="prefetch" href="/assets/js/92.feacde27.js"><link rel="prefetch" href="/assets/js/93.b39664d0.js"><link rel="prefetch" href="/assets/js/94.5c3e78aa.js"><link rel="prefetch" href="/assets/js/95.c0874e6d.js"><link rel="prefetch" href="/assets/js/96.f5e3b5bb.js"><link rel="prefetch" href="/assets/js/97.4722f38d.js"><link rel="prefetch" href="/assets/js/98.2ec1dd6a.js"><link rel="prefetch" href="/assets/js/99.cf458698.js">
    <link rel="stylesheet" href="/assets/css/0.styles.97ec401e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc/2.7.0/" class="home-link router-link-active"><!----> <span class="site-name">Apache Ignite技术服务</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc/2.7.0/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/doc/2.7.0/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/doc/2.7.0/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/doc/2.7.0/net/" class="nav-link">
  C#/.NET
</a></div><div class="nav-item"><a href="/doc/2.7.0/sql/" class="nav-link">
  SQL
</a></div><div class="nav-item"><a href="/doc/2.7.0/integration/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/doc/2.7.0/spark/" class="nav-link">
  Ignite&amp;Spark
</a></div><div class="nav-item"><a href="/doc/2.7.0/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">2.7.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">2.7.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  2.9.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.8.0/java/ComputeGrid.html" class="nav-link">
  2.8.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.7.0/java/ComputeGrid.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  2.7.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/ComputeGrid.html" class="nav-link">
  2.6.0
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc/2.7.0/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/doc/2.7.0/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/doc/2.7.0/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/doc/2.7.0/net/" class="nav-link">
  C#/.NET
</a></div><div class="nav-item"><a href="/doc/2.7.0/sql/" class="nav-link">
  SQL
</a></div><div class="nav-item"><a href="/doc/2.7.0/integration/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/doc/2.7.0/spark/" class="nav-link">
  Ignite&amp;Spark
</a></div><div class="nav-item"><a href="/doc/2.7.0/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">2.7.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">2.7.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  2.9.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.8.0/java/ComputeGrid.html" class="nav-link">
  2.8.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.7.0/java/ComputeGrid.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  2.7.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/ComputeGrid.html" class="nav-link">
  2.6.0
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc/2.7.0/java/" aria-current="page" class="sidebar-link">基本概念</a></li><li><a href="/doc/2.7.0/java/Clustering.html" class="sidebar-link">集群化</a></li><li><a href="/doc/2.7.0/java/Key-ValueDataGrid.html" class="sidebar-link">键-值数据网格</a></li><li><a href="/doc/2.7.0/java/DataLoadingStreaming.html" class="sidebar-link">数据注入和流处理</a></li><li><a href="/doc/2.7.0/java/DistributedDataStructures.html" class="sidebar-link">分布式数据结构</a></li><li><a href="/doc/2.7.0/java/ComputeGrid.html" aria-current="page" class="active sidebar-link">计算网格</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_1-计算网格" class="sidebar-link">1.计算网格</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_1-1-ignitecompute" class="sidebar-link">1.1.IgniteCompute</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_2-分布式闭包" class="sidebar-link">2.分布式闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_2-1-概述" class="sidebar-link">2.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_2-2-broadcast方法" class="sidebar-link">2.2.broadcast方法</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_2-3-call和run方法" class="sidebar-link">2.3.call和run方法</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_2-4-apply方法" class="sidebar-link">2.4.apply方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_3-executor-service" class="sidebar-link">3.Executor Service</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-mapreduce和forkjoin" class="sidebar-link">4.MapReduce和ForkJoin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-1-概述" class="sidebar-link">4.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-2-computetask" class="sidebar-link">4.2.ComputeTask</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-3-计算任务适配器" class="sidebar-link">4.3.计算任务适配器</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-4-computejob" class="sidebar-link">4.4.ComputeJob</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-5-示例" class="sidebar-link">4.5.示例</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_4-6-分布式任务会话" class="sidebar-link">4.6.分布式任务会话</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_5-节点内状态共享" class="sidebar-link">5.节点内状态共享</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_5-1-概述" class="sidebar-link">5.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_5-2-示例" class="sidebar-link">5.2.示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_6-计算和数据的并置" class="sidebar-link">6.计算和数据的并置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_6-1-概述" class="sidebar-link">6.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_6-2-基于关联的call方法和run方法" class="sidebar-link">6.2.基于关联的call方法和run方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_7-容错" class="sidebar-link">7.容错</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_7-1-概述" class="sidebar-link">7.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_7-2-至少一次保证" class="sidebar-link">7.2.至少一次保证</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_7-3-闭包故障转移" class="sidebar-link">7.3.闭包故障转移</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_7-4-alwaysfailoverspi" class="sidebar-link">7.4.AlwaysFailOverSpi</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_8-负载平衡" class="sidebar-link">8.负载平衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_8-1-概述" class="sidebar-link">8.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_8-2-轮询式负载平衡" class="sidebar-link">8.2.轮询式负载平衡</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_8-3-随机和加权负载平衡" class="sidebar-link">8.3.随机和加权负载平衡</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_8-4-作业窃取" class="sidebar-link">8.4.作业窃取</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-检查点" class="sidebar-link">9.检查点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-1-概述" class="sidebar-link">9.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-2-主节点故障保护" class="sidebar-link">9.2.主节点故障保护</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-3-设置检查点" class="sidebar-link">9.3.设置检查点</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-4-checkpointspi" class="sidebar-link">9.4.CheckpointSpi</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-5-文件系统检查点配置" class="sidebar-link">9.5.文件系统检查点配置</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-6-缓存检查点配置" class="sidebar-link">9.6.缓存检查点配置</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-7-数据库检查点配置" class="sidebar-link">9.7.数据库检查点配置</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_9-8-amazon-s3-检查点配置" class="sidebar-link">9.8.Amazon S3 检查点配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_10-作业调度" class="sidebar-link">10.作业调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_10-1-概述" class="sidebar-link">10.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_10-2-fifo排序" class="sidebar-link">10.2.FIFO排序</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_10-3-优先级排序" class="sidebar-link">10.3.优先级排序</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_11-任务部署" class="sidebar-link">11.任务部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_11-1-deploymentspi" class="sidebar-link">11.1.DeploymentSpi</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_11-2-urideploymentspi" class="sidebar-link">11.2.UriDeploymentSpi</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_11-3-localdeploymentspi" class="sidebar-link">11.3.LocalDeploymentSpi</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_12-基于cron的调度" class="sidebar-link">12.基于Cron的调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_12-1-概述" class="sidebar-link">12.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_12-2-schedulerfuture" class="sidebar-link">12.2.SchedulerFuture</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_12-3-语法扩展" class="sidebar-link">12.3.语法扩展</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_13-持续映射" class="sidebar-link">13.持续映射</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_13-1-概述" class="sidebar-link">13.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_13-2-运行持续的映射任务" class="sidebar-link">13.2.运行持续的映射任务</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_13-3-示例" class="sidebar-link">13.3.示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_14-启用基于aop的网格" class="sidebar-link">14.启用基于AOP的网格</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_14-1-gridify注解" class="sidebar-link">14.1.Gridify注解</a></li><li class="sidebar-sub-header"><a href="/doc/2.7.0/java/ComputeGrid.html#_14-2-配置aop" class="sidebar-link">14.2.配置AOP</a></li></ul></li></ul></li><li><a href="/doc/2.7.0/java/ServiceGrid.html" class="sidebar-link">服务网格</a></li><li><a href="/doc/2.7.0/java/MessagingEvents.html" class="sidebar-link">消息和事件</a></li><li><a href="/doc/2.7.0/java/DurableMemory.html" class="sidebar-link">固化内存</a></li><li><a href="/doc/2.7.0/java/Persistence.html" class="sidebar-link">持久化</a></li><li><a href="/doc/2.7.0/java/MachineLearning.html" class="sidebar-link">机器学习网格</a></li><li><a href="/doc/2.7.0/java/DeepLearning.html" class="sidebar-link">深度学习</a></li><li><a href="/doc/2.7.0/java/ThinClients.html" class="sidebar-link">瘦客户端</a></li><li><a href="/doc/2.7.0/java/PlatformsProtocols.html" class="sidebar-link">平台和协议</a></li><li><a href="/doc/2.7.0/java/Plugins.html" class="sidebar-link">插件</a></li><li><a href="/doc/2.7.0/java/Security.html" class="sidebar-link">安全</a></li><li><a href="/doc/2.7.0/java/Deployment.html" class="sidebar-link">部署</a></li><li><a href="/doc/2.7.0/java/KubernetesDeployment.html" class="sidebar-link">Kubernetes部署</a></li><li><a href="/doc/2.7.0/java/TestsAndBenchmarking.html" class="sidebar-link">基准测试</a></li><li><a href="/doc/2.7.0/java/Metrics.html" class="sidebar-link">指标</a></li><li><a href="/doc/2.7.0/java/ProductionReadiness.html" class="sidebar-link">生产准备</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="计算网格"><a href="#计算网格" class="header-anchor">#</a> 计算网格</h1> <h2 id="_1-计算网格"><a href="#_1-计算网格" class="header-anchor">#</a> 1.计算网格</h2> <p>Ignite的计算网格可以将比如一个计算这样的逻辑片段，可选地拆分为多个部分，然后在不同的节点并行地执行，这样就可以并行地利用所有节点的资源，来减少计算任务的整体执行时间。并行执行的最常见设计模式就是MapReduce。但是，即使不需要对计算进行拆分或者并行执行，计算网格也会非常有用，因为它可以通过将计算负载放在多个可用节点上，提高整个系统的扩展性和容错能力。</p> <p>计算网格的API非常简单，可以将计算和数据处理发布到集群的多个节点上，还可以配置失败策略来控制特定作业失败时的行为。</p> <p><img src="https://files.readme.io/kFOguSuNQNWCEnyUECLi_in_memory_compute.png" alt=""></p> <p>计算网格的关键特性包括：</p> <ul><li><strong>自动部署</strong>：可以自动化地部署执行某个任务所必需的类和资源；</li> <li><strong>拓扑分解</strong>：可以根据节点的特性或者指定的配置来供应资源，比如，希望只在Linux节点上执行，或者在特定的时间窗口中只希望在某些节点上执行，还可能希望只在CPU负载在50%以下的节点中执行，或者希望有至少2G的可用堆内存等等；</li> <li><strong>冲突解决</strong>：可以控制哪些任务可以执行，哪些任务会被拒绝，多少任务并行执行以及执行的顺序等等；</li> <li><strong>负载平衡</strong>：可以正确地在集群中平衡负载，常见的包括轮询、随机和自适应，Ignite还提供基于关联的负载平衡，即任务根据其关联键，在该关联键所对应的节点上执行，这意味着代码的执行更接近其数据，即并置处理；</li> <li><strong>故障转移</strong>：可以配置自动或者手工的故障转移，这样在节点故障或者出现其它错误时，任务会自动地转移到其它的节点。</li></ul> <h3 id="_1-1-ignitecompute"><a href="#_1-1-ignitecompute" class="header-anchor">#</a> 1.1.IgniteCompute</h3> <p><code>IgniteCompute</code>接口提供了在集群节点或者一个集群组中运行很多种类型计算的方法，这些方法可以以一个分布式的形式执行任务或者闭包。</p> <p>只要至少有一个节点有效，所有的作业和闭包就会保证得到执行，如果一个作业的执行由于资源不足被踢出，它会提供一个故障转移的机制。如果发生故障，负载平衡器会选择下一个有效的节点来执行该作业，下面的代码显示了如何获得<code>IgniteCompute</code>实例:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get compute instance over all nodes in the cluster.</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以通过集群组来限制执行的范围，这时，计算只会在集群组内的节点上执行。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignitition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ClusterGroup</span> remoteGroup <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit computations only to remote nodes (exclude local node).</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>remoteGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_2-分布式闭包"><a href="#_2-分布式闭包" class="header-anchor">#</a> 2.分布式闭包</h2> <h3 id="_2-1-概述"><a href="#_2-1-概述" class="header-anchor">#</a> 2.1.概述</h3> <p>Ignite计算网格可以对集群或者集群组内的任何闭包进行广播和负载平衡，包括纯Java的<code>runnables</code>和<code>callables</code>。</p> <h3 id="_2-2-broadcast方法"><a href="#_2-2-broadcast方法" class="header-anchor">#</a> 2.2.broadcast方法</h3> <p>所有的<code>broadcast(...)</code>方法会将一个给定的作业广播到所有的集群节点或者集群组。</p> <p>Java8广播：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit broadcast to remote nodes only.</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Print out hello message on remote nodes in the cluster group.</span>
compute<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Node: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">localIgnite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>Java8异步广播：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit broadcast to remote nodes only and</span>
<span class="token comment">// enable asynchronous mode.</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Print out hello message on remote nodes in the cluster group.</span>
compute<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Node: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">localIgnite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ComputeTaskFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fut <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>

fut<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished sending broadcast job.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java7广播：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit broadcast to rmeote nodes only.</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>ignite<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Print out hello message on remote nodes in projection.</span>
compute<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Print ID of remote node on remote node.</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Hello Node: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">localIgnite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java7异步广播：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">ignite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Limit broadcast to remote nodes only and</span>
<span class="token comment">// enable asynchronous mode.</span>
<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>ignite<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">forRemotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Print out hello message on remote nodes in the cluster group.</span>
compute<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Print ID of remote node on remote node.</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Hello Node: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">localIgnite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ComputeTaskFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fut <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>

fut<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteInClosure</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">ComputeTaskFuture</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">ComputeTaskFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished sending broadcast job to cluster.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-3-call和run方法"><a href="#_2-3-call和run方法" class="header-anchor">#</a> 2.3.call和run方法</h3> <p>所有的<code>call(...)</code>和<code>run(...)</code>方法都可以在集群或者集群组内既可以执行单独的作业也可以执行作业的集合。</p> <p>Java8：call：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IgniteCallable</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> calls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words in the sentence and create callable jobs.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;How many characters&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    calls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>word<span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute collection of callables on the cluster.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add all the word lengths received from cluster nodes.</span>
<span class="token keyword">int</span> total <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">intValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java8:run:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words and print</span>
<span class="token comment">// each word on a different cluster node.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Print words on different cluster nodes&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// Run on some cluster node.</span>
    compute<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java8:异步call：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IgniteCallable</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> calls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words in the sentence and create callable jobs.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Count characters using callable&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    calls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>word<span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enable asynchronous mode.</span>
<span class="token class-name">IgniteCompute</span> asyncCompute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Asynchronously execute collection of callables on the cluster.</span>
asyncCompute<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncCompute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>fut <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Total number of characters.</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> fut<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">intValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Total number of characters: &quot;</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java8:异步run：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> asyncCompute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeTaskFuture</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words and print</span>
<span class="token comment">// each word on a different cluster node.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Print words on different cluster nodes&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Asynchronously run on some cluster node.</span>
    asyncCompute<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    futs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCompute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Wait for completion of all futures.</span>
futs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">ComputeTaskFuture</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java7:call:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IgniteCallable</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> calls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words in the sentence and create callable jobs.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Count characters using callable&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    calls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Return word length.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Execute collection of callables on the cluster.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>calls<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// Total number of characters.</span>
<span class="token comment">// Looks much better in Java 8.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> i <span class="token operator">:</span> res<span class="token punctuation">)</span>
  total <span class="token operator">+=</span> i<span class="token punctuation">;</span>
</code></pre></div><p>Java7:异步run：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> asyncCompute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeTaskFuture</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words and print</span>
<span class="token comment">// each word on a different cluster node.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Print words on different cluster nodes&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Asynchronously run on some cluster node.</span>
    asyncCompute<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    futs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCompute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Wait for completion of all futures.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ComputeTaskFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">:</span> futs<span class="token punctuation">)</span>
  f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-4-apply方法"><a href="#_2-4-apply方法" class="header-anchor">#</a> 2.4.apply方法</h3> <p>闭包是一个代码块，它是把代码体和任何外部变量包装起来然后以一个函数对象的形式在内部使用它们，然后可以在任何传入一个变量的地方传递这样一个函数对象，然后执行。所有的apply方法都可以在集群内执行闭包。</p> <p>Java8：apply：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute  <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute closure on all cluster nodes.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">,</span>
    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;How many characters&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add all the word lengths received from cluster nodes.</span>
<span class="token keyword">int</span> total <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">intValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java8:异步apply：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Enable asynchronous mode.</span>
<span class="token class-name">IgniteCompute</span> asyncCompute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute closure on all cluster nodes.</span>
<span class="token comment">// If the number of closures is less than the number of</span>
<span class="token comment">// parameters, then Ignite will create as many closures</span>
<span class="token comment">// as there are parameters.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> asyncCompute<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
    <span class="token class-name">String</span><span class="token operator">::</span><span class="token function">length</span><span class="token punctuation">,</span>
    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;How many characters&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

asyncCompute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>fut <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Total number of characters.</span>
    <span class="token keyword">int</span> total <span class="token operator">=</span> fut<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">intValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Total number of characters: &quot;</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java7:apply:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Execute closure on all cluster nodes.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">IgniteClosure</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Return number of letters in the word.</span>
            <span class="token keyword">return</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;Count characters using closure&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// Add up individual word lengths received from remote nodes</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> len <span class="token operator">:</span> res<span class="token punctuation">)</span>
    sum <span class="token operator">+=</span> len<span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-executor-service"><a href="#_3-executor-service" class="header-anchor">#</a> 3.Executor Service</h2> <p>IgniteCompute提供了一个方便的API以在集群内执行计算。虽然也可以直接使用JDK提供的标准<code>ExecutorService</code>接口，但是Ignite还提供了一个<code>ExecutorService</code>接口的分布式实现然后可以在集群内自动以负载平衡的模式执行所有计算。该计算具有容错性以及保证只要有一个节点处于活动状态就能保证计算得到执行，可以将其视为一个分布式的集群化线程池。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Get cluster-enabled executor service.</span>
<span class="token class-name">ExecutorService</span> exec <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">executorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Iterate through all words in the sentence and create jobs.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> word <span class="token operator">:</span> <span class="token string">&quot;Print words using runnable&quot;</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Execute runnable on some node.</span>
  exec<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Printing '&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;' on this node from grid job.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以限制作业在一个集群组中执行：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Cluster group for nodes where the attribute 'worker' is defined.</span>
<span class="token class-name">ClusterGroup</span> workerGrp <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;worker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get cluster-enabled executor service for the above cluster group.</span>
<span class="token class-name">ExecutorService</span> exec <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">executorService</span><span class="token punctuation">(</span>workerGrp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-mapreduce和forkjoin"><a href="#_4-mapreduce和forkjoin" class="header-anchor">#</a> 4.MapReduce和ForkJoin</h2> <h3 id="_4-1-概述"><a href="#_4-1-概述" class="header-anchor">#</a> 4.1.概述</h3> <p><code>ComputeTask</code>是Ignite对于简化内存内MapReduce的抽象，这个也非常接近于ForkJoin范式，纯粹的MapReduce从来不是为了性能而设计，只适用于处理离线的批量业务处理(比如Hadoop MapReduce)。不过当对内存内的数据进行计算时，实时性低延迟和高吞吐量通常具有更高的优先级。同样，简化API也变得非常重要。考虑到这一点，Ignite推出了<code>ComputeTask</code> API，它是一个轻量级的MapReduce(或ForkJoin)实现。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>只有当需要对作业到节点的映射做细粒度控制或者对故障转移进行定制的时候，才使用<code>ComputeTask</code>。对于所有其它的场景，都需要使用<a href="#_7-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%97%AD%E5%8C%85">分布式闭包</a>中介绍的集群内闭包执行来实现。</p></div> <h3 id="_4-2-computetask"><a href="#_4-2-computetask" class="header-anchor">#</a> 4.2.ComputeTask</h3> <p><code>ComputeTask</code>定义了要在集群内执行的作业以及这些作业到节点的映射，它还定义了如何处理作业的返回值(Reduce)。所有的<code>IgniteCompute.execute(...)</code>方法都会在集群上执行给定的任务，应用只需要实现<code>ComputeTask</code>接口的<code>map(...)</code>和<code>reduce(...)</code>方法即可。</p> <p>任务是通过实现<code>ComputeTask</code>接口的2或者3个方法定义的。</p> <p><strong>map方法</strong></p> <p><code>map(...)</code>方法将作业实例化然后将它们映射到工作节点，这个方法收到任务要运行的集群节点的集合还有任务的参数，该方法会返回一个map，作业为键，映射的工作节点为值。然后作业会被发送到工作节点上并且在那里执行。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>关于<code>map(...)</code>方法的简化实现，可以参照下面的<code>ComputeTaskSplitAdapter</code>。</p></div> <p><strong>result方法</strong></p> <p><code>result(...)</code>方法在每次作业在集群节点上执行时都会被调用，它接收计算作业返回的结果，以及迄今为止收到的作业结果的列表。该方法会返回一个<code>ComputeJobResultPolicy</code>的实例，说明下一步要做什么。</p> <ul><li><code>WAIT</code>:等待所有剩余的作业完成（如果有）</li> <li><code>REDUCE</code>：立即进入Reduce阶段，丢弃剩余的作业和还未收到的结果</li> <li><code>FAILOVER</code>：将作业转移到另一个节点（参照<a href="#_7-7-%E5%AE%B9%E9%94%99">容错</a>章节），所有已经收到的作业结果也会在<code>reduce(...)</code>方法中有效</li></ul> <p><strong>reduce方法</strong></p> <p>当所有作业完成后（或者从<code>result(...)</code>方法返回REDUCE结果策略），<code>reduce(...)</code>方法在Reduce阶段被调用。该方法接收到所有计算结果的一个列表然后返回一个最终的计算结果。</p> <h3 id="_4-3-计算任务适配器"><a href="#_4-3-计算任务适配器" class="header-anchor">#</a> 4.3.计算任务适配器</h3> <p>定义计算时每次都实现<code>ComputeTask</code>的所有三个方法并不是必须的，有一些帮助类使得只需要描述一个特定的逻辑片段即可，剩下的交给Ignite自动处理。</p> <p><strong>ComputeTaskAdapter</strong></p> <p><code>ComputeTaskAdapter</code>定义了一个默认的<code>result(...)</code>方法实现，它在当一个作业抛出异常时返回一个<code>FAILOVER</code>策略，否则会返回一个<code>WAIT</code>策略，这样会等待所有的作业完成，并且有结果。</p> <p><strong>ComputeTaskSplitAdapter</strong></p> <p><code>ComputeTaskSplitAdapter</code>继承了<code>ComputeTaskAdapter</code>,它增加了将作业自动分配给节点的功能。它隐藏了<code>map(...)</code>方法然后增加了一个新的<code>split(...)</code>方法，使得开发者只需要提供一个待执行的作业集合（这些作业到节点的映射会被适配器以负载平衡的方式自动处理）。</p> <p>这个适配器对于所有节点都适于执行作业的同质化环境是非常有用的，这样映射阶段就可以隐式地完成。</p> <h3 id="_4-4-computejob"><a href="#_4-4-computejob" class="header-anchor">#</a> 4.4.ComputeJob</h3> <p>任务触发的所有作业都实现了<code>ComputeJob</code>接口，这个接口的<code>execute()</code>方法定义了作业的逻辑然后应该返回一个作业的结果。<code>cancel()</code>方法定义了当一个作业被丢弃时的逻辑（比如，当任务决定立即进入Reduce阶段或者被取消）。</p> <p><strong>ComputeJobAdapter</strong></p> <p>这是一个提供了无操作的<code>cancel()</code>方法的方便的适配器类。</p> <h3 id="_4-5-示例"><a href="#_4-5-示例" class="header-anchor">#</a> 4.5.示例</h3> <p>下面是一个<code>ComputeTask</code>和<code>ComputeJob</code>的示例：</p> <p>ComputeTaskSplitAdapter：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute task on the clustr and wait for its completion.</span>
<span class="token keyword">int</span> cnt <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">CharacterCountTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello Grid Enabled World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Total number of characters in the phrase is '&quot;</span> <span class="token operator">+</span> cnt <span class="token operator">+</span> <span class="token string">&quot;'.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Task to count non-white-space characters in a phrase.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CharacterCountTask</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeTaskSplitAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. Splits the received string into to words</span>
  <span class="token comment">// 2. Creates a child job for each word</span>
  <span class="token comment">// 3. Sends created jobs to other nodes for processing.</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridSize<span class="token punctuation">,</span> <span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">&gt;</span></span> jobs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>words<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> word <span class="token operator">:</span> arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      jobs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComputeJobAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Printing '&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;' on from compute job.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Return number of letters in the word.</span>
          <span class="token keyword">return</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> jobs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ComputeJobResult</span> res <span class="token operator">:</span> results<span class="token punctuation">)</span>
      sum <span class="token operator">+=</span> res<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ComputeTaskAdapter：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute task on the clustr and wait for its completion.</span>
<span class="token keyword">int</span> cnt <span class="token operator">=</span> grid<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">CharacterCountTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello Grid Enabled World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Total number of characters in the phrase is '&quot;</span> <span class="token operator">+</span> cnt <span class="token operator">+</span> <span class="token string">&quot;'.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Task to count non-white-space characters in a phrase.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CharacterCountTask</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeTaskAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. Splits the received string into to words</span>
    <span class="token comment">// 2. Creates a child job for each word</span>
    <span class="token comment">// 3. Sends created jobs to other nodes for processing.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> subgrid<span class="token punctuation">,</span> <span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>words<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> subgrid<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> word <span class="token operator">:</span> arg<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If we used all nodes, restart the iterator.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                it <span class="token operator">=</span> subgrid<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ClusterNode</span> node <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComputeJobAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt; Printing '&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token string">&quot;' on this node from grid job.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Return number of letters in the word.</span>
                    <span class="token keyword">return</span> word<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ComputeJobResult</span> res <span class="token operator">:</span> results<span class="token punctuation">)</span>
            sum <span class="token operator">+=</span> res<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-6-分布式任务会话"><a href="#_4-6-分布式任务会话" class="header-anchor">#</a> 4.6.分布式任务会话</h3> <p>每个任务执行时都会创建分布式任务会话，它是由<code>ComputeTaskSession</code>接口定义的。任务会话对于任务和其产生的所有作业都是可见的，因此一个作业或者一个任务设置的属性也可以被其它的作业访问。任务会话也可以在属性设置或者等待属性设置时接收通知。</p> <p>在任务及其相关的所有作业之间会话属性设置的顺序是一致的，不会出现一个作业发现属性A在属性B之前，而另一个作业发现属性B在属性A之前的情况。</p> <p>在下面的例子中，让所有的作业在步骤1移动到步骤2之前是同步的：</p> <div class="custom-block tip"><p class="custom-block-title">@ComputeTaskSessionFullSupport注解</p> <p>注意由于性能的原因分布式任务会话默认是禁用的，可以任务类上加注<code>@ComputeTaskSessionFullSupport</code>注解启用。</p></div> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">commpute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compute<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskSessionAttributesTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Task demonstrating distributed task session attributes.
 * Note that task session attributes are enabled only if
 * @ComputeTaskSessionFullSupport annotation is attached.
 */</span>
<span class="token annotation punctuation">@ComputeTaskSessionFullSupport</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TaskSessionAttributesTask</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeTaskSplitAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GridJob</span><span class="token punctuation">&gt;</span></span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridSize<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">&gt;</span></span> jobs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Generate jobs by number of nodes in the grid.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> gridSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      jobs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComputeJobAdapter</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Auto-injected task session.</span>
        <span class="token annotation punctuation">@TaskSessionResource</span>
        <span class="token keyword">private</span> <span class="token class-name">ComputeTaskSession</span> ses<span class="token punctuation">;</span>

        <span class="token comment">// Auto-injected job context.</span>
        <span class="token annotation punctuation">@JobContextResource</span>
        <span class="token keyword">private</span> <span class="token class-name">ComputeJobContext</span> jobCtx<span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Perform STEP1.</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

          <span class="token comment">// Tell other jobs that STEP1 is complete.</span>
          ses<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>jobCtx<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;STEP1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Wait for other jobs to complete STEP1.</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ComputeJobSibling</span> sibling <span class="token operator">:</span> ses<span class="token punctuation">.</span><span class="token function">getJobSiblings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            ses<span class="token punctuation">.</span><span class="token function">waitForAttribute</span><span class="token punctuation">(</span>sibling<span class="token punctuation">.</span><span class="token function">getJobId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;STEP1&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Move on to STEP2.</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No-op.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-节点内状态共享"><a href="#_5-节点内状态共享" class="header-anchor">#</a> 5.节点内状态共享</h2> <h3 id="_5-1-概述"><a href="#_5-1-概述" class="header-anchor">#</a> 5.1.概述</h3> <p>通常来说在不同的计算作业或者不同的部署服务之间共享状态是很有用的，为此Ignite在每个节点上提供了一个共享并发<strong>node-local-map</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCluster</span> cluster <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> nodeLocalMap <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">nodeLocalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
</code></pre></div><p>节点局部变量类似于线程局部变量，只不过它不是分布式的，它只会保持在本地节点上。节点局部变量可以用于计算任务在不同的执行中共享状态，也可以用于部署的服务。</p> <h3 id="_5-2-示例"><a href="#_5-2-示例" class="header-anchor">#</a> 5.2.示例</h3> <p>作为一个例子，创建一个作业，每次当它在某个节点上执行时都会使节点局部的计数器增加，这样，每个节点的节点局部计数器都会通知某作业在那个节点上执行了多少次。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">IgniteCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@IgniteInstanceResource</span>
  <span class="token keyword">private</span> <span class="token class-name">Ignite</span> ignite<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get a reference to node local.</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">&gt;</span></span> nodeLocalMap <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nodeLocalMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">AtomicLong</span> cntr <span class="token operator">=</span> nodeLocalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cntr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AtomicLong</span> old <span class="token operator">=</span> nodeLocalMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span> cntr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        cntr <span class="token operator">=</span> old<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cntr<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在在同一个节点上执行这个作业2次然后确保计数器的值为2：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ClusterGroup</span> random <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span>random<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The first time the counter on the picked node will be initialized to 1.</span>
<span class="token class-name">Long</span> res <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">assert</span> res <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// Now the counter will be incremented and will have value 2.</span>
res <span class="token operator">=</span> compute<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">assert</span> res <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-计算和数据的并置"><a href="#_6-计算和数据的并置" class="header-anchor">#</a> 6.计算和数据的并置</h2> <h3 id="_6-1-概述"><a href="#_6-1-概述" class="header-anchor">#</a> 6.1.概述</h3> <p>计算和数据的并置可以最小化网络中的数据序列化，以及可以显著地提升应用的性能和可扩展性。只要可能，都应该尽力地将计算和存储待处理数据的集群节点并置在一起。</p> <h3 id="_6-2-基于关联的call方法和run方法"><a href="#_6-2-基于关联的call方法和run方法" class="header-anchor">#</a> 6.2.基于关联的call方法和run方法</h3> <p><code>affinityCall(...)</code>和<code>affinityRun(...)</code>方法使作业和缓存着数据的节点位于一处，换句话说，给定缓存名字和关联键，这些方法会试图在指定的缓存中定位键所在的节点，然后在那里执行作业。</p> <div class="custom-block tip"><p class="custom-block-title">一致性保证</p> <p>从ignite1.8版本开始，当<code>affinityCall(...)</code>或者<code>affinityRun(...)</code>触发一个作业时，关联键所在的分区是不会从作业执行所处的节点退出的。由于拓扑的变更事件，比如新节点加入集群或者旧节点离开，分区的再平衡会经常发生。<br>
这个保证使得可以执行复杂的业务逻辑，因为作业执行的全过程中让数据一直位于同一个节点至关重要。比如，这个特性可以将执行<em>本地</em>SQL查询作为<code>affinityCall(...)</code>或者<code>affinityRun(...)</code>触发的作业的一部分，不用担心因为数据再平衡导致本地查询返回一部分的结果集。</p></div> <p>Java8:affinityRun：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> key <span class="token operator">&lt;</span> KEY_CNT<span class="token punctuation">;</span> key<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This closure will execute on the remote node where</span>
    <span class="token comment">// data with the 'key' is located.</span>
    compute<span class="token punctuation">.</span><span class="token function">affinityRun</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Peek is a local memory lookup.</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Co-located [key= &quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;, value= &quot;</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">localPeek</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Java8:异步affinityRun：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteCompute</span> asyncCompute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IgniteFuture</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> futs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> key <span class="token operator">&lt;</span> KEY_CNT<span class="token punctuation">;</span> key<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This closure will execute on the remote node where</span>
    <span class="token comment">// data with the 'key' is located.</span>
    asyncCompute<span class="token punctuation">.</span><span class="token function">affinityRun</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// Peek is a local memory lookup.</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Co-located [key= &quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;, value= &quot;</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    futs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>asyncCompute<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Wait for all futures to complete.</span>
futs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">IgniteFuture</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Java7:affinityRun:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">IgniteCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> KEY_CNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> key <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token comment">// This closure will execute on the remote node where</span>
    <span class="token comment">// data with the 'key' is located.</span>
    compute<span class="token punctuation">.</span><span class="token function">affinityRun</span><span class="token punctuation">(</span>CACHE_NAME<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IgniteRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Peek is a local memory lookup.</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Co-located [key= &quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;, value= &quot;</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">']'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">注意</p> <p><code>affinityCall(...)</code>或者<code>affinityRun(...)</code>方法都有重载的版本，可以锁定分区，避免作业跨多个缓存执行时，分区的退出，要做的仅仅是将缓存的名字传递给上述方法。</p></div> <h2 id="_7-容错"><a href="#_7-容错" class="header-anchor">#</a> 7.容错</h2> <h3 id="_7-1-概述"><a href="#_7-1-概述" class="header-anchor">#</a> 7.1.概述</h3> <p>Ignite支持作业的自动故障转移，当一个节点崩溃时，作业会被转移到其它可用节点再次执行。不过在Ignite中也可以将任何作业的结果认为是失败的。工作的节点可以仍然是在线的，但是它运行在一个很低的CPU，I/O，磁盘空间等资源上，在很多情况下会导致应用的故障然后触发一个故障的转移。此外，也有选择一个作业故障转移到那个节点的功能，因为同一个应用内部不同的程序或者不同的计算也会是不同的。</p> <p><code>FailoverSpi</code>负责选择一个新的节点来执行失败作业。<code>FailoverSpi</code>检查发生故障的作业以及该作业可以尝试执行的所有可用的网格节点的列表。它会确保该作业不会再次映射到出现故障的同一个节点。故障转移是在<code>ComputeTask.result(...)</code>方法返回<code>ComputeJobResultPolicy.FAILOVER</code>策略时触发的。Ignite内置了一些可定制的故障转移SPI实现。</p> <h3 id="_7-2-至少一次保证"><a href="#_7-2-至少一次保证" class="header-anchor">#</a> 7.2.至少一次保证</h3> <p>只要有一个节点是有效的，作业就不会丢失。</p> <p>Ignite默认会自动对停止或者故障的节点上的所有作业进行故障转移，如果要定制故障转移的行为，需要实现<code>ComputeTask.result()</code>方法。下面的例子显示了当一个作业抛出任何的<code>IgniteException</code>(或者它的子类)时会触发故障转移。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComputeTask</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeTaskSplitAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ComputeJobResultPolicy</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token class-name">ComputeJobResult</span> res<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> rcvd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IgniteException</span> err <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token class-name">ComputeJobResultPolicy</span><span class="token punctuation">.</span>FAILOVER<span class="token punctuation">;</span>

        <span class="token comment">// If there is no exception, wait for all job results.</span>
        <span class="token keyword">return</span> <span class="token class-name">ComputeJobResultPolicy</span><span class="token punctuation">.</span>WAIT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-3-闭包故障转移"><a href="#_7-3-闭包故障转移" class="header-anchor">#</a> 7.3.闭包故障转移</h3> <p>闭包的故障转移是被<code>ComputeTaskAdapter</code>管理的，它在一个远程节点或者故障或者拒绝执行闭包时被触发。这个默认的行为可以被<code>IgniteCompute.withNoFailover()</code>方法覆盖，它会创建一个设置了无故障转移标志的<code>IgniteCompute</code>实例，下面是一个示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withNoFailover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compute<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do something</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Some argument&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-4-alwaysfailoverspi"><a href="#_7-4-alwaysfailoverspi" class="header-anchor">#</a> 7.4.AlwaysFailOverSpi</h3> <p>Ignite将任务拆分成作业然后为了加快处理的速度将它们分配给多个节点执行，如果一个节点故障了，<code>AlwaysFailoverSpi</code>会将一个故障的作业路由到另一个节点，首先会尝试将故障的作业路由到该任务还没有被执行过的节点上，如果没有可用的节点，然后会试图将故障的作业路由到可能运行同一个任务中其它的作业的节点上，如果上述的尝试都失败了，那么该作业就不会被故障转移然后会返回一个null。</p> <p>下面的配置参数可以用于配置<code>AlwaysFailoverSpi</code>:</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setMaximumFailoverAttempts(int)</code></td> <td>设置尝试将故障作业转移到其它节点的最大次数</td> <td>5</td></tr></tbody></table> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>grid.custom.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.failover.always.AlwaysFailoverSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maximumFailoverAttempts<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>5<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">AlwaysFailoverSpi</span> failSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlwaysFailoverSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override maximum failover attempts.</span>
failSpi<span class="token punctuation">.</span><span class="token function">setMaximumFailoverAttempts</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override the default failover SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setFailoverSpi</span><span class="token punctuation">(</span>failSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-负载平衡"><a href="#_8-负载平衡" class="header-anchor">#</a> 8.负载平衡</h2> <h3 id="_8-1-概述"><a href="#_8-1-概述" class="header-anchor">#</a> 8.1.概述</h3> <p>负载平衡组件将作业在集群节点之间平衡分配。Ignite中负载平衡是通过<code>LoadBalancingSpi</code>实现的，它控制所有节点的负载以及确保集群中的每个节点负载水平均衡。对于同质化环境中的同质化任务，负载平衡采用的是随机或者轮询的策略。不过在很多其它场景中，特别是在一些不均匀的负载下，就需要更复杂的自适应负载平衡策略。</p> <p><code>LoadBalancingSpi</code>采用前负载技术，即在将其发送到集群之前就对作业在某个节点的执行进行了调度。</p> <div class="custom-block tip"><p class="custom-block-title">数据并置</p> <p>注意，当作业还没有与数据并置或者还没有在哪个节点上执行的倾向时，负载平衡就已经触发了。如果使用了数据和计算的并置，那么数据的并置优先于负载平衡。</p></div> <h3 id="_8-2-轮询式负载平衡"><a href="#_8-2-轮询式负载平衡" class="header-anchor">#</a> 8.2.轮询式负载平衡</h3> <p><code>RoundRobinLoadBalancingSpi</code>以轮询的方式在节点间迭代，然后选择下一个连续的节点。轮询式负载平衡支持两种操作模式：每任务以及全局，全局模式为默认模式。</p> <p><strong>每任务模式</strong></p> <p>如果配置成每任务模式，当任务开始执行时实现会随机地选择一个节点，然后会顺序地迭代拓扑中所有的节点，对于任务拆分的大小等同于节点的数量时，这个模式保证所有的节点都会参与任务的执行。</p> <p><strong>全局模式</strong></p> <p>如果配置成全局模式，对于所有的任务都会维护一个节点的单一连续队列然后每次都会从队列中选择一个节点。这个模式中（不像每任务模式），当多个任务并发执行时，即使任务的拆分大小等同于节点的数量，同一个任务的某些作业仍然可能被赋予同一个节点。</p> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>grid.custom.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loadBalancingSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.loadbalancing.roundrobin.RoundRobinLoadBalancingSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- Set to per-task round-robin mode (this is default behavior). --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>perTask<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">RoundRobinLoadBalancingSpi</span> spi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinLoadBalancingSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configure SPI to use per-task mode (this is default behavior).</span>
spi<span class="token punctuation">.</span><span class="token function">setPerTask</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default load balancing SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setLoadBalancingSpi</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-3-随机和加权负载平衡"><a href="#_8-3-随机和加权负载平衡" class="header-anchor">#</a> 8.3.随机和加权负载平衡</h3> <p><code>WeightedRandomLoadBalancingSpi</code>会为作业的执行随机选择一个节点。也可以选择为节点赋予权值，这样有更高权重的节点最终会使将作业分配给它的机会更多。所有节点的权重默认值都是10。</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>grid.custom.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loadBalancingSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.loadbalancing.weightedrandom.WeightedRandomLoadBalancingSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>useWeights<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>nodeWeight<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">WeightedRandomLoadBalancingSpi</span> spi<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeightedRandomLoadBalancingSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Configure SPI to used weighted random load balancing.</span>
spi<span class="token punctuation">.</span><span class="token function">setUseWeights</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set weight for the local node.</span>
spi<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default load balancing SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setLoadBalancingSpi</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-4-作业窃取"><a href="#_8-4-作业窃取" class="header-anchor">#</a> 8.4.作业窃取</h3> <p>通常集群由很多计算机组成，这就可能存在配置不均衡的情况，这时开启<code>JobStealingCollisionSpi</code>就会有助于避免作业聚集在过载的节点，因为它们将被未充分利用的节点窃取。</p> <p><code>JobStealingCollisionSpi</code>支持将作业从高负载节点移动到低负载节点，当部分作业完成得很快，而其它的作业还在高负载节点中排队时，这个SPI就会非常有用。这时等待作业就会被移动到低负载的节点。</p> <p><code>JobStealingCollisionSpi</code>采用的是后负载技术，它可以在任务已经被调度在节点A执行后重新分配到节点B。</p> <p>下面是配置<code>JobStealingCollisionSpi</code>的示例：</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Enabling the required Failover SPI. --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>failoverSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.failover.jobstealing.JobStealingFailoverSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Enabling the JobStealingCollisionSpi for late load balancing. --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>collisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.collision.jobstealing.JobStealingCollisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>activeJobsThreshold<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>waitJobsThreshold<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>messageExpireTime<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maximumStealingAttempts<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stealingEnabled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stealingAttributes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>node.segment<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>foobar<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">JobStealingCollisionSpi</span> spi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobStealingCollisionSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Configure number of waiting jobs</span>
 <span class="token comment">// in the queue for job stealing.</span>
 spi<span class="token punctuation">.</span><span class="token function">setWaitJobsThreshold</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Configure message expire time (in milliseconds).</span>
 spi<span class="token punctuation">.</span><span class="token function">setMessageExpireTime</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Configure stealing attempts number.</span>
 spi<span class="token punctuation">.</span><span class="token function">setMaximumStealingAttempts</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Configure number of active jobs that are allowed to execute</span>
 <span class="token comment">// in parallel. This number should usually be equal to the number</span>
 <span class="token comment">// of threads in the pool (default is 100).</span>
 spi<span class="token punctuation">.</span><span class="token function">setActiveJobsThreshold</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Enable stealing.</span>
 spi<span class="token punctuation">.</span><span class="token function">setStealingEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Set stealing attribute to steal from/to nodes that have it.</span>
 spi<span class="token punctuation">.</span><span class="token function">setStealingAttributes</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;node.segment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;foobar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Enable `JobStealingFailoverSpi`</span>
 <span class="token class-name">JobStealingFailoverSpi</span> failoverSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobStealingFailoverSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Override default Collision SPI.</span>
 cfg<span class="token punctuation">.</span><span class="token function">setCollisionSpi</span><span class="token punctuation">(</span>spi<span class="token punctuation">)</span><span class="token punctuation">;</span>

 cfg<span class="token punctuation">.</span><span class="token function">setFailoverSpi</span><span class="token punctuation">(</span>failoverSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">必要的配置</p> <p>注意<code>org.apache.ignite.spi.failover.jobstealing.JobStealingFailoverSpi</code>和<code>IgniteConfiguration.getMetricsUpdateFrequency()</code>都要开启，这样这个SPI才能正常工作，<code>JobStealingCollisionSpi</code>的其它配置参数都是可选的。</p></div> <h2 id="_9-检查点"><a href="#_9-检查点" class="header-anchor">#</a> 9.检查点</h2> <h3 id="_9-1-概述"><a href="#_9-1-概述" class="header-anchor">#</a> 9.1.概述</h3> <p>检查点提供了保存一个作业中间状态的能力，它有助于一个长期运行的作业保存一些中间状态以防节点故障。重启一个故障节点后，一个作业会从保存的检查点载入然后从故障处继续执行。对于作业检查点状态，唯一必要的就是实现<code>java.io.Serializable</code>接口。</p> <p>检查点功能可以通过<code>GridTaskSession</code>接口的如下方法启用：</p> <ul><li><code>ComputeTaskSession.loadCheckpoint(String)</code></li> <li><code>ComputeTaskSession.removeCheckpoint(String)</code></li> <li><code>ComputeTaskSession.saveCheckpoint(String, Object)</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">@ComputeTaskSessionFullSupport注解</p> <p>注意检查点因为性能的原因默认是禁用的，要启用它需要在任务或者闭包类上加注<code>@ComputeTaskSessionFullSupport</code>注解。</p></div> <h3 id="_9-2-主节点故障保护"><a href="#_9-2-主节点故障保护" class="header-anchor">#</a> 9.2.主节点故障保护</h3> <p>检查点的一个重要使用场景是避免“主”节点（发起任务的节点）的故障。当主节点故障时，Ignite不知道将作业的执行结果发送给谁，这样结果就会被丢弃。</p> <p>这种情况下要恢复，可以先将作业的最终执行结果保存为一个检查点然后在”主”节点故障时有一个逻辑来重新运行整个任务。这时任务的重新运行会非常快因为所有的作业都可以从已保存的检查点启动。</p> <h3 id="_9-3-设置检查点"><a href="#_9-3-设置检查点" class="header-anchor">#</a> 9.3.设置检查点</h3> <p>每个计算任务都可以通过调用<code>ComputeTaskSession.saveCheckpoint(...)</code>方法定期地保存检查点。</p> <p>如果作业确实保存了检查点，那么当它开始执行的时候，应该检查检查点是否可用然后从最后保存的检查点处开始执行。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteCompute</span> compute <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

compute<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CheckpointsRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Note that this class is annotated with @ComputeTaskSessionFullSupport
 * annotation to enable checkpointing.
 */</span>
<span class="token annotation punctuation">@ComputeTaskSessionFullSupport</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CheckpointsRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">IgniteCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// Task session (injected on closure instantiation).</span>
  <span class="token annotation punctuation">@TaskSessionResource</span>
  <span class="token keyword">private</span> <span class="token class-name">ComputeTaskSession</span> ses<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GridException</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try to retrieve step1 result.</span>
    <span class="token class-name">Object</span> res1 <span class="token operator">=</span> ses<span class="token punctuation">.</span><span class="token function">loadCheckpoint</span><span class="token punctuation">(</span><span class="token string">&quot;STEP1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res1 <span class="token operator">=</span> <span class="token function">computeStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do some computation.</span>

      <span class="token comment">// Save step1 result.</span>
      ses<span class="token punctuation">.</span><span class="token function">saveCheckpoint</span><span class="token punctuation">(</span><span class="token string">&quot;STEP1&quot;</span><span class="token punctuation">,</span> res1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Try to retrieve step2 result.</span>
    <span class="token class-name">Object</span> res2 <span class="token operator">=</span> ses<span class="token punctuation">.</span><span class="token function">loadCheckpoint</span><span class="token punctuation">(</span><span class="token string">&quot;STEP2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res2 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res2 <span class="token operator">=</span> <span class="token function">computeStep2</span><span class="token punctuation">(</span>res1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do some computation.</span>

      <span class="token comment">// Save step2 result.</span>
      ses<span class="token punctuation">.</span><span class="token function">saveCheckpoint</span><span class="token punctuation">(</span><span class="token string">&quot;STEP2&quot;</span><span class="token punctuation">,</span> res2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9-4-checkpointspi"><a href="#_9-4-checkpointspi" class="header-anchor">#</a> 9.4.CheckpointSpi</h3> <p>Ignite中，检查点功能是通过<code>CheckpointSpi</code>提供的，它直接支持下面的实现：</p> <table><thead><tr><th>类</th> <th>描述</th></tr></thead> <tbody><tr><td><code>SharedFsCheckpointSpi</code></td> <td>这个实现通过一个共享的文件系统来保存检查点</td></tr> <tr><td><code>CacheCheckpointSpi</code></td> <td>这个实现通过缓存来保存检查点</td></tr> <tr><td><code>JdbcCheckpointSpi</code></td> <td>这个实现通过数据库来保存检查点</td></tr> <tr><td><code>S3CheckpointSpi</code></td> <td>这个实现通过Amazon S3来保存检查点</td></tr></tbody></table> <p><code>CheckpointSpi</code>是在<code>IgniteConfiguration</code>中提供的，然后在启动时传递给Ignition类，默认使用一个没有任何操作的检查点SPI。</p> <h3 id="_9-5-文件系统检查点配置"><a href="#_9-5-文件系统检查点配置" class="header-anchor">#</a> 9.5.文件系统检查点配置</h3> <p>下面的配置参数可用于配置<code>SharedFsCheckpointSpi</code>:</p> <table><thead><tr><th>settter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setDirectoryPaths(Collection)</code></td> <td>设置检查点要保存的共享文件夹的目录路径。这个路径既可以是绝对的也可以是相对于<code>IGNITE_HOME</code>环境变量或者系统参数指定的路径</td> <td><code>IGNITE_HOME/work/cp/sharedfs</code></td></tr></tbody></table> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.checkpoint.sharedfs.SharedFsCheckpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Change to shared directory path in your environment. --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>directoryPaths<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/my/directory/path<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/other/directory/path<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">SharedFsCheckpointSpi</span> checkpointSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedFsCheckpointSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// List of checkpoint directories where all files are stored.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dirPaths <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dirPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;/my/directory/path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dirPaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;/other/directory/path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default directory path.</span>
checkpointSpi<span class="token punctuation">.</span><span class="token function">setDirectoryPaths</span><span class="token punctuation">(</span>dirPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default checkpoint SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCheckpointSpi</span><span class="token punctuation">(</span>checkpointSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Starts Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-6-缓存检查点配置"><a href="#_9-6-缓存检查点配置" class="header-anchor">#</a> 9.6.缓存检查点配置</h3> <p><code>CacheCheckpointSpi</code>对于检查点SPI来说是一个基于缓存的实现，检查点数据会存储于Ignite数据网格中的一个预定义缓存中。
下面的配置参数可用于配置<code>CacheCheckpointSpi</code>:</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setCacheName(String)</code></td> <td>设置用于保存检查点的缓存的名字</td> <td><code>checkpoints</code></td></tr></tbody></table> <h3 id="_9-7-数据库检查点配置"><a href="#_9-7-数据库检查点配置" class="header-anchor">#</a> 9.7.数据库检查点配置</h3> <p><code>JdbcCheckpointSpi</code>通过数据库来保存检查点。所有的检查点都会保存在数据库表中然后对于集群中的所有节点都是可用的。注意每个节点必须访问数据库。一个作业状态可以在一个节点保存然后在另一个节点载入（例如一个作业在节点故障后被另一个节点取代）。</p> <p>下面的配置参数可用于配置<code>JdbcCheckpointSpi</code>，（所有的都是可选的）</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setDataSource(DataSource)</code></td> <td>设置用于数据库访问的数据源</td> <td>无</td></tr> <tr><td><code>setCheckpointTableName(String)</code></td> <td>设置检查点表名</td> <td><code>CHECKPOINTS</code></td></tr> <tr><td><code>setKeyFieldName(String)</code></td> <td>设置检查点键字段名</td> <td><code>NAME</code></td></tr> <tr><td><code>setKeyFieldType(String)</code></td> <td>设置检查点键字段类型，字段应该有相应的SQL字符串类型（比如<code>VARCHAR</code>）</td> <td><code>VARCHAR(256)</code></td></tr> <tr><td><code>setValueFieldName(String)</code></td> <td>设置检查点值字段名</td> <td><code>VALUE</code></td></tr> <tr><td><code>setValueFieldType(String)</code></td> <td>设置检查点值字段类型，注意，字段需要有相应的SQL BLOB类型，默认值是BLOB，但不是所有数据库都兼容，比如，如果使用HSQL DB，那么类型应该为<code>longvarbinary</code></td> <td><code>BLOB</code></td></tr> <tr><td><code>setExpireDateFieldName(String)</code></td> <td>设置检查点过期时间字段名</td> <td><code>EXPIRE_DATE</code></td></tr> <tr><td><code>setExpireDateFieldType(String)</code></td> <td>设置检查点过期时间字段类型，字段应该有相应的<code>DATETIME</code>类型</td> <td><code>DATETIME</code></td></tr> <tr><td><code>setNumberOfRetries(int)</code></td> <td>任何数据库错误时的重试次数</td> <td><code>2</code></td></tr> <tr><td><code>setUser(String)</code></td> <td>设置检查点数据库用户名，注意只有同时设置了用户名和密码时，认证才会执行</td> <td><code>无</code></td></tr> <tr><td><code>setPwd(String)</code></td> <td>设置检查点数据库密码</td> <td><code>无</code></td></tr></tbody></table> <p><strong>Apache DBCP</strong></p> <p><a href="http://commons.apache.org/proper/commons-dbcp/" target="_self" rel="noopener noreferrer">Apache DBCP</a>项目对于数据源和连接池提供了各种封装，可以通过Spring配置文件或者代码以spring bean的形式使用这些封装类来配置这个SPI，可以参照<a href="http://commons.apache.org/proper/commons-dbcp/" target="_self" rel="noopener noreferrer">Apache DBCP</a>来获得更多的信息。</p> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.checkpoint.jdbc.JdbcCheckpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>anyPoolledDataSourceBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkpointTableName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>CHECKPOINTS<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>pwd<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>test<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">JdbcCheckpointSpi</span> checkpointSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcCheckpointSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token class-name">DataSource</span> ds <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// Set datasource.</span>

<span class="token comment">// Set database checkpoint SPI parameters.</span>
checkpointSpi<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>ds<span class="token punctuation">)</span><span class="token punctuation">;</span>
checkpointSpi<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
checkpointSpi<span class="token punctuation">.</span><span class="token function">setPwd</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default checkpoint SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCheckpointSpi</span><span class="token punctuation">(</span>checkpointSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-8-amazon-s3-检查点配置"><a href="#_9-8-amazon-s3-检查点配置" class="header-anchor">#</a> 9.8.Amazon S3 检查点配置</h3> <p><code>S3CheckpointSpi</code>使用S3存储来保存检查点。要了解有关Amazon S3的信息可以参考<a href="http://aws.amazon.com/" target="_self" rel="noopener noreferrer">http://aws.amazon.com/</a>。</p> <p>下面的参数可用于配置<code>S3CheckpointSpi</code>:</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setAwsCredentials(AWSCredentials)</code></td> <td>设置要使用的AWS凭证来保存检查点</td> <td><code>无，但必须提供</code></td></tr> <tr><td><code>setClientConfiguration(Client)</code></td> <td>设置AWS客户端配置</td> <td><code>无</code></td></tr> <tr><td><code>setBucketNameSuffix(String)</code></td> <td>设置bucket名字后缀</td> <td><code>default-bucket</code></td></tr></tbody></table> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.checkpoint.s3.S3CheckpointSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>awsCredentials<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.amazonaws.auth.BasicAWSCredentials<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>YOUR_ACCESS_KEY_ID<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>YOUR_SECRET_ACCESS_KEY<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">S3CheckpointSpi</span> spi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">S3CheckpointSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">AWSCredentials</span> cred <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicAWSCredentials</span><span class="token punctuation">(</span>YOUR_ACCESS_KEY_ID<span class="token punctuation">,</span> YOUR_SECRET_ACCESS_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>

spi<span class="token punctuation">.</span><span class="token function">setAwsCredentials</span><span class="token punctuation">(</span>cred<span class="token punctuation">)</span><span class="token punctuation">;</span>

spi<span class="token punctuation">.</span><span class="token function">setBucketNameSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;checkpoints&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default checkpoint SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCheckpointSpi</span><span class="token punctuation">(</span>cpSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_10-作业调度"><a href="#_10-作业调度" class="header-anchor">#</a> 10.作业调度</h2> <h3 id="_10-1-概述"><a href="#_10-1-概述" class="header-anchor">#</a> 10.1.概述</h3> <p>Ignite中，作业是在客户端侧的任务拆分初始化或者闭包执行阶段被映射到集群节点上的。不过一旦作业到达被分配的节点，就需要有序地执行。作业默认是被提交到一个线程池然后随机地执行，如果要对作业执行顺序进行细粒度控制，需要启用<code>CollisionSpi</code>。</p> <h3 id="_10-2-fifo排序"><a href="#_10-2-fifo排序" class="header-anchor">#</a> 10.2.FIFO排序</h3> <p><code>FifoQueueCollisionSpi</code>可以使一定数量的作业无中断地以先入先出的顺序执行，所有其它的作业都会被放入一个等待列表，直到轮到它。</p> <p>并行作业的数量是由<code>parallelJobsNumber</code>配置参数控制的，默认值为2.</p> <p><strong>一次一个</strong></p> <p>注意如果将<code>parallelJobsNumber</code>设置为1，可以保证所有作业同时只会执行一个，这样就没有任何两个作业并发执行。</p> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>collisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.collision.fifoqueue.FifoQueueCollisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- Execute one job at a time. --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>parallelJobsNumber<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">FifoQueueCollisionSpi</span> colSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FifoQueueCollisionSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute jobs sequentially, one at a time,</span>
<span class="token comment">// by setting parallel job number to 1.</span>
colSpi<span class="token punctuation">.</span><span class="token function">setParallelJobsNumber</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default collision SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCollisionSpi</span><span class="token punctuation">(</span>colSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-3-优先级排序"><a href="#_10-3-优先级排序" class="header-anchor">#</a> 10.3.优先级排序</h3> <p><code>PriorityQueueCollisionSpi</code>可以为每个作业设置一个优先级，因此高优先级的作业会比低优先级的作业先执行。</p> <p><strong>任务优先级</strong></p> <p>任务优先级是通过任务会话中的<code>grid.task.priority</code>属性设置的，如果任务没有被赋予优先级，那么会使用默认值0。</p> <p>下面是一个如何设置任务优先级的示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUrgentTask</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeTaskSplitAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// Auto-injected task session.</span>
  <span class="token annotation punctuation">@TaskSessionResource</span>
  <span class="token keyword">private</span> <span class="token class-name">GridTaskSession</span> taskSes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">&gt;</span></span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridSize<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Set high task priority.</span>
    taskSes<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;grid.task.priority&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">&gt;</span></span> jobs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>gridSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> gridSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      jobs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GridJobAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// These jobs will be executed with higher priority.</span>
    <span class="token keyword">return</span> jobs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>配置</strong></p> <p>和FIFO排序一样，并行执行作业的数量是由<code>parallelJobsNumber</code>配置参数控制的。</p> <p>XML:</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.IgniteConfiguration<span class="token punctuation">&quot;</span></span> <span class="token attr-name">singleton</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>collisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.collision.priorityqueue.PriorityQueueCollisionSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--
        Change the parallel job number if needed.
        Default is number of cores times 2.
      --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>parallelJobsNumber<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>5<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">PriorityQueueCollisionSpi</span> colSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueueCollisionSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Change the parallel job number if needed.</span>
<span class="token comment">// Default is number of cores times 2.</span>
colSpi<span class="token punctuation">.</span><span class="token function">setParallelJobsNumber</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Override default collision SPI.</span>
cfg<span class="token punctuation">.</span><span class="token function">setCollisionSpi</span><span class="token punctuation">(</span>colSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_11-任务部署"><a href="#_11-任务部署" class="header-anchor">#</a> 11.任务部署</h2> <p>除了对等类加载之外，Ignite还有一个部署机制，它负责在运行时从不同的源中部署任务和类。</p> <h3 id="_11-1-deploymentspi"><a href="#_11-1-deploymentspi" class="header-anchor">#</a> 11.1.DeploymentSpi</h3> <p>部署的功能是通过<code>DeploymentSpi</code>接口提供的。</p> <p>类加载器负责加载任务类（或者其它的类），它可以通过调用<code>register(ClassLoader, Class)</code>方法或者SPI自己来直接部署。比如通过异步地扫描一些文件夹来加载新的任务。当系统调用了<code>findResource(String)</code>方法时，SPI必须返回一个与给定的类相对应的类加载器。每次一个类加载器获得（再次）部署或者释放，SPI必须调用<code>DeploymentListener.onUnregistered(ClassLoader)</code>回调。</p> <p>如果启用了对等类加载，因为通常只会在一个网格节点上部署类加载器，一旦一个任务在集群上开始执行，所有其它的节点都会从发起任务的节点自动加载所有的任务类。对等类加载也支持热部署。每次任务发生变化或者在一个节点上重新部署，所有其它的节点都会侦测到然后重新部署这个任务。注意对等类加载只在任务为非本地部署时才生效，否则本地部署总是具有优先权。</p> <p>Ignite直接支持如下的<code>DeploymentSpi</code>实现：</p> <ul><li>UriDeploymentSpi</li> <li>LocalDeploymentSpi</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>SPI的方法不要直接使用。SPI提供了子系统的内部视图，由Ignite内部使用，需要访问这个SPI的某个实现的场景很少。可以通过<code>Ignite.configuration()</code>方法来获得这个SPI的一个实例，来检查它的配置属性或者调用其它的非SPI方法。再次注意从获得的实例中调用该接口的方法可能导致无法预期的行为，因此Ignite明确不会为此提供支持。</p></div> <h3 id="_11-2-urideploymentspi"><a href="#_11-2-urideploymentspi" class="header-anchor">#</a> 11.2.UriDeploymentSpi</h3> <p>这是<code>DeploymentSpi</code>的一个实现，它可以从不同的资源部署任务，比如文件系统文件夹、email和FTP。在集群中有不同的方式来部署任务以及每个部署方法都会依赖于所选的源协议。这个SPI可以配置与一系列的URI一起工作，每个URI都包括有关协议/传输加上配置参数比如凭证、扫描频率以及其它的所有数据。</p> <p>当SPI建立一个与URI的连接时，为了防止扫描过程中的任何变化它会下载待部署的单元到一个临时目录，通过方法<code>setTemporaryDirectoryPath(String)</code>可以为下载的部署单元设置自定义的临时文件夹。SPI会在该路径下创建一个和本地节点ID名字完全一样的文件夹。</p> <p>SPI会跟踪每个给定URI的所有变化。这意味着如果任何文件发生变化或者被删除，SPI会重新部署或者删除相应的任务。注意第一个调用<code>findResource(String)</code>是阻塞的，直到SPI至少一次完成了对所有URI的扫描。</p> <p>下面是一些支持的可部署单元的类型：</p> <ul><li>GAR文件</li> <li>带有未解压GAR文件结构的本地磁盘文件夹</li> <li>只包含已编译的Java类的本地磁盘文件夹</li></ul> <p><strong>GAR文件</strong></p> <p>GAR文件是一个可部署的单元，GAR文件基于ZLIB压缩格式，类似简单JAR文件，它的结构类似于WAR包，GAR文件有一个“.gar”扩展名。
GAR文件结构（以.gar结尾的文件或者目录）：</p> <div class="language- extra-class"><pre class="language-text"><code>META-INF/
        |
         - ignite.xml
         - ...
lib/
   |
    -some-lib.jar
    - ...
xyz.class
...
</code></pre></div><ul><li><code>META-INF</code>:包含任务描述的<code>ignite.xml</code>文件的入口，任务描述XML格式文件的作用是指定所有要部署的任务。这个文件是标准的Spring格式XML定义文件，<code>META-INF/</code>也可以包含其它所有的JAR格式指定的文件。</li> <li><code>lib/</code>:包含所有库依赖的入口。</li> <li>编译过的java类必须放在GAR文件的根目录中。</li></ul> <p>当然没有描述文件GAR文件也可以部署。如果没有描述文件，SPI会扫描包里的所有类然后实例化其中实现<code>ComputeTask</code>接口的，不过这样所有的任务类必须有一个公开的无参数的构造函数。为了方便，创建任务时也可以使用<code>ComputeTaskAdapter</code>适配器。</p> <p>所有下载的GAR文件在<code>META-INF</code>文件夹都要有默认待认证的数字签名，然后只有在签名有效时才会被部署。</p> <p><strong>示例</strong></p> <p>下面的实例演示了可用的SPI是如何部署的，不同的协议也可以一起使用。</p> <p>File协议：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// The example expects that you have a GAR file in</span>
<span class="token comment">// `home/username/ignite/work/my_deployment/file` folder</span>
<span class="token comment">// which contains `myproject.HelloWorldTask` class.</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">UriDeploymentSpi</span> deploymentSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UriDeploymentSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

deploymentSpi<span class="token punctuation">.</span><span class="token function">setUriList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;file:///home/username/ignite/work/my_deployment/file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setDeploymentSpi</span><span class="token punctuation">(</span>deploymentSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;myproject.HelloWorldTask&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;my args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HTTP协议：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// The example expects that you have a HTMP under</span>
<span class="token comment">// 'www.mysite.com:110/ignite/deployment'page which contains a link</span>
<span class="token comment">// on GAR file which contains `myproject.HelloWorldTask` class.</span>

<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">UriDeploymentSpi</span> deploymentSpi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UriDeploymentSpi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

deploymentSpi<span class="token punctuation">.</span><span class="token function">setUriList</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;http://username:password;freq=10000@www.mysite.com:110/ignite/deployment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setDeploymentSpi</span><span class="token punctuation">(</span>deploymentSpi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">&quot;myproject.HelloWorldTask&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;my args&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>XML配置</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>deploymentSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.spi.deployment.uri.UriDeploymentSpi<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>temporaryDirectoryPath<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>c:/tmp/grid<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>uriList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>http://www.site.com/tasks<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>file://freq=20000@localhost/c:/Program files/gg-deployment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>配置</strong></p> <table><thead><tr><th>属性</th> <th>描述</th> <th>可选</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>uriList</code></td> <td>SPI扫描新任务的URI列表</td> <td>是</td> <td><code>file://${IGNITE_HOME}/work/deployment/file</code>,注意如果要使用默认文件夹,<code>IGNITE_HOME</code>必须设置。</td></tr> <tr><td><code>scanners</code></td> <td>用于部署资源的<code>UriDeploymentScanner</code>实现的数组</td> <td>是</td> <td><code>UriDeploymentFileScanner</code>和<code>UriDeploymentHttpScanner</code></td></tr> <tr><td><code>temporaryDirectoryPath</code></td> <td>要扫描的GAR文件和目录要拷贝的目标临时目录路径</td> <td>是</td> <td><code>java.io.tmpdir</code>系统属性值</td></tr> <tr><td><code>encodeUri</code></td> <td>控制URI中路径部分编码的标志</td> <td>是</td> <td><code>true</code></td></tr></tbody></table> <p><strong>协议</strong></p> <p>SPI直接支持如下协议：</p> <ul><li>file:// - File协议</li> <li>http:// - HTTP协议</li> <li>https:// - 安全HTTP协议</li></ul> <div class="custom-block tip"><p class="custom-block-title">自定义协议</p> <p>如果需要可以增加其它的协议的支持，可以通过实现<code>UriDeploymentScanner</code>接口然后通过<code>setScanners(UriDeploymentScanner... scanners)</code>方法将实现加入SPI来做到这一点。</p></div> <p>除了SPI配置参数之外，对于选择的URI所有必要的配置参数都应该在URI中定义。不同的协议有不同的配置参数，下面分别做了描述，参数是以分号分割的。</p> <p><em>File</em></p> <p>对于这个协议，SPI会在文件系统中扫描URI指定的文件夹然后从URI定义的源文件夹中下载任何的GAR文件或者目录中的以.gar结尾的文件。</p> <p>支持如下的参数：</p> <table><thead><tr><th>参数</th> <th>描述</th> <th>可选</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>freq</code></td> <td>扫描频率，以毫秒为单位</td> <td>是</td> <td><code>5000ms</code></td></tr></tbody></table> <p><em>File URI示例</em></p> <p>下面的示例会在本地每2000毫秒扫描<code>c:/Program files/ignite/deployment</code>文件夹。注意如果path有空格，<code>setEncodeUri(boolean)</code>参数必须设置为<code>true</code>（这也是默认的行为）。</p> <div class="language- extra-class"><pre class="language-text"><code>file://freq=2000@localhost/c:/Program files/ignite/deployment
</code></pre></div><p><em>HTTP/HTTPS</em></p> <p>URI部署扫描器会试图读取指向的HTML文件的DOM然后解析出所有的<code>&lt;a&gt;</code>标签的href属性 - 这会成为要部署的URL集合（到GAR文件）：每个'A'链接都应该是指向GAR文件的URL。很重要的是只有HTTP扫描器会使用<code>URLConnection.getLastModified()</code>方法来检查自从重新部署之前对每个GAR文件的最后一次迭代以来是否有任何变化。</p> <p>支持如下的参数：</p> <table><thead><tr><th>参数</th> <th>描述</th> <th>可选</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>freq</code></td> <td>扫描频率，以毫秒为单位</td> <td>是</td> <td><code>300000ms</code></td></tr></tbody></table> <p><em>HTTP URI示例</em></p> <p>下面的示例会下载<code>www.mysite.com/ignite/deployment</code>页面，解析它然后每<code>10000</code>毫秒使用<code>username:password</code>进行认证，对从页面的所有a元素的href属性指定的所有GAR文件进行下载和部署。</p> <div class="language- extra-class"><pre class="language-text"><code>http://username:password;freq=10000@www.mysite.com:110/ignite/deployment
</code></pre></div><h3 id="_11-3-localdeploymentspi"><a href="#_11-3-localdeploymentspi" class="header-anchor">#</a> 11.3.LocalDeploymentSpi</h3> <p>本地部署SPI只是通过<code>register(ClassLoader, Class)</code>方法实现了在本地节点中的虚拟机进行部署，这个SPI不需要配置。
显式地配置<code>LocalDeploymentSpi</code>是没有意义的，因为它是默认的以及没有配置参数。</p> <h2 id="_12-基于cron的调度"><a href="#_12-基于cron的调度" class="header-anchor">#</a> 12.基于Cron的调度</h2> <h3 id="_12-1-概述"><a href="#_12-1-概述" class="header-anchor">#</a> 12.1.概述</h3> <p><code>Runnable</code>和<code>Callable</code>的实例在本地节点可以使用<code>IgniteScheduler.scheduleLocal()</code>方法和<code>Cron</code>语法进行调度用于周期性的执行。下面的一个示例会在所有的有效节点上触发周期性的发送缓存指标报告。</p> <div class="language-java extra-class"><pre class="language-java"><code>ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IgniteCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@IgniteInstanceResource</span>
    <span class="token class-name">Ignite</span> ignite<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        ignite<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleLocal</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">sendReportWithCacheMetrics</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">metrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;0 0   *&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Cron简称</p> <p>在当前的实现中，Cron简称(@hourly, @daily, @weekly...)还不支持，并且最小的调度时间单元是一分钟。</p></div> <h3 id="_12-2-schedulerfuture"><a href="#_12-2-schedulerfuture" class="header-anchor">#</a> 12.2.SchedulerFuture</h3> <p><code>IgniteScheduler.scheduleLocal()</code>方法返回<code>SchedulerFuture</code>，它有一组有用的方法来监控调度的执行以及获得结果，通过它也可以取消周期性的执行。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">SchedulerFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fut <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleLocal</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;0 0 * * *&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;The task will be next executed on &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>fut<span class="token punctuation">.</span><span class="token function">nextExecutionTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fut<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait for next execution to finish.</span>

fut<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Cancel periodic execution.</span>
</code></pre></div><h3 id="_12-3-语法扩展"><a href="#_12-3-语法扩展" class="header-anchor">#</a> 12.3.语法扩展</h3> <p>Ignite引入了一个Cron语法的扩展，它可以指定一个初始化的延迟（秒）和运行的次数。这两个可选的数值用大括号括起来，用逗号分割，放在Cron规范之前。下面的示例中指定了每分钟执行五次，并且有一个初始2秒钟的延迟。</p> <div class="language- extra-class"><pre class="language-text"><code>{2, 5} * * * * *
</code></pre></div><h2 id="_13-持续映射"><a href="#_13-持续映射" class="header-anchor">#</a> 13.持续映射</h2> <h3 id="_13-1-概述"><a href="#_13-1-概述" class="header-anchor">#</a> 13.1.概述</h3> <p>传统的MapReduce范式中，有一个明确且有限的作业集，它在Map阶段是已知的并且在整个计算运行期间都不会改变。但是如果有一个作业流会怎么样呢？这时仍然可以使用Ignite的持续映射能力执行MapReduce。通过持续映射，当计算仍然在运行时作业可以动态地生成，新生成的作业同样会被工作节点处理，并且Reducer和通常的MapReduce一样会收到结果。</p> <h3 id="_13-2-运行持续的映射任务"><a href="#_13-2-运行持续的映射任务" class="header-anchor">#</a> 13.2.运行持续的映射任务</h3> <p>如果在任务中要使用持续映射，需要在一个任务实例中注入<code>TaskContinuousMapperResource</code>资源：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@TaskContinuousMapperResource</span>
<span class="token keyword">private</span> <span class="token class-name">TaskContinuousMapper</span> mapper<span class="token punctuation">;</span>
</code></pre></div><p>之后，新的作业可以异步地生成，并且使用<code>TaskContinuousMapper</code>实例的<code>send()</code>方法加入当前正在运行的计算中：</p> <div class="language-java extra-class"><pre class="language-java"><code>mapper<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComputeJobAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I'm a continuously-mapped job!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于持续映射，有几个约束需要了解：</p> <ul><li>如果最初的<code>ComputeTask.map()</code>方法返回null，那么在返回之前通过持续映射器要至少发送一个作业；</li> <li>在<code>ComputeTask.result()</code>方法返回<code>REDUCE</code>策略之后持续映射器无法使用；</li> <li>如果<code>ComputeTask.result()</code>方法返回<code>WAIT</code>策略，并且所有的作业都已经结束，那么任务会进入<code>REDUCE</code>阶段并且持续映射器再也无法使用。</li></ul> <p>在其它方面，计算逻辑和正常的MapReduce一样，详情可以参照14.2章节。</p> <h3 id="_13-3-示例"><a href="#_13-3-示例" class="header-anchor">#</a> 13.3.示例</h3> <p>下面的示例是基于网站包含的图片对其进行分析。Web搜索引擎会扫描站点上的所有图片，然后Ignite实现的MapReduce引擎会基于一些图片分析算法确定每个图片的种类（“含义”）。然后图片分析的结果会归约确定站点的种类，这个示例会很好地演示<strong>持续映射</strong>，因为Web搜索是一个持续的过程，其中MapReduce可以并行地执行，并且分析到来的新的Web搜索结果（新的图片文件）。这会节省大量的时间，而传统的MapReduce，首先需要等待所有的Web搜索结果（一个完整的图片集），然后将它们映射到节点，分析，归约结果。</p> <p>假定有一个来自一些扫描站点图片的库的<code>Crawler</code>接口，<code>CrawlerListener</code>接口用于获得异步的后台扫描结果，然后一个<code>Image</code>接口表示一个单个图片文件（类名故意缩短以简化阅读）：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">Crawler</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token class-name">Image</span> <span class="token function">findNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findNextAsync</span><span class="token punctuation">(</span><span class="token class-name">CrawlerListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">CrawlerListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onImage</span><span class="token punctuation">(</span><span class="token class-name">Crawler</span> c<span class="token punctuation">,</span> <span class="token class-name">Image</span> img<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Image</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>假定还有一个实现了<code>ComputeJob</code>的ImageAnalysisJob，它的逻辑是分析图片：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ImageAnalysisJob</span> <span class="token keyword">implements</span> <span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token class-name">ImageAnalysisJob</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imgBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IgniteException</span> <span class="token punctuation">{</span>
        <span class="token comment">// Image analysis logic (returns some information</span>
        <span class="token comment">// about the image content: category, etc.).</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的都准备好后，下面是如何运行Web搜索然后使用<strong>持续映射</strong>进行并行地分析：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">enum</span> <span class="token class-name">SiteCategory</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Instantiate a Web search engine for a particular site.</span>
<span class="token class-name">Crawler</span> crawler <span class="token operator">=</span> <span class="token class-name">CrawlerFactory</span><span class="token punctuation">.</span><span class="token function">newCrawler</span><span class="token punctuation">(</span>siteUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Execute a continuously-mapped task.</span>
<span class="token class-name">SiteCategory</span> result <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComputeTaskAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Crawler</span><span class="token punctuation">,</span> <span class="token class-name">SiteCategory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Interface for continuous mapping (injected on task instantiation).</span>
    <span class="token annotation punctuation">@TaskContinuousMapperResource</span>
    <span class="token keyword">private</span> <span class="token class-name">TaskContinuousMapper</span> mapper<span class="token punctuation">;</span>

    <span class="token comment">// Map step.</span>
    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> nodes<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Crawler</span> c<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IgniteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> c <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// Find a first image synchronously to submit an initial job.</span>
        <span class="token class-name">Image</span> img <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">findNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>img <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IgniteException</span><span class="token punctuation">(</span><span class="token string">&quot;No images found on the site.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Submit an initial job.</span>
        mapper<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ImageAnalysisJob</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Now start asynchronous background Web search and</span>
        <span class="token comment">// submit new jobs as search results come. This call</span>
        <span class="token comment">// will return immediately.</span>
        c<span class="token punctuation">.</span><span class="token function">findNextAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CrawlerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onImage</span><span class="token punctuation">(</span><span class="token class-name">Crawler</span> c<span class="token punctuation">,</span> <span class="token class-name">Image</span> img<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>img <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Submit a new job to analyse image file.</span>
                    mapper<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ImageAnalysisJob</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// Move on with search.</span>
                    c<span class="token punctuation">.</span><span class="token function">findNextAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initial job was submitted, so we can return</span>
        <span class="token comment">// empty mapping.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Reduce step.</span>
    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">SiteCategory</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IgniteException</span> <span class="token punctuation">{</span>
        <span class="token comment">// At this point Web search is finished and all image</span>
        <span class="token comment">// files are analysed. Here we execute some logic for</span>
        <span class="token comment">// determining site category based on image content</span>
        <span class="token comment">// information.</span>
        <span class="token keyword">return</span> <span class="token function">defineSiteCategory</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> crawler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面这个示例中，为了简化，假定图片分析作业会比在站点上搜索下一张图片花费更长的时间。换句话说，新的Web搜索结果的到来会快于分析完图片文件。在现实生活中，这不一定是真的，并且可以轻易地获得一个情况，就是过早地完成了分析，因为当前所有的作业都已经完成而新的搜索结果还没有到达（由于网络延迟或者其它的原因）。这时，Ignite会切换至归约阶段，因此持续映射就不再可能了。</p> <p>要避免这样的情况，需要考虑提交一个特别的作业，它只是完成接收一些消息，或者使用可用的分布式同步化基本类型之一，比如<code>CountDownLatch</code>,这个做法可以确保在Web搜索结束之前归约阶段不会启动。</p> <h2 id="_14-启用基于aop的网格"><a href="#_14-启用基于aop的网格" class="header-anchor">#</a> 14.启用基于AOP的网格</h2> <p>通过<a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_self" rel="noopener noreferrer">面向方面编程</a>，可以隐式地修改任何方法的行为（比如，记录日志或者开启一个方法级的事务等）。在Ignite中，可以将方法加入运行在网格中的一个闭包，这和在一个方法上加注<code>@Gridify</code>注解一样简单。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Gridify</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以使用任何的AOP库：<strong>AspectJ</strong>、<strong>JBoss</strong>或者<strong>Spring AOP</strong>，只需要在主节点（发起执行的节点）上正确配置这些框架中的任何一个。仅仅上述方法的一个调用就会产生集群范围的一次任务执行，它会在拓扑内的所有工作节点上输出&quot;Hello!&quot;。</p> <h3 id="_14-1-gridify注解"><a href="#_14-1-gridify注解" class="header-anchor">#</a> 14.1.Gridify注解</h3> <p><code>@Gridify</code>注解可以用于任何方法，它可以有如下的参数，所有参数都是可选的：</p> <table><thead><tr><th>属性名称</th> <th>类型</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>taskClass</code></td> <td>Class</td> <td>自定义任务类</td> <td>GridifyDefaultTask.class</td></tr> <tr><td><code>taskName</code></td> <td>String</td> <td>要启动的自定义任务名</td> <td>“”</td></tr> <tr><td><code>timeout</code></td> <td>long</td> <td>任务执行超时时间，0为没有超时限制</td> <td>0</td></tr> <tr><td><code>interceptor</code></td> <td>Class</td> <td>过滤网格化方法的拦截器</td> <td>GridifyInterceptor.class</td></tr> <tr><td><code>gridName</code></td> <td>String</td> <td>要使用的网格名</td> <td>“”</td></tr></tbody></table> <p>通常，如果调用了一个<code>网格化</code>的方法，会发生如下事情：</p> <ul><li>通过<code>gridName</code>指定的网格会用于执行（如果未指定网格名，默认会使用没有名字的网格）；</li> <li>如果指定了，会使用一个拦截器检查方法是否应该启用网格化，如果拦截器返回<code>false</code>，一个方法会像正常的一样被调用，而不会被网格化；</li> <li>通过有效的方法参数，<code>this</code>对象（如果方法为非静态），会创建并且执行一个网格任务；</li> <li>这个网格任务的返回值会通过<code>网格化</code>的方法返回。</li></ul> <p><strong>默认的行为</strong></p> <p>如果使用了没有参数的@Gridify注解，会隐式地使用如下的默认的行为：</p> <ul><li>会创建一个名为<code>GridifyDefaultTask</code>的任务类，它会生成一个<code>GridifyJobAdapter</code>作业类，然后使用一个默认的负载平衡器选择一个工作节点；</li> <li>远程节点的一个作业会通过内置的参数调用一个方法，使用反序列化的这个对象（如果方法为静态则为null），然后返回这个方法的结果作为作业的结果；</li> <li>远程节点上作业的结果会作为调用端任务的结果；</li> <li>任务的结果会返回，作为<code>网格化</code>方法的返回值。</li></ul> <p><strong>自定义任务</strong></p> <p>对于一个网格化的方法也可以自定义任务，用于特定的网格化逻辑。下面的示例会广播网格化的方法到所有有效的工作节点上，然后忽略reduce阶段（意味着这个任务没有返回值）：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Custom task class.</span>
<span class="token keyword">class</span> <span class="token class-name">GridifyBroadcastMethodTask</span> <span class="token keyword">extends</span> <span class="token class-name">GridifyTaskAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> subgrid<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">GridifyArgument</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IgniteException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJob</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>subgrid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Broadcast method to all nodes.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClusterNode</span> node <span class="token operator">:</span> subgrid<span class="token punctuation">)</span>
            ret<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GridifyJobAdapter</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComputeJobResult</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IgniteException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// No-op.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GridifyHelloWorldTaskExample</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// Gridified method.</span>
  <span class="token annotation punctuation">@Gridify</span><span class="token punctuation">(</span>taskClass <span class="token operator">=</span> <span class="token class-name">GridifyBroadcastMethodTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, &quot;</span> <span class="token operator">+</span> arg <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_14-2-配置aop"><a href="#_14-2-配置aop" class="header-anchor">#</a> 14.2.配置AOP</h3> <p>Ignite支持三个AOP框架：</p> <ul><li>AspectJ</li> <li>JBoss AOP</li> <li>Spring AOP</li></ul> <p>这个章节会描述每个框架的详细配置，假定IGNITE_HOME是Ignite的安装目录。</p> <blockquote><p>这些细节只适用于逻辑主节点（初始化该次执行的节点），剩下的都应该是逻辑工作节点。</p></blockquote> <p><strong>AspectJ</strong></p> <p>要启用AspectJ字节码织入，主节点的JVM需要通过如下方式进行配置：</p> <ul><li>启动时需要添加<code>-javaagent:IGNITE_HOME/libs/aspectjweaver-1.8.9.jar</code>参数；</li> <li>类路径需要包含<code>IGNITE_HOME/config/aop/aspectj</code>文件夹。</li></ul> <p><strong>JBoss AOP</strong></p> <p>要启用JBoss的字节码织入，主节点的JVM需要有如下的配置：</p> <ul><li>启动时需要有如下参数：</li> <li>-javaagent:[指向jboss-aop-jdk50-4.x.x.jar的路径]</li> <li>-Djboss.aop.class.path=[ignite.jar的路径]</li> <li>-Djboss.aop.exclude=org,com</li> <li>-Djboss.aop.include=[应用的包名]</li> <li>还要在类路径中包含如下的jar文件：</li> <li>javassist-3.x.x.jar</li> <li>jboss-aop-jdk50-4.x.x.jar</li> <li>jboss-aspect-library-jdk50-4.x.x.jar</li> <li>jboss-common-4.x.x.jar</li> <li>trove-1.0.2.jar</li></ul> <div class="custom-block tip"><p class="custom-block-title">JBoss依赖</p> <p>Ignite不带有JBoss，因此必要的库需要单独下载（如果已经安装了JBoss，这些都是标准的）。</p></div> <p><strong>Spring AOP</strong></p> <p>Spring AOP框架基于动态代理实现，对于在线织入不需要任何特定的运行时参数，所有的织入都是按需的，对于有加注了<code>@Gridify</code>注解的方法的对象会通过调用<code>GridifySpringEnhancer.enhance()</code>方法执行。</p> <p>注意这个织入的方法是非常不方便的，推荐使用AspectJ或者JBoss AOP代替。当代码增强是不想要的并且无法使用时，Spring AOP适用于这样的场景，它也可以用于对织入什么进行细粒度的控制。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间：:</span> <span class="time">11/3/2020, 3:16:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc/2.7.0/java/DistributedDataStructures.html" class="prev">
        分布式数据结构
      </a></span> <span class="next"><a href="/doc/2.7.0/java/ServiceGrid.html">
        服务网格
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e19e712a.js" defer></script><script src="/assets/js/3.d41ef727.js" defer></script><script src="/assets/js/1.c1604912.js" defer></script><script src="/assets/js/100.7e3232a9.js" defer></script>
  </body>
</html>
