<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>持久化 | Apache Ignite技术服务</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="stylesheet" href="/css/plugin.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://hm.baidu.com/hm.js?8e93516f96b603fac3e2738ca002c88a"></script>
    <meta name="description" content="apache ignite,ignite中文,ignite官网,内存数据库,分布式数据库">
    <meta name="keywords" content="apache ignite,ignite中文,ignite官网,内存数据库,分布式数据库">
    <meta http-equiv="cache-control" content="no-store,no-cache,must-revalidate">
    <meta http-equiv="expires" content="0">
    
    <link rel="preload" href="/assets/css/0.styles.0d208948.css" as="style"><link rel="preload" href="/assets/js/app.cd3dd904.js" as="script"><link rel="preload" href="/assets/js/3.d41ef727.js" as="script"><link rel="preload" href="/assets/js/1.c1604912.js" as="script"><link rel="preload" href="/assets/js/57.c4175403.js" as="script"><link rel="prefetch" href="/assets/js/10.cd30f947.js"><link rel="prefetch" href="/assets/js/100.89c79b30.js"><link rel="prefetch" href="/assets/js/101.a0b8cd77.js"><link rel="prefetch" href="/assets/js/102.8e70745a.js"><link rel="prefetch" href="/assets/js/103.4045528f.js"><link rel="prefetch" href="/assets/js/104.4b2ee848.js"><link rel="prefetch" href="/assets/js/105.14da88c2.js"><link rel="prefetch" href="/assets/js/106.33f7983e.js"><link rel="prefetch" href="/assets/js/107.13d6293c.js"><link rel="prefetch" href="/assets/js/108.c47727ac.js"><link rel="prefetch" href="/assets/js/109.9642ffab.js"><link rel="prefetch" href="/assets/js/11.43551a62.js"><link rel="prefetch" href="/assets/js/110.d478a889.js"><link rel="prefetch" href="/assets/js/111.d36a1009.js"><link rel="prefetch" href="/assets/js/112.6fe1414c.js"><link rel="prefetch" href="/assets/js/113.d8a8cef8.js"><link rel="prefetch" href="/assets/js/114.eb5ec645.js"><link rel="prefetch" href="/assets/js/115.cdd281a6.js"><link rel="prefetch" href="/assets/js/116.1ebcccf4.js"><link rel="prefetch" href="/assets/js/117.28cdd513.js"><link rel="prefetch" href="/assets/js/118.6fc27095.js"><link rel="prefetch" href="/assets/js/119.130567ca.js"><link rel="prefetch" href="/assets/js/12.7891e08b.js"><link rel="prefetch" href="/assets/js/120.fef35465.js"><link rel="prefetch" href="/assets/js/121.db5e0a95.js"><link rel="prefetch" href="/assets/js/122.d41d5f10.js"><link rel="prefetch" href="/assets/js/123.90f999da.js"><link rel="prefetch" href="/assets/js/124.f63edeeb.js"><link rel="prefetch" href="/assets/js/125.b66c2014.js"><link rel="prefetch" href="/assets/js/126.270f73d5.js"><link rel="prefetch" href="/assets/js/127.f48abfe1.js"><link rel="prefetch" href="/assets/js/128.ba9d7b99.js"><link rel="prefetch" href="/assets/js/129.a4762a31.js"><link rel="prefetch" href="/assets/js/13.550a0e6d.js"><link rel="prefetch" href="/assets/js/130.12b00d5f.js"><link rel="prefetch" href="/assets/js/131.3effe8da.js"><link rel="prefetch" href="/assets/js/132.065ffd21.js"><link rel="prefetch" href="/assets/js/133.aa7ec4fa.js"><link rel="prefetch" href="/assets/js/134.a52965fa.js"><link rel="prefetch" href="/assets/js/135.1652d314.js"><link rel="prefetch" href="/assets/js/136.0985d763.js"><link rel="prefetch" href="/assets/js/137.aa923dff.js"><link rel="prefetch" href="/assets/js/138.34a0121f.js"><link rel="prefetch" href="/assets/js/139.eda491d2.js"><link rel="prefetch" href="/assets/js/14.7da9e4b5.js"><link rel="prefetch" href="/assets/js/140.7b8fc5f3.js"><link rel="prefetch" href="/assets/js/141.bca1ff5e.js"><link rel="prefetch" href="/assets/js/142.54e0d47f.js"><link rel="prefetch" href="/assets/js/143.e41019a4.js"><link rel="prefetch" href="/assets/js/144.88ea9b2a.js"><link rel="prefetch" href="/assets/js/145.374ff906.js"><link rel="prefetch" href="/assets/js/146.a51cfb64.js"><link rel="prefetch" href="/assets/js/147.090a3bf3.js"><link rel="prefetch" href="/assets/js/148.2f1d54fa.js"><link rel="prefetch" href="/assets/js/149.54b5aa60.js"><link rel="prefetch" href="/assets/js/15.3c7b9c2f.js"><link rel="prefetch" href="/assets/js/150.3819b3fc.js"><link rel="prefetch" href="/assets/js/151.8b054147.js"><link rel="prefetch" href="/assets/js/152.aa478fa3.js"><link rel="prefetch" href="/assets/js/153.71a85de8.js"><link rel="prefetch" href="/assets/js/154.91076aee.js"><link rel="prefetch" href="/assets/js/155.c96098ee.js"><link rel="prefetch" href="/assets/js/156.e5171ed9.js"><link rel="prefetch" href="/assets/js/157.42809de6.js"><link rel="prefetch" href="/assets/js/158.e8754b1f.js"><link rel="prefetch" href="/assets/js/159.9a3383ef.js"><link rel="prefetch" href="/assets/js/16.d2d8db9b.js"><link rel="prefetch" href="/assets/js/160.89b7d6a8.js"><link rel="prefetch" href="/assets/js/161.2acdfefd.js"><link rel="prefetch" href="/assets/js/162.7a7a07cb.js"><link rel="prefetch" href="/assets/js/163.e6dfbfc4.js"><link rel="prefetch" href="/assets/js/164.a22f25e3.js"><link rel="prefetch" href="/assets/js/165.0bc4ff9b.js"><link rel="prefetch" href="/assets/js/166.16682d7d.js"><link rel="prefetch" href="/assets/js/167.1007be32.js"><link rel="prefetch" href="/assets/js/168.678047a7.js"><link rel="prefetch" href="/assets/js/169.2048bec0.js"><link rel="prefetch" href="/assets/js/17.1e8642e7.js"><link rel="prefetch" href="/assets/js/170.a64c8df1.js"><link rel="prefetch" href="/assets/js/171.5f553b26.js"><link rel="prefetch" href="/assets/js/172.d0e53c3d.js"><link rel="prefetch" href="/assets/js/173.aeec1ad5.js"><link rel="prefetch" href="/assets/js/174.b2d22974.js"><link rel="prefetch" href="/assets/js/175.e0f71f8c.js"><link rel="prefetch" href="/assets/js/176.d2fae53a.js"><link rel="prefetch" href="/assets/js/177.d7f99cbd.js"><link rel="prefetch" href="/assets/js/178.513210dd.js"><link rel="prefetch" href="/assets/js/179.9bdb418d.js"><link rel="prefetch" href="/assets/js/18.40d811f2.js"><link rel="prefetch" href="/assets/js/180.55f887c6.js"><link rel="prefetch" href="/assets/js/181.4cc3f728.js"><link rel="prefetch" href="/assets/js/182.2126a2fc.js"><link rel="prefetch" href="/assets/js/183.0a3558ba.js"><link rel="prefetch" href="/assets/js/184.6864be6e.js"><link rel="prefetch" href="/assets/js/185.f0df1752.js"><link rel="prefetch" href="/assets/js/186.ffcd2148.js"><link rel="prefetch" href="/assets/js/187.cb445f9f.js"><link rel="prefetch" href="/assets/js/188.6bff308e.js"><link rel="prefetch" href="/assets/js/189.94991ad3.js"><link rel="prefetch" href="/assets/js/19.01668f6f.js"><link rel="prefetch" href="/assets/js/190.605307a5.js"><link rel="prefetch" href="/assets/js/191.ae4e0f99.js"><link rel="prefetch" href="/assets/js/192.31a67265.js"><link rel="prefetch" href="/assets/js/193.b0b8f0a6.js"><link rel="prefetch" href="/assets/js/194.0f170952.js"><link rel="prefetch" href="/assets/js/195.12dd3386.js"><link rel="prefetch" href="/assets/js/196.cf77c362.js"><link rel="prefetch" href="/assets/js/197.3ff8915e.js"><link rel="prefetch" href="/assets/js/198.c11ac9e5.js"><link rel="prefetch" href="/assets/js/199.60737fbd.js"><link rel="prefetch" href="/assets/js/20.cffe7c76.js"><link rel="prefetch" href="/assets/js/200.90357497.js"><link rel="prefetch" href="/assets/js/201.1120ab69.js"><link rel="prefetch" href="/assets/js/202.0b052147.js"><link rel="prefetch" href="/assets/js/203.c89b5898.js"><link rel="prefetch" href="/assets/js/204.13e0a1f0.js"><link rel="prefetch" href="/assets/js/205.b83fea2f.js"><link rel="prefetch" href="/assets/js/206.f8645274.js"><link rel="prefetch" href="/assets/js/207.cc1e480b.js"><link rel="prefetch" href="/assets/js/208.53bff87f.js"><link rel="prefetch" href="/assets/js/209.affeeef5.js"><link rel="prefetch" href="/assets/js/21.f23c032e.js"><link rel="prefetch" href="/assets/js/210.4f1ac945.js"><link rel="prefetch" href="/assets/js/211.0149c636.js"><link rel="prefetch" href="/assets/js/212.7c5d9377.js"><link rel="prefetch" href="/assets/js/213.71cb0567.js"><link rel="prefetch" href="/assets/js/214.d0df16eb.js"><link rel="prefetch" href="/assets/js/215.80d31c6e.js"><link rel="prefetch" href="/assets/js/216.92405e0e.js"><link rel="prefetch" href="/assets/js/217.a2f9536c.js"><link rel="prefetch" href="/assets/js/218.c3734a1e.js"><link rel="prefetch" href="/assets/js/219.c62ae5e2.js"><link rel="prefetch" href="/assets/js/22.88721d8b.js"><link rel="prefetch" href="/assets/js/220.feb2cbeb.js"><link rel="prefetch" href="/assets/js/221.a8530e53.js"><link rel="prefetch" href="/assets/js/222.4c335cda.js"><link rel="prefetch" href="/assets/js/223.beeb80b7.js"><link rel="prefetch" href="/assets/js/224.d058ca14.js"><link rel="prefetch" href="/assets/js/225.53d9b00e.js"><link rel="prefetch" href="/assets/js/226.8c88a48d.js"><link rel="prefetch" href="/assets/js/227.34d0b8af.js"><link rel="prefetch" href="/assets/js/228.92f3e7a6.js"><link rel="prefetch" href="/assets/js/229.d02e2d49.js"><link rel="prefetch" href="/assets/js/23.adce0254.js"><link rel="prefetch" href="/assets/js/230.ba46c817.js"><link rel="prefetch" href="/assets/js/231.f115b830.js"><link rel="prefetch" href="/assets/js/232.6c2594cc.js"><link rel="prefetch" href="/assets/js/233.079b9aa9.js"><link rel="prefetch" href="/assets/js/234.63b7f866.js"><link rel="prefetch" href="/assets/js/235.d75454d2.js"><link rel="prefetch" href="/assets/js/236.20755d57.js"><link rel="prefetch" href="/assets/js/237.905f98f7.js"><link rel="prefetch" href="/assets/js/238.36857ca5.js"><link rel="prefetch" href="/assets/js/239.855193be.js"><link rel="prefetch" href="/assets/js/24.20e14549.js"><link rel="prefetch" href="/assets/js/240.02767546.js"><link rel="prefetch" href="/assets/js/241.31185d1e.js"><link rel="prefetch" href="/assets/js/242.cd483741.js"><link rel="prefetch" href="/assets/js/243.b92d9ea8.js"><link rel="prefetch" href="/assets/js/244.630ea25e.js"><link rel="prefetch" href="/assets/js/245.5e505e5a.js"><link rel="prefetch" href="/assets/js/246.cf717220.js"><link rel="prefetch" href="/assets/js/247.0cbdfc28.js"><link rel="prefetch" href="/assets/js/248.cb4275dd.js"><link rel="prefetch" href="/assets/js/249.a8c2daba.js"><link rel="prefetch" href="/assets/js/25.24a22469.js"><link rel="prefetch" href="/assets/js/250.7f51ed49.js"><link rel="prefetch" href="/assets/js/251.1581bc51.js"><link rel="prefetch" href="/assets/js/252.41f772a1.js"><link rel="prefetch" href="/assets/js/253.0ed127d3.js"><link rel="prefetch" href="/assets/js/254.fb8064cb.js"><link rel="prefetch" href="/assets/js/255.b0e7e758.js"><link rel="prefetch" href="/assets/js/256.3147433c.js"><link rel="prefetch" href="/assets/js/257.1d96de72.js"><link rel="prefetch" href="/assets/js/26.40eb9f16.js"><link rel="prefetch" href="/assets/js/27.e46a12e1.js"><link rel="prefetch" href="/assets/js/28.168a9bfd.js"><link rel="prefetch" href="/assets/js/29.70ee46c1.js"><link rel="prefetch" href="/assets/js/30.001c4a10.js"><link rel="prefetch" href="/assets/js/31.aa462b87.js"><link rel="prefetch" href="/assets/js/32.6872e770.js"><link rel="prefetch" href="/assets/js/33.3ab6c388.js"><link rel="prefetch" href="/assets/js/34.86764b0b.js"><link rel="prefetch" href="/assets/js/35.836ebd5b.js"><link rel="prefetch" href="/assets/js/36.3bbd7cc3.js"><link rel="prefetch" href="/assets/js/37.f3b74f8f.js"><link rel="prefetch" href="/assets/js/38.a5019cee.js"><link rel="prefetch" href="/assets/js/39.aaa32dd9.js"><link rel="prefetch" href="/assets/js/4.d87cdc3c.js"><link rel="prefetch" href="/assets/js/40.ca4253a4.js"><link rel="prefetch" href="/assets/js/41.84c2858c.js"><link rel="prefetch" href="/assets/js/42.3b4e70ba.js"><link rel="prefetch" href="/assets/js/43.745e442b.js"><link rel="prefetch" href="/assets/js/44.9f2a3bfd.js"><link rel="prefetch" href="/assets/js/45.b26e7d9c.js"><link rel="prefetch" href="/assets/js/46.5cadc469.js"><link rel="prefetch" href="/assets/js/47.e6613404.js"><link rel="prefetch" href="/assets/js/48.b263f5e0.js"><link rel="prefetch" href="/assets/js/49.c9bb398b.js"><link rel="prefetch" href="/assets/js/5.d99c93c3.js"><link rel="prefetch" href="/assets/js/50.cdfd4ff3.js"><link rel="prefetch" href="/assets/js/51.27c56a04.js"><link rel="prefetch" href="/assets/js/52.2409b052.js"><link rel="prefetch" href="/assets/js/53.b706dd01.js"><link rel="prefetch" href="/assets/js/54.eca56d74.js"><link rel="prefetch" href="/assets/js/55.49db8070.js"><link rel="prefetch" href="/assets/js/56.7f452e49.js"><link rel="prefetch" href="/assets/js/58.6e5d83b3.js"><link rel="prefetch" href="/assets/js/59.8808a61c.js"><link rel="prefetch" href="/assets/js/6.91cc8ac1.js"><link rel="prefetch" href="/assets/js/60.f2a1619b.js"><link rel="prefetch" href="/assets/js/61.7a05ef08.js"><link rel="prefetch" href="/assets/js/62.54c0f272.js"><link rel="prefetch" href="/assets/js/63.43cbcaa9.js"><link rel="prefetch" href="/assets/js/64.7f307a82.js"><link rel="prefetch" href="/assets/js/65.85ad65fa.js"><link rel="prefetch" href="/assets/js/66.5742e448.js"><link rel="prefetch" href="/assets/js/67.a0555b56.js"><link rel="prefetch" href="/assets/js/68.a7a22ff6.js"><link rel="prefetch" href="/assets/js/69.9cdbaa2c.js"><link rel="prefetch" href="/assets/js/7.db4f6f85.js"><link rel="prefetch" href="/assets/js/70.a0e37d99.js"><link rel="prefetch" href="/assets/js/71.1ab62514.js"><link rel="prefetch" href="/assets/js/72.a460ca74.js"><link rel="prefetch" href="/assets/js/73.1f7b3c0d.js"><link rel="prefetch" href="/assets/js/74.1959305f.js"><link rel="prefetch" href="/assets/js/75.df32dd2d.js"><link rel="prefetch" href="/assets/js/76.e8c9fc75.js"><link rel="prefetch" href="/assets/js/77.4a6e4c76.js"><link rel="prefetch" href="/assets/js/78.e8750839.js"><link rel="prefetch" href="/assets/js/79.bb789130.js"><link rel="prefetch" href="/assets/js/8.7ff96eb1.js"><link rel="prefetch" href="/assets/js/80.1283ae02.js"><link rel="prefetch" href="/assets/js/81.7bf4f95c.js"><link rel="prefetch" href="/assets/js/82.7c41201e.js"><link rel="prefetch" href="/assets/js/83.e2994430.js"><link rel="prefetch" href="/assets/js/84.75fd70df.js"><link rel="prefetch" href="/assets/js/85.63b6dd59.js"><link rel="prefetch" href="/assets/js/86.bd968a1c.js"><link rel="prefetch" href="/assets/js/87.5fa8bbcb.js"><link rel="prefetch" href="/assets/js/88.ab52b170.js"><link rel="prefetch" href="/assets/js/89.77d1009d.js"><link rel="prefetch" href="/assets/js/9.bab0bdef.js"><link rel="prefetch" href="/assets/js/90.0a487dbe.js"><link rel="prefetch" href="/assets/js/91.fb33fe17.js"><link rel="prefetch" href="/assets/js/92.13d0c8ad.js"><link rel="prefetch" href="/assets/js/93.b39664d0.js"><link rel="prefetch" href="/assets/js/94.78132be4.js"><link rel="prefetch" href="/assets/js/95.ffb30cc7.js"><link rel="prefetch" href="/assets/js/96.9650f55c.js"><link rel="prefetch" href="/assets/js/97.4722f38d.js"><link rel="prefetch" href="/assets/js/98.5f2ed9c6.js"><link rel="prefetch" href="/assets/js/99.11e66eaa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0d208948.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/doc/2.6.0/" class="home-link router-link-active"><!----> <span class="site-name">Apache Ignite技术服务</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/doc/2.6.0/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/doc/2.6.0/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/doc/2.6.0/sql/" class="nav-link">
  SQL
</a></div><div class="nav-item"><a href="/doc/2.6.0/integration/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/doc/2.6.0/spark/" class="nav-link">
  Ignite&amp;Spark
</a></div><div class="nav-item"><a href="/doc/2.6.0/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">2.6.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">2.6.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  2.9.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.8.0/java/Persistence.html" class="nav-link">
  2.8.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.7.0/java/Persistence.html" class="nav-link">
  2.7.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/Persistence.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  2.6.0
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/doc/2.6.0/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/doc/2.6.0/java/" class="nav-link router-link-active">
  Java
</a></div><div class="nav-item"><a href="/doc/2.6.0/sql/" class="nav-link">
  SQL
</a></div><div class="nav-item"><a href="/doc/2.6.0/integration/" class="nav-link">
  集成
</a></div><div class="nav-item"><a href="/doc/2.6.0/spark/" class="nav-link">
  Ignite&amp;Spark
</a></div><div class="nav-item"><a href="/doc/2.6.0/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">2.6.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">2.6.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  2.9.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.8.0/java/Persistence.html" class="nav-link">
  2.8.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.7.0/java/Persistence.html" class="nav-link">
  2.7.0
</a></li><li class="dropdown-item"><!----> <a href="/doc/2.6.0/java/Persistence.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  2.6.0
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/doc/2.6.0/java/" aria-current="page" class="sidebar-link">基本概念</a></li><li><a href="/doc/2.6.0/java/Clustering.html" class="sidebar-link">集群化</a></li><li><a href="/doc/2.6.0/java/Key-ValueDataGrid.html" class="sidebar-link">键-值数据网格</a></li><li><a href="/doc/2.6.0/java/Security.html" class="sidebar-link">安全</a></li><li><a href="/doc/2.6.0/java/DataLoadingStreaming.html" class="sidebar-link">数据注入和流处理</a></li><li><a href="/doc/2.6.0/java/DistributedDataStructures.html" class="sidebar-link">分布式数据结构</a></li><li><a href="/doc/2.6.0/java/ComputeGrid.html" class="sidebar-link">计算网格</a></li><li><a href="/doc/2.6.0/java/ServiceGrid.html" class="sidebar-link">服务网格</a></li><li><a href="/doc/2.6.0/java/MessagingEvents.html" class="sidebar-link">消息和事件</a></li><li><a href="/doc/2.6.0/java/DurableMemory.html" class="sidebar-link">固化内存</a></li><li><a href="/doc/2.6.0/java/ProductionReadiness.html" class="sidebar-link">生产准备</a></li><li><a href="/doc/2.6.0/java/PlatformsProtocols.html" class="sidebar-link">平台和协议</a></li><li><a href="/doc/2.6.0/java/Plugins.html" class="sidebar-link">插件</a></li><li><a href="/doc/2.6.0/java/Deployment.html" class="sidebar-link">部署</a></li><li><a href="/doc/2.6.0/java/MachineLearningGrid.html" class="sidebar-link">机器学习网格</a></li><li><a href="/doc/2.6.0/java/Persistence.html" aria-current="page" class="active sidebar-link">持久化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-持久化存储" class="sidebar-link">1.持久化存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-1-概述" class="sidebar-link">1.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-2-使用" class="sidebar-link">1.2.使用</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-3-事务保证" class="sidebar-link">1.3.事务保证</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-4-sql支持" class="sidebar-link">1.4.SQL支持</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-5-ignite持久化内部" class="sidebar-link">1.5.Ignite持久化内部</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-6-性能提示" class="sidebar-link">1.6.性能提示</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_1-7-示例" class="sidebar-link">1.7.示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_2-预写日志" class="sidebar-link">2.预写日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_2-1-概述" class="sidebar-link">2.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_2-2-wal模式" class="sidebar-link">2.2.WAL模式</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_2-3-wal激活和非激活" class="sidebar-link">2.3.WAL激活和非激活</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_2-4-禁用wal归档" class="sidebar-link">2.4.禁用WAL归档</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_3-检查点" class="sidebar-link">3.检查点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_3-1-概述" class="sidebar-link">3.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_3-2-工作方式" class="sidebar-link">3.2.工作方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-第三方存储" class="sidebar-link">4.第三方存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-1-概述" class="sidebar-link">4.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-2-通读和通写" class="sidebar-link">4.2.通读和通写</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-3-后写缓存" class="sidebar-link">4.3.后写缓存</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-4-cachestore" class="sidebar-link">4.4.CacheStore</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-5-cachestoresession" class="sidebar-link">4.5.CacheStoreSession</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-6-cachestore示例" class="sidebar-link">4.6.CacheStore示例</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-7-配置" class="sidebar-link">4.7.配置</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-8-cachejdbcblobstore" class="sidebar-link">4.8.CacheJdbcBlobStore</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-9-cachejdbcpojostore" class="sidebar-link">4.9.CacheJdbcPojoStore</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-10-cachehibernateblobstore" class="sidebar-link">4.10.CacheHibernateBlobStore</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-11-cassandra-cachestore" class="sidebar-link">4.11.Cassandra CacheStore</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_4-12-原生持久化和第三方持久化一起使用" class="sidebar-link">4.12.原生持久化和第三方持久化一起使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-基线拓扑" class="sidebar-link">5.基线拓扑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-1-概述" class="sidebar-link">5.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-2-基线拓扑" class="sidebar-link">5.2.基线拓扑</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-3-集群激活工具" class="sidebar-link">5.3.集群激活工具</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-4-集群激活" class="sidebar-link">5.4.集群激活</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-5-使用场景" class="sidebar-link">5.5.使用场景</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_5-6-编程方式触发再平衡" class="sidebar-link">5.6.编程方式触发再平衡</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_6-交换空间" class="sidebar-link">6.交换空间</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_6-1-概述" class="sidebar-link">6.1.概述</a></li><li class="sidebar-sub-header"><a href="/doc/2.6.0/java/Persistence.html#_6-2-配置" class="sidebar-link">6.2.配置</a></li></ul></li></ul></li><li><a href="/doc/2.6.0/java/TestsAndBenchmarking.html" class="sidebar-link">基准测试</a></li><li><a href="/doc/2.6.0/java/Metrics.html" class="sidebar-link">指标</a></li><li><a href="/doc/2.6.0/java/ThinClients.html" class="sidebar-link">瘦客户端</a></li><li><a href="/doc/2.6.0/java/KubernetesDeployment.html" class="sidebar-link">Kubernetes部署</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h1> <h2 id="_1-持久化存储"><a href="#_1-持久化存储" class="header-anchor">#</a> 1.持久化存储</h2> <h3 id="_1-1-概述"><a href="#_1-1-概述" class="header-anchor">#</a> 1.1.概述</h3> <p>Ignite的原生持久化是一个分布式的ACID和兼容SQL的磁盘存储，它可以透明地与Ignite的固化内存进行集成。Ignite的持久化是可选的，可以打开也可以关闭，当关闭时Ignite就会变成一个纯内存存储。</p> <p>Ignite的原生持久化会在磁盘上存储一个数据的超集，以及根据容量在内存中存储一个子集。比如，如果有100个条目，然后内存只能存储20条，那么磁盘上会存储所有的100条，然后为了提高性能在内存中缓存20条。</p> <p>另外值得一提的是，和纯内存的使用场景一样，当打开持久化时，每个独立的节点只会持久化数据的一个子集，不管是主还是备节点，都是只包括节点所属的分区的数据，总的来说，整个集群包括了完整的数据集。</p> <p>Ignite的原生持久化有如下的特性：</p> <ul><li>SQL查询会在囊括内存和磁盘的完整数据集上执行，这就意味着Ignite可以被用作一个以内存为中心的分布式SQL数据库；</li> <li>不需要在内存中保存所有的数据和索引，Ignite的持久化允许在磁盘上存储一个数据的超集，然后只在内存中保存频繁访问的数据的子集；</li> <li>集群即时重启，如果整个集群宕掉，那么是不需要通过从持久化预加载数据来对内存进行预热的，只要所有的节点都可以互相访问了，集群就具有了完整的功能；</li> <li>数据和索引在内存和磁盘上以类似的格式存储，这有助于避免在内存和磁盘之间移动数据时进行昂贵的转换；</li> <li>通过加入第三方的解决方案，可以具有创建集群的完整以及增量快照的功能。</li></ul> <h3 id="_1-2-使用"><a href="#_1-2-使用" class="header-anchor">#</a> 1.2.使用</h3> <p>要开启Ignite的原生持久化，需要给集群的配置传递一个<code>DataStorageConfiguration</code>的实例：</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Enabling Apache Ignite native persistence. --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultDataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>persistenceEnabled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Additional setting. --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Apache Ignite node configuration.</span>
<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ignite persistence configuration.</span>
<span class="token class-name">DataStorageConfiguration</span> storageCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorageConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enabling the persistence.</span>
storageCfg<span class="token punctuation">.</span><span class="token function">getDefaultDataRegionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPersistenceEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Applying settings.</span>
cfg<span class="token punctuation">.</span><span class="token function">setDataStorageConfiguration</span><span class="token punctuation">(</span>storageCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>持久化开启之后，所有的数据和索引都会存储在所有集群节点的内存和磁盘上，下图描述了在单独的集群节点的文件系统层看到的持久化结构：</p> <blockquote><p><strong>每个数据区和每个缓存的持久化</strong><br>
Ignite可以为每个具体的数据区甚至每个缓存开启持久化，具体可以看<a href="/doc/2.6.0/java/DurableMemory.html#_3-2-内存区">10.3.2.内存区</a>。</p></blockquote> <p><img src="https://files.readme.io/74a2aac-persistent_store_structure_final.png" alt="">
首先，节点中的每个缓存都要有一个唯一的目录，从上图可知，可以看到至少两个缓存（Cache_A和Cache_B），由节点来维护它们的数据和索引。</p> <p>其次，对于节点的每个分区，不管是主还是备，Ignite的原生持久化都会在文件系统中创建一个专用文件。比如，对上面的节点来说，它负责分区1,10到564，索引是每个缓存一个文件。</p> <blockquote><p><strong>缓存组和分区文件</strong><br>
如果Cache_A和Cache_B属于同一个缓存组，那么这些缓存共享的分区文件会放在一个目录中。</p></blockquote> <p>最后，和预写日志活动有关的文件和目录，下面还会介绍。</p> <blockquote><p><strong>集群激活</strong><br>
注意如果开启了Ignite持久化，集群默认是未激活的，无法进行任何的CRUD操作。用户需要手工激活集群，后面会介绍如何进行操作。</p></blockquote> <p>上述的文件层次默认是在一个名为<code>${IGNITE_HOME}/work/db</code>的目录中进行维护的，要改变存储和WAL文件的默认位置，可以使用<code>DataStorageConfiguration</code>中对应的<code>setStoragePath(...)</code>、<code>setWalPath(...)</code>和<code>setWalArchivePath(...)</code>方法。</p> <p>如果一台主机启动了若干个节点，那么每个节点进程都会在一个预定义的唯一子目录中，比如<code>${IGNITE_HOME}/work/db/node{IDX}-{UUID}</code>，有自己的持久化文件，这里<code>IDX</code>和<code>UUID</code>参数都是Ignite在节点启动时自动计算的（<a href="https://cwiki.apache.org/confluence/display/IGNITE/Ignite+Persistent+Store+-+under+the+hood#IgnitePersistentStore-underthehood-SubfoldersGeneration" target="_self" rel="noopener noreferrer">这里</a>有详细描述）。如果在持久化层次结构中已经有了若干<code>node{IDX}-{UUID}</code>子目录，那么它们是按照节点先入先出的顺序进行赋值的。如果希望某节点即使重启也有专用目录和专用的数据分区，需要在集群范围配置唯一的<code>IgniteConfiguration.setConsistentId</code>，这个唯一ID会在<code>node{IDX}-{UUID}</code>字符串中映射到<code>UUID</code>。</p> <blockquote><p><strong>一台主机隔离集群中的节点</strong><br>
Ignite可以在一台主机上隔离多个集群，每个集群都要在文件系统的不同目录下存储持久化文件，这时可以通过<code>DataStorageConfiguration</code>的<code>setStoragePath(...)</code>、<code>setStoragePath(...)</code>、<code>setWalArchivePath(...)</code>方法来重新定义每个集群的相应的路径。</p></blockquote> <h3 id="_1-3-事务保证"><a href="#_1-3-事务保证" class="header-anchor">#</a> 1.3.事务保证</h3> <p>Ignite的原生持久化是一个兼容ACID的分布式存储，每个事务性更新都会首先被添加到WAL。更新会被赋予一个唯一的ID，这意味着集群在故障或者重启时总是会恢复到最近的成功提交的事务或者原子性更新。</p> <h3 id="_1-4-sql支持"><a href="#_1-4-sql支持" class="header-anchor">#</a> 1.4.SQL支持</h3> <p>Ignite的原生持久化可以将Ignite作为一个分布式的SQL数据库。</p> <p>在集群中执行SQL查询时是不需要在内存中保存所有的数据的，Ignite会在内存和磁盘上的所有数据中执行。另外，在集群重启后将所有的数据都预加载到内存中也是一个选择，这时当集群启动运行时，就可以执行SQL查询了。</p> <h3 id="_1-5-ignite持久化内部"><a href="#_1-5-ignite持久化内部" class="header-anchor">#</a> 1.5.Ignite持久化内部</h3> <p>本章节提供了Ignite持久化的一个高层视图，如果想了解更多的技术细节，可以看下面的文档：</p> <ul><li><a href="https://cwiki.apache.org/confluence/display/IGNITE/Persistent+Store+Overview" target="_self" rel="noopener noreferrer">Ignite原生持久化设计</a></li> <li><a href="https://cwiki.apache.org/confluence/display/IGNITE/Persistent+Store+Architecture" target="_self" rel="noopener noreferrer">Ignite原生持久化架构</a></li></ul> <h3 id="_1-6-性能提示"><a href="#_1-6-性能提示" class="header-anchor">#</a> 1.6.性能提示</h3> <p>在<a href="/doc/2.6.0/java/ProductionReadiness.html#_4-固化内存调优">固化内存调优</a>章节中有关于性能方面的建议。</p> <h3 id="_1-7-示例"><a href="#_1-7-示例" class="header-anchor">#</a> 1.7.示例</h3> <p>要了解Ignite的原生持久化在实践中的应用，可以看GitHub上的这个<a href="https://github.com/apache/ignite/tree/master/examples/src/main/java/org/apache/ignite/examples/persistentstore" target="_self" rel="noopener noreferrer">示例</a>。</p> <h2 id="_2-预写日志"><a href="#_2-预写日志" class="header-anchor">#</a> 2.预写日志</h2> <h3 id="_2-1-概述"><a href="#_2-1-概述" class="header-anchor">#</a> 2.1.概述</h3> <p>Ignite的持久化会为节点的每个分区创建和维护一个专有文件，但是当内存中的页面更新时，更新是不会直接写入对应的分区文件的，因为会严重影响性能，而是将数据写入预写日志的尾部（WAL）。</p> <p>WAL的目的是以最快的速度向磁盘传播更新，以及为单个节点或者整个集群故障的场景提供一种恢复机制。值得一提的是，集群可以根据WAL的内容在故障或者重启时随时恢复到最近成功提交的事务。</p> <p>整个WAL会被拆分为若干个文件，叫做段，它是按顺序进行填充的。当第一个段满了之后，它的内容会被复制到WAL归档文件，然后在那里保存由<code>DataStorageConfiguration.walHistorySize</code>配置的时间。复制完成之后，第二个段会被视为激活的WAL文件，然后接收由应用发送过来的更新请求。默认会创建和使用10个这样的段，这个数值可以通过<code>DataStorageConfiguration.setWalSegmentSize</code>进行修改。
每个更新在写入WAL文件之前会被写入缓冲区，这个缓冲区的大小由<code>DataStorageConfiguration.walBuffSize</code>属性定义。如果开启了内存映射文件，WAL缓冲区大小默认等于WAL段大小，如果禁用了内存映射文件，WAL缓冲区大小为WAL段大小的四分之一。注意内存映射文件默认是开启的，它可以通过<code>IGNITE_WAL_MMAP</code>系统属性进行调整，这个属性可以通过JVM参数传入，比如：<code>-DIGNITE_WAL_MMAP=false</code>。</p> <h3 id="_2-2-wal模式"><a href="#_2-2-wal模式" class="header-anchor">#</a> 2.2.WAL模式</h3> <p>根据WAL模式的不同，Ignite提供了如下的一致性保证：</p> <table><thead><tr><th>WAL模式</th> <th>描述</th> <th>一致性保证</th></tr></thead> <tbody><tr><td><code>FSYNC</code></td> <td>保证每个原子写或者事务性提交都会持久化到磁盘。</td> <td>数据更新不会丢失，不管是任何的操作系统或者进程故障，甚至是电源故障。</td></tr> <tr><td><code>LOG_ONLY</code></td> <td>默认模式，对于每个原子写或者事务性提交，保证会刷新到操作系统的缓冲区缓存或者内存映射文件。默认会使用内存映射文件方式，并且可以通过将<code>IGNITE_WAL_MMAP</code>系统属性配置为<code>false</code>将其关闭。</td> <td>如果仅仅是进程崩溃数据更新会保留。</td></tr> <tr><td><code>BACKGROUND</code></td> <td>如果打开了<code>IGNITE_WAL_MMAP</code>属性（默认），该模式的行为类似于<code>LOG_ONLY</code>模式，如果关闭了内存映射文件方式，变更会保持在节点的内部缓冲区，缓冲区刷新到磁盘的频率由<code>DataStorageConfiguration.setWalFlushFrequency</code>参数定义。</td> <td>如果打开了<code>IGNITE_WAL_MMAP</code>属性（默认），该模式提供了与<code>LOG_ONLY</code>模式一样的保证，否则如果进程故障或者其它的故障发生时，最近的数据更新可能丢失。</td></tr> <tr><td><code>NONE</code></td> <td>WAL被禁用，只有在检查点进程执行过程中或者节点正常关闭时，变更才会正常持久化，使用<code>Ignite#active(false)</code>可以优雅地停止节点。</td> <td>如果一个节点异常终止，可能出现数据丢失，存储于磁盘上的数据很可能会损坏或者不同步，然后持久化目录需要清理以便节点重启。</td></tr></tbody></table> <p>下面是如何配置WAL模式的代码示例：</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  		<span class="token comment">&lt;!-- Enabling Apache Ignite Persistent Store. --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultDataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>persistenceEnabled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

       <span class="token comment">&lt;!-- Changing WAL Mode. --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>walMode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>FSYNC<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Additional setting. --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Apache Ignite node configuration.</span>
<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Native Persistence configuration.</span>
<span class="token class-name">DataStorageConfiguration</span> psCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorageConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enabling the persistence.</span>
psCfg<span class="token punctuation">.</span><span class="token function">getDefaultDataRegionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPersistenceEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set WAL Mode.</span>
psCfg<span class="token punctuation">.</span><span class="token function">setWalMode</span><span class="token punctuation">(</span><span class="token class-name">WALMode</span><span class="token punctuation">.</span>LOG_ONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enabling the Persistent Store.</span>
cfg<span class="token punctuation">.</span><span class="token function">setDataStorageConfiguration</span><span class="token punctuation">(</span>psCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Additional parameters.</span>
</code></pre></div><h3 id="_2-3-wal激活和非激活"><a href="#_2-3-wal激活和非激活" class="header-anchor">#</a> 2.3.WAL激活和非激活</h3> <p>WAL是Ignite持久化的一个基本组件，会在集群故障时保证持久性和一致性。</p> <p>但是，有时因为性能原因禁用WAL也是合理的，比如，通常在数据初始加载时禁用WAL，然后在预加载完毕后再打开它。</p> <p>通过<code>IgniteCluster.enableWal(cacheName)</code>和<code>IgniteCluster.disableWal(cachename)</code>方法可以打开和关闭WAL。如果要检查某个缓存是否开启了WAL，可以使用<code>IgniteCluster.isWalEnabled(cacheName)</code>。</p> <p>如果使用SQL，可以使用ALTER TABLE命令打开/关闭WAL。</p> <h3 id="_2-4-禁用wal归档"><a href="#_2-4-禁用wal归档" class="header-anchor">#</a> 2.4.禁用WAL归档</h3> <p>有时可能想要禁用WAL归档，比如减少与将WAL段复制到归档文件有关的开销，当Ignite将数据写入WAL段的速度快于将段复制到归档文件的速度时，这样做就有用，因为这样会导致I/O瓶颈，从而冻结节点的操作，如果遇到了这样的问题，就可以尝试关闭WAL归档。</p> <p>要关闭归档，可以将WAL路径和WAL归档路径配置为同一个值，这时Ignite就不会将段复制到归档文件，而是周期性的按顺序覆盖活动段。</p> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  		<span class="token comment">&lt;!-- Enabling Apache Ignite Persistent Store. --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultDataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>persistenceEnabled<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>walPath<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/wal/path<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>walArchivePath<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/wal/path<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Additional setting. --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DataStorageConfiguration</span> dsCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorageConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">DataRegionConfiguration</span> regCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataRegionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
regCfg<span class="token punctuation">.</span><span class="token function">setPersistenceEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dsCfg<span class="token punctuation">.</span><span class="token function">setDefaultDataRegionConfiguration</span><span class="token punctuation">(</span>regCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> walAbsPath <span class="token operator">=</span> <span class="token string">&quot;/wal/path&quot;</span><span class="token punctuation">;</span>

dsCfg<span class="token punctuation">.</span><span class="token function">setWalPath</span><span class="token punctuation">(</span>walAbsPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

dsCfg<span class="token punctuation">.</span><span class="token function">setWalArchivePath</span><span class="token punctuation">(</span>walAbsPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-检查点"><a href="#_3-检查点" class="header-anchor">#</a> 3.检查点</h2> <h3 id="_3-1-概述"><a href="#_3-1-概述" class="header-anchor">#</a> 3.1.概述</h3> <p>由于<a href="https://apacheignite.readme.io/docs/write-ahead-log" target="_self" rel="noopener noreferrer">WAL</a>文件会一直增长，并且通过WAL从头到尾地恢复集群会花费大量的时间。为了解决这个问题，Ignite引入了一个检查点过程。</p> <p><strong>检查点</strong>是一个将脏页面从内存复制到磁盘上的分区文件的过程，脏页面是指页面已经在内存中进行了更新但是还没有写入对应的分区文件（只是添加到了WAL中）。</p> <p>这个过程有助于通过在磁盘上保持页面的最新状态而高效地利用磁盘空间，并且允许在WAL档案中删除过时的WAL段（文件）。</p> <h3 id="_3-2-工作方式"><a href="#_3-2-工作方式" class="header-anchor">#</a> 3.2.工作方式</h3> <p>下图显示的是一个简单的更新操作的执行过程：
<img src="https://files.readme.io/a5032a2-9b7fa53-native_persistence.png" alt=""></p> <ol><li>节点接收到更新请求之后，它会在内存中查找该数据所属的数据页面，该页面会被更新然后标记为脏页面；</li> <li>更新会被附加到WAL的尾部；</li> <li>节点会向更新发起方发送一个更新成功的确认信息；</li> <li>根据配置或者其它参数配置的频率，检查点会被定期地触发。脏页面会从内存复制到磁盘，然后传递给特定的分区文件；</li></ol> <h2 id="_4-第三方存储"><a href="#_4-第三方存储" class="header-anchor">#</a> 4.第三方存储</h2> <h3 id="_4-1-概述"><a href="#_4-1-概述" class="header-anchor">#</a> 4.1.概述</h3> <p>Ignite可以做为第三方数据库的一个缓存层（数据网格），包括RDBMS、Apache Cassandra或者MongoDB，该模式可以对底层数据库进行加速。</p> <p>JCache规范提供了<code>javax.cache.integration.CacheLoader</code>和<code>javax.cache.integration.CacheWriter</code>API，它们分别用于底层持久化存储的<code>通读</code>和<code>通写</code>（比如RDBMS中的Oracle或者MySQL，以及NoSQL数据库中的MongoDB或者CouchDB）。除了键-值操作，Ignite还支持INSERT、UPDATE和MERGE操作的通写，但是SELECT查询是无法读取第三方数据库的数据的。
<img src="https://files.readme.io/2b3807b-in_memory_data.png" alt="">
虽然Ignite可以单独地配置<code>CacheRLoader</code>和<code>CacheWriter</code>，但是在两个单独的类中实现事务化存储是非常尴尬的，因为多个<code>load</code>和<code>put</code>操作需要在同一个事务中的同一个连接中共享状态。为了解决这个问题，Ignite提供了<code>org.apacche.ignite.cache.store.CacheStore</code>接口，它同时扩展了<code>CacheLoader</code>和<code>CacheWriter</code>。</p> <blockquote><p><strong>事务</strong><br> <code>CacheStore</code>是完整事务性的，它会自动地融入当前的缓存事务。
<strong>CacheJdbcPojoStore</strong><br>
Ignite附带了它自己的<code>CacheJdbcPojoStore</code>,它会自动地建立Java POJO和数据库模式之间的映射。</p></blockquote> <h3 id="_4-2-通读和通写"><a href="#_4-2-通读和通写" class="header-anchor">#</a> 4.2.通读和通写</h3> <p>如果需要通读和通写行为时，就得提供一个正确的<code>CacheStore</code>实现。通读意味着当缓存无效时会从底层的持久化存储中读取，通写意味着当缓存更新时会自动地进行持久化。所有的通读和通写都会参与整体的缓存事务以及作为一个整体提交或者回滚。</p> <p>要配置通读和通写，需要实现<code>CacheStore</code>接口以及设置<code>CacheConfiguration</code>中<code>cacheStoreFactory</code>的<code>readThrough</code>和<code>writeThrough</code>属性，下面的示例会有说明。</p> <h3 id="_4-3-后写缓存"><a href="#_4-3-后写缓存" class="header-anchor">#</a> 4.3.后写缓存</h3> <p>在一个简单的通写模式中每个缓存的put和remove操作都会涉及一个持久化存储的请求，因此整个缓存更新的持续时间可能是相对比较长的。另外，密集的缓存更新频率也会导致非常高的存储负载。</p> <p>对于这种情况，Ignite提供了一个选项来执行异步化的持久化存储更新，也叫做<strong>后写</strong>，这个方式的主要概念是累加更新操作然后作为一个批量操作异步化地刷入持久化存储中。真实的数据持久化可以被基于时间的事件触发（数据输入的最大时间受到队列的限制），也可以被队列的大小触发（当队列大小达到一个限值），或者通过两者的组合触发，这时任何事件都会触发刷新。</p> <blockquote><p><strong>更新顺序</strong><br>
对于后写的方式只有数据的最后一次更新会被写入底层存储。如果键为key1的缓存数据分别依次地更新为值value1、value2和value3，那么只有(key1,value3)对这一个存储请求会被传播到持久化存储。
<strong>更新性能</strong><br>
批量的存储操作通常比按顺序的单一存储操作更有效率，因此可以通过开启后写模式的批量操作来利用这个特性。简单类型（put和remove）的简单顺序更新操作可以被组合成一个批量操作。比如，连续地往缓存中加入(key1,value1),(key2,value2),(key3,value3)可以通过一个单一的<code>CacheStore.putAll(...)</code>操作批量处理。</p></blockquote> <p>后写缓存可以通过<code>CacheConfiguration.setWriteBehindEnabled(boolean)</code>配置项来开启，下面的<code>16.5.7.配置</code>章节显示了一个完整的配置属性列表来进行后写缓存行为的定制。</p> <h3 id="_4-4-cachestore"><a href="#_4-4-cachestore" class="header-anchor">#</a> 4.4.CacheStore</h3> <p>Ignite中的<code>CacheStore</code>接口用于向底层的数据存储写入或者加载数据。除了标准的JCache加载和存储方法，它还引入了最终事务划界以及从底层数据存储批量载入数据的能力。</p> <p><strong>loadCache()</strong></p> <p><code>CacheStore.loadCache()</code>方法可以加载缓存，即使没有传入要加载的所有键，它通常用于启动时缓存的热加载，但是也可以在缓存加载完之后的任何时间点调用。</p> <p>在每一个相关的集群节点，<code>IgniteCache.loadCache()</code>方法会分配给<code>CacheStore.loadCache()</code>方法，如果只想在本地节点上进行加载，可以用<code>IgniteCache.localLoadCache()</code>方法。</p> <blockquote><p>对于分区缓存，不管是主节点还是备份节点，如果键没有被映射到该节点，会被缓存自动丢弃。</p></blockquote> <p><strong>load(), write(), delete()</strong></p> <p>当<code>IgniteCache</code>接口的<code>get</code>,<code>put</code>,<code>remove</code>方法被调用时，相对应的<code>CacheStore</code>的<code>load()</code>,<code>write()</code>和<code>delete()</code>方法会被调用，当与单个缓存数据工作时，这些方法会用于启用<strong>通读</strong>和<strong>通写</strong>行为。</p> <p><strong>loadAll(), writeAll(), deleteAll()</strong></p> <p>当<code>IgniteCache</code>接口的<code>getAll</code>,<code>putAll</code>,<code>removeAll</code>方法被调用时，相对应的<code>CacheStore</code>的<code>loadAll()</code>,<code>writeAll()</code>和<code>deleteAll()</code>方法会被调用，当与多个缓存数据工作时，这些方法会用于启用<strong>通读</strong>和<strong>通写</strong>行为，它们通常用批量操作的方式实现以提供更好的性能。</p> <blockquote><p><code>CacheStoreAdapter</code>提供了<code>loadAll()</code>,<code>writeAll()</code>和<code>deleteAll()</code>方法的默认实现，它只是简单地对键进行一个一个地迭代。</p></blockquote> <p><strong>sessionEnd()</strong></p> <p>Ignite有一个存储会话的概念，它可以跨越不止一个<code>CacheStore</code>操作，会话对于事务非常有用。</p> <p>对于<code>原子化</code>的缓存，<code>sessionEnd()</code>方法会在每个<code>CacheStore</code>方法完成之后被调用，对于<code>事务化</code>的缓存，不管是在底层持久化存储进行提交或者回滚多个操作，<code>sessionEnd()</code>方法都会在每个事务结束后被调用。</p> <blockquote><p><code>CacheStoreAdapater</code>提供了<code>sessionEnd()</code>方法的默认的空实现。</p></blockquote> <p><strong>Cassandra CacheStore</strong></p> <p>Ignite提供了将Apache Cassandra作为内存网格级<code>CacheStore</code>的直接集成，要了解更多的信息，可以查看相关的文档。</p> <h3 id="_4-5-cachestoresession"><a href="#_4-5-cachestoresession" class="header-anchor">#</a> 4.5.CacheStoreSession</h3> <p><code>CacheStore</code>会话的主要目的是当<code>CacheStore</code>用于事务中时在多个存储操作中持有一个上下文。比如，如果使用JDBC，可以通过<code>CacheStoreSession.attach()</code>方法保存数据库的连接，然后可以在<code>CacheStore.sessionEnd(boolean)</code>方法中提交这个连接。
<code>CacheStoreSession</code>可以通过<code>@GridCacheStoreSessionResource</code>注解注入自定义的<code>CacheStore</code>实现中。</p> <h3 id="_4-6-cachestore示例"><a href="#_4-6-cachestore示例" class="header-anchor">#</a> 4.6.CacheStore示例</h3> <p>下面是几个不同场景的<code>CacheStore</code>的实现，注意事务化的实现用还是没用事务。</p> <p><strong>JDBC非事务：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheJdbcPersonStore</span> <span class="token keyword">extends</span> <span class="token class-name">CacheStoreAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// This mehtod is called whenever &quot;get(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;select * from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;put(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Syntax of MERGE statement is database specific and should be adopted for your database.</span>
      <span class="token comment">// If your database does not support MERGE statement then use sequentially update, insert statements.</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
        <span class="token string">&quot;merge into PERSONS (id, firstName, lastName) key (id) VALUES (?, ?, ?)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Person</span> val <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to write [key=&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">']'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;remove(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;delete from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        st<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to delete: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;loadCache()&quot; and &quot;localLoadCache()&quot;</span>
  <span class="token comment">// methods are called on IgniteCache. It is used for bulk-loading the cache.</span>
  <span class="token comment">// If you don't need to bulk-load the cache, skip this method.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadCache</span><span class="token punctuation">(</span><span class="token class-name">IgniteBiInClosure</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> clo<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Expected entry count parameter is not provided.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> entryCnt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;select * from PERSONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

          <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> entryCnt <span class="token operator">&amp;&amp;</span> rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            clo<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>

            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load values from cache store.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Open JDBC connection.</span>
  <span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  <span class="token punctuation">{</span>
    <span class="token comment">// Open connection to your RDBMS systems (Oracle, MySQL, Postgres, DB2, Microsoft SQL, etc.)</span>
    <span class="token comment">// In this example we use H2 Database for simplification.</span>
    <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:h2:mem:example;DB_CLOSE_DELAY=-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>JDBC事务：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheJdbcPersonStore</span> <span class="token keyword">extends</span> <span class="token class-name">CacheStoreAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">/** Auto-injected store session. */</span>
  <span class="token annotation punctuation">@CacheStoreSessionResource</span>
  <span class="token keyword">private</span> <span class="token class-name">CacheStoreSession</span> ses<span class="token punctuation">;</span>

  <span class="token comment">// Complete transaction or simply close connection if there is no transaction.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sessionEnd</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> commit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> ses<span class="token punctuation">.</span><span class="token function">getAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ses<span class="token punctuation">.</span><span class="token function">isWithinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>commit<span class="token punctuation">)</span>
          conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
          conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to end store session.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;get(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Long</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;select * from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;put(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Syntax of MERGE statement is database specific and should be adopted for your database.</span>
      <span class="token comment">// If your database does not support MERGE statement then use sequentially update, insert statements.</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
        <span class="token string">&quot;merge into PERSONS (id, firstName, lastName) key (id) VALUES (?, ?, ?)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Person</span> val <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to write [key=&quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot;, val=&quot;</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">']'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;remove(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;delete from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        st<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to delete: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;loadCache()&quot; and &quot;localLoadCache()&quot;</span>
  <span class="token comment">// methods are called on IgniteCache. It is used for bulk-loading the cache.</span>
  <span class="token comment">// If you don't need to bulk-load the cache, skip this method.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadCache</span><span class="token punctuation">(</span><span class="token class-name">IgniteBiInClosure</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> clo<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Expected entry count parameter is not provided.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token keyword">int</span> entryCnt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;select * from PERSONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

          <span class="token keyword">while</span> <span class="token punctuation">(</span>cnt <span class="token operator">&lt;</span> entryCnt <span class="token operator">&amp;&amp;</span> rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            clo<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> person<span class="token punctuation">)</span><span class="token punctuation">;</span>

            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to load values from cache store.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Opens JDBC connection and attaches it to the ongoing</span>
  <span class="token comment">// session if within a transaction.</span>
  <span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span>  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ses<span class="token punctuation">.</span><span class="token function">isWithinTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Connection</span> conn <span class="token operator">=</span> ses<span class="token punctuation">.</span><span class="token function">getAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        conn <span class="token operator">=</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Store connection in the session, so it can be accessed</span>
        <span class="token comment">// for other operations within the same transaction.</span>
        ses<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Transaction can be null in case of simple load or put operation.</span>
    <span class="token keyword">else</span>
      <span class="token keyword">return</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Opens JDBC connection.</span>
  <span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autocommit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
    <span class="token comment">// Open connection to your RDBMS systems (Oracle, MySQL, Postgres, DB2, Microsoft SQL, etc.)</span>
    <span class="token comment">// In this example we use H2 Database for simplification.</span>
    <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:h2:mem:example;DB_CLOSE_DELAY=-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span>autocommit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>JDBC批量操作：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheJdbcPersonStore</span> <span class="token keyword">extends</span> <span class="token class-name">CacheStore</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// Skip single operations and open connection methods.</span>
  <span class="token comment">// You can copy them from jdbc non-transactional or jdbc transactional examples.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// This mehtod is called whenever &quot;getAll(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadAll</span><span class="token punctuation">(</span><span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
        <span class="token string">&quot;select firstName, lastName from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> loaded <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              loaded<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> loaded<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheLoaderException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to loadAll: &quot;</span> <span class="token operator">+</span> keys<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;putAll(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeAll</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Syntax of MERGE statement is database specific and should be adopted for your database.</span>
      <span class="token comment">// If your database does not support MERGE statement then use sequentially update, insert statements.</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>
        <span class="token string">&quot;merge into PERSONS (id, firstName, lastName) key (id) VALUES (?, ?, ?)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cache</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Person</span> val <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          st<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        st<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to writeAll: &quot;</span> <span class="token operator">+</span> entries<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// This mehtod is called whenever &quot;removeAll(...)&quot; methods are called on IgniteCache.</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> st <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">&quot;delete from PERSONS where id=?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          st<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

          st<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        st<span class="token punctuation">.</span><span class="token function">executeBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CacheWriterException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to deleteAll: &quot;</span> <span class="token operator">+</span> keys<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-7-配置"><a href="#_4-7-配置" class="header-anchor">#</a> 4.7.配置</h3> <p>下面的配置参数可以通过<code>CacheConfiguration</code>用于启用以及配置<strong>后写</strong>缓存：</p> <table><thead><tr><th>setter方法</th> <th>描述</th> <th>默认值</th></tr></thead> <tbody><tr><td><code>setWriteBehindEnabled(boolean)</code></td> <td>设置后写是否启用的标志</td> <td>false</td></tr> <tr><td><code>setWriteBehindFlushSize(int)</code></td> <td>后写缓存的最大值，如果超过了这个限值，所有的缓存数据都会被刷入<code>CacheStore</code>然后写缓存被清空。如果值为0，刷新操作将会依据刷新频率间隔，注意不能将写缓存大小和刷新频率都设置为0</td> <td>10240</td></tr> <tr><td><code>setWriteBehindFlushFrequency(long)</code></td> <td>后写缓存的刷新频率，单位为毫秒，该值定义了从对缓存对象进行插入/删除和当相应的操作被施加到<code>CacheStore</code>的时刻之间的最大时间间隔。如果值为0，刷新会依据写缓存大小，注意不能将写缓存大小和刷新频率都设置为0</td> <td>5000</td></tr> <tr><td><code>setWriteBehindFlushThreadCount(int)</code></td> <td>执行缓存刷新的线程数</td> <td>1</td></tr> <tr><td><code>setWriteBehindBatchSize(int)</code></td> <td>后写缓存存储操作的操作数最大值</td> <td>512</td></tr></tbody></table> <p><code>CacheStore</code>接口可以在<code>IgniteConfiguration</code>上通过一个工厂进行设置，就和<code>CacheLoader</code>和<code>CacheWriter</code>同样的方式。</p> <blockquote><p>对于分布式缓存的配置，<code>Factory</code>应该是可序列化的。</p></blockquote> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          ...
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javax.cache.configuration.FactoryBuilder<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>factoryOf<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>foo.bar.MyPersonStore<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>readThrough<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>writeThrough<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">CacheConfiguration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span> cacheCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheConfiguration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cacheCfg<span class="token punctuation">.</span><span class="token function">setCacheStoreFactory</span><span class="token punctuation">(</span><span class="token class-name">FactoryBuilder</span><span class="token punctuation">.</span><span class="token function">factoryOf</span><span class="token punctuation">(</span><span class="token class-name">MyPersonStore</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cacheCfg<span class="token punctuation">.</span><span class="token function">setReadThrough</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cacheCfg<span class="token punctuation">.</span><span class="token function">setWriteThrough</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cfg<span class="token punctuation">.</span><span class="token function">setCacheConfiguration</span><span class="token punctuation">(</span>cacheCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ignite node.</span>
<span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-8-cachejdbcblobstore"><a href="#_4-8-cachejdbcblobstore" class="header-anchor">#</a> 4.8.CacheJdbcBlobStore</h3> <p><code>CacheJdbcBlobStore</code>实现基于JDBC，这个实现将对象以<code>BLOB</code>的格式存储在底层数据库中。存储会在数据库中创建名为<code>ENTRIES</code>的表来存储数据，表具有key和val两个字段。</p> <p>如果提供了定制的DDL和DML语句，表和字段的名字要和所有的语句一致以及参数的顺序也要保留。</p> <p>使用<code>CacheJdbcBlobStoreFactory</code>工厂来向<code>CacheConfiguration</code>传入<code>CacheJdbcBlobStore</code>:</p> <p><strong>Spring:</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">&quot;</span>simpleDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.h2.jdbcx.JdbcDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jdbc:h2:mem:jdbcCacheStore;DB_CLOSE_DELAY=-1<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ignite.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
         ...
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.store.jdbc.CacheJdbcBlobStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">&quot;</span>user<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSourceBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">&quot;</span>simpleDataSource<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_4-9-cachejdbcpojostore"><a href="#_4-9-cachejdbcpojostore" class="header-anchor">#</a> 4.9.CacheJdbcPojoStore</h3> <p><code>CacheJdbcPojoStore</code>实现基于JDBC和基于反射的POJO，这个实现将对象用基于反射的Java Bean映射描述的形式存储在底层数据库中。</p> <p>使用<code>CacheJdbcPojoStoreFactory</code>工厂来向<code>CacheConfiguration</code>传入<code>CacheJdbcPojoStore</code>:
<strong>Spring:</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">&quot;</span>simpleDataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.h2.jdbcx.JdbcDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ignite.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          ...
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.store.jdbc.CacheJdbcPojoStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataSourceBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation">=</span> <span class="token punctuation">&quot;</span>simpleDataSource<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_4-10-cachehibernateblobstore"><a href="#_4-10-cachehibernateblobstore" class="header-anchor">#</a> 4.10.CacheHibernateBlobStore</h3> <p><code>CacheHibernateBlobStore</code>实现基于Hibernate,这个实现将对象以<code>BLOB</code>的格式存储在底层数据库中。</p> <p>使用<code>CacheHibernateBlobStoreFactory</code>工厂来向<code>CacheConfiguration</code>传入<code>CacheHibernateBlobStore</code>:</p> <p><strong>Spring:</strong></p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ignite.cfg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.CacheConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.cache.store.hibernate.CacheHibernateBlobStoreFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hibernateProperties<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>props</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prop</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>connection.url<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>jdbc:h2:mem:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prop</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prop</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hbm2ddl.auto<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>update<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prop</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prop</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>show_sql<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prop</span><span class="token punctuation">&gt;</span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>props</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
  ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_4-11-cassandra-cachestore"><a href="#_4-11-cassandra-cachestore" class="header-anchor">#</a> 4.11.Cassandra CacheStore</h3> <p>可以查看<code>Cassandra集成</code>相关章节的内容，了解更详细的信息。</p> <h3 id="_4-12-原生持久化和第三方持久化一起使用"><a href="#_4-12-原生持久化和第三方持久化一起使用" class="header-anchor">#</a> 4.12.原生持久化和第三方持久化一起使用</h3> <p>从2.4版本开始，在一个集群中，Ignite支持原生持久化和第三方持久化的共存，如果启用了第三方持久化，Ignite会尽力保证两者之间的一致性。</p> <p>但是，当使用事务且在事务提交期间，如果一个分区对应的所有节点故障（或者整个集群故障），数据可能会不一致。根据时间节点，第三方持久化和原生持久化的事务状态可能有所不同。</p> <blockquote><p>Ignite无法保证原生持久化和第三方持久化之间的严格一致性，因为目前的CacheStore接口还不支持二阶段提交协议。</p></blockquote> <p>在恢复时，必须对两个存储的提交日志进行比较。不一致时，相应的缺失事务要么重做要么回滚。</p> <h2 id="_5-基线拓扑"><a href="#_5-基线拓扑" class="header-anchor">#</a> 5.基线拓扑</h2> <h3 id="_5-1-概述"><a href="#_5-1-概述" class="header-anchor">#</a> 5.1.概述</h3> <p>如果启用了原生持久化，Ignite引入了一个<em>基线拓扑</em>的概念，它代表了集群中将数据持久化到磁盘的一组服务端节点。</p> <p>通常，打开原生持久化第一次启动集群后，集群被认为处于非激活状态，无法进行任何CRUD操作。比如，如果尝试执行一个SQL或者键-值操作，会抛出一个异常，如下图所示：
<img src="https://files.readme.io/057d4fb-cluster-activation.png" alt="">
这样做是为了避免可能的性能、可用性和一致性问题，如果集群正在重启，然后应用就开始修改持久化在还未加入集群的节点的数据，因此，需要为开启持久化的集群定义一个基线拓扑，之后，Ignite就可以手工或者自动地维护它，下面会看这个概念的细节以及如何使用它。</p> <h3 id="_5-2-基线拓扑"><a href="#_5-2-基线拓扑" class="header-anchor">#</a> 5.2.基线拓扑</h3> <p>基线拓扑是一组Ignite服务端节点，目的是在内存以及原生持久化中存储数据。来自基线拓扑的节点在功能方面不受限制，并且作为数据和计算的容器，在行为上也和普通的服务端节点一样。</p> <p>另外，部分节点不属于基线拓扑，也是可以的，比如：</p> <ul><li>不在内存中存储数据，或者也不在第三方数据库，比如RDBMS或者NoSQL中持久化的服务端节点；</li> <li>不在基线拓扑中的客户端节点，因为它们不持有数据。</li></ul> <p>基线拓扑的目的是：</p> <ul><li>如果节点重启，避免不必要的数据再平衡。比如，每个节点重启都会触发两个再平衡事件，一个是节点停止，一个是节点重新加入集群，这会导致集群资源的无效利用；</li> <li>集群重启后，如果基线拓扑中的所有节点都已经加入，那么集群会被自动激活。</li></ul> <blockquote><p><strong>深入了解基线拓扑</strong><br>
如果要深入了解基线拓扑和集群自动激活的细节，可以看这个<a href="https://cwiki.apache.org/confluence/display/IGNITE/IEP-4+Baseline+topology+for+caches" target="_self" rel="noopener noreferrer">Wiki页面</a>。</p></blockquote> <p>打开持久化之后，集群第一次启动是没有配置基线拓扑的，这是唯一一个需要人工干预的时间点。因此，当所有属于基线拓扑的节点都启动运行之后，就可以通过代码或者命令行工具进行配置了，之后就可以让Ignite自动地处理与激活有关的日常工作了。</p> <p>在整个生命周期中，同样的工具和API也可以对基线拓扑进行调整。通过配置让更多或者更少的节点存储数据，就可以对已有的基线拓扑进行缩放，下面的章节会说明如何使用这些API和工具。</p> <h3 id="_5-3-集群激活工具"><a href="#_5-3-集群激活工具" class="header-anchor">#</a> 5.3.集群激活工具</h3> <p>Ignite提供了<code>control.sh|bat</code>脚本，位于<code>$IGNITE_HOME/bin</code>文件夹，它是作为从命令行激活/冻结集群的工具，也可以用于配置基线拓扑。<code>control.sh|bat</code>支持如下的命令：</p> <table><thead><tr><th>命令</th> <th>描述</th></tr></thead> <tbody><tr><td><code>--activate</code></td> <td>激活集群</td></tr> <tr><td><code>--deactivate</code></td> <td>冻结集群</td></tr> <tr><td><code>--host {ip}</code></td> <td>集群IP地址，默认值为127.0.0.1</td></tr> <tr><td><code>--port {port}</code></td> <td>要连接的端口，默认值为11211</td></tr> <tr><td><code>--state</code></td> <td>输出当前的集群状态</td></tr> <tr><td><code>--baseline</code></td> <td>如果没有任何参数，该命令输出该集群的基线拓扑信息。它支持如下的参数：<code>add</code>、<code>remove</code>、<code>set</code>和<code>version</code></td></tr> <tr><td><code>--baseline add</code></td> <td>往基线拓扑中添加节点</td></tr> <tr><td><code>--baseline remove</code></td> <td>从基线拓扑中删除节点</td></tr> <tr><td><code>--baseline set</code></td> <td>配置基线拓扑</td></tr> <tr><td><code>--baseline version</code></td> <td>基于版本配置基线拓扑</td></tr></tbody></table> <p>可以使用<code>./control.sh --help</code>查看帮助。</p> <p>除了首选的几种手动激活集群的方法之外，Ignite还提供了集群自动激活的能力，下面首先介绍为自动激活集群设计的功能，然后再介绍手动激活方法。</p> <h3 id="_5-4-集群激活"><a href="#_5-4-集群激活" class="header-anchor">#</a> 5.4.集群激活</h3> <p>要实现对启用持久化的集群的自动激活，首先需要手动激活集群。这可以通过3种方式实现：通过代码、命令行或第三方工具，如下所述。当第一次激活集群后，就会从当前服务端节点集合自动建立基线拓扑。完成之后构成基线拓扑结构的节点信息就会持久化到磁盘。然后即使重启集群，只要基线拓扑中配置的所有节点都启动运行，集群都会自动激活。</p> <p><strong>通过代码配置基线拓扑</strong></p> <p>如上所述，如果手动激活集群之后，基线拓扑会自动初始化，通过代码，可以使用<code>IgniteCluster.activate()</code>方法激活集群，然后，可以使用<code>IgniteCluster.setBaseLineTopogy()</code>方法调整一个已有的基线拓扑。</p> <p>激活集群：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Connect to the cluster.</span>
<span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Activate the cluster. Automatic topology initialization occurs</span>
<span class="token comment">// only if you manually activate the cluster for the very first time.</span>
ignite<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">If</span>
</code></pre></div><p>配置基线拓扑节点：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Connect to the cluster.</span>
<span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Activate the cluster.</span>
<span class="token comment">// This is required only if the cluster is still inactive.</span>
ignite<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get all server nodes that are already up and running.</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClusterNode</span><span class="token punctuation">&gt;</span></span> nodes <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the baseline topology that is represented by these nodes.</span>
ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBaselineTopology</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将集群拓扑配置为基线拓扑：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Connect to the cluster.</span>
<span class="token class-name">Ignite</span> ignite <span class="token operator">=</span> <span class="token class-name">Ignition</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Activate the cluster.</span>
<span class="token comment">// This is required only if the cluster is still inactive.</span>
ignite<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Set the baseline topology to a specific Ignite cluster topology version.</span>
ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBaselineTopology</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果之后更新了基线拓扑，比如添加了新的节点，那么Ignite会自动地在基线拓扑中进行数据再平衡。</p> <p><strong>通过命令行配置基线拓扑</strong></p> <p>可以使用<code>16.5.3.集群激活工具</code>中介绍的工具来配置基线拓扑。</p> <p><em>获取节点唯一性ID</em></p> <p>这个定义和调整基线拓扑的命令，需要提供一个节点的唯一性ID，这是节点在第一次启动以及重启时复用后被赋予的一个唯一ID。要获取目前正在运行节点的唯一性ID，可以在<code>$IGNITE_HOME/bin</code>目录下执行<code>./control.sh --baseline</code>命令，然后获得有关集群基线拓扑的各种信息，比如：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline
</code></pre></div><p>输出大致如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Cluster state: active
Current topology version: <span class="token number">4</span>

Baseline nodes:
    <span class="token assign-left variable">ConsistentID</span><span class="token operator">=</span>cde228a8-da90-4b74-87c0-882d9c5729b7, <span class="token assign-left variable">STATE</span><span class="token operator">=</span>ONLINE
    <span class="token assign-left variable">ConsistentID</span><span class="token operator">=</span>dea120d9-3157-464f-a1ea-c8702de45c7b, <span class="token assign-left variable">STATE</span><span class="token operator">=</span>ONLINE
    <span class="token assign-left variable">ConsistentID</span><span class="token operator">=</span>fdf68f13-8f1c-4524-9102-ac2f5937c62c, <span class="token assign-left variable">STATE</span><span class="token operator">=</span>ONLINE
--------------------------------------------------------------------------------
Number of baseline nodes: <span class="token number">3</span>

Other nodes:
    <span class="token assign-left variable">ConsistentID</span><span class="token operator">=</span>5d782f5e-0d47-4f42-aed9-3b7edeb527c0
</code></pre></div><p>上面的基线信息显示，集群的状态、拓扑版本、属于和不属于基线拓扑的节点及其唯一性ID都显示出来了。</p> <p><em>配置拓扑</em></p> <p>要将一组节点组成基线拓扑，需要使用<code>./control.sh --baseline set</code>命令，再加上节点的唯一性ID列表：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline <span class="token builtin class-name">set</span> consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span>
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline <span class="token builtin class-name">set</span> <span class="token punctuation">{</span>consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>另外，也可以使用数字化的集群拓扑版本来配置基线：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline topologyVersion
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline version <span class="token punctuation">{</span>topologyVersion<span class="token punctuation">}</span>
</code></pre></div><p>在上面的命令中，需要将<code>topologyVersion</code>替换为实际的拓扑版本。</p> <p><em>往拓扑中添加节点</em></p> <p>要往已有的基线拓扑中添加节点，需要使用<code>./control.sh --baseline add</code>命令，它会接受一个逗号分隔的节点唯一性ID的列表：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline <span class="token function">add</span> consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span>
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline <span class="token function">add</span> <span class="token punctuation">{</span>consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>比如下面的命令，会将唯一性ID为<code>5d782f5e-0d47-4f42-aed9-3b7edeb527c0</code>的节点加入基线拓扑：
Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline <span class="token function">add</span> 5d782f5e-0d47-4f42-aed9-3b7edeb527c0
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline <span class="token function">add</span> eb05ce3d-f246-4b7b-8e80-91155774c20b
</code></pre></div><p><em>从拓扑中删除节点</em></p> <p>要从拓扑中删除节点，可以使用<code>./control.sh --baseline remove</code>命令，语法如下：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline remove consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span>
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline remove <span class="token punctuation">{</span>consistentId1<span class="token punctuation">[</span>,consistentId2,<span class="token punctuation">..</span><span class="token punctuation">..</span>,consistentIdN<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>注意要被删除的节点首先应该停止，否则会抛出一个类似<code>Failed to remove nodes from baseline</code>这样的异常。下面的示例会显示如何删除唯一性ID为<code>fdf68f13-8f1c-4524-9102-ac2f5937c62c</code>的节点（假定该节点已停止）：</p> <p>Unix：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.sh --baseline remove fdf68f13-8f1c-4524-9102-ac2f5937c62c
</code></pre></div><p>Windows：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./control.bat --baseline remove eb05ce3d-f246-4b7b-8e80-91155774c20b
</code></pre></div><p><strong>使用第三方工具激活</strong></p> <p>也可以使用第三方工具激活集群，比如<a href="https://docs.gridgain.com/docs/baseline-topology" target="_self" rel="noopener noreferrer">这个</a>。</p> <h3 id="_5-5-使用场景"><a href="#_5-5-使用场景" class="header-anchor">#</a> 5.5.使用场景</h3> <p>设计基线拓扑的目的是避免不必要的分区重新分配和数据的再平衡。这意味着，相对于特定事件（比如节点加入或者离开集群），决定什么时候对基线拓扑进行调整（会触发数据再平衡），变成了IT管理员的职责。如上所述，这可以通过<code>control.sh|bat</code>命令手工完成，也可以通过一些外部的自动化工具实现（比如一个检查运行Ignite节点的主机健康状态的系统，会从基线拓扑中移除不稳定或者故障的节点）。</p> <blockquote><p><strong>再平衡和非基线服务端节点</strong><br>
只存储在内存中（或内存中和第三方持久化）中的数据再平衡会自动触发，不需要任何人工干预。·</p></blockquote> <p>下面会讨论若干个常见场景，即如果开启了Ignite原生持久化时的基线拓扑管理问题。</p> <p><strong>集群第一次启动</strong></p> <p>场景：集群第一次启动，没有数据预加载。</p> <p>步骤：</p> <ol><li>不管什么方式，启动所有节点，比如通过<code>ignite.sh</code>，这时：</li></ol> <ul><li>集群为非激活状态，无法处理来自客户端的和数据相关的请求（键-值、SQL、扫描查询等）；</li> <li>基线拓扑未配置。</li></ul> <ol start="2"><li>通过调用<code>control.sh --activate</code>激活集群，或者上面文档描述的其它方式，做了如下事情：</li></ol> <ul><li>将正在运行的服务端节点全部加入基线拓扑；</li> <li>将集群切换为激活状态，允许交互。</li></ul> <blockquote><p><code>control.sh --activate</code>命令只在第一次激活时配置基线拓扑，如果已经配置了基线拓扑，则该命令无效。</p></blockquote> <blockquote><p>如果集群激活，除非冻结或者所有节点停止，否则会一直处于激活状态，单节点的退出不会影响整个集群的可用性。</p></blockquote> <p><strong>集群重启</strong></p> <p>场景：所有节点都需要重启（比如执行系统或者硬件升级）。</p> <p>步骤：</p> <ol><li>正常停止所有的节点；</li> <li>执行升级；</li> <li>启动所有的节点，基线拓扑中的所有节点都启动之后，集群会被自动激活；</li></ol> <p><strong>添加新的节点</strong></p> <p>场景：添加一个新的空节点（没有持久化的数据）。</p> <p>步骤：</p> <ol><li>正常启动节点，这时：</li></ol> <ul><li>集群仍然是激活状态；</li> <li>新节点已经加入集群，但是未加入基线拓扑；</li> <li>新节点可以用于存储不使用持久化的缓存/表的数据；</li> <li>新节点无法在持久化中存储缓存/表的数据；</li> <li>新节点可用于计算。</li></ul> <ol start="2"><li>如果希望该节点可以再持久化中存储数据，那么需要通过<code>control.sh --baseline add &lt;node's consistentId&gt;</code>或者其它方式将其加入基线拓扑，然后：</li></ol> <ul><li>基线拓扑会调整，包含新的节点；</li> <li>在新的基线拓扑中进行数据再平衡。</li></ul> <p><strong>节点重启</strong></p> <p>场景：节点需要重启，时间很短。</p> <p>步骤：</p> <ol><li>停止节点；</li> <li>重启节点，之后：</li></ol> <ul><li>基线拓扑没有必要变化，重启之后节点仍然保留它的<code>consistentId</code>，因此集群以及基线拓扑只是将该节点收回；</li> <li>在节点下线期间如果有数据更新，修改的分区的数据会从其它节点复制到重启后的节点。</li></ul> <blockquote><p>如果节点重启时间很短，那么不要去碰基线拓扑是安全的（也是高效的），因此也不需要触发再平衡。但是如果时间很长，就需要从基线拓扑中删除该节点，然后触发再平衡以避免可能的数据丢失，因为要下线的节点上存储的主备数据可能丢失。</p></blockquote> <p><strong>基线节点删除</strong></p> <p>场景：基线节点需要停止，或者除了严重的故障，然后需要从集群中永久删除，或者需要下线很长时间。</p> <p>步骤：</p> <ol><li>停止节点（还没有停止/故障），这时：</li></ol> <ul><li>集群仍然处于激活状态；</li> <li>停止的节点仍然在基线拓扑中，状态为失去连接；</li> <li>保存在内存中的缓存/表中的数据（或者开启了第三方持久化的缓存/表）会进行数据再平衡；</li> <li>如果开启了原生持久化，不会触发再平衡，在停止的节点恢复在线或者从基线拓扑中删除之前，复制因子（副本数量）都会减小。</li></ul> <blockquote><p>长时间降低复制因子可能是危险的。例如，考虑具有一个备份的缓存，如果一个节点故障，则没有数据丢失（因为一个副本仍然在线），但是需要尽快触发再平衡，因为如果另一个节点在重新平衡完成之前故障，则可能导致数据丢失。</p></blockquote> <ol start="2"><li>通过调用<code>contol.sh --baseline remove &lt;node's consistentId&gt;</code>或者其它方式将节点从基线拓扑中删除，之后：</li></ol> <ul><li>基线拓扑发生变更，排除了停止的节点；</li> <li>开启原生持久化的缓存/表，会按照配置好的复制因子（或者副本数量）进行数据再平衡。</li></ul> <blockquote><p>节点从基线拓扑中删除之后，它就无法加入集群然后持有删除之前存储在持久化中的数据。通过在基线拓扑中删除一个节点，可以确定即使该节点重启，也无法再使用存储在该节点上的数据。</p></blockquote> <p><strong>非基线节点删除和故障处理</strong></p> <p>不添加到基线拓扑的服务端节点不需要IT管理员的额外干预来触发数据再平衡。由于这些节点只在内存（或内存和第三方数据库）中存储数据，所以再平衡会自动触发。</p> <h3 id="_5-6-编程方式触发再平衡"><a href="#_5-6-编程方式触发再平衡" class="header-anchor">#</a> 5.6.编程方式触发再平衡</h3> <p>如前述的<code>节点重启</code>和<code>节点删除</code>章节所述，基线拓扑可能会在一个较长的时间段内维持复制因子（副本数量）的降低，因此如果预期下线时间足够长，就需要从基线拓扑中删除该节点，然后触发再平衡以避免可能的数据丢失，因为要下线的节点上存储的主备数据可能丢失。
从基线拓扑中手动删除节点之后，就可以触发再平衡以及恢复复制因子。通过<code>control.sh</code>脚本以及监控工具，可以自动地执行删除操作，另外，使用如下的模板代码，也可以通过编程方式触发再平衡：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Set</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream</span><span class="token punctuation">.</span><span class="token class-name">Collectors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite</span><span class="token punctuation">.</span><span class="token class-name">Ignite</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>cluster</span><span class="token punctuation">.</span><span class="token class-name">BaselineNode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>cluster</span><span class="token punctuation">.</span><span class="token class-name">ClusterNode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>events</span><span class="token punctuation">.</span><span class="token class-name">DiscoveryEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>events</span><span class="token punctuation">.</span><span class="token class-name">EventType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>internal</span><span class="token punctuation">.</span><span class="token class-name">IgniteEx</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ignite<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>timeout</span><span class="token punctuation">.</span><span class="token class-name">GridTimeoutObjectAdapter</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaselineWatcher</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Ignite. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IgniteEx</span> ignite<span class="token punctuation">;</span>

    <span class="token comment">/** BLT change delay millis. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> bltChangeDelayMillis<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param ignite Ignite.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BaselineWatcher</span><span class="token punctuation">(</span><span class="token class-name">Ignite</span> ignite<span class="token punctuation">,</span> <span class="token keyword">long</span> bltChangeDelayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ignite <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IgniteEx</span><span class="token punctuation">)</span>ignite<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bltChangeDelayMillis <span class="token operator">=</span> bltChangeDelayMillis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ignite<span class="token punctuation">.</span><span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">localListen</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">DiscoveryEvent</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DiscoveryEvent</span><span class="token punctuation">)</span>event<span class="token punctuation">;</span>

            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> aliveSrvNodes <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">topologyNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>n <span class="token operator">-&gt;</span> <span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">isClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ClusterNode</span><span class="token operator">::</span><span class="token function">consistentId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> baseline <span class="token operator">=</span> ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">currentBaselineTopology</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">BaselineNode</span><span class="token operator">::</span><span class="token function">consistentId</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> topVer <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">topologyVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aliveSrvNodes<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>baseline<span class="token punctuation">)</span><span class="token punctuation">)</span>
                ignite<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTimeoutObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GridTimeoutObjectAdapter</span><span class="token punctuation">(</span>bltChangeDelayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">topologyVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> topVer<span class="token punctuation">)</span>
                            ignite<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBaselineTopology</span><span class="token punctuation">(</span>topVer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">EventType</span><span class="token punctuation">.</span>EVT_NODE_FAILED<span class="token punctuation">,</span> <span class="token class-name">EventType</span><span class="token punctuation">.</span>EVT_NODE_LEFT<span class="token punctuation">,</span> <span class="token class-name">EventType</span><span class="token punctuation">.</span>EVT_NODE_JOINED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-交换空间"><a href="#_6-交换空间" class="header-anchor">#</a> 6.交换空间</h2> <h3 id="_6-1-概述"><a href="#_6-1-概述" class="header-anchor">#</a> 6.1.概述</h3> <p>如果使用纯内存存储，随着数据量的大小逐步达到物理内存大小，可能导致内存溢出。要避免这种情况的发生，可能的想法包括开启原生的持久化或者使用第三方的持久化。但是，如果不想使用原生或者第三方的持久化，还可以开启交换，这时，Ignite会将内存中的数据移动到磁盘上的交换空间，注意要知道Ignite不会提供自己的交换空间实现，而是利用了操作系统（OS）提供的交换功能。</p> <p>打开交换空间之后，Ignite会将数据存储在内存映射文件（MMF）中，操作系统会根据内存使用情况，将其内容交换到磁盘，但是这时数据访问的性能会下降，另外，还没有数据持久性保证，这意味着交换空间中的数据只在节点在线期间才可用。一旦节点停止，所有数据都会丢失。因此，应该使用交换空间作为内存的扩展，以便留出足够的时间向集群中添加更多的节点，以便数据重新分布并避免集群未及时扩容导致内存溢出的错误（OOM）发生。</p> <blockquote><p>建议使用Ignite的原生持久化，它容量超过了RAM并且保留了持久性。</p></blockquote> <h3 id="_6-2-配置"><a href="#_6-2-配置" class="header-anchor">#</a> 6.2.配置</h3> <p>数据区的<code>maxSize</code>定义了区域的整体最大值，如果数据量达到了<code>maxSize</code>，然后既没有使用原生持久化，也没有使用第三方数据库，那么可能会抛出内存溢出异常。使用交换可以避免这种情况的发生，这时：</p> <ul><li>配置<code>maxSize</code>的值大于内存大小，这时操作系统就会使用交换；</li> <li>配置<code>DataRegionConfiguration.swapPath</code>属性来启用交换。</li></ul> <p>XML：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.IgniteConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Durable memory configuration. --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataStorageConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dataRegionConfigurations<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!--
              Defining a data region that will consume up to 500 MB of RAM
              with swap enabled.
          --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>org.apache.ignite.configuration.DataRegionConfiguration<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!-- Custom region name. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>500MB_Region<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

            <span class="token comment">&lt;!-- 100 MB initial size. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>initialSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#{100L * 1024 * 1024}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

            <span class="token comment">&lt;!-- Setting region max size equal to physical RAM size(5 GB). --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>maxSize<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>#{5L * 1024 * 1024 * 1024}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

            <span class="token comment">&lt;!-- Enabling swap space for the region. --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>swapPath<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/path/to/some/directory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- Other configurations. --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Java：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Ignite configuration.</span>
<span class="token class-name">IgniteConfiguration</span> cfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IgniteConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Durable Memory configuration.</span>
<span class="token class-name">DataStorageConfiguration</span> storageCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorageConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Creating a new data region.</span>
<span class="token class-name">DataRegionConfiguration</span> regionCfg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataRegionConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Region name.</span>
regionCfg<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;500MB_Region&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting initial RAM size.</span>
regionCfg<span class="token punctuation">.</span><span class="token function">setInitialSize</span><span class="token punctuation">(</span><span class="token number">100L</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting region max size equal to physical RAM size(5 GB)</span>
regionCfg<span class="token punctuation">.</span><span class="token function">setMaxSize</span><span class="token punctuation">(</span><span class="token number">5L</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enable swap space.</span>
regionCfg<span class="token punctuation">.</span><span class="token function">setSwapPath</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/some/directory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Setting the data region configuration.</span>
storageCfg<span class="token punctuation">.</span><span class="token function">setDataRegionConfigurations</span><span class="token punctuation">(</span>regionCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Applying the new configuration.</span>
cfg<span class="token punctuation">.</span><span class="token function">setDataStorageConfiguration</span><span class="token punctuation">(</span>storageCfg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p><strong>可能的数据丢失</strong><br>
虽然交换空间位于磁盘上，但不要认为它可以替代原生持久化，交换空间中的数据只在节点在线期间可用。一旦节点停止，所有数据都会丢失。要一直保证数据的可用性，要么使用原生持久化，要么使用第三方持久化。</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间：:</span> <span class="time">12/19/2020, 9:46:01 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc/2.6.0/java/MachineLearningGrid.html" class="prev">
        机器学习网格
      </a></span> <span class="next"><a href="/doc/2.6.0/java/TestsAndBenchmarking.html">
        基准测试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd3dd904.js" defer></script><script src="/assets/js/3.d41ef727.js" defer></script><script src="/assets/js/1.c1604912.js" defer></script><script src="/assets/js/57.c4175403.js" defer></script>
  </body>
</html>
