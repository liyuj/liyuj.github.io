(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{214:function(t,a,e){"use strict";e.r(a);var s=e(3),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"kafka-connect之在2-3版本中的改进"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kafka-connect之在2-3版本中的改进"}},[t._v("#")]),t._v(" Kafka Connect之在2.3版本中的改进")]),t._v(" "),e("p",[t._v("在Kafka的2.3版本中，对Kafka Connect做了很大的改进。首先就是在添加和删除连接器时，修改了Kafka Connect处理任务的方式。之前这个动作造成了整个系统的停顿，这是一直被开发和运维人员诟病的地方，除此之外，社区中频繁提到的其他一些问题，也得到了解决。")]),t._v(" "),e("h2",{attrs:{id:"kafka-connect中的增量协作再平衡"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kafka-connect中的增量协作再平衡"}},[t._v("#")]),t._v(" Kafka Connect中的增量协作再平衡")]),t._v(" "),e("p",[t._v("Kafka Connect集群由一个或多个工作节点进程组成，集群以任务的形式分发连接器的负载。在添加或删除连接器或工作节点时，Kafka Connect会尝试再平衡这些任务。在Kafka的2.3版本之前，集群会停止所有任务，重新计算所有任务的执行位置，然后重启所有任务。每次再平衡都会暂停所有数据进出的工作，通常时间很短，但有时也会持续一段时间。")]),t._v(" "),e("p",[t._v("现在通过"),e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-415%3A+Incremental+Cooperative+Rebalancing+in+Kafka+Connect",target:"_self",rel:"noopener noreferrer"}},[t._v("KIP-415")]),t._v("，Kafka 2.3用增量协作再平衡做了替代，以后将仅对需要启动、停止或移动的任务进行再平衡。具体的详细信息请参见"),e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-415%3A+Incremental+Cooperative+Rebalancing+in+Kafka+Connect",target:"_self",rel:"noopener noreferrer"}},[t._v("这里")]),t._v("。")]),t._v(" "),e("p",[t._v("下面用一些连接器做了一个简单的测试，这里只使用了一个分布式Kafka Connect工作节点，而源端使用了"),e("code",[t._v("kafka-connect-datagen")]),t._v("，它以固定的时间间隔根据给定的模式生成随机数据。以固定的时间间隔就可以粗略地计算由于再平衡而停止任务的时间，因为生成的消息作为Kafka消息的一部分，包含了时间戳。这些消息之后会被流式注入Elasticsearch，之所以用它，不仅因为它是一个易于使用的接收端，也因为可以通过观察源端消息的时间戳来查看生产中的任何停顿。")]),t._v(" "),e("p",[t._v("通过如下的方式，可以创建源端：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s -X PUT -H  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type:application/json"')]),t._v(" http://localhost:8083/connectors/source-datagen-01/config "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{\n    "connector.class": "io.confluent.kafka.connect.datagen.DatagenConnector",\n    "kafka.topic": "orders",\n    "quickstart":"orders",\n    "max.interval":200,\n    "iterations":10000000,\n    "tasks.max": "1"\n  }\'')]),t._v("\n")])])]),e("p",[t._v("通过如下方式创建接收端：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s -X PUT -H  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type:application/json"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    http://localhost:8083/connectors/sink-elastic-orders-00/config "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{\n        "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",\n        "topics": "orders",\n        "connection.url": "http://elasticsearch:9200",\n        "type.name": "type.name=kafkaconnect",\n        "key.ignore": "true",\n        "schema.ignore": "false",\n        "transforms": "addTS",\n        "transforms.addTS.type": "org.apache.kafka.connect.transforms.InsertField'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$Value")]),t._v('",\n        "transforms.addTS.timestamp.field": "op_ts"\n        }\'')]),t._v("\n")])])]),e("p",[t._v("这里使用了单消息转换，将Kafka消息的时间戳提升到消息本身的字段中，以便可以在Elasticsearch中进行公开。之后会使用Kibana进行绘制，这样产生的消息数量下降就可以显示出来，与再平衡发生的位置一致：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.confluent.io/wp-content/uploads/Kibana_Rebalance_Kafka_2.2_vs_2.3.png",alt:""}})]),t._v(" "),e("p",[t._v("在Kafka Connect的工作节点日志中，可以查看活动和时间，并对Kafka的2.2版本和2.3版本的行为进行比较：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.confluent.io/wp-content/uploads/Kafka_Connect_Worker_Log.png",alt:""}})]),t._v(" "),e("p",[t._v("**注意：**为了清楚地说明问题，日志做了精简处理。")]),t._v(" "),e("h2",{attrs:{id:"对日志的改进"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#对日志的改进"}},[t._v("#")]),t._v(" 对日志的改进")]),t._v(" "),e("p",[t._v("在再平衡问题（如前述）已大大改善之后，Kafka Connect的第二大困扰可能是难以在Kafka Connect工作节点日志中确定某个消息属于哪个连接器。")]),t._v(" "),e("p",[t._v("之前可以直接从连接器的任务中获取日志中的消息，例如：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("INFO Using multi thread/connection supporting pooling connection manager (io.searchbox.client.JestClientFactory)\nINFO Using default GSON instance (io.searchbox.client.JestClientFactory)\nINFO Node Discovery disabled... (io.searchbox.client.JestClientFactory)\nINFO Idle connection reaping disabled... (io.searchbox.client.JestClientFactory)\n")])])]),e("p",[t._v("他们属于哪个任务？不清楚。也许会认为"),e("code",[t._v("JestClient")]),t._v("与"),e("code",[t._v("Elasticsearch")]),t._v("有关，也许它们来自"),e("code",[t._v("Elasticsearch")]),t._v("连接器，但是现在有5个不同的"),e("code",[t._v("Elasticsearch")]),t._v("连接器在运行，那么它们来自哪个实例？更不用说连接器可以有多个任务了。")]),t._v(" "),e("p",[t._v("在Apache Kafka 2.3中，可以使用映射诊断上下文（MDC）日志，在日志中提供了更多的上下文信息：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("INFO [sink-elastic-orders-00|task-0] Using multi thread/connection supporting pooling connection manager (io.searchbox.client.JestClientFactory:223)\nINFO [sink-elastic-orders-00|task-0] Using default GSON instance (io.searchbox.client.JestClientFactory:69)\nINFO [sink-elastic-orders-00|task-0] Node Discovery disabled... (io.searchbox.client.JestClientFactory:86)\nINFO [sink-elastic-orders-00|task-0] Idle connection reaping disabled... (io.searchbox.client.JestClientFactory:98)\n")])])]),e("p",[t._v("这个日志格式的更改默认是禁用的，以保持后向兼容性。要启用此改进，需要编辑"),e("code",[t._v("etc/kafka/connect-log4j.properties")]),t._v("文件，按照如下方式修改"),e("code",[t._v("log4j.appender.stdout.layout.ConversionPattern")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language-properties extra-class"},[e("pre",{pre:!0,attrs:{class:"language-properties"}},[e("code",[e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("log4j.appender.stdout.layout.ConversionPattern")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("[%d] %p %X{connector.context}%m (%c:%L)%n")]),t._v("\n")])])]),e("p",[t._v("通过环境变量"),e("code",[t._v("CONNECT_LOG4J_APPENDER_STDOUT_LAYOUT_CONVERSIONPATTERN")]),t._v("，"),e("a",{attrs:{href:"https://hub.docker.com/r/confluentinc/cp-kafka-connect",target:"_self",rel:"noopener noreferrer"}},[t._v("Kafka Connect的Docker镜像")]),t._v("也支持了这个特性。")]),t._v(" "),e("p",[t._v("具体细节请参见"),e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-449%3A+Add+connector+contexts+to+Connect+worker+logs",target:"_self",rel:"noopener noreferrer"}},[t._v("KIP-449")]),t._v("。")]),t._v(" "),e("p",[e("strong",[t._v("REST改进")])]),t._v(" "),e("p",[e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-465%3A+Add+Consolidated+Connector+Endpoint+to+Connect+REST+API",target:"_self",rel:"noopener noreferrer"}},[t._v("KIP-465")]),t._v("为"),e("code",[t._v("/connectors")]),t._v("REST端点添加了一些方便的功能。通过传递其他参数，可以获取有关每个连接器的更多信息，而不必迭代结果并进行其他REST调用。")]),t._v(" "),e("p",[t._v("例如，在Kafka 2.3之前要查询所有任务的状态，必须执行以下操作，使用"),e("code",[t._v("xargs")]),t._v("迭代输出并重复调用"),e("code",[t._v("status")]),t._v("端点：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8083/connectors"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    jq "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.[]'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("xargs")]),t._v(" -I"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("connector_name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8083/connectors/"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("connector_name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/status"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    jq -c -M "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[.name,.connector.state,.tasks[].state]|join(\":|:\")'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("column")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" -t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/"),e("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("//g'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sort")]),t._v("\nsink-elastic-orders-00  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING\nsource-datagen-01       "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING\n")])])]),e("p",[t._v("现在使用Kafka 2.3，可以使用"),e("code",[t._v("/connectors?expand=status")]),t._v("加上一些"),e("code",[t._v("jq")]),t._v("技巧进行单个REST调用，就可以达到和之前一样的效果：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8083/connectors?expand=status"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n     jq "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'to_entries[] | [.key, .value.status.connector.state,.value.status.tasks[].state]|join(\":|:\")'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n     "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("column")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" -t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/"),e("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("//g'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sort")]),t._v("\nsink-elastic-orders-00  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING\nsource-datagen-01       "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING\n")])])]),e("p",[t._v("还有"),e("code",[t._v("/connectors?expand=status")]),t._v("，它将返回每个连接器信息，如配置、连接器类型等，也可以把它们结合起来：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8083/connectors?expand=info&expand=status"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("jq "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'to_entries[] | [ .value.info.type, .key, .value.status.connector.state,.value.status.tasks[].state,.value.info.config."connector.class"]|join(":|:")\'')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n       "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("column")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" -t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/"),e("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("//g'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sort")]),t._v("\nsink    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  sink-elastic-orders-00  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  io.confluent.connect.elasticsearch.ElasticsearchSinkConnector\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  source-datagen-01       "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  RUNNING  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  io.confluent.kafka.connect.datagen.DatagenConnector\n")])])]),e("p",[e("strong",[t._v("Kafka Connect现已支持client.id")])]),t._v(" "),e("p",[t._v("因为"),e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-411%3A+Make+default+Kafka+Connect+worker+task+client+IDs+distinct",target:"_self",rel:"noopener noreferrer"}},[t._v("KIP-411")]),t._v("，Kafka Connect现在可以以更有用的方式为每项任务配置"),e("code",[t._v("client.id")]),t._v("。之前，只能看到"),e("code",[t._v("consumer-25")]),t._v("作为连接器的消费者组的一部分从给定的分区进行消费，现在则可以将其直接绑定回特定的任务，从而使故障排除和诊断更加容易。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.confluent.io/wp-content/uploads/KIP-411_Kafka_Connect_client.id_.png",alt:""}})]),t._v(" "),e("p",[e("strong",[t._v("连接器级生产者/消费者配置覆写")])]),t._v(" "),e("p",[t._v("长期以来的一个常见需求是能够覆写分别由Kafka Connect接收端和源端使用的"),e("a",{attrs:{href:"https://kafka.apache.org/documentation/#consumerconfigs",target:"_self",rel:"noopener noreferrer"}},[t._v("消费者设置")]),t._v("或"),e("a",{attrs:{href:"https://kafka.apache.org/documentation/#producerconfigs",target:"_self",rel:"noopener noreferrer"}},[t._v("生产者设置")]),t._v("。到目前为止，它们都采用了工作节点配置中指定的值，除非生成了更多的工作节点，否则无法对诸如安全主体之类的内容进行细粒度的控制。")]),t._v(" "),e("p",[t._v("Kafka 2.3中的"),e("a",{attrs:{href:"https://cwiki.apache.org/confluence/display/KAFKA/KIP-458%3A+Connector+Client+Config+Override+Policy",target:"_self",rel:"noopener noreferrer"}},[t._v("KIP-458")]),t._v("使工作节点能够允许对配置进行覆写。"),e("code",[t._v("connector.client.config.override.policy")]),t._v("是一个新的参数，在工作节点级可以有3个可选项：")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("值")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("None")]),t._v(" "),e("td",[e("strong",[t._v("默认策略")]),t._v("，不允许任何配置的覆写")])]),t._v(" "),e("tr",[e("td",[t._v("Principal")]),t._v(" "),e("td",[t._v("允许覆盖生产者、消费者和"),e("code",[t._v("admin")]),t._v("前缀的"),e("code",[t._v("security.protocol")]),t._v("、"),e("code",[t._v("sasl.jaas.config")]),t._v("和"),e("code",[t._v("sasl.mechanism")])])]),t._v(" "),e("tr",[e("td",[t._v("All")]),t._v(" "),e("td",[t._v("允许覆盖生产者、消费者和"),e("code",[t._v("admin")]),t._v("前缀的所有配置")])])])]),t._v(" "),e("p",[t._v("通过在工作节点配置中设置上述参数，现在可以针对每个连接器对配置进行覆写。只需提供带有"),e("code",[t._v("consumer.override")]),t._v("（接收端）或"),e("code",[t._v("producer.override")]),t._v("（源端）前缀的必需参数即可，还可以针对"),e("a",{attrs:{href:"https://liyuj.gitee.io/confluent/Kafka-ErrorHandlingDeadLetterQueues.html",target:"_self",rel:"noopener noreferrer"}},[t._v("死信队列")]),t._v("使用"),e("code",[t._v("admin.override")]),t._v("。")]),t._v(" "),e("p",[t._v("在下面的示例中，创建连接器时，它将从主题的当前点开始消费数据，而不是读取主题中的所有可用数据，这是通过将"),e("code",[t._v("consumer.override.auto.offset.reset")]),t._v("配置为"),e("code",[t._v("latest")]),t._v("覆盖"),e("code",[t._v("auto.offset.reset configuration")]),t._v("来实现的。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -i -X PUT -H  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type:application/json"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n      http://localhost:8083/connectors/sink-elastic-orders-01-latest/config "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n      -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{\n  "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",\n  "topics": "orders",\n  "consumer.override.auto.offset.reset": "latest",\n  "tasks.max": 1,\n  "connection.url": "http://elasticsearch:9200",  "type.name": "type.name=kafkaconnect",\n  "key.ignore": "true",   "schema.ignore": "false",\n  "transforms": "renameTopic",\n  "transforms.renameTopic.type": "org.apache.kafka.connect.transforms.RegexRouter",\n  "transforms.renameTopic.regex": "orders",\n  "transforms.renameTopic.replacement": "orders-latest"\n}\'')]),t._v("\n")])])]),e("p",[t._v("通过检查工作节点日志，可以看到覆写已经生效：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[2019-07-17 13:57:27,532] INFO [sink-elastic-orders-01-latest|task-0] ConsumerConfig values:\n        allow.auto.create.topics = true\n        auto.commit.interval.ms = 5000\n        auto.offset.reset = latest\n[…]\n")])])]),e("p",[t._v("可以看到这个"),e("code",[t._v("ConsumerConfig")]),t._v("日志条目与创建的连接器直接关联，证明了上述MDC日志记录的有用性。")]),t._v(" "),e("p",[t._v("第二个连接器运行于同一主题但没有"),e("code",[t._v("consumer.override")]),t._v("，因此继承了默认值"),e("code",[t._v("earliest")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[2019-07-17 13:57:27,487] INFO [sink-elastic-orders-01-earliest|task-0] ConsumerConfig values:\n        allow.auto.create.topics = true\n        auto.commit.interval.ms = 5000\n        auto.offset.reset = earliest\n[…]\n")])])]),e("p",[t._v("通过将数据从主题流式传输到Elasticsearch可以检查配置的差异造成的影响。")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"localhost:9200/_cat/indices?h=idx,docsCount"')]),t._v("\norders-latest     "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2369")]),t._v("\norders-earliest "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("144932")]),t._v("\n")])])]),e("p",[t._v("有两个索引：一个从同一主题注入了较少的消息，因为"),e("code",[t._v("orders-latest")]),t._v("索引只注入了连接器创建后才到达主题的消息；而另一个"),e("code",[t._v("orders-earliest")]),t._v("索引，由一个单独的连接器注入，它会使用Kafka Connect的默认配置，即会注入所有的新消息，再加上主题中原有的所有消息。\n"),e("RightPane")],1)])}),[],!1,null,null,null);a.default=n.exports}}]);